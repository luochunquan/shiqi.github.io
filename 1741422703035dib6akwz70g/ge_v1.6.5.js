!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ge={})}(this,(function(t){"use strict";var e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},e(t,r)};function r(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}var i=function(){return i=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},i.apply(this,arguments)};function n(t,e,r,i){return new(r||(r=Promise))((function(n,o){function s(t){try{u(i.next(t))}catch(t){o(t)}}function a(t){try{u(i.throw(t))}catch(t){o(t)}}function u(t){t.done?n(t.value):function(t){return t instanceof r?t:new r((function(e){e(t)}))}(t.value).then(s,a)}u((i=i.apply(t,e||[])).next())}))}function o(t,e){var r,i,n,o,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,i&&(n=2&a[0]?i.return:a[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,a[1])).done)return n;switch(i=0,n&&(a=[2&a[0],n.value]),a[0]){case 0:case 1:n=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,i=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(n=s.trys,!((n=n.length>0&&n[n.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!n||a[1]>n[0]&&a[1]<n[3])){s.label=a[1];break}if(6===a[0]&&s.label<n[1]){s.label=n[1],n=a;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(a);break}n[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],i=0}finally{r=n=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}function s(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function a(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}function u(t,e,r){if(r||2===arguments.length)for(var i,n=0,o=e.length;n<o;n++)!i&&n in e||(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))}"function"==typeof SuppressedError&&SuppressedError;var c=6,l="editor",h="none",f={"Filter not imported":"https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg","Item duration can't be less than 0":"https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg"};function p(t,e,r){var i;if(void 0===e&&(e="webgl"),"webgl2"===e&&((i=t.getContext("webgl2",r))||console.debug("WebGL2 context retrieval failed, falling back to WebGL context.")),i&&"webgl"!==e||(i=t.getContext("webgl",r)),!i)throw new Error("This browser does not support WebGL or the WebGL version is incorrect. Please check your WebGL version.");return i}function d(t){var e=this,r=t.getExtension("EXT_disjoint_timer_query_webgl2");if(r){var i=t.createQuery(),s=function(){return n(e,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e,n){if(i){var o=t.getQueryParameter(i,t.QUERY_RESULT_AVAILABLE),a=t.getParameter(r.GPU_DISJOINT_EXT);if(o&&!a){var u=t.getQueryParameter(i,t.QUERY_RESULT);e(u/1e3/1e3)}(o||a)&&(t.deleteQuery(i),i=null),null!==o&&i&&window.setTimeout((function(){s().then(e).catch}),1)}}))]}))}))};if(!i)return;return{begin:function(){i&&t.beginQuery(r.TIME_ELAPSED_EXT,i)},end:function(){t.endQuery(r.TIME_ELAPSED_EXT)},getTime:s}}}var m=[],v={};function y(){"function"==typeof WebGL2RenderingContext?x(WebGL2RenderingContext):"undefined"!=typeof WebGLRenderingContext?(x(WebGLRenderingContext),x(WebGLRenderingContext.prototype)):m.push("iOS16 lockdown mode, WebGL Constants not in global"),m.length||"HALF_FLOAT"in v||(v.HALF_FLOAT=5131)}function g(t){return"undefined"!=typeof WebGL2RenderingContext&&"WebGL2RenderingContext"===t.constructor.name}function x(t){for(var e in t)/^[A-Z_]/.test(e)&&(v[e]=t[e])}m.length||y();var T,E,b,S,A,R,C,_,w,O,M,L,I,P,F,V,N,D,z,B,U,k,G,X,H,Y,j,W,Z,q,K={},Q={};function J(t,e,r){t in K&&console.error("Filter ".concat(t," registered twice.")),K[t]=e,Q[t]=r}function $(t){Object.keys(t).forEach((function(e){var r=a(t[e],2);J(e,r[0],r[1])}))}function tt(t){var e=Q[t.name];if(!e)throw Error("Filter ".concat(t.name," not imported, see ").concat(f["Filter not imported"]));return e(t)}function et(t,e){var r=K[t.name];if(!r)throw Error("Filter ".concat(t.name," not imported, see ").concat(f["Filter not imported"]));var i=r(t,e);return i.passSplitOptions||(i.passSplitOptions={attachments:[{texture:{format:v.RGBA}}]}),i}function rt(t,e){return t.includes(e)||t.push(e),t}function it(t,e){var r=t.indexOf(e);return r>-1&&t.splice(r,1),t}function nt(t,e,r,i){if(void 0===i&&(i=!1),!t.includes(e)&&(t.push(e),1!==t.length)){var n=t.length-1;if(n){var o=t[n];if(i)for(;t[n-1][r]<o[r]&&(t[n]=t[n-1],0!=--n););else for(;t[n-1][r]>o[r]&&(t[n]=t[n-1],0!=--n););t[n]=o}}}function ot(t,e,r,i){if(void 0===r&&(r=1),t.buffer.byteLength<t.BYTES_PER_ELEMENT*e){var n=Math.ceil(e*r);isNaN(i)||(n=Math.min(n,i));var o=new ArrayBuffer(t.BYTES_PER_ELEMENT*n),s=new t.constructor(o);return s.set(t),s}return t}function st(t,e){var r=[0,0,0,0];if(tr(t)){t=t.replace(/[\s\t\r\n]/g,"");var i=/rgba?\(([.\d]+),([.\d]+),([.\d]+),?([.\d]+)?\)/.exec(t);if(i){var n=+i[4];r=[+i[1],+i[2],+i[3],isNaN(n)?255:255*n]}else/^#[a-f\d]{3}$/i.test(t)?r=[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16),255]:(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))&&(r=[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16),255]||[0,0,0,255])}else t instanceof Array&&(r=[t[0],t[1],t[2],isNaN(t[3])?255:t[3]]);if(e)for(var o=0;o<4;o++)r[o]/=255;return r}function at(t,e,r){if(t.length){for(var i=void 0,n=1;n<=t.length-1;n++){var o=t[n-1],s=t[n];if(o.stop<=e&&e<=s.stop){i=ct(o.color,s.color,(e-o.stop)/(s.stop-o.stop));break}}return i||(i=t[t.length-1].color),r?i.map((function(t){return t/255})):i}return[0,0,0,0]}function ut(t){var e=[];if(t instanceof Array?t.forEach((function(t){var r=a(t,5),i=r[0],n=r[1],o=r[2],s=r[3],u=r[4];e.push({stop:lt(i),color:[n,o,s,u]})})):Object.keys(t).forEach((function(r){var i=st(t[r]);e.push({stop:lt(r),color:i})})),(e=e.sort((function(t,e){return t.stop-e.stop}))).length){0!==e[0].stop&&e.unshift({stop:0,color:e[0].color.slice()});var r=e[e.length-1];1!==r.stop&&e.push({stop:1,color:r.color.slice()})}return e}function ct(t,e,r,i){var n=[],o=1-r;if(i)for(var s=0;s<4;s++)n[s]=t[s]*o+e[s]*r;else{for(s=0;s<3;s++)n[s]=Math.round(Math.sqrt(t[s]*t[s]*o+e[s]*e[s]*r));n[3]=Math.round(t[3]*o+e[3]*r)}return n}function lt(t){var e=/^(-)?([\d+.]+)%$/.exec(t);return e?+e[2]/100*(e[1]?-1:1):+t}function ht(){if("object"==typeof screen&&"object"==typeof document){var t=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e=screen.width/t;return Math.min(2*e,2)}return 1}function ft(){return/\b[Aa]ndroid\b/.test(navigator.userAgent)}function pt(){return ft()||/\b(iPad|iPhone|iPod)\b/.test(navigator.userAgent)}function dt(t){tr(t)&&(t=st(t));for(var e=t,r={width:1,height:1,data:new Uint8Array(4)},i=r.data,n=0;n<4;n++)i[n]=e[n];return r}function mt(t){var e=128,r={width:e,height:1,data:new Uint8Array(512)},i=r.data,n=ut(t);if(n.length){i.set(n[0].color,0);for(var o=1;o<127;o++){for(var s=o/e,a=void 0,u=void 0,c=0;c<n.length&&(a=n[c],u=n[c+1],!(a.stop<=s&&u.stop>s));c++);var l=ct(a.color,u.color,(s-a.stop)/(u.stop-a.stop));i.set(l,4*o)}i.set(n[n.length-1].color,508)}return r}function vt(e,r){void 0===r&&(r=t.OrderType.ascending);var i=e.length;if(i<=1||r===t.OrderType.none)return e;if(i<=30){for(var n=1;n<i;n++)gt(e,n,r);return e}return xt(e,r)}function yt(e,r,i){return void 0===i&&(i=t.OrderType.ascending),e.includes(r)||(e.push(r),1===e.length||i!==t.OrderType.none&&gt(e,e.length-1,i)),e}function gt(e,r,i){var n=e[r];if(i!==t.OrderType.ascending)for(;r>=1&&e[r-1].priority<n.priority&&(e[r]=e[r-1],0!=--r););else for(;r>=1&&e[r-1].priority>n.priority&&(e[r]=e[r-1],0!=--r););e[r]=n}function xt(e,r,i,n){var o,s;if(void 0===i&&(i=0),void 0===n&&(n=e.length-1),i>=n)return e;for(var u=e[i],c=i,l=n;c<l;){if(r===t.OrderType.ascending){for(;e[l].priority>u.priority&&l>=c;)l--;for(;e[c].priority<=u.priority&&c<l;)c++}else{for(;e[l].priority<u.priority&&l>=c;)l--;for(;e[c].priority>=u.priority&&c<l;)c++}o=a([e[l],e[c]],2),e[c]=o[0],e[l]=o[1]}return s=a([e[c],e[i]],2),e[i]=s[0],e[c]=s[1],xt(e,r,i,c-1),xt(e,r,l+1,n),e}function Tt(t,e){if(void 0===e&&(e="item doesn't exist"),null==t)throw new Error(e)}function Et(t){return/^[^\d.][\w-]*$/.test(t)}
/*!
     * Name: @galacean/effects-specification
     * Description: Galacean Effects JSON Specification
     * Author: Ant Group CO., Ltd.
     * Version: v1.3.0
     */t.OrderType=void 0,(T=t.OrderType||(t.OrderType={}))[T.none=1]="none",T[T.ascending=2]="ascending",T[T.descending=3]="descending",function(t){t.S="S",t.APlus="A+",t.A="A",t.BPlus="B+",t.B="B"}(E||(E={})),function(t){t[t.ALPHA=0]="ALPHA",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.BRIGHTNESS=3]="BRIGHTNESS",t[t.SUBTRACTION=4]="SUBTRACTION",t[t.STRONG_LIGHT=5]="STRONG_LIGHT",t[t.WEAK_LIGHT=6]="WEAK_LIGHT",t[t.SUPERPOSITION=7]="SUPERPOSITION"}(b||(b={})),function(t){t[t.DOUBLE=1032]="DOUBLE",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK"}(S||(S={})),function(t){t[t.NONE=0]="NONE",t[t.MASK=1]="MASK",t[t.OBSCURED=2]="OBSCURED",t[t.REVERSE_OBSCURED=3]="REVERSE_OBSCURED"}(A||(A={})),function(t){t[t.NONE=0]="NONE",t[t.SPHERE=1]="SPHERE",t[t.CONE=2]="CONE",t[t.HEMISPHERE=3]="HEMISPHERE",t[t.CIRCLE=4]="CIRCLE",t[t.DONUT=5]="DONUT",t[t.RECTANGLE=6]="RECTANGLE",t[t.RECTANGLE_EDGE=7]="RECTANGLE_EDGE",t[t.EDGE=8]="EDGE",t[t.TEXTURE=9]="TEXTURE"}(R||(R={})),function(t){t[t.GYROSCOPE=0]="GYROSCOPE",t[t.SPINE=1]="SPINE"}(C||(C={})),function(t){t[t.CLICK=0]="CLICK",t[t.MESSAGE=1]="MESSAGE",t[t.DRAG=2]="DRAG"}(_||(_={})),function(t){t[t.NONE=0]="NONE",t[t.NOTIFY=1]="NOTIFY",t[t.RESUME_PLAYER=2]="RESUME_PLAYER",t[t.REMOVE=3]="REMOVE",t[t.PAUSE=4]="PAUSE"}(w||(w={})),function(t){t.base="0",t.sprite="1",t.particle="2",t.null="3",t.interact="4",t.plugin="5",t.camera="6",t.composition="7",t.filter="8",t.spine="spine",t.mesh="mesh",t.tree="tree",t.text="text",t.light="light",t.skybox="skybox"}(O||(O={})),function(t){t[t.BILLBOARD=0]="BILLBOARD",t[t.MESH=1]="MESH",t[t.VERTICAL_BILLBOARD=2]="VERTICAL_BILLBOARD",t[t.HORIZONTAL_BILLBOARD=3]="HORIZONTAL_BILLBOARD"}(M||(M={})),function(t){t[t.PARTICLE_ORIGIN_CENTER=0]="PARTICLE_ORIGIN_CENTER",t[t.PARTICLE_ORIGIN_LEFT_TOP=1]="PARTICLE_ORIGIN_LEFT_TOP",t[t.PARTICLE_ORIGIN_LEFT_CENTER=2]="PARTICLE_ORIGIN_LEFT_CENTER",t[t.PARTICLE_ORIGIN_LEFT_BOTTOM=3]="PARTICLE_ORIGIN_LEFT_BOTTOM",t[t.PARTICLE_ORIGIN_CENTER_TOP=4]="PARTICLE_ORIGIN_CENTER_TOP",t[t.PARTICLE_ORIGIN_CENTER_BOTTOM=5]="PARTICLE_ORIGIN_CENTER_BOTTOM",t[t.PARTICLE_ORIGIN_RIGHT_TOP=6]="PARTICLE_ORIGIN_RIGHT_TOP",t[t.PARTICLE_ORIGIN_RIGHT_CENTER=7]="PARTICLE_ORIGIN_RIGHT_CENTER",t[t.PARTICLE_ORIGIN_RIGHT_BOTTOM=8]="PARTICLE_ORIGIN_RIGHT_BOTTOM"}(L||(L={})),function(t){t[t.portrait=1]="portrait",t[t.landscape=0]="landscape"}(I||(I={})),function(t){t[t.destroy=0]="destroy",t[t.pause=1]="pause",t[t.restart=5]="restart",t[t.forward=2]="forward",t[t.pause_destroy=3]="pause_destroy"}(P||(P={})),function(t){t.video="video",t.image="image"}(F||(F={})),function(t){t[t.CONSTANT=0]="CONSTANT",t[t.CONSTANT_VEC2=1]="CONSTANT_VEC2",t[t.CONSTANT_VEC3=2]="CONSTANT_VEC3",t[t.CONSTANT_VEC4=3]="CONSTANT_VEC4",t[t.RANDOM=4]="RANDOM",t[t.LINE=5]="LINE",t[t.CURVE=6]="CURVE",t[t.BEZIER_PATH=7]="BEZIER_PATH",t[t.RGBA_COLOR=8]="RGBA_COLOR",t[t.GRADIENT_COLOR=9]="GRADIENT_COLOR",t[t.SHAPE_POINTS=10]="SHAPE_POINTS",t[t.SHAPE_SPLITS=11]="SHAPE_SPLITS",t[t.LINEAR_PATH=12]="LINEAR_PATH",t[t.COLORS=13]="COLORS",t[t.BINARY=20]="BINARY",t[t.BEZIER_CURVE=21]="BEZIER_CURVE",t[t.BEZIER_CURVE_PATH=22]="BEZIER_CURVE_PATH"}(V||(V={})),function(t){t[t.AUTO=0]="AUTO",t[t.EASE=1]="EASE",t[t.EASE_IN=2]="EASE_IN",t[t.EASE_OUT=3]="EASE_OUT",t[t.LINE=4]="LINE",t[t.HOLD=5]="HOLD",t[t.LINE_OUT=6]="LINE_OUT"}(N||(N={})),function(t){t[t.destroy=0]="destroy",t[t.loop=5]="loop",t[t.freeze=4]="freeze"}(D||(D={})),function(t){t[t.destroyChildren=6]="destroyChildren"}(z||(z={})),function(t){t[t.none=0]="none",t[t.removeParticle=1]="removeParticle"}(B||(B={})),function(t){t[t.RANDOM=0]="RANDOM",t[t.UNIDIRECTIONAL_CYCLE=1]="UNIDIRECTIONAL_CYCLE",t[t.BIDIRECTIONAL_CYCLE=2]="BIDIRECTIONAL_CYCLE",t[t.UNIFORM_BURST=3]="UNIFORM_BURST"}(U||(U={})),function(t){t[t.box=2]="box",t[t.sphere=3]="sphere"}(k||(k={})),function(t){t.unlit="unlit",t.pbr="pbr",t.hair="hair"}(G||(G={})),function(t){t[t.opaque=100]="opaque",t[t.masked=101]="masked",t[t.translucent=102]="translucent",t[t.additive=103]="additive"}(X||(X={})),function(t){t.none="none",t.uv="uv",t.normal="normal",t.basecolor="basecolor",t.alpha="alpha",t.metallic="metallic",t.roughness="roughness",t.ao="ao",t.emissive="emissive"}(H||(H={})),function(t){t[t.display=0]="display",t[t.clip=1]="clip",t[t.ellipsis=2]="ellipsis"}(Y||(Y={})),function(t){t[t.top=0]="top",t[t.middle=1]="middle",t[t.bottom=2]="bottom"}(j||(j={})),function(t){t[t.left=0]="left",t[t.middle=1]="middle",t[t.right=2]="right"}(W||(W={})),function(t){t.normal="normal",t.bold="bold",t.lighter="lighter"}(Z||(Z={})),function(t){t.normal="normal",t.italic="italic",t.oblique="oblique"}(q||(q={}));var bt=Object.freeze({__proto__:null,get BackgroundType(){return F},get BezierKeyframeType(){return N},get BlendingMode(){return b},BloomFilterThresholdAvgColor:0,CAMERA_CLIP_MODE_NORMAL:0,CAMERA_CLIP_MODE_VERTICAL:1,get CameraClipMode(){return I},get CompositionEndBehavior(){return P},END_BEHAVIOR_DESTROY:0,END_BEHAVIOR_DESTROY_CHILDREN:6,END_BEHAVIOR_FORWARD:2,END_BEHAVIOR_FREEZE:4,END_BEHAVIOR_PAUSE:1,END_BEHAVIOR_PAUSE_AND_DESTROY:3,END_BEHAVIOR_RESTART:5,get FontStyle(){return q},get InteractBehavior(){return w},get InteractType(){return _},get ItemEndBehavior(){return D},get ItemType(){return O},MESSAGE_ITEM_PHRASE_BEGIN:2,MESSAGE_ITEM_PHRASE_END:1,get MaskMode(){return A},get MaterialBlending(){return X},get MaterialType(){return G},get ModelBoundingType(){return k},get ParentItemEndBehavior(){return z},get ParticleInteractionBehavior(){return B},get ParticleOrigin(){return L},get PluginType(){return C},get RenderLevel(){return E},get RenderMode(){return M},get RenderMode3D(){return H},get ShapeArcMode(){return U},get ShapeType(){return R},get SideMode(){return S},get TextAlignment(){return W},get TextBaseline(){return j},get TextOverflow(){return Y},get TextWeight(){return Z},get ValueType(){return V}}),St=2*Math.PI,At=Math.PI/180,Rt=180/Math.PI,Ct=1e-6;function _t(t,e){return Math.abs(t-e)<Ct||t===1/0&&e===1/0||t===-1/0&&e===-1/0}var wt=function(t,e,r){return(1-r)*t+r*e};function Ot(t,e,r){var i=isNaN(e)?-1/0:e,n=isNaN(r)?1/0:r,o=Math.min(i,n),s=Math.max(i,n);return Math.min(Math.max(t,o),s)}var Mt,Lt=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.setZero=function(){return this.x=0,this.y=0,this},t.prototype.setFromNumber=function(t){return this.x=t,this.y=t,this},t.prototype.setFromArray=function(t,e){var r,i;return void 0===e&&(e=0),this.x=null!==(r=t[e])&&void 0!==r?r:0,this.y=null!==(i=t[e+1])&&void 0!==i?i:0,this},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.setElement=function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:console.error("index is out of range: "+t)}return this},t.prototype.getElement=function(t){switch(t){case 0:return this.x;case 1:return this.y;default:console.error("index is out of range: "+t)}return 0},t.prototype.add=function(t){return"number"==typeof t?(this.x+=t,this.y+=t):t instanceof Array?(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},t.prototype.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},t.prototype.subtract=function(t){return"number"==typeof t?(this.x-=t,this.y-=t):t instanceof Array?(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},t.prototype.subtractVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},t.prototype.multiply=function(t){return"number"==typeof t?(this.x*=t,this.y*=t):t instanceof Array?(this.x*=t[0],this.y*=t[1]):(this.x*=t.x,this.y*=t.y),this},t.prototype.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this},t.prototype.divide=function(t){return"number"==typeof t?(this.x/=t,this.y/=t):t instanceof Array?(this.x/=t[0],this.y/=t[1]):(this.x/=t.x,this.y/=t.y),this},t.prototype.scale=function(t){return this.x*=t,this.y*=t,this},t.prototype.sum=function(){return this.x+this.y},t.prototype.min=function(t){return"number"==typeof t?(this.x=Math.min(this.x,t),this.y=Math.min(this.y,t)):(this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y)),this},t.prototype.max=function(t){return"number"==typeof t?(this.x=Math.max(this.x,t),this.y=Math.max(this.y,t)):(this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y)),this},t.prototype.clamp=function(t,e){return this.max(t).min(e)},t.prototype.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},t.prototype.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},t.prototype.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},t.prototype.abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y},t.prototype.normalize=function(){return this.divide(this.length()||1)},t.prototype.setLength=function(t){return this.normalize().multiply(t)},t.prototype.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this},t.prototype.lerpVectors=function(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.distance=function(t){var e=this.x-t.x,r=this.y-t.y;return Math.sqrt(e*e+r*r)},t.prototype.distanceSquared=function(t){var e=this.x-t.x,r=this.y-t.y;return e*e+r*r},t.prototype.equals=function(t){return this.x===t.x&&this.y===t.y},t.prototype.isZero=function(){var t=Ct,e=this.x,r=this.y;return Math.abs(e)<=t&&Math.abs(r)<=t},t.prototype.toArray=function(){return[this.x,this.y]},t.prototype.fill=function(t,e){void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y},t.prototype.random=function(){return this.x=Math.random(),this.y=Math.random(),this},t.fromNumber=function(e){return(new t).setFromNumber(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.ONE=new t(1,1),t.ZERO=new t(0,0),t}(),It=function(){function t(t,e,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),this.x=t,this.y=e,this.z=r}return t.prototype.set=function(t,e,r){return this.x=t,this.y=e,this.z=r,this},t.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this},t.prototype.setFromNumber=function(t){return this.x=t,this.y=t,this.z=t,this},t.prototype.setFromArray=function(t,e){var r,i,n;return void 0===e&&(e=0),this.x=null!==(r=t[e])&&void 0!==r?r:0,this.y=null!==(i=t[e+1])&&void 0!==i?i:0,this.z=null!==(n=t[e+2])&&void 0!==n?n:0,this},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.prototype.clone=function(){return new t(this.x,this.y,this.z)},t.prototype.setElement=function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:console.error("index is out of range: "+t)}return this},t.prototype.getElement=function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:console.error("index is out of range: "+t)}return 0},t.prototype.add=function(t){return"number"==typeof t?(this.x+=t,this.y+=t,this.z+=t):t instanceof Array?(this.x+=t[0],this.y+=t[1],this.z+=t[2]):(this.x+=t.x,this.y+=t.y,this.z+=t.z),this},t.prototype.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},t.prototype.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},t.prototype.subtract=function(t){return"number"==typeof t?(this.x-=t,this.y-=t,this.z-=t):t instanceof Array?(this.x-=t[0],this.y-=t[1],this.z-=t[2]):(this.x-=t.x,this.y-=t.y,this.z-=t.z),this},t.prototype.subtractVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},t.prototype.multiply=function(t){return"number"==typeof t?(this.x*=t,this.y*=t,this.z*=t):t instanceof Array?(this.x*=t[0],this.y*=t[1],this.z*=t[2]):(this.x*=t.x,this.y*=t.y,this.z*=t.z),this},t.prototype.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},t.prototype.divide=function(t){return"number"==typeof t?(this.x/=t,this.y/=t,this.z/=t):t instanceof Array?(this.x/=t[0],this.y/=t[1],this.z/=t[2]):(this.x/=t.x,this.y/=t.y,this.z/=t.z),this},t.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this},t.prototype.sum=function(){return this.x+this.y+this.z},t.prototype.min=function(t){return"number"==typeof t?(this.x=Math.min(this.x,t),this.y=Math.min(this.y,t),this.z=Math.min(this.z,t)):(this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z)),this},t.prototype.max=function(t){return"number"==typeof t?(this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),this.z=Math.max(this.z,t)):(this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z)),this},t.prototype.clamp=function(t,e){return this.max(t).min(e)},t.prototype.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},t.prototype.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},t.prototype.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},t.prototype.abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z},t.prototype.normalize=function(){return this.divide(this.length()||1)},t.prototype.setLength=function(t){return this.normalize().multiply(t)},t.prototype.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},t.prototype.lerpVectors=function(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},t.prototype.cross=function(t){return this.crossVectors(this,t)},t.prototype.crossVectors=function(t,e){var r=t.x,i=t.y,n=t.z,o=e.x,s=e.y,a=e.z;return this.x=i*a-n*s,this.y=n*o-r*a,this.z=r*s-i*o,this},t.prototype.reflect=function(t){return this.subtract(t.clone().multiply(2*this.dot(t)))},t.prototype.distance=function(t){return Math.sqrt(this.distanceSquared(t))},t.prototype.distanceSquared=function(t){var e=this.x-t.x,r=this.y-t.y,i=this.z-t.z;return e*e+r*r+i*i},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},t.prototype.isZero=function(){var t,e=Ct,r=(t=this).x,i=t.y,n=t.z;return Math.abs(r)<=e&&Math.abs(i)<=e&&Math.abs(n)<=e},t.prototype.toArray=function(){return[this.x,this.y,this.z]},t.prototype.toVector2=function(){return new Lt(this.x,this.y)},t.prototype.fill=function(t,e){void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z},t.prototype.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t.prototype.applyEuler=function(t,e){return t.rotateVector3(this,e)},t.prototype.applyQuaternion=function(t,e){return t.rotateVector3(this,e)},t.prototype.applyMatrix=function(t,e){return t.transformPoint(this,e)},t.prototype.applyNormalMatrix=function(t,e){return t.transformNormal(this,e)},t.prototype.applyProjectionMatrix=function(t,e){return t.projectPoint(this,e)},t.fromNumber=function(e){return(new t).setFromNumber(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.X=new t(1,0,0),t.Y=new t(0,1,0),t.Z=new t(0,0,1),t.ONE=new t(1,1,1),t.ZERO=new t(0,0,0),t}(),Pt=function(){function t(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=1),this.x=t,this.y=e,this.z=r,this.w=i}return t.prototype.set=function(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this},t.prototype.setFromEuler=function(t){return t.toQuaternion(this),this},t.prototype.setFromAxisAngle=function(e,r){var i=r/2,n=Math.sin(i),o=t.tempVec0;return o.copyFrom(e).normalize(),this.x=o.x*n,this.y=o.y*n,this.z=o.z*n,this.w=Math.cos(i),this},t.prototype.setFromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},t.prototype.setFromRotationMatrix=function(t){var e=t.elements,r=e[0],i=e[4],n=e[8],o=e[1],s=e[5],a=e[9],u=e[2],c=e[6],l=e[10],h=r+s+l;if(h>0){var f=.5/Math.sqrt(h+1);this.w=.25/f,this.x=(c-a)*f,this.y=(n-u)*f,this.z=(o-i)*f}else r>s&&r>l?(f=2*Math.sqrt(1+r-s-l),this.w=(c-a)/f,this.x=.25*f,this.y=(i+o)/f,this.z=(n+u)/f,this.negate()):s>l?(f=2*Math.sqrt(1+s-r-l),this.w=(n-u)/f,this.x=(i+o)/f,this.y=.25*f,this.z=(a+c)/f,this.negate()):(f=2*Math.sqrt(1+l-r-s),this.w=(o-i)/f,this.x=(n+u)/f,this.y=(a+c)/f,this.z=.25*f,this.negate());return this},t.prototype.setFromUnitVectors=function(t,e){var r=t.dot(e)+1;return r<Number.EPSILON?(r=0,Math.abs(t.x)>Math.abs(t.z)?(this.x=-t.y,this.y=t.x,this.z=0,this.w=r):(this.x=0,this.y=-t.z,this.z=t.y,this.w=r)):(this.x=t.y*e.z-t.z*e.y,this.y=t.z*e.x-t.x*e.z,this.z=t.x*e.y-t.y*e.x,this.w=r),this.normalize()},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.angleTo=function(t){return 2*Math.acos(Math.abs(Ot(this.dot(t),-1,1)))},t.prototype.rotateTowards=function(t,e){var r=this.angleTo(t);if(0===r)return this;var i=Math.min(1,e/r);return this.slerp(t,i),this},t.prototype.identity=function(){return this.set(0,0,0,1)},t.prototype.invert=function(){return this.conjugate()},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.prototype.conjugate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){var t=this.length();return 0===t?(this.x=0,this.y=0,this.z=0,this.w=1):(t=1/t,this.x=this.x*t,this.y=this.y*t,this.z=this.z*t,this.w=this.w*t),this},t.prototype.multiply=function(t){return this.multiplyQuaternions(this,t)},t.prototype.premultiply=function(t){return this.multiplyQuaternions(t,this)},t.prototype.multiplyQuaternions=function(t,e){var r=t.x,i=t.y,n=t.z,o=t.w,s=e.x,a=e.y,u=e.z,c=e.w;return this.x=r*c+o*s+i*u-n*a,this.y=i*c+o*a+n*s-r*u,this.z=n*c+o*u+r*a-i*s,this.w=o*c-r*s-i*a-n*u,this},t.prototype.slerp=function(t,e){var r;if(0===e)return this;if(1===e)return this.copyFrom(t);var i=(r=this).x,n=r.y,o=r.z,s=r.w,a=s*t.w+i*t.x+n*t.y+o*t.z;if(a<0?(this.w=-t.w,this.x=-t.x,this.y=-t.y,this.z=-t.z,a=-a):this.copyFrom(t),a>=1)return this.w=s,this.x=i,this.y=n,this.z=o,this;var u=1-a*a;if(u<=Number.EPSILON){var c=1-e;return this.w=c*s+e*this.w,this.x=c*i+e*this.x,this.y=c*n+e*this.y,this.z=c*o+e*this.z,this.normalize(),this}var l=Math.sqrt(u),h=Math.atan2(l,a),f=Math.sin((1-e)*h)/l,p=Math.sin(e*h)/l;return this.w=s*f+this.w*p,this.x=i*f+this.x*p,this.y=n*f+this.y*p,this.z=o*f+this.z*p,this},t.prototype.slerpQuaternions=function(t,e,r){this.copyFrom(t).slerp(e,r)},t.prototype.rotateVector3=function(t,e){var r,i=(r=this).x,n=r.y,o=r.z,s=r.w,a=t.x,u=t.y,c=t.z,l=s*a+n*c-o*u,h=s*u+o*a-i*c,f=s*c+i*u-n*a,p=-i*a-n*u-o*c,d=null!=e?e:t;return d.x=l*s+p*-i+h*-o-f*-n,d.y=h*s+p*-n+f*-i-l*-o,d.z=f*s+p*-o+l*-n-h*-i,d},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},t.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.toVector4=function(t){return t.set(this.x,this.y,this.z,this.w)},t.prototype.toEuler=function(t){return t.setFromQuaternion(this)},t.prototype.toMatrix4=function(t){return t.compose(It.ZERO,this,It.ONE)},t.fromEuler=function(e){return(new t).setFromEuler(e)},t.fromAxisAngle=function(e,r){return(new t).setFromAxisAngle(e,r)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.fromRotationMatrix=function(e){return(new t).setFromRotationMatrix(e)},t.fromUnitVectors=function(e,r){return(new t).setFromUnitVectors(e,r)},t.tempVec0=new It,t}(),Ft=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s},Vt=function(t,e,r){if(r||2===arguments.length)for(var i,n=0,o=e.length;n<o;n++)!i&&n in e||(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))},Nt=function(){function t(t,e,r,i,n,o,s,a,u,c,l,h,f,p,d,m){void 0===t&&(t=1),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===o&&(o=1),void 0===s&&(s=0),void 0===a&&(a=0),void 0===u&&(u=0),void 0===c&&(c=0),void 0===l&&(l=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),this.elements=[t,e,r,i,n,o,s,a,u,c,l,h,f,p,d,m]}return t.prototype.set=function(t,e,r,i,n,o,s,a,u,c,l,h,f,p,d,m){var v=this.elements;return v[0]=t,v[1]=e,v[2]=r,v[3]=i,v[4]=n,v[5]=o,v[6]=s,v[7]=a,v[8]=u,v[9]=c,v[10]=l,v[11]=h,v[12]=f,v[13]=p,v[14]=d,v[15]=m,this},t.prototype.setFromRowMajorData=function(t,e,r,i,n,o,s,a,u,c,l,h,f,p,d,m){var v=this.elements;return v[0]=t,v[4]=e,v[8]=r,v[12]=i,v[1]=n,v[5]=o,v[9]=s,v[13]=a,v[2]=u,v[6]=c,v[10]=l,v[14]=h,v[3]=f,v[7]=p,v[11]=d,v[15]=m,this},t.prototype.setFromColumnVectors=function(t,e,r,i){return this.set(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,r.x,r.y,r.z,r.w,i.x,i.y,i.z,i.w)},t.prototype.setFromMatrix3=function(t){var e=t.elements;return this.set(e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,0,0,0,1),this},t.prototype.setFromArray=function(t,e){void 0===e&&(e=0);for(var r=0;r<16;r++)this.elements[r]=t[e+r];return this},t.prototype.setFromScale=function(t,e,r){return this.set(t,0,0,0,0,e,0,0,0,0,r,0,0,0,0,1)},t.prototype.setFromTranslation=function(t,e,r){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,t,e,r,1)},t.prototype.setFromRotationX=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(1,0,0,0,0,e,r,0,0,-r,e,0,0,0,0,1)},t.prototype.setFromRotationY=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,0,-r,0,0,1,0,0,r,0,e,0,0,0,0,1)},t.prototype.setFromRotationZ=function(t){var e=Math.cos(t),r=Math.sin(t);return this.set(e,r,0,0,-r,e,0,0,0,0,1,0,0,0,0,1)},t.prototype.setFromRotationAxis=function(e,r){var i=t.tempVec0;i.copyFrom(e).normalize();var n=Math.cos(r),o=Math.sin(r),s=1-n,a=i.x,u=i.y,c=i.z,l=s*a,h=s*u;return this.set(l*a+n,l*u+o*c,l*c-o*u,0,l*u-o*c,h*u+n,h*c+o*a,0,l*c+o*u,h*c-o*a,s*c*c+n,0,0,0,0,1)},t.prototype.setFromEuler=function(t){return t.toMatrix4(this),this},t.prototype.setFromQuaternion=function(t){return this.compose(It.ZERO,t,It.ONE)},t.prototype.setFromShear=function(t,e,r){return this.set(1,t,t,0,e,1,e,0,r,r,1,0,0,0,0,1)},t.prototype.setFromBasis=function(t,e,r){return this.set(t.x,t.y,t.z,0,e.x,e.y,e.z,0,r.x,r.y,r.z,0,0,0,0,1)},t.prototype.setZero=function(){for(var t=0;t<16;t++)this.elements[t]=0;return this},t.prototype.identity=function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.prototype.isIdentity=function(){var t=this.elements;return 1===t[0]&&0===t[4]&&0===t[8]&&0===t[12]&&0===t[1]&&1===t[5]&&0===t[9]&&0===t[13]&&0===t[2]&&0===t[6]&&1===t[10]&&0===t[14]&&0===t[3]&&0===t[7]&&0===t[11]&&1===t[15]},t.prototype.clone=function(){var e=this.elements;return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},t.prototype.copyFrom=function(t){return this.elements=Vt([],Ft(t.elements),!1),this},t.prototype.getColumnVector=function(t,e){return e.set(this.elements[4*t],this.elements[4*t+1],this.elements[4*t+2],this.elements[4*t+3])},t.prototype.lookAt=function(e,r,i){var n=t.tempVec0,o=t.tempVec1,s=t.tempVec2;s.subtractVectors(e,r),s.normalize(),n.crossVectors(i,s),n.normalize(),o.crossVectors(s,n);var a=this.elements;return a[0]=n.x,a[1]=o.x,a[2]=s.x,a[3]=0,a[4]=n.y,a[5]=o.y,a[6]=s.y,a[7]=0,a[8]=n.z,a[9]=o.z,a[10]=s.z,a[11]=0,a[12]=-n.dot(e),a[13]=-o.dot(e),a[14]=-s.dot(e),a[15]=1,this},t.prototype.addScaledMatrix=function(t,e){for(var r=this.elements,i=t.elements,n=0;n<16;n++)r[n]+=i[n]*e;return this},t.prototype.multiply=function(t){if("number"==typeof t){for(var e=0;e<16;e++)this.elements[e]*=t;return this}return this.multiplyMatrices(this,t)},t.prototype.premultiply=function(t){return this.multiplyMatrices(t,this)},t.prototype.multiplyMatrices=function(t,e){var r=t.elements,i=e.elements,n=this.elements,o=r[0],s=r[4],a=r[8],u=r[12],c=r[1],l=r[5],h=r[9],f=r[13],p=r[2],d=r[6],m=r[10],v=r[14],y=r[3],g=r[7],x=r[11],T=r[15],E=i[0],b=i[4],S=i[8],A=i[12],R=i[1],C=i[5],_=i[9],w=i[13],O=i[2],M=i[6],L=i[10],I=i[14],P=i[3],F=i[7],V=i[11],N=i[15];return n[0]=o*E+s*R+a*O+u*P,n[4]=o*b+s*C+a*M+u*F,n[8]=o*S+s*_+a*L+u*V,n[12]=o*A+s*w+a*I+u*N,n[1]=c*E+l*R+h*O+f*P,n[5]=c*b+l*C+h*M+f*F,n[9]=c*S+l*_+h*L+f*V,n[13]=c*A+l*w+h*I+f*N,n[2]=p*E+d*R+m*O+v*P,n[6]=p*b+d*C+m*M+v*F,n[10]=p*S+d*_+m*L+v*V,n[14]=p*A+d*w+m*I+v*N,n[3]=y*E+g*R+x*O+T*P,n[7]=y*b+g*C+x*M+T*F,n[11]=y*S+g*_+x*L+T*V,n[15]=y*A+g*w+x*I+T*N,this},t.prototype.multiplyScalar=function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},t.prototype.determinant=function(){var t=this.elements,e=t[0],r=t[4],i=t[8],n=t[12],o=t[1],s=t[5],a=t[9],u=t[13],c=t[2],l=t[6],h=t[10],f=t[14];return t[3]*(+n*a*l-i*u*l-n*s*h+r*u*h+i*s*f-r*a*f)+t[7]*(+e*a*f-e*u*h+n*o*h-i*o*f+i*u*c-n*a*c)+t[11]*(+e*u*l-e*s*f-n*o*l+r*o*f+n*s*c-r*u*c)+t[15]*(-i*s*c-e*a*l+e*s*h+i*o*l-r*o*h+r*a*c)},t.prototype.transpose=function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},t.prototype.invert=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],n=t[3],o=t[4],s=t[5],a=t[6],u=t[7],c=t[8],l=t[9],h=t[10],f=t[11],p=t[12],d=t[13],m=t[14],v=t[15],y=l*m*u-d*h*u+d*a*f-s*m*f-l*a*v+s*h*v,g=p*h*u-c*m*u-p*a*f+o*m*f+c*a*v-o*h*v,x=c*d*u-p*l*u+p*s*f-o*d*f-c*s*v+o*l*v,T=p*l*a-c*d*a-p*s*h+o*d*h+c*s*m-o*l*m,E=e*y+r*g+i*x+n*T;if(0===E)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);var b=1/E;return t[0]=y*b,t[1]=(d*h*n-l*m*n-d*i*f+r*m*f+l*i*v-r*h*v)*b,t[2]=(s*m*n-d*a*n+d*i*u-r*m*u-s*i*v+r*a*v)*b,t[3]=(l*a*n-s*h*n-l*i*u+r*h*u+s*i*f-r*a*f)*b,t[4]=g*b,t[5]=(c*m*n-p*h*n+p*i*f-e*m*f-c*i*v+e*h*v)*b,t[6]=(p*a*n-o*m*n-p*i*u+e*m*u+o*i*v-e*a*v)*b,t[7]=(o*h*n-c*a*n+c*i*u-e*h*u-o*i*f+e*a*f)*b,t[8]=x*b,t[9]=(p*l*n-c*d*n-p*r*f+e*d*f+c*r*v-e*l*v)*b,t[10]=(o*d*n-p*s*n+p*r*u-e*d*u-o*r*v+e*s*v)*b,t[11]=(c*s*n-o*l*n-c*r*u+e*l*u+o*r*f-e*s*f)*b,t[12]=T*b,t[13]=(c*d*i-p*l*i+p*r*h-e*d*h-c*r*m+e*l*m)*b,t[14]=(p*s*i-o*d*i-p*r*a+e*d*a+o*r*m-e*s*m)*b,t[15]=(o*l*i-c*s*i+c*r*a-e*l*a-o*r*h+e*s*h)*b,this},t.prototype.extractBasis=function(t,e,r){var i=this.elements;return t.set(i[0],i[1],i[2]),e.set(i[4],i[5],i[6]),r.set(i[8],i[9],i[10]),this},t.prototype.compose=function(t,e,r,i){void 0===i&&(i=It.ZERO);var n=this.elements,o=e.x,s=e.y,a=e.z,u=e.w,c=-i.x,l=-i.y,h=-i.z,f=o+o,p=s+s,d=a+a,m=o*f,v=o*p,y=o*d,g=s*p,x=s*d,T=a*d,E=u*f,b=u*p,S=u*d,A=r.x,R=r.y,C=r.z;return n[0]=(1-(g+T))*A,n[1]=(v+S)*A,n[2]=(y-b)*A,n[3]=0,n[4]=(v-S)*R,n[5]=(1-(m+T))*R,n[6]=(x+E)*R,n[7]=0,n[8]=(y+b)*C,n[9]=(x-E)*C,n[10]=(1-(m+g))*C,n[11]=0,n[12]=c*n[0]+l*n[4]+h*n[8]-c+t.x,n[13]=c*n[1]+l*n[5]+h*n[9]-l+t.y,n[14]=c*n[2]+l*n[6]+h*n[10]-h+t.z,this},t.prototype.decompose=function(e,r,i){var n=t.tempVec0,o=this.elements,s=n.set(o[0],o[1],o[2]).length(),a=n.set(o[4],o[5],o[6]).length(),u=n.set(o[8],o[9],o[10]).length();this.determinant()<0&&(s=-s),e.x=o[12],e.y=o[13],e.z=o[14];var c=t.tempMat0;c.copyFrom(this);var l=1/s,h=1/a,f=1/u;return c.elements[0]*=l,c.elements[1]*=l,c.elements[2]*=l,c.elements[4]*=h,c.elements[5]*=h,c.elements[6]*=h,c.elements[8]*=f,c.elements[9]*=f,c.elements[10]*=f,r.setFromRotationMatrix(c),i.x=s,i.y=a,i.z=u,this},t.prototype.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14])},t.prototype.getScale=function(t){var e=this.elements;return t.set(Math.hypot(e[0],e[1],e[2]),Math.hypot(e[4],e[5],e[6]),Math.hypot(e[8],e[9],e[10]))},t.prototype.getTransform=function(){var t=new It,e=new Pt,r=new It;return this.decompose(t,e,r),{translation:t,rotation:e,scale:r}},t.prototype.orthographic=function(t,e,r,i,n,o){var s=1/(e-t),a=1/(r-i),u=1/(o-n),c=-(e+t)*s,l=-(r+i)*a,h=-(o+n)*u;s*=2,a*=2,u*=-2;var f=this.elements;return f[0]=s,f[1]=0,f[2]=0,f[3]=0,f[4]=0,f[5]=a,f[6]=0,f[7]=0,f[8]=0,f[9]=0,f[10]=u,f[11]=0,f[12]=c,f[13]=l,f[14]=h,f[15]=1,this},t.prototype.perspective=function(t,e,r,i,n){var o=1/Math.tan(.5*t),s=1/(r-i),a=this.elements;return a[0]=n?o:o/e,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=n?o*e:o,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(i+r)*s,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*i*r*s,a[15]=0,null!==i&&i!==1/0||(a[10]=-1,a[14]=-2*r),this},t.prototype.projectPoint=function(t,e){var r=t.x,i=t.y,n=t.z,o=this.elements,s=null!=e?e:t;s.x=o[0]*r+o[4]*i+o[8]*n+o[12],s.y=o[1]*r+o[5]*i+o[9]*n+o[13],s.z=o[2]*r+o[6]*i+o[10]*n+o[14];var a=o[3]*r+o[7]*i+o[11]*n+o[15];return s.multiply(1/a)},t.prototype.transformPoint=function(t,e){var r=t.x,i=t.y,n=t.z,o=this.elements,s=null!=e?e:t;return s.x=o[0]*r+o[4]*i+o[8]*n+o[12],s.y=o[1]*r+o[5]*i+o[9]*n+o[13],s.z=o[2]*r+o[6]*i+o[10]*n+o[14],s},t.prototype.transformNormal=function(t,e){var r=t.x,i=t.y,n=t.z,o=this.elements,s=null!=e?e:t;return s.x=o[0]*r+o[4]*i+o[8]*n,s.y=o[1]*r+o[5]*i+o[9]*n,s.z=o[2]*r+o[6]*i+o[10]*n,s.normalize()},t.prototype.transformVector4=function(t,e){var r=t.x,i=t.y,n=t.z,o=t.w,s=this.elements,a=null!=e?e:t;return a.x=s[0]*r+s[4]*i+s[8]*n+s[12]*o,a.y=s[1]*r+s[5]*i+s[9]*n+s[13]*o,a.z=s[2]*r+s[6]*i+s[10]*n+s[14]*o,a.w=s[3]*r+s[7]*i+s[11]*n+s[15]*o,a},t.prototype.equals=function(t){for(var e=this.elements,r=t.elements,i=0;i<16;i++)if(!_t(e[i],r[i]))return!1;return!0},t.prototype.toArray=function(){return Vt([],Ft(this.elements),!1)},t.prototype.fill=function(t,e){void 0===e&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},t.fromIdentity=function(){return new t(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.fromLookAt=function(e,r,i){return(new t).lookAt(e,r,i)},t.fromPerspective=function(e,r,i,n,o){return(new t).perspective(e,r,i,n,o)},t.fromColumnVectors=function(e,r,i,n){return(new t).setFromColumnVectors(e,r,i,n)},t.fromMatrix3=function(e){return(new t).setFromMatrix3(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.fromScale=function(e,r,i){return(new t).setFromScale(e,r,i)},t.fromTranslation=function(e,r,i){return(new t).setFromTranslation(e,r,i)},t.fromRotationX=function(e){return(new t).setFromRotationX(e)},t.fromRotationY=function(e){return(new t).setFromRotationY(e)},t.fromRotationZ=function(e){return(new t).setFromRotationZ(e)},t.fromRotationAxis=function(e,r){return(new t).setFromRotationAxis(e,r)},t.fromEuler=function(e){return(new t).setFromEuler(e)},t.fromQuaternion=function(e){return(new t).setFromQuaternion(e)},t.fromShear=function(e,r,i){return(new t).setFromShear(e,r,i)},t.fromBasis=function(e,r,i){return(new t).setFromBasis(e,r,i)},t.fromRowMajorData=function(e,r,i,n,o,s,a,u,c,l,h,f,p,d,m,v){return new t(e,o,c,p,r,s,l,d,i,a,h,m,n,u,f,v)},t.IDENTITY=new t(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),t.ZERO=new t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),t.tempVec0=new It,t.tempVec1=new It,t.tempVec2=new It,t.tempMat0=new t,t}();!function(t){t[t.XYZ=0]="XYZ",t[t.XZY=1]="XZY",t[t.YXZ=2]="YXZ",t[t.YZX=3]="YZX",t[t.ZXY=4]="ZXY",t[t.ZYX=5]="ZYX"}(Mt||(Mt={}));var Dt,zt,Bt,Ut=function(){function t(e,r,i,n){void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=t.DEFAULT_ORDER),this.x=e,this.y=r,this.z=i,this.order=n}return t.prototype.set=function(t,e,r,i){return void 0===i&&(i=this.order),this.x=t,this.y=e,this.z=r,this.order=i,this},t.prototype.setZero=function(t){return void 0===t&&(t=this.order),this.set(0,0,0,t)},t.prototype.setFromRotationMatrix4=function(t,e){void 0===e&&(e=this.order);var r=t.elements,i=r[0],n=r[4],o=r[8],s=r[1],a=r[5],u=r[9],c=r[2],l=r[6],h=r[10];switch(e){case Mt.XYZ:this.y=Math.asin(Ot(o,-1,1)),Math.abs(o)<.9999999?(this.x=Math.atan2(-u,h),this.z=Math.atan2(-n,i)):(this.x=Math.atan2(l,a),this.z=0);break;case Mt.YXZ:this.x=Math.asin(-Ot(u,-1,1)),Math.abs(u)<.9999999?(this.y=Math.atan2(o,h),this.z=Math.atan2(s,a)):(this.y=Math.atan2(-c,i),this.z=0);break;case Mt.ZXY:this.x=Math.asin(Ot(l,-1,1)),Math.abs(l)<.9999999?(this.y=Math.atan2(-c,h),this.z=Math.atan2(-n,a)):(this.y=0,this.z=Math.atan2(s,i));break;case Mt.ZYX:this.y=Math.asin(-Ot(c,-1,1)),Math.abs(c)<.9999999?(this.x=Math.atan2(l,h),this.z=Math.atan2(s,i)):(this.x=0,this.z=Math.atan2(-n,a));break;case Mt.YZX:this.z=Math.asin(Ot(s,-1,1)),Math.abs(s)<.9999999?(this.x=Math.atan2(-u,a),this.y=Math.atan2(-c,i)):(this.x=0,this.y=Math.atan2(o,h));break;case Mt.XZY:this.z=Math.asin(-Ot(n,-1,1)),Math.abs(n)<.9999999?(this.x=Math.atan2(l,a),this.y=Math.atan2(o,i)):(this.x=Math.atan2(-u,h),this.y=0);break;default:console.error("setFromRotationMatrix: unknown order: "+e)}return this.x*=Rt,this.y*=Rt,this.z*=Rt,this.order=e,this},t.prototype.setFromQuaternion=function(e,r){void 0===r&&(r=this.order);var i=t.tempMat0;return i.setFromQuaternion(e),this.setFromRotationMatrix4(i,r)},t.prototype.setFromVector3=function(t,e){return void 0===e&&(e=this.order),this.set(t.x,t.y,t.z,e)},t.prototype.setFromArray=function(t,e,r){var i,n,o,s;return void 0===e&&(e=0),void 0===r&&(r=this.order),this.x=null!==(i=t[e])&&void 0!==i?i:0,this.y=null!==(n=t[e+1])&&void 0!==n?n:0,this.z=null!==(o=t[e+2])&&void 0!==o?o:0,this.order=null!==(s=t[e+3])&&void 0!==s?s:r,this},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.order)},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.order=t.order,this},t.prototype.add=function(t){return this.order!=t.order?(console.error("add euler with different order"),this):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},t.prototype.addEulers=function(t,e){return t.order!=e.order?(console.error("add euler with different order"),this):(this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.order=t.order,this)},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.prototype.reorder=function(t){var e=new Pt;return e.setFromEuler(this),this.setFromQuaternion(e,t)},t.prototype.rotateVector3=function(e,r){return t.tempQuat0.setFromEuler(this).rotateVector3(e,r)},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.order===this.order},t.prototype.toVector3=function(t){return t.set(this.x,this.y,this.z)},t.prototype.toArray=function(){return[this.x,this.y,this.z]},t.prototype.toQuaternion=function(t){var e,r=(e=this).x,i=e.y,n=e.z,o=e.order,s=Math.cos(r*At*.5),a=Math.cos(i*At*.5),u=Math.cos(n*At*.5),c=Math.sin(r*At*.5),l=Math.sin(i*At*.5),h=Math.sin(n*At*.5);switch(o){case Mt.XYZ:t.set(c*a*u+s*l*h,s*l*u-c*a*h,s*a*h+c*l*u,s*a*u-c*l*h);break;case Mt.YXZ:t.set(c*a*u+s*l*h,s*l*u-c*a*h,s*a*h-c*l*u,s*a*u+c*l*h);break;case Mt.ZXY:t.set(c*a*u-s*l*h,s*l*u+c*a*h,s*a*h+c*l*u,s*a*u-c*l*h);break;case Mt.ZYX:t.set(c*a*u-s*l*h,s*l*u+c*a*h,s*a*h-c*l*u,s*a*u+c*l*h);break;case Mt.YZX:t.set(c*a*u+s*l*h,s*l*u+c*a*h,s*a*h-c*l*u,s*a*u-c*l*h);break;case Mt.XZY:t.set(c*a*u-s*l*h,s*l*u-c*a*h,s*a*h+c*l*u,s*a*u+c*l*h);break;default:console.error("unknown euler order: "+o)}return t},t.prototype.toMatrix4=function(t){var e,r=t.elements,i=(e=this).x,n=e.y,o=e.z,s=e.order,a=Math.cos(i*At),u=Math.sin(i*At),c=Math.cos(n*At),l=Math.sin(n*At),h=Math.cos(o*At),f=Math.sin(o*At);if(s===Mt.XYZ){var p=a*h,d=a*f,m=u*h,v=u*f;r[0]=c*h,r[4]=-c*f,r[8]=l,r[1]=d+m*l,r[5]=p-v*l,r[9]=-u*c,r[2]=v-p*l,r[6]=m+d*l,r[10]=a*c}else if(s===Mt.YXZ){var y=c*h,g=c*f,x=l*h,T=l*f;r[0]=y+T*u,r[4]=x*u-g,r[8]=a*l,r[1]=a*f,r[5]=a*h,r[9]=-u,r[2]=g*u-x,r[6]=T+y*u,r[10]=a*c}else if(s===Mt.ZXY)y=c*h,g=c*f,x=l*h,T=l*f,r[0]=y-T*u,r[4]=-a*f,r[8]=x+g*u,r[1]=g+x*u,r[5]=a*h,r[9]=T-y*u,r[2]=-a*l,r[6]=u,r[10]=a*c;else if(s===Mt.ZYX)p=a*h,d=a*f,m=u*h,v=u*f,r[0]=c*h,r[4]=m*l-d,r[8]=p*l+v,r[1]=c*f,r[5]=v*l+p,r[9]=d*l-m,r[2]=-l,r[6]=u*c,r[10]=a*c;else if(s===Mt.YZX){var E=a*c,b=a*l,S=u*c,A=u*l;r[0]=c*h,r[4]=A-E*f,r[8]=S*f+b,r[1]=f,r[5]=a*h,r[9]=-u*h,r[2]=-l*h,r[6]=b*f+S,r[10]=E-A*f}else s===Mt.XZY?(E=a*c,b=a*l,S=u*c,A=u*l,r[0]=c*h,r[4]=-f,r[8]=l*h,r[1]=E*f+A,r[5]=a*h,r[9]=b*f-S,r[2]=S*f-b,r[6]=u*h,r[10]=A*f+E):console.error("toMatrix4: Invalid order "+s);return r[3]=0,r[7]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,t},t.fromRotationMatrix4=function(e,r){return void 0===r&&(r=t.DEFAULT_ORDER),(new t).setFromRotationMatrix4(e,r)},t.fromQuaternion=function(e,r){return void 0===r&&(r=t.DEFAULT_ORDER),(new t).setFromQuaternion(e,r)},t.fromVector3=function(e,r){return void 0===r&&(r=t.DEFAULT_ORDER),(new t).setFromVector3(e,r)},t.fromArray=function(e,r,i){return void 0===r&&(r=0),void 0===i&&(i=t.DEFAULT_ORDER),(new t).setFromArray(e,r,i)},t.DEFAULT_ORDER=Mt.ZYX,t.tempQuat0=new Pt,t.tempMat0=new Nt,t}(),kt=function(){function t(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.x=t,this.y=e,this.z=r,this.w=i}return t.prototype.set=function(t,e,r,i){return this.x=t,this.y=e,this.z=r,this.w=i,this},t.prototype.setZero=function(){return this.x=0,this.y=0,this.z=0,this.w=0,this},t.prototype.setFromNumber=function(t){return this.x=t,this.y=t,this.z=t,this.w=t,this},t.prototype.setFromArray=function(t,e){var r,i,n,o;return void 0===e&&(e=0),this.x=null!==(r=t[e])&&void 0!==r?r:0,this.y=null!==(i=t[e+1])&&void 0!==i?i:0,this.z=null!==(n=t[e+2])&&void 0!==n?n:0,this.w=null!==(o=t[e+3])&&void 0!==o?o:0,this},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},t.prototype.clone=function(){return new t(this.x,this.y,this.z,this.w)},t.prototype.setElement=function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:console.error("index is out of range: "+t)}return this},t.prototype.getElement=function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:console.error("index is out of range: "+t)}return 0},t.prototype.add=function(t){return"number"==typeof t?(this.x+=t,this.y+=t,this.z+=t,this.w+=t):t instanceof Array?(this.x+=t[0],this.y+=t[1],this.z+=t[2],this.w+=t[3]):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w),this},t.prototype.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},t.prototype.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this},t.prototype.subtract=function(t){return"number"==typeof t?(this.x-=t,this.y-=t,this.z-=t,this.w-=t):t instanceof Array?(this.x-=t[0],this.y-=t[1],this.z-=t[2],this.w-=t[3]):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w),this},t.prototype.subtractVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},t.prototype.multiply=function(t){return"number"==typeof t?(this.x*=t,this.y*=t,this.z*=t,this.w*=t):t instanceof Array?(this.x*=t[0],this.y*=t[1],this.z*=t[2],this.w*=t[3]):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w),this},t.prototype.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this},t.prototype.divide=function(t){return"number"==typeof t?(this.x/=t,this.y/=t,this.z/=t,this.w/=t):t instanceof Array?(this.x/=t[0],this.y/=t[1],this.z/=t[2],this.w/=t[3]):(this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w),this},t.prototype.scale=function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},t.prototype.sum=function(){return this.x+this.y+this.z+this.w},t.prototype.min=function(t){return"number"==typeof t?(this.x=Math.min(this.x,t),this.y=Math.min(this.y,t),this.z=Math.min(this.z,t),this.w=Math.min(this.w,t)):(this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w)),this},t.prototype.max=function(t){return"number"==typeof t?(this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),this.z=Math.max(this.z,t),this.w=Math.max(this.w,t)):(this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w)),this},t.prototype.clamp=function(t,e){return this.max(t).min(e)},t.prototype.floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},t.prototype.ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},t.prototype.round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},t.prototype.abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this.w=Math.abs(this.w),this},t.prototype.negate=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},t.prototype.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},t.prototype.normalize=function(){return this.divide(this.length()||1)},t.prototype.setLength=function(t){return this.normalize().multiply(t)},t.prototype.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this},t.prototype.lerpVectors=function(t,e,r){return this.x=t.x+(e.x-t.x)*r,this.y=t.y+(e.y-t.y)*r,this.z=t.z+(e.z-t.z)*r,this.w=t.w+(e.w-t.w)*r,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},t.prototype.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},t.prototype.isZero=function(){var t,e=Ct,r=(t=this).x,i=t.y,n=t.z,o=t.w;return Math.abs(r)<=e&&Math.abs(i)<=e&&Math.abs(n)<=e&&Math.abs(o)<=e},t.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},t.prototype.toVector3=function(){return new It(this.x,this.y,this.z)},t.prototype.fill=function(t,e){void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w},t.prototype.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this},t.prototype.applyMatrix=function(t,e){return t.transformVector4(this,e)},t.fromNumber=function(e){return(new t).setFromNumber(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.ONE=new t(1,1,1,1),t.ZERO=new t(0,0,0,0),t}(),Gt=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s},Xt=function(t,e,r){if(r||2===arguments.length)for(var i,n=0,o=e.length;n<o;n++)!i&&n in e||(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))},Ht=function(){function t(t,e,r,i,n,o,s,a,u){void 0===t&&(t=1),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===o&&(o=0),void 0===s&&(s=0),void 0===a&&(a=0),void 0===u&&(u=1),this.elements=[t,e,r,i,n,o,s,a,u]}return t.prototype.set=function(t,e,r,i,n,o,s,a,u){var c=this.elements;return c[0]=t,c[3]=i,c[6]=s,c[1]=e,c[4]=n,c[7]=a,c[2]=r,c[5]=o,c[8]=u,this},t.prototype.setFromRowMajorData=function(t,e,r,i,n,o,s,a,u){var c=this.elements;return c[0]=t,c[3]=e,c[6]=r,c[1]=i,c[4]=n,c[7]=o,c[2]=s,c[5]=a,c[8]=u,this},t.prototype.setFromColumnVectors=function(t,e,r){return this.set(t.x,t.y,t.z,e.x,e.y,e.z,r.x,r.y,r.z)},t.prototype.setFromMatrix4=function(t){var e=t.elements;return this.set(e[0],e[1],e[2],e[4],e[5],e[6],e[8],e[9],e[10])},t.prototype.setFromArray=function(t,e){void 0===e&&(e=0);for(var r=0;r<9;r++)this.elements[r]=t[e+r];return this},t.prototype.setFromQuaternion=function(t){var e=t.x,r=t.y,i=t.z,n=t.w,o=e+e,s=r+r,a=i+i,u=e*o,c=e*s,l=e*a,h=r*s,f=r*a,p=i*a,d=n*o,m=n*s,v=n*a,y=this.elements;return y[0]=1-(h+p),y[1]=c+v,y[2]=l-m,y[3]=c-v,y[4]=1-(u+p),y[5]=f+d,y[6]=l+m,y[7]=f-d,y[8]=1-(u+h),this},t.prototype.setZero=function(){for(var t=0;t<9;t++)this.elements[t]=0;return this},t.prototype.identity=function(){return this.set(1,0,0,0,1,0,0,0,1)},t.prototype.clone=function(){var e=this.elements;return new t(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},t.prototype.copyFrom=function(t){return this.elements=Xt([],Gt(t.elements),!1),this},t.prototype.getColumnVector=function(t,e){return e.set(this.elements[3*t],this.elements[3*t+1],this.elements[3*t+2])},t.prototype.scale=function(t,e){var r=this.elements;return r[0]*=t,r[3]*=t,r[6]*=t,r[1]*=e,r[4]*=e,r[7]*=e,this},t.prototype.rotate=function(t){var e=Math.cos(t),r=Math.sin(t),i=this.elements,n=i[0],o=i[3],s=i[6],a=i[1],u=i[4],c=i[7];return i[0]=e*n+r*a,i[3]=e*o+r*u,i[6]=e*s+r*c,i[1]=-r*n+e*a,i[4]=-r*o+e*u,i[7]=-r*s+e*c,this},t.prototype.translate=function(t,e){var r=this.elements;return r[0]+=t*r[2],r[3]+=t*r[5],r[6]+=t*r[8],r[1]+=e*r[2],r[4]+=e*r[5],r[7]+=e*r[8],this},t.prototype.multiply=function(t){if("number"==typeof t){for(var e=0;e<9;e++)this.elements[e]*=t;return this}return this.multiplyMatrices(this,t)},t.prototype.premultiply=function(t){return this.multiplyMatrices(t,this)},t.prototype.multiplyMatrices=function(t,e){var r=t.elements,i=e.elements,n=this.elements,o=r[0],s=r[3],a=r[6],u=r[1],c=r[4],l=r[7],h=r[2],f=r[5],p=r[8],d=i[0],m=i[3],v=i[6],y=i[1],g=i[4],x=i[7],T=i[2],E=i[5],b=i[8];return n[0]=o*d+s*y+a*T,n[3]=o*m+s*g+a*E,n[6]=o*v+s*x+a*b,n[1]=u*d+c*y+l*T,n[4]=u*m+c*g+l*E,n[7]=u*v+c*x+l*b,n[2]=h*d+f*y+p*T,n[5]=h*m+f*g+p*E,n[8]=h*v+f*x+p*b,this},t.prototype.determinant=function(){var t=this.elements,e=t[0],r=t[3],i=t[6],n=t[1],o=t[4],s=t[7],a=t[2],u=t[5],c=t[8];return e*(o*c-u*s)+n*(u*i-r*c)+a*(r*s-o*i)},t.prototype.invert=function(){var t=this.elements,e=t[0],r=t[3],i=t[6],n=t[1],o=t[4],s=t[7],a=t[2],u=t[5],c=t[8],l=c*o-u*s,h=u*i-c*r,f=s*r-o*i,p=e*l+n*h+a*f;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);var d=1/p;return t[0]=l*d,t[1]=(a*s-c*n)*d,t[2]=(u*n-a*o)*d,t[3]=h*d,t[4]=(c*e-a*i)*d,t[5]=(a*r-u*e)*d,t[6]=f*d,t[7]=(n*i-s*e)*d,t[8]=(o*e-n*r)*d,this},t.prototype.transpose=function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},t.prototype.transformPoint=function(t,e){var r=t.x,i=t.y,n=t.z,o=this.elements,s=null!=e?e:t;return s.x=o[0]*r+o[3]*i+o[6]*n,s.y=o[1]*r+o[4]*i+o[7]*n,s.z=o[2]*r+o[5]*i+o[8]*n,s},t.prototype.transformNormal=function(t,e){return this.transformPoint(t,e).normalize()},t.prototype.equals=function(t){for(var e=this.elements,r=t.elements,i=0;i<9;i++)if(!_t(e[i],r[i]))return!1;return!0},t.prototype.toArray=function(){return Xt([],Gt(this.elements),!1)},t.prototype.fill=function(t,e){void 0===e&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},t.fromIdentity=function(){return new t(1,0,0,0,1,0,0,0,1)},t.fromColumnVectors=function(e,r,i){return(new t).setFromColumnVectors(e,r,i)},t.fromMatrix4=function(e){return(new t).setFromMatrix4(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.fromQuaternion=function(e){return(new t).setFromQuaternion(e)},t.fromRowMajorData=function(e,r,i,n,o,s,a,u,c){return new t(e,n,a,r,o,u,i,s,c)},t}(),Yt=function(){function t(t,e){void 0===t&&(t=It.ZERO),void 0===e&&(e=It.X),this.origin=new It,this.direction=new It,this.origin.copyFrom(t),this.direction.copyFrom(e).normalize()}return t.prototype.set=function(t,e){return this.origin.copyFrom(t),this.direction.copyFrom(e).normalize(),this},t.prototype.clone=function(){return new t(this.origin,this.direction)},t.prototype.copyFrom=function(t){return this.set(t.origin,t.direction)},t.prototype.recast=function(e){return this.origin.copyFrom(this.at(e,t.tempVec0)),this},t.prototype.at=function(t,e){var r=e||new It;return r.copyFrom(this.origin),r.addScaledVector(this.direction,t)},t.prototype.equals=function(t){return this.origin.equals(t.origin)&&this.direction.equals(t.direction)},t.prototype.applyMatrix=function(t){return this.origin.applyProjectionMatrix(t),this.direction.applyNormalMatrix(t),this},t.prototype.intersectBox=function(t,e){var r,i,n,o,s,a,u,c,l,h,f=(r=this.origin).x,p=r.y,d=r.z,m=(i=this.direction).x,v=i.y,y=i.z,g=(n=t.min).x,x=n.y,T=n.z,E=(o=t.max).x,b=o.y,S=o.z,A=1/m,R=1/v,C=1/y;if(A>=0?(s=(g-f)*A,a=(E-f)*A):(s=(E-f)*A,a=(g-f)*A),R>=0?(u=(x-p)*R,c=(b-p)*R):(u=(b-p)*R,c=(x-p)*R),!(s>c||u>a||((u>s||s!=s)&&(s=u),(c<a||a!=a)&&(a=c),(u>s||s!=s)&&(s=u),(c<a||a!=a)&&(a=c),C>=0?(l=(T-d)*C,h=(S-d)*C):(l=(S-d)*C,h=(T-d)*C),s>h||l>a||((l>s||s!=s)&&(s=l),(h<a||a!=a)&&(a=h),a<0))))return s>=0?this.at(s,e):this.at(a,e)},t.prototype.intersectPlane=function(t,e){var r=t.normal,i=t.distance,n=r.dot(this.direction);if(0===n)return 0===r.dot(this.origin)+i?(e||new It).copyFrom(this.origin):void 0;var o=-(this.origin.dot(r)+i)/n;return o>=0?this.at(o,e):void 0},t.prototype.intersectSphere=function(e,r){var i=e.center,n=t.tempVec0.subtractVectors(i,this.origin),o=n.dot(this.direction),s=n.dot(n)-o*o,a=e.radius*e.radius;if(!(s>a)){var u=Math.sqrt(a-s),c=o-u,l=o+u;if(!(l<0))return c>=0?this.at(c,r):this.at(l,r)}},t.prototype.intersectTriangle=function(e,r,i){var n,o=e.p0,s=e.p1,a=e.p2,u=t.tempVec0.subtractVectors(s,o),c=t.tempVec1.subtractVectors(a,o),l=t.tempVec2.subtractVectors(this.origin,o),h=t.tempVec3.crossVectors(u,c),f=this.direction.dot(h);if(f>0){if(i)return;n=1}else{if(!(f<0))return;n=-1,f=-f}c.crossVectors(l,c);var p=n*this.direction.dot(c);if(!(p<0)){u.cross(l);var d=n*this.direction.dot(u);if(!(d<0||p+d>f)){var m=-n*l.dot(h);if(!(m<0))return this.at(m/f,r)}}},t.tempVec0=new It,t.tempVec1=new It,t.tempVec2=new It,t.tempVec3=new It,t}(),jt=function(){function t(t,e,r,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===i&&(i=0),this.r=t,this.g=e,this.b=r,this.a=i}return t.prototype.set=function(t,e,r,i){return this.r=t,this.g=e,this.b=r,this.a=i,this},t.prototype.setZero=function(){return this.r=0,this.g=0,this.b=0,this.a=0,this},t.prototype.setFromNumber=function(t){return this.r=t,this.g=t,this.b=t,this.a=t,this},t.prototype.setFromVector4=function(t){return this.r=t.x,this.g=t.y,this.b=t.z,this.a=t.w,this},t.prototype.setFromArray=function(t,e){var r,i,n,o;return void 0===e&&(e=0),this.r=null!==(r=t[e])&&void 0!==r?r:0,this.g=null!==(i=t[e+1])&&void 0!==i?i:0,this.b=null!==(n=t[e+2])&&void 0!==n?n:0,this.a=null!==(o=t[e+3])&&void 0!==o?o:0,this},t.prototype.setFromHSV=function(t,e,r,i){void 0===i&&(i=1);var n=r*e,o=t/60,s=n*(1-Math.abs(o%2-1)),a=0,u=0,c=0;o>=0&&o<=1?(a=n,u=s):o>=1&&o<=2?(a=s,u=n):o>=2&&o<=3?(u=n,c=s):o>=3&&o<=4?(u=s,c=n):o>=4&&o<=5?(a=s,c=n):o>=5&&o<=6&&(a=n,c=s);var l=r-n;return this.set(a+l,u+l,c+l,i)},t.prototype.setFromHexString=function(t){if("#"!==t.substring(0,1)||9!==t.length&&7!==t.length)return this;var e=parseInt(t.substring(1,3),16)/255,r=parseInt(t.substring(3,5),16)/255,i=parseInt(t.substring(5,7),16)/255,n=9===t.length?parseInt(t.substring(7,9),16)/255:1;return this.set(e,r,i,n)},t.prototype.copyFrom=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.clone=function(){return new t(this.r,this.g,this.b,this.a)},t.prototype.setElement=function(t,e){switch(t){case 0:this.r=e;break;case 1:this.g=e;break;case 2:this.b=e;break;case 3:this.a=e;break;default:console.error("index is out of range: "+t)}return this},t.prototype.getElement=function(t){switch(t){case 0:return this.r;case 1:return this.g;case 2:return this.b;case 3:return this.a;default:console.error("index is out of range: "+t)}return 0},t.prototype.add=function(t){return"number"==typeof t?(this.r+=t,this.g+=t,this.b+=t,this.a+=t):t instanceof Array?(this.r+=t[0],this.g+=t[1],this.b+=t[2],this.a+=t[3]):(this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a),this},t.prototype.subtract=function(t){return"number"==typeof t?(this.r-=t,this.g-=t,this.b-=t,this.a-=t):t instanceof Array?(this.r-=t[0],this.g-=t[1],this.b-=t[2],this.a-=t[3]):(this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a),this},t.prototype.multiply=function(t){return"number"==typeof t?(this.r*=t,this.g*=t,this.b*=t,this.a*=t):t instanceof Array?(this.r*=t[0],this.g*=t[1],this.b*=t[2],this.a*=t[3]):(this.r*=t.r,this.g*=t.g,this.b*=t.b,this.a*=t.a),this},t.prototype.divide=function(t){return"number"==typeof t?(this.r/=t,this.g/=t,this.b/=t,this.a/=t):t instanceof Array?(this.r/=t[0],this.g/=t[1],this.b/=t[2],this.a/=t[3]):(this.r/=t.r,this.g/=t.g,this.b/=t.b,this.a/=t.a),this},t.prototype.scale=function(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this},t.prototype.min=function(t){return"number"==typeof t?(this.r=Math.min(this.r,t),this.g=Math.min(this.g,t),this.b=Math.min(this.b,t),this.a=Math.min(this.a,t)):(this.r=Math.min(this.r,t.r),this.g=Math.min(this.g,t.g),this.b=Math.min(this.b,t.b),this.a=Math.min(this.a,t.a)),this},t.prototype.max=function(t){return"number"==typeof t?(this.r=Math.max(this.r,t),this.g=Math.max(this.g,t),this.b=Math.max(this.b,t),this.a=Math.max(this.a,t)):(this.r=Math.max(this.r,t.r),this.g=Math.max(this.g,t.g),this.b=Math.max(this.b,t.b),this.a=Math.max(this.a,t.a)),this},t.prototype.clamp=function(t,e){return this.max(t).min(e)},t.prototype.lerp=function(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this.a+=(t.a-this.a)*e,this},t.prototype.luminance=function(){return.3*this.r+.59*this.g+.11*this.b},t.prototype.equals=function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a},t.prototype.toLinear=function(){return this.r=t.gammaToLinear(this.r),this.g=t.gammaToLinear(this.g),this.b=t.gammaToLinear(this.b),this},t.prototype.toGamma=function(){return this.r=t.linearToGamma(this.r),this.g=t.linearToGamma(this.g),this.b=t.linearToGamma(this.b),this},t.prototype.toArray=function(){return[this.r,this.g,this.b,this.a]},t.prototype.toVector4=function(){return new kt(this.r,this.g,this.b,this.a)},t.prototype.toHSV=function(){var e,r=(e=this).r,i=e.g,n=e.b,o=e.a,s=Math.max(r,i,n),a=Math.min(r,i,n),u=s-a,c=0,l=0;return 0!==s&&(l=u/s),s!=a&&(s==r?(c=(i-n)/u,i<n&&(c+=6)):s==i?c=(n-r)/u+2:s==n&&(c=(r-i)/u+4),c*=60),new t(c,l,s,o)},t.prototype.toHexString=function(e){void 0===e&&(e=!0);var r=t.ToHex(Math.round(255*this.r)),i=t.ToHex(Math.round(255*this.g)),n=t.ToHex(Math.round(255*this.b)),o=t.ToHex(Math.round(255*this.a));return e?"#"+r+i+n+o:"#"+r+i+n},t.prototype.fill=function(t,e){void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t[e+3]=this.a},t.fromNumber=function(e){return(new t).setFromNumber(e)},t.fromArray=function(e,r){return void 0===r&&(r=0),(new t).setFromArray(e,r)},t.fromHexString=function(e){return(new t).setFromHexString(e)},t.fromHSV=function(e,r,i,n){return void 0===n&&(n=1),(new t).setFromHSV(e,r,i,n)},t.gammaToLinear=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},t.linearToGamma=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},t.ToHex=function(t){var e=t.toString(16);return t<=15?("0"+e).toUpperCase():e.toUpperCase()},t.BLACK=new t(0,0,0,1),t.BLUE=new t(0,0,1,1),t.CLEAR=new t(0,0,0,0),t.CYAN=new t(0,1,1,1),t.GRAY=new t(.5,.5,.5,1),t.GREEN=new t(0,1,0,1),t.MAGENTA=new t(1,0,1,1),t.RED=new t(1,0,0,1),t.WHITE=new t(1,1,1,1),t.YELLOW=new t(1,.92,.016,1),t}(),Wt=function(){function t(t,e){void 0===t&&(t=new It(1/0,1/0,1/0)),void 0===e&&(e=new It(-1/0,-1/0,-1/0)),this.min=t.clone(),this.max=e.clone()}return t.prototype.set=function(t,e){return this.min.copyFrom(t),this.max.copyFrom(e),this},t.prototype.setFromArray=function(t){for(var e=Number(1/0),r=Number(1/0),i=Number(1/0),n=-1/0,o=-1/0,s=-1/0,a=0,u=t.length;a<u;a+=3){var c=t[a],l=t[a+1],h=t[a+2];c<e&&(e=c),l<r&&(r=l),h<i&&(i=h),c>n&&(n=c),l>o&&(o=l),h>s&&(s=h)}return this.min.set(e,r,i),this.max.set(n,o,s),this},t.prototype.setFromPoints=function(t){this.makeEmpty();for(var e=0,r=t.length;e<r;e++)this.expandByPoint(t[e]);return this},t.prototype.setFromCenterAndSize=function(t,e){var r=e.clone().multiply(.5);return this.min.copyFrom(t).subtract(r),this.max.copyFrom(t).add(r),this},t.prototype.setFromObject=function(t){return this.makeEmpty(),this.expandByObject(t)},t.prototype.clone=function(){return(new t).copyFrom(this)},t.prototype.copyFrom=function(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this},t.prototype.makeEmpty=function(){return this.min.x=this.min.y=this.min.z=Number(1/0),this.max.x=this.max.y=this.max.z=-1/0,this},t.prototype.isEmpty=function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},t.prototype.getCenter=function(t){return void 0===t&&(t=new It),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiply(.5)},t.prototype.getSize=function(t){return void 0===t&&(t=new It),this.isEmpty()?t.set(0,0,0):t.subtractVectors(this.max,this.min)},t.prototype.expandByPoint=function(t){return this.min.min(t),this.max.max(t),this},t.prototype.expandByVector=function(t){return this.min.subtract(t),this.max.add(t),this},t.prototype.expandByScalar=function(t){return this.min.add(-t),this.max.add(t),this},t.prototype.expandByBox=function(t){return this.min.min(t.min),this.max.max(t.max),this},t.prototype.expandByObject=function(e){e.updateWorldMatrix(!1,!1);var r=e.geometry;if(void 0!==r){null===r.boundingBox&&r.computeBoundingBox();var i=new t;i.copyFrom(r.boundingBox),i.applyMatrix4(e.matrixWorld),this.union(i)}for(var n=e.children,o=0,s=n.length;o<s;o++)this.expandByObject(n[o]);return this},t.prototype.containsPoint=function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)},t.prototype.containsBox=function(t){return this.min.x<=t.min.x&&this.max.x>=t.max.x&&this.min.y<=t.min.y&&this.max.y>=t.max.y&&this.min.z<=t.min.z&&this.max.z>=t.max.z},t.prototype.getParameter=function(t,e){return void 0===e&&(e=new It),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},t.prototype.intersectsBox=function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)},t.prototype.intersectsSphere=function(t){var e=new It;return this.clampPoint(t.center,e),e.distanceSquared(t.center)<=t.radius*t.radius},t.prototype.clampPoint=function(t,e){return void 0===e&&(e=new It),e.copyFrom(t).clamp(this.min,this.max)},t.prototype.distanceToPoint=function(t){return t.clone().clamp(this.min,this.max).subtract(t).length()},t.prototype.intersect=function(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this},t.prototype.union=function(t){return this.min.min(t.min),this.max.max(t.max),this},t.prototype.applyMatrix4=function(t,e){if(void 0===e&&(e=new It),this.isEmpty())return this;var r=this.getOBBPoints(t,e);return this.setFromPoints(r),this},t.prototype.getOBBPoints=function(t,e){if(void 0===e&&(e=new It),this.isEmpty())return[];var r=[];return r[0]=new It(this.min.x,this.min.y,this.min.z),r[1]=new It(this.min.x,this.min.y,this.max.z),r[2]=new It(this.min.x,this.max.y,this.min.z),r[3]=new It(this.min.x,this.max.y,this.max.z),r[4]=new It(this.max.x,this.min.y,this.min.z),r[5]=new It(this.max.x,this.min.y,this.max.z),r[6]=new It(this.max.x,this.max.y,this.min.z),r[7]=new It(this.max.x,this.max.y,this.max.z),r.forEach((function(r){r.subtract(e),r.applyMatrix(t),r.add(e)})),r},t.prototype.getBoundingSphere=function(t){this.getCenter(t.center);var e=new It;return t.radius=.5*this.getSize(e).length(),t},t.prototype.translate=function(t){return this.min.add(t),this.max.add(t),this},t.prototype.equals=function(t){return t.min.equals(this.min)&&t.max.equals(this.max)},t}(),Zt=function(){function t(t,e){void 0===t&&(t=It.ZERO),void 0===e&&(e=-1),this.center=t.clone(),this.radius=e}return t.prototype.set=function(t,e){return this.center.copyFrom(t),this.radius=e,this},t.prototype.setFromPoints=function(t,e){var r=this.center;if(void 0!==e){r.copyFrom(e);for(var i=0,n=0;n<t.length;n++)i=Math.max(i,r.distanceSquared(t[n]));this.radius=Math.sqrt(i)}else{var o=(new Wt).setFromPoints(t);o.getCenter(r),this.radius=o.getSize().length()/2}return this},t.prototype.copyFrom=function(t){return this.center.copyFrom(t.center),this.radius=t.radius,this},t.prototype.isEmpty=function(){return this.radius<0},t.prototype.makeEmpty=function(){return this.center.set(0,0,0),this.radius=-1,this},t.prototype.containsPoint=function(t){return t.distanceSquared(this.center)<=this.radius*this.radius},t.prototype.distanceToPoint=function(t){return t.distance(this.center)-this.radius},t.prototype.intersectsSphere=function(t){var e=this.radius+t.radius;return t.center.distanceSquared(this.center)<=e*e},t.prototype.intersectsBox=function(t){return t.intersectsSphere(this)},t.prototype.clampPoint=function(t,e){var r=this.center.distanceSquared(t);return void 0===e&&(e=new It),e.copyFrom(t),r>this.radius*this.radius&&(e.subtract(this.center).normalize(),e.multiply(this.radius).add(this.center)),e},t.prototype.getBoundingBox=function(t){return void 0===t&&(t=new Wt),this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)},t.prototype.applyMatrix4=function(t){var e=t.elements,r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10],o=Math.sqrt(Math.max(r,i,n));return this.center.applyMatrix(t),this.radius=this.radius*o,this},t.prototype.translate=function(t){return this.center.add(t),this},t.prototype.expandByPoint=function(t){var e=(new It).subtractVectors(t,this.center),r=e.lengthSquared();if(r>this.radius*this.radius){var i=Math.sqrt(r),n=.5*(i-this.radius);this.center.add(e.multiply(n/i)),this.radius+=n}return this},t.prototype.union=function(t){var e=new It,r=new It;return r.subtractVectors(t.center,this.center).normalize().multiply(t.radius),this.expandByPoint(e.copyFrom(t.center).add(r)),this.expandByPoint(e.copyFrom(t.center).subtract(r)),this},t.prototype.intersect=function(t){var e=(new It).subtractVectors(this.center,t.center),r=e.length();return r>this.radius+t.radius?this.makeEmpty():(this.center=this.center.add(e.normalize().multiply(r/2)),this.radius=this.radius+t.radius-r,this)},t.prototype.equals=function(t){return t.center.equals(this.center)&&t.radius===this.radius},t.prototype.clone=function(){return(new t).copyFrom(this)},t}(),qt=Object.freeze({__proto__:null,get EulerOrder(){return Mt},Euler:Ut,Quaternion:Pt,Vector2:Lt,Vector3:It,Vector4:kt,Matrix3:Ht,Matrix4:Nt,Ray:Yt,PI2:St,DEG2RAD:At,RAD2DEG:Rt,NumberEpsilon:Ct,isZero:function(t){return isNaN(t)||Math.abs(t)<Ct},isEqual:_t,damp:function(t,e,r,i){return wt(t,e,1-Math.exp(-r*i))},lerp:wt,degToRad:function(t){return t*At},radToDeg:function(t){return t*Rt},clamp:Ot,Color:jt,Box3:Wt,Sphere:Zt}),Kt=(Dt=new Float32Array(1),zt=new Int32Array(Dt.buffer),function(t){Dt[0]=t;var e=zt[0],r=e>>16&32768,i=e>>12&2047,n=e>>23&255;return n<103?r:n>142?(r|=31744,r|=(255==n?0:1)&&8388607&e):n<113?r|=((i|=2048)>>114-n)+(i>>113-n&1):(r|=n-112<<10|i>>1,r+=1&i)}),Qt=function(){function t(t){if(Number.isInteger(t))this.data=new Uint16Array(t);else if(t&&"object"==typeof t&&Number.isInteger(t.length))for(var e=this.data=new Uint16Array(t.length),r=0;r<e.length;r++)e[r]=Kt(t[r])}return t.prototype.set=function(t,e){for(var r=0;r<t.length;r++)this.data[r+e]=Kt(t[r])},t}(),Jt=new Ut,$t=new Nt;function te(t,e,r,i,n,o,s){var a=t,u=i/n,c=i,l=e.speedOverLifetime;l&&(c=l.getIntegrateValue(0,i,n));var h=e.gravityModifier?e.gravityModifier.getIntegrateByTime(0,i):0;a.copyFrom(o),a.addScaledVector(s,c),a.addScaledVector(r,h);var f=e.linearVelOverLifetime||{},p=e.orbitalVelOverLifetime||{},d=["x","y","z"];if(p.enabled){var m=new It;p.center&&m.setFromArray(p.center);var v=a.clone().subtract(m),y=p.asRotation,g=d.map((function(t){var e=p[t];return e?y?e.getValue(u):e.getIntegrateValue(0,i,n):0}));Jt.setFromArray(g).negate(),$t.setFromEuler(Jt);var x=$t.transformPoint(v);a.addVectors(m,x)}if(f.enabled)for(var T=f.asMovement,E=0;E<3;E++){var b=f[d[E]];if(b){var S=T?b.getValue(u):b.getIntegrateValue(0,i,n);a.setElement(E,a.getElement(E)+S)}}return a}function ee(t){return Array.isArray(t)?[t[0],t[1],t[2]]:[0,0,0]}function re(t,e){for(var r=0,i=t.length;r<i;r++)t[r]=e;return t}function ie(t,e,r,i){void 0===i&&(i=0);for(var n=0;n<r;n++)t[n]=e[n+i];return t}function ne(t,e){1===arguments.length&&(e=t,t=[]);var r=e,i=Math.hypot.apply(Math,u([],a(r),!1));if(0===i)return ie(t,r,r.length);for(var n=0;n<r.length;n++)t[n]=r[n]/i;return t}function oe(t,e,r){if(e&&r)for(var i=0,n=e.length;i<n;i++)t[i]=e[i]*r[i];else if(e){if(t!==e)for(i=0;i<e.length;i++)t[i]=e[i]}else if(r&&t!==r)for(i=0;i<r.length;i++)t[i]=r[i];return t}var se=((Bt={})[L.PARTICLE_ORIGIN_CENTER]=[0,0],Bt[L.PARTICLE_ORIGIN_CENTER_BOTTOM]=[0,-.5],Bt[L.PARTICLE_ORIGIN_CENTER_TOP]=[0,.5],Bt[L.PARTICLE_ORIGIN_LEFT_TOP]=[-.5,.5],Bt[L.PARTICLE_ORIGIN_LEFT_CENTER]=[-.5,0],Bt[L.PARTICLE_ORIGIN_LEFT_BOTTOM]=[-.5,-.5],Bt[L.PARTICLE_ORIGIN_RIGHT_CENTER]=[.5,0],Bt[L.PARTICLE_ORIGIN_RIGHT_BOTTOM]=[.5,-.5],Bt[L.PARTICLE_ORIGIN_RIGHT_TOP]=[.5,.5],Bt);function ae(t,e){return t?[t[0]-.5,.5-t[1]]:e?se[e]:[0,0]}function ue(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))}function ce(t,e,r){var i=r.position,n=new It(t,e,0),o=new It;return r.getInverseViewProjectionMatrix().projectPoint(n,o),o.subtract(i),new Yt(i,o)}function le(t,e,r){var i=t.x,n=t.y,o=t.z,s=new It(i-e,n+r,o),a=new It(i-e,n-r,o),u=new It(i+e,n-r,o),c=new It(i+e,n+r,o);return[{p0:s,p1:a,p2:u},{p0:s.clone(),p1:u.clone(),p2:c}]}function he(t,e,r){return void 0===r&&(r=1e-6),Math.abs(t-e)<r}function fe(t,e){void 0===e&&(e=2);var r=Math.pow(10,e);return Math.floor(t*r)/r}var pe={getPointInCurve:function(t){var e=a(t,2);e[0];var r=e[1],i=this.getPointIndexInCurve(t),n=i.xIndex,o=i.yIndex,s=r[n],u=r[o];return new Lt(s,u)},getPointIndexInCurve:function(t){var e=a(t,3),r=e[0],i=e[2],n=r===N.LINE||r===N.EASE_OUT?0:r===N.EASE_IN||r===N.EASE||r===N.HOLD&&i===N.EASE_IN?2:0;return{xIndex:n,yIndex:n+1}},isLeftSideEase:function(t){var e=a(t,3),r=e[0];e[1];var i=e[2];return!(r!==N.HOLD||!this.isKeyframeTypeLeftSideEase(i))||this.isKeyframeTypeLeftSideEase(r)},isRightSideEase:function(t){var e=a(t,3),r=e[0];e[1];var i=e[2];return!(r!==N.HOLD||!this.isKeyframeTypeRightSideEase(i))||this.isKeyframeTypeRightSideEase(r)},isKeyframeTypeLeftSideEase:function(t){return[N.EASE,N.EASE_IN,N.AUTO].includes(t)},isKeyframeTypeRightSideEase:function(t){return[N.EASE,N.EASE_OUT,N.AUTO].includes(t)},isHoldInKeyframe:function(t){var e=a(t,3),r=e[0];e[1];var i=e[2];return r===N.HOLD&&[N.HOLD,N.LINE_OUT,N.EASE_OUT].includes(i)},isHoldOutKeyframe:function(t){var e=a(t,3),r=e[0];e[1];var i=e[2];return r===N.HOLD&&[N.HOLD,N.LINE,N.EASE_IN].includes(i)}},de=function(t,e){this.points=t,this.totalLength=e},me={},ve={},ye=.1;function ge(t,e){return 1-3*e+3*t}function xe(t,e){return 3*e-6*t}function Te(t){return 3*t}function Ee(t,e,r){return((ge(e,r)*t+xe(e,r))*t+Te(e))*t}function be(t,e,r){return 3*ge(e,r)*t*t+2*xe(e,r)*t+Te(e)}var Se,Ae=function(){function t(t,e,r,i){this.p1=t,this.p2=e,this.p3=r,this.p4=i,this.catching={lastPoint:0,lastAddedLength:0};var n=function(t,e,r,i){var n=fe(e.x-t.x,3)+"_"+fe(e.y-t.y,3)+"_"+fe(e.z-t.z,3)+"&"+fe(r.x-t.x,3)+"_"+fe(r.y-t.y,3)+"_"+fe(r.z-t.z,3)+"&"+fe(i.x-t.x,3)+"_"+fe(i.y-t.y,3)+"_"+fe(i.z-t.z,3);if(ve[n])return{data:ve[n],interval:t};for(var o=[],s=null,a=0,u=0,c=0;c<300;c+=1){var l=new It,h=c/299;u=0,l.x=3*Math.pow(1-h,2)*h*(r.x-t.x)+3*(1-h)*Math.pow(h,2)*(i.x-t.x)+Math.pow(h,3)*(e.x-t.x),l.y=3*Math.pow(1-h,2)*h*(r.y-t.y)+3*(1-h)*Math.pow(h,2)*(i.y-t.y)+Math.pow(h,3)*(e.y-t.y),l.z=3*Math.pow(1-h,2)*h*(r.z-t.z)+3*(1-h)*Math.pow(h,2)*(i.z-t.z)+Math.pow(h,3)*(e.z-t.z),null!==s&&(u+=Math.pow(l.x-s.x,2),u+=Math.pow(l.y-s.y,2),u+=Math.pow(l.z-s.z,2)),s=l,a+=u=Math.sqrt(u),o[c]={partialLength:u,point:l}}var f=new de(o,a);return ve[n]=f,{data:f,interval:new It(t.x,t.y,t.z)}}(t,e,r,i),o=n.data,s=n.interval;this.lengthData=o,this.interval=s,this.totalLength=o.totalLength}return t.prototype.getPointInPercent=function(t){var e=this.lengthData;if(0===t)return e.points[0].point.clone().add(this.interval);if(he(1-t,0))return e.points[299].point.clone().add(this.interval);if(he(e.totalLength,0))return this.p1.clone();var r=new It,i=fe(e.totalLength*t,4),n=this.catching.lastAddedLength,o=this.catching.lastPoint;if(he(n,i))return e.points[o].point.clone().add(this.interval);var s=!0,a=1;for(i<n&&(a=-1);s;){if(i>=n){if(299===o){r.x=e.points[o].point.x,r.y=e.points[o].point.y,r.z=e.points[o].point.z;break}if(i<n+e.points[o+1].partialLength){var u=(i-n)/e.points[o+1].partialLength;r.x=e.points[o].point.x+(e.points[o+1].point.x-e.points[o].point.x)*u,r.y=e.points[o].point.y+(e.points[o+1].point.y-e.points[o].point.y)*u,r.z=e.points[o].point.z+(e.points[o+1].point.z-e.points[o].point.z)*u;break}}a>0&&o<299?(o+=a,n+=fe(e.points[o].partialLength,5)):a<0&&o>0?(n-=fe(e.points[o].partialLength,5),o+=a):s=!1}return this.catching.lastPoint=o,this.catching.lastAddedLength=n,r.add(this.interval),r},t}(),Re=function(){function t(t,e,r,i){this.mX1=t,this.mY1=e,this.mX2=r,this.mY2=i,this.precomputed=!1,this.mSampleValues=new Array(11)}return t.prototype.precompute=function(){this.precomputed=!0,this.mX1===this.mY1&&this.mX2===this.mY2||this.calcSampleValues()},t.prototype.getValue=function(t){return this.mX1===this.mY1&&this.mX2===this.mY2?t:isNaN(this.mY1)||isNaN(this.mY2)?0:0===t||1===t?t:(this.precomputed||this.precompute(),Ee(this.getTForX(t),this.mY1,this.mY2))},t.prototype.calcSampleValues=function(){for(var t=0;t<11;++t)this.mSampleValues[t]=Ee(t*ye,this.mX1,this.mX2)},t.prototype.getTForX=function(t){for(var e=this.mSampleValues,r=0,i=1;10!==i&&e[i]<=t;++i)r+=ye;var n=r+(t-e[--i])/(e[i+1]-e[i])*ye,o=be(n,this.mX1,this.mX2);return o>=.001?function(t,e,r,i){for(var n=0;n<4;++n){var o=be(e,r,i);if(0===o)return e;e-=(Ee(e,r,i)-t)/o}return e}(t,n,this.mX1,this.mX2):0===o?n:function(t,e,r,i,n){var o,s,a=0;do{(o=Ee(s=e+(r-e)/2,i,n)-t)>0?r=s:e=s}while(Math.abs(o)>1e-7&&++a<10);return s}(t,r,r+ye,this.mX1,this.mX2)},t}();function Ce(t,e){var r=function(t,e,r){var i=a(t,2),n=i[1],o=pe.isHoldOutKeyframe(t),s=pe.isHoldInKeyframe(e),u=!s&&pe.isRightSideEase(t),c=!o&&pe.isLeftSideEase(e);if(u&&!c&&!s){var l=new Lt(n[n.length-4],n[n.length-3]),h=new Lt(n[n.length-2],n[n.length-1]),f=pe.getPointInCurve(e),p=new Lt(f.x,f.y);return{type:"ease",p0:l,p1:h,p2:y=new Lt(p.x-(p.x-l.x)/10,p.y),p3:p}}if(!u&&c&&!o){var d=a(e,2)[1],m=pe.getPointInCurve(t),v=new Lt(m.x,m.y),y=new Lt(d[0],d[1]);return p=new Lt(d[2],d[3]),{type:"ease",p0:v,p1:new Lt(v.x+(p.x-v.x)/10,v.y),p2:y,p3:p}}if(u&&c)return d=a(e,2)[1],{type:"ease",p0:new Lt(n[n.length-4],n[n.length-3]),p1:new Lt(n[n.length-2],n[n.length-1]),p2:y=new Lt(d[0],d[1]),p3:p=new Lt(d[2],d[3])};var g=pe.getPointInCurve(t),x=pe.getPointInCurve(e);return o?x.y=g.y:s&&(g.y=x.y),r?{type:"ease",p0:g,p1:y=new Lt((x.x-g.x)/3+g.x,(x.y-g.y)/3+g.y),p2:p=new Lt((x.x-g.x)/3*2+g.x,(x.y-g.y)/3*2+g.y),p3:x,isHold:o||s,leftHoldLine:o,rightHoldLine:s}:{type:"line",p0:g,p1:x,isHold:o||s,leftHoldLine:o,rightHoldLine:s}}(t,e,!0),i=r.p0,n=r.p1,o=r.p2,s=r.p3;Tt(o),Tt(s);var u,c,l=s.x-i.x,h=s.y-i.y,f=fe((n.x-i.x)/l,5),p=fe((o.x-i.x)/l,5);he(h,0)?u=c=NaN:(u=fe((n.y-i.y)/h,5),c=fe((o.y-i.y)/h,5)),f<0&&(console.error("invalid bezier points, x1 < 0",i,n,o,s),f=0),p<0&&(console.error("invalid bezier points, x2 < 0",i,n,o,s),p=0),f>1&&(console.error("invalid bezier points, x1 >= 1",i,n,o,s),f=1),p>1&&(console.error("invalid bezier points, x2 >= 1",i,n,o,s),p=1);var d,m=("bez_"+f+"_"+u+"_"+p+"_"+c).replace(/\./g,"p");return me[m]?d=me[m]:(d=new Re(f,u,p,c),me[m]=d),{points:[i,n,o,s],timeInterval:l,valueInterval:h,curve:d}}var _e="not_implement",we=function(){function t(t){this.onCreate(t)}return t.getAllData=function(t,e){for(var r=new(e?Qt:Float32Array)(4*t.index),i=0,n=0,o=t.curves;i<o.length;i++){var s=o[i].toData();r.set(s,n),n+=s.length}return e?r.data:r},t.prototype.onCreate=function(t){throw Error(_e)},t.prototype.getIntegrateValue=function(t,e,r){throw Error(_e)},t.prototype.getIntegrateByTime=function(t,e){throw Error(_e)},t.prototype.getValue=function(t){throw Error(_e)},t.prototype.toUniform=function(t){throw Error(_e)},t.prototype.map=function(t){throw Error(_e)},t.prototype.scaleXCoord=function(t){return this},t.prototype.toData=function(){throw Error(_e)},t}(),Oe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.value=t},e.prototype.getIntegrateValue=function(t,e,r){return this.value*(e-t)},e.prototype.getIntegrateByTime=function(t,e){return.5*this.value*(e*e-t*t)},e.prototype.getValue=function(t){return this.value},e.prototype.toUniform=function(){return new Float32Array([0,this.value,0,0])},e.prototype.map=function(t){var e=this.value;return this.value=t(e),this},e}(we),Me=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.items=t},e.prototype.getValue=function(t){var e=this.items;return e[Math.floor(Math.random()*e.length)]},e.prototype.map=function(t){return this.items=this.items.map(t),this},e}(we),Le=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.min=t[0],this.max=t[1]},e.prototype.getValue=function(t){return nr(this.min,this.max)},e.prototype.toUniform=function(){return new Float32Array([4,this.min,this.max,0])},e.prototype.map=function(t){return this.min=t(this.min),this.max=t(this.max),this},e}(we),Ie=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.min=t[0],this.max=t[1]},e.prototype.getValue=function(t){for(var e=this.min,r=this.max,i=[],n=0;n<e.length;n++){var o=Math.random();i[n]=e[n]*(1-o)+r[n]*o}return i},e.prototype.map=function(t){return this.min=this.min.map(t),this.max=this.max.map(t),this},e}(we),Pe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.min=t[0],this.max=t[1],this.xCoord=1},e.prototype.getValue=function(t){return t/=this.xCoord,this.min*(1-t)+this.max*t},e.prototype.toUniform=function(){return new Float32Array([1,this.min,this.max,this.xCoord])},e.prototype.getIntegrateValue=function(t,e,r){void 0===r&&(r=1);var i=this.min,n=this.max,o=this.xCoord*r;return((i+e/o*(n-i)+i)*e-(i+t/o*(n-i)+i)*t)/2},e.prototype.getIntegrateByTime=function(t,e){return ke(e,0,this.xCoord,this.min,this.max)-ke(t,0,this.xCoord,this.min,this.max)},e.prototype.map=function(t){return this.min=t(this.min),this.max=t(this.max),this},e.prototype.scaleXCoord=function(t){return this.xCoord=t,this},e}(we),Fe=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.stops=ut(t)},e.prototype.getStops=function(){return this.stops},e.prototype.getValue=function(t){for(var e=this.stops,r=e.length-1,i=0;i<r;i++){var n=e[i],o=e[i+1];if(n.stop<=t&&o.stop>t){var s=(t-n.stop)/(o.stop-n.stop);return ct(n.color,o.color,s,!0)}}return e[r].color.slice()},e}(we),Ve=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){this.keys=t.map((function(t){return t.slice?t.slice(0,2):[t.time,t.value]})).sort((function(t,e){return t[0]-e[0]}));var e=this.keys[this.keys.length-1];e[0]<1&&this.keys.push([1,e[1]]);var r=this.keys[0];r[0]>0&&this.keys.unshift([0,r[1]]),this.isLineSeg=!0},e.prototype.getValue=function(t){var e=this.keys;if(t<e[0][0])return e[0][1];for(var r=e.length-1,i=0;i<r;i++){var n=e[i],o=e[i+1],s=n[0],a=o[0];if(t>=s&&t<=a){var u=(t-s)/(a-s),c=n[1];return c+u*(o[1]-c)}}return e[r][1]},e.prototype.getIntegrateValue=function(t,e,r){return void 0===r&&(r=1),(this.integrate(e,!1)-this.integrate(t,!1))*r},e.prototype.getIntegrateByTime=function(t,e){return this.integrate(e,!0)-this.integrate(t,!0)},e.prototype.integrate=function(t,e){var r=this.keys;if(t<=r[0][0])return 0;for(var i=0,n=r.length-1,o=e?ke:Ue,s=0;s<n;s++){var a=r[s],u=r[s+1],c=a[0],l=u[0];if(t>c&&t<=l)return i+o(t,c,l,a[1],u[1]);i+=o(l,c,l,a[1],u[1])}return i},e.prototype.toData=function(){for(var t=this.keys,e=new Float32Array(4*Math.ceil(t.length/2)),r=0,i=0;r<t.length;r++,i+=2)e.set(t[r],i);return e.set(t[t.length-1],e.length-2),e},e.prototype.toUniform=function(t){var e=t.index,r=this.keys,i=Math.ceil(r.length/2);return t.lineSegCount+=i,t.curves.push(this),t.index+=i,t.max=Math.max(t.max,i),new Float32Array([3,e,i,0])},e.prototype.map=function(t){return this.keys.forEach((function(e){return e[1]=t(e[1])})),this},e.prototype.scaleXCoord=function(t){return this.keys.forEach((function(e){return e[0]=t*e[0]})),this},e}(we),Ne=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){var e=t;this.curveMap={},this.keys=[];for(var r=0;r<e.length-1;r++){var i=Ce(e[r],e[r+1]),n=i.points,o=i.curve,s=i.timeInterval,c=i.valueInterval,l=n[0],h=n[n.length-1];this.keys.push(u(u([],a(l.toArray()),!1),a(n[1].toArray()),!1)),this.keys.push(u(u([],a(h.toArray()),!1),a(n[2].toArray()),!1)),this.curveMap["".concat(l.x,"&").concat(h.x)]={points:n,timeInterval:s,valueInterval:c,curve:o}}},e.prototype.getValue=function(t){var e=0,r=Object.keys(this.curveMap),i=Number(r[0].split("&")[0]),n=Number(r[r.length-1].split("&")[1]);if(t<=i)return this.getCurveValue(r[0],i);if(t>=n)return this.getCurveValue(r[r.length-1],n);for(var o=0;o<r.length;o++){var s=a(r[o].split("&"),2),u=s[0],c=s[1];if(t>=Number(u)&&t<Number(c)){e=this.getCurveValue(r[o],t);break}}return e},e.prototype.getIntegrateValue=function(t,e,r){void 0===r&&(r=1);var i=(e-t)/r,n=0,o=Object.keys(this.curveMap);if(i<=Number(o[0].split("&")[0]))return 0;for(var s=0;s<o.length;s++){var u=a(o[s].split("&"),2),c=u[0],l=u[1];if(i>=Number(l)&&(n+=r*this.getCurveIntegrateValue(o[s],Number(l))),i>=Number(c)&&i<Number(l)){n+=r*this.getCurveIntegrateValue(o[s],i);break}}return n},e.prototype.getIntegrateByTime=function(t,e){return this.getIntegrateValue(0,e)-this.getIntegrateValue(0,t)},e.prototype.getCurveIntegrateValue=function(t,e){for(var r=this.curveMap[t],i=a(r.points,1)[0],n=r.timeInterval,o=r.valueInterval,s=0,u=(e-i.x)/20,c=0;c<=20;c++){var l=c*u/n,h=i.y+o*r.curve.getValue(l);s+=0===c||20===c?h:c%2==1?4*h:2*h}return s*(u/3)},e.prototype.getCurveValue=function(t,e){var r=this.curveMap[t],i=a(r.points,1)[0],n=r.timeInterval,o=r.valueInterval,s=(e-i.x)/n,u=r.curve.getValue(s);return i.y+o*u},e.prototype.toUniform=function(t){var e=t.index,r=this.keys.length;return t.curves.push(this),t.index=e+r,t.max=Math.max(t.max,r),t.curveCount+=r,new Float32Array([5,e+1/r,e,r])},e.prototype.toData=function(){for(var t=this.keys,e=new Float32Array(4*t.length),r=0,i=0;r<t.length;r++,i+=4)e.set(t[r],i);return e},e}(we),De=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.onCreate=function(t){var e=a(t,3),r=e[0],i=e[1],n=e[2];if(this.curveSegments={},n.length)for(var o=0;o<r.length-1;o++){var s=r[o],u=r[o+1],c=new It(i[o][0],i[o][1],i[o][2]),l=new It(i[o+1][0],i[o+1][1],i[o+1][2]),h=new It(n[2*o][0],n[2*o][1],n[2*o][2]),f=new It(n[2*o+1][0],n[2*o+1][1],n[2*o+1][2]),p=Ce(s,u),d=p.points,m=p.curve,v=p.timeInterval,y=p.valueInterval,g=d[0],x=d[d.length-1],T=new Ae(c,l,h,f);this.curveSegments["".concat(g.x,"&").concat(x.x)]={points:d,timeInterval:v,valueInterval:y,easingCurve:m,pathCurve:T}}},e.prototype.getValue=function(t){var e=fe(t,5),r=0,i=new It,n=Object.keys(this.curveSegments);if(!n.length)return i;var o=Number(n[0].split("&")[0]),s=Number(n[n.length-1].split("&")[1]);if(e<=o)return this.curveSegments[n[0]].pathCurve.getPointInPercent(0);if(e>=s)return this.curveSegments[n[n.length-1]].pathCurve.getPointInPercent(1);for(var u=0;u<n.length;u++){var c=a(n[u].split("&"),2),l=c[0],h=c[1];if(e>=Number(l)&&e<Number(h)){var f=this.curveSegments[n[u]].pathCurve;r=this.getPercValue(n[u],e),i=f.getPointInPercent(r)}}return i},e.prototype.getPercValue=function(t,e){var r=this.curveSegments[t],i=a(r.points,1)[0],n=r.timeInterval,o=fe((e-i.x)/n,4);return Ot(r.easingCurve.getValue(o),0,1)},e}(we),ze=((Se={})[V.RANDOM]=function(t){return t[0]instanceof Array?new Ie(t):new Le(t)},Se[V.CONSTANT]=function(t){return new Oe(t)},Se[V.CONSTANT_VEC2]=function(t){return new Oe(t)},Se[V.CONSTANT_VEC3]=function(t){return new Oe(t)},Se[V.CONSTANT_VEC4]=function(t){return new Oe(t)},Se[V.RGBA_COLOR]=function(t){return new Oe(t)},Se[V.COLORS]=function(t){return new Me(t.map((function(t){return st(t,!1)})))},Se[V.LINE]=function(t){return 2===t.length&&0===t[0][0]&&1===t[1][0]?new Pe([t[0][1],t[1][1]]):new Ve(t)},Se[V.GRADIENT_COLOR]=function(t){return new Fe(t)},Se[V.BEZIER_CURVE]=function(t){return 1===t.length?new Oe(t[0][1][1]):new Ne(t)},Se[V.BEZIER_CURVE_PATH]=function(t){return 1===t[0].length?new Oe(new(It.bind.apply(It,u([void 0],a(t[1][0]),!1)))):new De(t)},Se);function Be(t){if(!t||!isNaN(+t))return new Oe(t||0);if(t instanceof we)return t;if(rr(ze[t[0]]))return ze[t[0]](t[1]);throw new Error("ValueType: ".concat(t[0]," is not support"))}function Ue(t,e,r,i,n){var o=t-e;return(i+i+(n-i)*o/(r-e))*o/2}function ke(t,e,r,i,n){var o=t*t,s=e*e;return(o*t*2*(i-n)+3*o*(e*n-r*i)-s*e*(2*i+n)+3*s*r*i)/(6*(e-r))}function Ge(t,e){if(e){var r=e[0],i=e[1];if(r===V.CURVE){t.curves.push(i);var n=i.length;i[0][0]>0&&n++,i[i.length-1][0]<1&&n++,t.index+=n,t.max=Math.max(t.max,n),t.curveCount+=n}else if(r===V.LINE){if(2===(n=i.length)&&0===i[0][0]&&1===i[1][0])return;i[0][0]>0&&n++,i[i.length-1][0]<1&&n++;var o=Math.ceil(n/2);t.lineSegCount+=o,t.curves.push(i),t.index+=o,t.max=Math.max(t.max,o)}else r===V.BEZIER_CURVE&&(n=i.length-1,t.index+=2*n,t.curves.push(i),t.max=Math.max(t.max,2*n),t.curveCount+=2*n)}}function Xe(){return{curves:[],index:0,max:0,lineSegCount:0,curveCount:0}}var He,Ye=new Ut,je=new It(1,1,1),We=new It(0,0,0),Ze=function(){function t(t,e){var r,i=t.positionOverLifetime,n=void 0===i?{}:i,o=e.transform,s=e.duration,a=e.endBehavior,u=o.scale;this.transform=o,this.basicTransform={position:o.position.clone(),rotation:o.getRotation(),scale:u},n.path&&(this.basicTransform.path=Be(n.path)),this.positionOverLifetime=n,this.options={startSpeed:n.startSpeed||0,startSize:u&&u.x||1,sizeAspect:u&&u.x/(u.y||1)||1,startColor:[1,1,1,1],duration:s||0,looping:a&&a===D.loop,gravity:It.fromArray(n.gravity||[]),gravityModifier:Be(null!==(r=n.gravityOverLifetime)&&void 0!==r?r:0),direction:n.direction?It.fromArray(n.direction).normalize():new It,endBehavior:a||0};var c=t.sizeOverLifetime;c&&(c.separateAxes?(this.sizeSeparateAxes=!0,this.sizeXOverLifetime=Be(c.x||1),this.sizeYOverLifetime=Be(c.y||1),this.sizeZOverLifetime=Be(c.z||1)):this.sizeXOverLifetime=Be(c.size||1));var l=n.linearX||n.linearY||n.linearZ;l&&(this.linearVelOverLifetime={x:n.linearX&&Be(n.linearX),y:n.linearY&&Be(n.linearY),z:n.linearZ&&Be(n.linearZ),asMovement:n.asMovement,enabled:!!l});var h=n.orbitalX||n.orbitalY||n.orbitalZ;h&&(this.orbitalVelOverLifetime={x:n.orbitalX&&Be(n.orbitalX),y:n.orbitalY&&Be(n.orbitalY),z:n.orbitalZ&&Be(n.orbitalZ),center:ee(n.orbCenter),asRotation:n.asRotation,enabled:!!h}),this.speedOverLifetime=n.speedOverLifetime&&Be(n.speedOverLifetime);var f=t.rotationOverLifetime;if(f&&(this.rotationOverLifetime={asRotation:f.asRotation,separateAxes:f.separateAxes,z:Be(f.z||0)},f.separateAxes)){var p=this.rotationOverLifetime;p.x=Be(f.x||0),p.y=Be(f.y||0)}this.gravityModifier=this.options.gravityModifier}return t.prototype.getVelocity=function(){return this.velocity||(this.velocity=this.options.direction.clone().multiply(this.options.startSpeed)),this.velocity},t.prototype.willTranslate=function(){return!!(this.linearVelOverLifetime&&this.linearVelOverLifetime.enabled||this.orbitalVelOverLifetime&&this.orbitalVelOverLifetime.enabled||this.options.gravityModifier&&!this.options.gravity.isZero()||this.options.startSpeed&&!this.options.direction.isZero())},t.prototype.updatePosition=function(t,e,r){this.basicTransform.position.set(t,e,r)},t.prototype.updateRotation=function(t,e,r){this.basicTransform.rotation.set(t,e,r)},t.prototype.getRenderData=function(t,e){var r,i,n=this.options,o=je.setFromNumber(1),s=Ye.set(0,0,0),a=t<0?t:Math.max(t,0),u=n.duration,c=a/u,l={life:c,transform:this.transform,startSize:this.basicTransform.scale.clone()},h=this.basicTransform;c=c<0?0:c>1?1:c,this.sizeXOverLifetime&&(o.x=this.sizeXOverLifetime.getValue(c),this.sizeSeparateAxes?(o.y=this.sizeYOverLifetime.getValue(c),o.z=this.sizeZOverLifetime.getValue(c)):o.z=o.y=o.x,r=!0),(r||e)&&l.transform.setScale(o.x,o.y,o.z);var f,p=this.rotationOverLifetime;if(p){var d=function(t){return p.asRotation?t.getValue(c):t.getIntegrateValue(0,c,u)},m=d(p.z),v=p.separateAxes;s.x=v?d(p.x):0,s.y=v?d(p.y):0,s.z=m,i=!0}if(i||e){var y=Ye.addEulers(h.rotation,s);l.transform.setRotation(y.x,y.y,y.z)}if((this.willTranslate()||e)&&(f=te(je.setFromNumber(0),this,n.gravity,a,u,h.position,this.getVelocity())),h.path&&(f||(f=We.copyFrom(h.position)),f.add(h.path.getValue(c))),f&&l.transform.setPosition(f.x,f.y,f.z),l.startSize){var g=l.transform.scale;l.transform.setScale(g.x*l.startSize.x,g.y*l.startSize.y,g.z*l.startSize.z)}return l},t}(),qe="[Galacean Effects]";function Ke(t){return["%c".concat(qe),"background: #AA0100; color: white","".concat(t)]}var Qe,Je={error:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];console.error.apply(console,u(u([],a(Ke(t)),!1),[e],!1)),null==He||He("error",t,e)},info:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];console.debug.apply(console,u([],a(Ke(t)),!1)),null==He||He("info",t,e)},warn:function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];console.warn.apply(console,u([],a(Ke(t)),!1)),null==He||He("warn",t,e)},register:function(t){t&&rr(t)&&(He=t)}};function $e(){}function tr(t){return"string"==typeof t}t.DestroyOptions=void 0,(Qe=t.DestroyOptions||(t.DestroyOptions={}))[Qe.destroy=0]="destroy",Qe[Qe.keep=1]="keep",Qe[Qe.force=0]="force";var er=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function rr(t){return"[object Function]"===Object.prototype.toString.call(t)}function ir(t){return"[object Object]"===Object.prototype.toString.call(t)}function nr(t,e){return t+Math.random()*(e-t)}function or(){throw Error("destroyed item cannot be used again")}var sr,ar=new Pt,ur=1,cr=function(){function t(t,e){void 0===t&&(t={}),this.position=new It(0,0,0),this.quat=new Pt(0,0,0,1),this.rotation=new Ut(0,0,0),this.scale=new It(1,1,1),this.anchor=new It(0,0,0),this.children=[],this.worldMatrix=Nt.fromIdentity(),this.localMatrix=Nt.fromIdentity(),this.valid=!1,this.dirtyFlags={localData:!1,localMatrix:!1,worldMatrix:!1,parentMatrix:!1},this.worldTRSCache={position:new It(0,0,0),quat:new Pt(0,0,0,1),scale:new It(1,1,1)},this.name="transform_".concat(ur++),t&&this.setTransform(t),e&&(this.parentTransform=e),void 0!==t.valid&&this.setValid(t.valid)}return t.getRotation=function(t,e){var r=ar.copyFrom(t);return r.conjugate(),e.setFromQuaternion(r)},Object.defineProperty(t.prototype,"parentTransform",{get:function(){return this.parent},set:function(t){t&&this.parent!==t&&this!==t&&(this.parent&&this.parent.removeChild(this),t.addChild(this),this.parent=t,this.parentMatrixDirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"parentMatrixDirty",{get:function(){return this.dirtyFlags.parentMatrix},set:function(t){this.dirtyFlags.parentMatrix!==t&&(this.dirtyFlags.parentMatrix=t,this.dispatchValueChange())},enumerable:!1,configurable:!0}),t.prototype.setPosition=function(t,e,r){this.position.x===t&&this.position.y===e&&this.position.z===r||(this.position.x=t,this.position.y=e,this.position.z=r,this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.translate=function(t,e,r){0===t&&0===e&&0===r||(this.position.x+=t,this.position.y+=e,this.position.z+=r,this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.setRotation=function(t,e,r){this.rotation.x===t&&this.rotation.y===e&&this.rotation.z===r||(this.rotation.x=t,this.rotation.y=e,this.rotation.z=r,this.quat.setFromEuler(this.rotation),this.quat.conjugate(),this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.setQuaternion=function(t,e,r,i){this.quat.x===t&&this.quat.y===e&&this.quat.z===r&&this.quat.w===i||(this.quat.x=t,this.quat.y=e,this.quat.z=r,this.quat.w=i,this.rotation.setFromQuaternion(this.quat),this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.setScale=function(t,e,r){this.scale.x===t&&this.scale.y===e&&this.scale.z===r||(this.scale.x=t,this.scale.y=e,this.scale.z=r,this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.rotateByQuat=function(t){this.quat.multiply(t),this.rotation.setFromQuaternion(this.quat),this.dirtyFlags.localData=!0,this.dispatchValueChange()},t.prototype.scaleBy=function(t,e,r){this.scale.x*=t,this.scale.y*=e,this.scale.z*=r,this.dirtyFlags.localData=!0,this.dispatchValueChange()},t.prototype.setAnchor=function(t,e,r){this.anchor.x===t&&this.anchor.y===e&&this.anchor.z===r||(this.anchor.x=t,this.anchor.y=e,this.anchor.z=r,this.dirtyFlags.localData=!0,this.dispatchValueChange())},t.prototype.setTransform=function(t,e){var r,i=t.position,n=t.rotation,o=t.scale,s=t.quat,a=t.name,u=t.anchor;if(a&&(this.name=a),i&&(i instanceof It?this.setPosition(i.x,i.y,i.z):this.setPosition(i[0],i[1],i[2])),s)s instanceof Pt?this.setQuaternion(s.x,s.y,s.z,s.w):this.setQuaternion(s[0],s[1],s[2],s[3]);else if(n){var c=e?-1:1;n instanceof Ut?this.setRotation(n.x*c,n.y*c,n.z*c):this.setRotation(n[0]*c,n[1]*c,n[2]*c)}o&&(o instanceof It?this.setScale(o.x,o.y,o.z):this.setScale(o[0],o[1],o[2])),u&&(u instanceof It?this.setAnchor(u.x,u.y,u.z):this.setAnchor(u[0],u[1],null!==(r=u[2])&&void 0!==r?r:0))},t.prototype.addChild=function(t){rt(this.children,t)},t.prototype.removeChild=function(t){it(this.children,t)},t.prototype.getRotation=function(){return t.getRotation(this.quat,new Ut)},t.prototype.getQuaternion=function(){return this.quat},t.prototype.updateLocalMatrix=function(){this.valid?(this.dirtyFlags.localData&&(this.localMatrix.compose(this.position,this.quat,this.scale,this.anchor),this.dirtyFlags.localMatrix=!0),this.dirtyFlags.localData=!1):this.localMatrix.isIdentity()||(this.localMatrix.identity(),this.dirtyFlags.localMatrix=!0)},t.prototype.getMatrix=function(){return this.updateLocalMatrix(),this.localMatrix},t.prototype.getParentMatrix=function(){return this.parent&&(this.parentMatrix=this.parent.getWorldMatrix(),this.dirtyFlags.parentMatrix=this.dirtyFlags.parentMatrix||this.parent.dirtyFlags.localMatrix||this.parent.dirtyFlags.worldMatrix),this.parentMatrix},t.prototype.getWorldMatrix=function(){var t=this.getMatrix(),e=this.getParentMatrix();return(this.dirtyFlags.localMatrix||this.dirtyFlags.parentMatrix)&&(e?this.worldMatrix.multiplyMatrices(e,t):this.worldMatrix.copyFrom(t),this.dirtyFlags.worldMatrix=!0,this.dirtyFlags.localMatrix=!1,this.dirtyFlags.parentMatrix=!1),this.worldMatrix},t.prototype.getWorldScale=function(){var t=this.worldTRSCache;return this.dirtyFlags.worldMatrix&&(this.getWorldMatrix().decompose(t.position,t.quat,t.scale),this.dirtyFlags.worldMatrix=!1),this.worldTRSCache.scale.clone()},t.prototype.getWorldPosition=function(){return this.updateTRSCache(),this.worldTRSCache.position.clone()},t.prototype.getWorldRotation=function(){return this.updateTRSCache(),t.getRotation(this.worldTRSCache.quat,new Ut)},t.prototype.assignWorldTRS=function(t,e,r){this.updateTRSCache(),t&&t.copyFrom(this.worldTRSCache.position),e&&e.copyFrom(this.worldTRSCache.quat),r&&r.copyFrom(this.worldTRSCache.scale)},t.prototype.cloneFromMatrix=function(t,e){t.decompose(this.position,this.quat,this.scale),e&&e.copyFrom(this.scale),this.dirtyFlags.localData=!0,this.dispatchValueChange()},t.prototype.setValid=function(t){this.valid!==t&&(this.valid=t,t?this.dirtyFlags.localData=!0:(this.localMatrix.identity(),this.dirtyFlags.localMatrix=!0),this.dispatchValueChange())},t.prototype.getValid=function(){return this.valid},t.prototype.dispose=function(){},t.prototype.updateTRSCache=function(){var t=this.getWorldMatrix();if(this.dirtyFlags.worldMatrix){var e=this.worldTRSCache;t.decompose(e.position,e.quat,e.scale),this.dirtyFlags.worldMatrix=!1}},t.prototype.dispatchValueChange=function(){this.children.forEach((function(t){t.parentMatrixDirty=!0}))},t}(),lr=function(){function t(t,e){this._v_priority=0,this.visible=!0,this._contentVisible=!1,this.timeInms=0,this.time=0,this._frozen=!1;var r=t.id,n=t.name,o=t.delay,s=t.parentId,a=t.endBehavior,u=t.transform,c=t.listIndex,l=void 0===c?0:c,h=t.duration,p=void 0===h?0:h;if(this.composition=e,this.id=r,this.name=n,this.delay=o,this.transform=new cr(i({name:this.name},u),e.transform),this.parentId=s,this.duration=p,this.delayInms=1e3*(o||0),this.durInms=1e3*this.duration,this.endBehavior=a,this.lifetime=-this.delayInms/this.durInms,this.listIndex=l,this.speed=1,this.onConstructed(t),p<=0)throw Error("Item duration can't be less than 0, see ".concat(f["Item duration can't be less than 0"]))}return t.isComposition=function(t){return t.type===O.composition},t.isSprite=function(t){return t.type===O.sprite},t.isParticle=function(t){return t.type===O.particle},t.isFilterSprite=function(t){return t.type===O.filter},t.isNull=function(t){return t.type===O.null},t.isTree=function(t){return t.type===O.tree},t.isCamera=function(t){return t.type===O.camera},t.isExtraCamera=function(t){return"extra-camera"===t.id&&"extra-camera"===t.name},Object.defineProperty(t.prototype,"contentVisible",{get:function(){return this._contentVisible&&this.visible},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"content",{get:function(){return this._content},set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reusable",{get:function(){var t,e;return null!==(e=null===(t=this.composition)||void 0===t?void 0:t.reusable)&&void 0!==e&&e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"type",{get:function(){return O.base},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"frozen",{get:function(){return this._frozen},set:function(t){this.handleFrozenChanged(this._frozen=!!t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lifetimeStarted",{get:function(){return this.started&&!this.delaying},enumerable:!1,configurable:!0}),t.prototype.setSpeed=function(t){this.speed=t},t.prototype.getSpeed=function(){return this.speed},t.prototype.start=function(){this.started&&!this.ended||(this.started=!0,this.delaying=!0,this.timeInms=0,this.time=0,this.callEnd=!1,this.ended=!1)},t.prototype.stop=function(){this.doStop(),this.started=!1},t.prototype.doStop=function(){this._content&&this._content.stop&&this._content.stop()},t.prototype.createContent=function(){return this._content||(this._content=this.doCreateContent(this.composition)),this._content},t.prototype.doCreateContent=function(t){},t.prototype.onConstructed=function(t){},t.prototype.onUpdate=function(t){var e,r;if(this.started&&!this.frozen&&this.composition){var i=t*this.speed,n=this.timeInms+=i;this.time+=i/1e3;var o=n-this.delayInms;if(this.delaying&&o>=0&&(this.delaying=!1,this.transform.setValid(!0),this.createContent(),this._contentVisible=!0,this.onLifetimeBegin(this.composition,this.content),this.composition.itemLifetimeEvent(this,!0)),!this.delaying){var s=o/this.durInms,a=this.isEnded(o),u=!0;if(this.transform.setValid(!0),a)if(u=!1,this.callEnd||(this.callEnd=!0,this.composition.itemLifetimeEvent(this,!1),this.onEnd()),2!==this.endBehavior&&5!==this.endBehavior){if(this.ended=!0,this.transform.setValid(!1),1===this.endBehavior||3===this.endBehavior?null===(r=(e=this.composition).onPlayerPause)||void 0===r||r.call(e,this):4===this.endBehavior&&(this.transform.setValid(!0),u=!0,s=1,i=0),this.reusable)0===this.endBehavior&&(this._contentVisible=!1,u=!0,i=0,this.type===O.composition&&this.handleVisibleChanged(!1));else{if(0===this.endBehavior||3===this.endBehavior||6===this.endBehavior)return this.dispose();1===this.endBehavior&&(this.endBehavior=2)}s=Math.min(s,1)}else u=!0,5===this.endBehavior&&(this.ended=!0);else this.callEnd&&this.reusable&&(this.setVisible(!0),this.callEnd=!1);this.lifetime=s%1,u&&this.onItemUpdate(i,s)}}},t.prototype.onItemRemoved=function(t,e){},t.prototype.onItemUpdate=function(t,e){},t.prototype.onLifetimeBegin=function(t,e){},t.prototype.onEnd=function(){},t.prototype.setColor=function(t,e,r,i){},t.prototype.setOpacity=function(t){},t.prototype.getVisible=function(){return this.visible},t.prototype.setVisible=function(t){this.visible!==t&&(this.visible=!!t,this.handleVisibleChanged(this.visible))},t.prototype.handleVisibleChanged=function(t){},t.prototype.handleFrozenChanged=function(t){},t.prototype.getWorldTransform=function(t){var e=null!=t?t:new cr({valid:!0});return e.cloneFromMatrix(this.transform.getWorldMatrix()),e},t.prototype.getNodeTransform=function(t){return this.transform},t.prototype.translate=function(t,e,r){this.transform.translate(t,e,r)},t.prototype.rotate=function(t,e,r){var i=new Ut(t,e,r),n=Pt.fromEuler(i);n.conjugate(),this.transform.rotateByQuat(n)},t.prototype.scale=function(t,e,r){this.transform.scaleBy(t,e,r)},t.prototype.setPositionByPixel=function(t,e){if(this.composition){var r=this.transform.getWorldPosition().z,i=this.composition.camera.getInverseVPRatio(r),n=i.x,o=i.y,s=this.composition.renderer.getWidth()/2,a=this.composition.renderer.getHeight()/2;this.transform.setPosition(2*t*n/s,-2*e*o/a,r)}},t.prototype.setPosition=function(t,e,r){this.transform.setPosition(t,e,r)},t.prototype.setRotation=function(t,e,r){this.transform.setRotation(t,e,r)},t.prototype.setScale=function(t,e,r){this.transform.setScale(t,e,r)},t.prototype.getBoundingBox=function(){},t.prototype.getHitTestParams=function(t){},t.prototype.getRenderData=function(){return{transform:this.transform,life:0,visible:this.visible}},t.prototype.getCurrentPosition=function(){var t=new It;return this.transform.assignWorldTRS(t),t},t.prototype.isEnded=function(t){return t-this.durInms>.001},t.prototype.reset=function(){this.composition&&(this.onItemRemoved(this.composition,this._content),this._content=void 0,this._contentVisible=!1),this.started=!1},t.prototype.translateByPixel=function(t,e){if(this.composition){var r=this.composition.renderer.canvas.getBoundingClientRect(),i=r.width,n=r.height,o=this.transform.getWorldPosition().z,s=this.composition.camera.getInverseVPRatio(o),a=s.x,u=s.y;this.transform.translate(2*t*a/i,-2*e*u/n,0)}},t.prototype.dispose=function(){this.composition&&(this.composition.destroyItem(this),this.reset(),this.onUpdate=function(){return-1},this.composition=null,this._contentVisible=!1,this.transform.setValid(!1))},t}();function hr(t,e){var r=t.type,i=t.pluginName;if(!i)switch(r){case O.null:case O.base:i="cal";break;case O.sprite:i="sprite";break;case O.particle:i="particle";break;case O.interact:i="interact";break;case O.camera:i="camera";break;case O.filter:i="filter";break;case O.text:i="text";break;case O.tree:i="tree";break;default:throw new Error("invalid vfx item type")}return e.pluginSystem.createPluginItem(i,t,e)}t.Item=void 0,(sr=t.Item||(t.Item={})).is=function(t,e){return t.type===e},sr.isFilter=function(t){return t.type===O.filter},sr.isComposition=function(t){return t.type===O.composition},sr.isParticle=function(t){return t.type===O.particle},sr.isNull=function(t){return t.type===O.null};var fr={},pr=[],dr={};function mr(t,e,r,i){dr[t]=r,fr[t]=e,i&&rt(pr,t)}var vr,yr=function(){function t(t){var e={},r=[],i=function(t){var i=fr[t];r.includes(i)||(r.push(i),e[t]=i)};pr.forEach(i),t.forEach(i),this.plugins=Object.keys(e).map((function(t){var e=fr[t];if(!e)throw new Error("plugin '".concat(t,"' not found.")+function(t){var e=gr[t];return e?"\nInstall Plugin: npm i ".concat(e,"@latest --save\nImport Plugin: import '").concat(e,"'"):""}(t));var r=new e;return r.name=t,r})).sort((function(t,e){return t.order-e.order}))}return t.prototype.initializeComposition=function(t,e){this.plugins.forEach((function(r){return r.onCompositionConstructed(t,e)}))},t.prototype.destroyComposition=function(t){this.plugins.forEach((function(e){return e.onCompositionDestroyed(t)}))},t.prototype.resetComposition=function(t,e){this.plugins.forEach((function(r){return r.onCompositionReset(t,e)}))},t.prototype.createPluginItem=function(t,e,r){var i=dr[t];if(!i)throw new Error("plugin ".concat(t," no registered constructor"));var n=new i(e,r);if(!(n instanceof lr))throw new Error("plugin ".concat(t," invalid constructor type"));return n},t.prototype.processRawJSON=function(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,this.callStatic("processRawJSON",t,e)]}))}))},t.prototype.callStatic=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return n(this,void 0,void 0,(function(){var r,i,n,s,c;return o(this,(function(o){for(r=[],i=this.plugins,n=0;n<i.length;n++)s=i[n],c=fr[s.name],t in c&&r.push(Promise.resolve(c[t].apply(c,u([],a(e),!1))));return[2,Promise.all(r)]}))}))},t.prototype.precompile=function(t,e,r){return n(this,void 0,void 0,(function(){return o(this,(function(i){return[2,this.callStatic("precompile",t,e,r)]}))}))},t.prototype.loadResources=function(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,this.callStatic("prepareResource",t,e)]}))}))},t}(),gr={"alipay-downgrade":"@galacean/effects-plugin-alipay-downgrade","editor-gizmo":"@galacean/effects-plugin-editor-gizmo",tree:"@galacean/effects-plugin-model",model:"@galacean/effects-plugin-model","orientation-transformer":"@galacean/effects-plugin-orientation-transformer",spine:"@galacean/effects-plugin-spine"},xr=function(){function t(){this.order=100,this.name=""}return t.precompile=function(t,e){return Promise.resolve()},t.prototype.onCompositionConstructed=function(t,e){},t.prototype.onCompositionItemLifeBegin=function(t,e){},t.prototype.onCompositionItemLifeEnd=function(t,e){},t.prototype.onCompositionItemRemoved=function(t,e){},t.prototype.onCompositionReset=function(t,e){},t.prototype.onCompositionWillReset=function(t,e){},t.prototype.onCompositionDestroyed=function(t){},t.prototype.onCompositionUpdate=function(t,e){},t.prototype.prepareRenderFrame=function(t,e){return!1},t.prototype.postProcessFrame=function(t,e){},t}(),Tr=function(){function t(t,e){this.transform=t;var r=t.position,i=t.getRotation(),n=e.options,o=n.near,s=n.far,a=n.fov,u=n.clipMode;if(this.clipMode=u,this.options={position:r.clone(),rotation:i.clone(),near:Be(o),far:Be(s),fov:Be(a)},e.positionOverLifetime){var c=e.positionOverLifetime,l=c.path,h=c.linearX,f=void 0===h?0:h,p=c.linearY,d=void 0===p?0:p,m=c.linearZ,v=void 0===m?0:m;this.translateOverLifetime={path:l&&Be(l),x:Be(f),y:Be(d),z:Be(v)}}if(e.rotationOverLifetime){var y=e.rotationOverLifetime,g=y.separateAxes,x=y.x,T=void 0===x?0:x,E=y.y,b=void 0===E?0:E,S=y.z,A=void 0===S?0:S;this.rotationOverLifetime={separateAxes:g,x:Be(T),y:Be(b),z:Be(A)}}}return t.prototype.update=function(t){var e=new Pt,r=new It,i=new Ut;r.copyFrom(this.options.position),i.copyFrom(this.options.rotation);var n=this.translateOverLifetime,o=this.rotationOverLifetime;if(t=Ot(t,0,1),n&&(r.x+=n.x.getValue(t),r.y+=n.y.getValue(t),r.z+=n.z.getValue(t),n.path)){var s=n.path.getValue(t);r.add(s)}if(o){var a=o.z.getValue(t);i.z+=a,o.separateAxes?(i.x+=o.x.getValue(t),i.y+=o.y.getValue(t)):(i.x+=a,i.y+=a)}this.far=this.options.far.getValue(t),this.near=this.options.near.getValue(t),this.fov=this.options.fov.getValue(t),this.transform.setPosition(r.x,r.y,r.z),this.transform.setRotation(i.x,i.y,i.z),this.transform.assignWorldTRS(r,e),this.position=r,this.rotation=cr.getRotation(e,i)},t}(),Er=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e}(xr),br=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return O.camera},enumerable:!1,configurable:!0}),e.prototype.onConstructed=function(t){this.model=t.content},e.prototype.onItemUpdate=function(t,e){var r;null===(r=this.controller)||void 0===r||r.update(e),this.updateCamera()},e.prototype.updateCamera=function(){if(this.controller&&this.composition){var t=this.composition.camera;t.near=this.controller.near,t.far=this.controller.far,t.fov=this.controller.fov,t.clipMode=this.controller.clipMode,t.position=this.controller.position,t.rotation=this.controller.rotation}},e.prototype.getCurrentPosition=function(){return this.controller.position},e.prototype.doCreateContent=function(){return this.controller||(this.controller=new Tr(this.transform,this.model)),this.controller},e}(lr);t.HitTestType=void 0,(vr=t.HitTestType||(t.HitTestType={}))[vr.triangle=1]="triangle",vr[vr.box=2]="box",vr[vr.sphere=3]="sphere",vr[vr.custom=4]="custom";var Sr,Ar,Rr="click",Cr="touchstart",_r="touchmove",wr="touchend",Or=w,Mr=function(){function t(t,e){void 0===e&&(e=!1),this.target=t,this.allowPropagation=e,this.enabled=!0,this.handlers={},this.nativeHandlers={}}return t.prototype.bindListeners=function(){var t,e,r,i,n,o,s=this;o=function(t){return t};var a="mousedown",u="mousemove",c="mouseup",l=function(t,e,r,i,o){void 0===i&&(i=0),void 0===o&&(o=0);var a=0,u=0,c=performance.now();if(!s.target)return Je.error("Trigger TouchEvent after EventSystem is disposed"),{x:e,y:r,vx:0,vy:u,dx:i,dy:o,ts:c,width:0,height:0,origin:t};var l=s.target,h=l.width,f=l.height;if(n){var p=c-n.ts;a=(i-n.dx)/p||0,u=(o-n.dy)/p||0,n={dx:i,dy:o,ts:c}}return{x:e,y:r,vx:a,vy:u,dx:i,dy:o,ts:c,width:h,height:f,origin:t}};pt()&&(o=function(t){var e=t,r=e.touches,i=e.changedTouches;return r[0]||i[0]},a="touchstart",u="touchmove",c="touchend"),this.nativeHandlers=((t={})[a]=function(t){if(s.enabled){var a=o(t),u=Lr(a);e=u.x,r=u.y,n=i={clientX:a.clientX,clientY:a.clientY,ts:performance.now(),x:e,y:r},s.dispatchEvent(Cr,l(t,e,r))}},t[u]=function(t){if(i&&s.enabled){var n=Lr(o(t));e=n.x,r=n.y,s.dispatchEvent(_r,l(t,e,r,e-i.x,r-i.y))}},t[c]=function(t){if(i&&s.enabled){!s.allowPropagation&&t.cancelable&&(t.preventDefault(),t.stopPropagation());var n=o(t),a=Lr(n),u=Math.abs(i.clientX-n.clientX)+Math.abs(i.clientY-n.clientY);e=a.x,r=a.y,u<4&&s.dispatchEvent(Rr,l(t,e,r)),s.dispatchEvent(wr,l(t,e,r,e-i.x,r-i.y))}i=0},t),Object.keys(this.nativeHandlers).forEach((function(t){var e;null===(e=s.target)||void 0===e||e.addEventListener(String(t),s.nativeHandlers[t])}))},t.prototype.dispatchEvent=function(t,e){var r=this.handlers[t];null==r||r.forEach((function(t){return t(e)}))},t.prototype.addEventListener=function(t,e){var r=this.handlers[t];return r||(r=this.handlers[t]=[]),rt(r,e),function(){it(r,e)}},t.prototype.removeEventListener=function(t,e){var r=this.handlers[t];r&&it(r,e)},t.prototype.dispose=function(){var t=this;this.target&&(this.handlers={},Object.keys(this.nativeHandlers).forEach((function(e){var r;null===(r=t.target)||void 0===r||r.removeEventListener(String(e),t.nativeHandlers[e])})),this.nativeHandlers={},this.target=null)},t}();function Lr(t){var e=t.target,r=t.clientX,i=t.clientY,n=e.getBoundingClientRect(),o=n.left,s=n.top;return{x:(r-o)/n.width*2-1,y:1-(i-s)/n.height*2}}function Ir(t){switch(t){case b.ALPHA:case b.ADD:case b.SUBTRACTION:case b.STRONG_LIGHT:case b.WEAK_LIGHT:return 1;case b.SUPERPOSITION:return 2;case b.BRIGHTNESS:return 3;case b.MULTIPLY:return 0;default:return 1}}t.ShaderType=void 0,(Sr=t.ShaderType||(t.ShaderType={}))[Sr.vertex=0]="vertex",Sr[Sr.fragment=1]="fragment";var Pr,Fr,Vr=((Ar={})[t.ShaderType.vertex]={in:"attribute",out:"varying"},Ar[t.ShaderType.fragment]={in:"varying"},Ar);function Nr(t,e,r,i){var n=[],o="";n.push("#define GE_RUNTIME"),t&&(t.forEach((function(t){var e=a(t,2),r=e[0],i=e[1];!0===i?n.push("#define ".concat(r)):Number.isFinite(i)&&n.push("#define ".concat(r," ").concat(i))})),o=n.length?n.join("\n")+"\n":"");var s="WEBGL".concat(i),u=(o+="\n#ifndef ".concat(s,"\n#define ").concat(s,"\n#endif"))+"\n"+e,c=u.match(/#version\s+\b\d{3}\b\s*(es)?/),l=c?c[0]:"";if(l&&l.includes("300")){var h=new RegExp("".concat(l),"g");1===i&&(u=u.replace(/\b(in|out)\b/g,(function(t){var e;return null!==(e=Vr[r][t])&&void 0!==e?e:t}))),u=u.replace(h,"\n")}return u}function Dr(t,e){switch(e){case void 0:case b.ALPHA:t.blendFunction=[v.ONE,v.ONE_MINUS_SRC_ALPHA,v.ONE,v.ONE_MINUS_SRC_ALPHA];break;case b.ADD:t.blendFunction=[v.ONE,v.ONE,v.ONE,v.ONE];break;case b.SUBTRACTION:t.blendFunction=[v.ONE,v.ONE,v.ZERO,v.ONE],t.blendEquation=[v.FUNC_REVERSE_SUBTRACT,v.FUNC_REVERSE_SUBTRACT];break;case b.SUPERPOSITION:t.blendFunction=[v.ONE,v.ONE,v.ONE,v.ONE];break;case b.MULTIPLY:t.blendFunction=[v.DST_COLOR,v.ONE_MINUS_SRC_ALPHA,v.DST_COLOR,v.ONE_MINUS_SRC_ALPHA];break;case b.BRIGHTNESS:t.blendFunction=[v.ONE,v.ONE_MINUS_SRC_ALPHA,v.ONE,v.ONE_MINUS_SRC_ALPHA];break;case b.STRONG_LIGHT:t.blendFunction=[v.DST_COLOR,v.DST_ALPHA,v.ZERO,v.ONE];break;case b.WEAK_LIGHT:t.blendFunction=[v.DST_COLOR,v.ZERO,v.ZERO,v.ONE];break;default:console.warn("blendMode ".concat(e," not in specification, please set blend params separately"))}}function zr(t,e){e===S.DOUBLE?t.culling=!1:(t.culling=!0,t.frontFace=v.CW,t.cullFace=e===S.BACK?v.BACK:v.FRONT)}function Br(t,e){switch(e){case void 0:t.stencilTest=!1;break;case A.MASK:t.stencilTest=!0,t.stencilFunc=[v.ALWAYS,v.ALWAYS],t.stencilOpZPass=[v.REPLACE,v.REPLACE];break;case A.OBSCURED:t.stencilTest=!0,t.stencilFunc=[v.EQUAL,v.EQUAL];break;case A.REVERSE_OBSCURED:t.stencilTest=!0,t.stencilFunc=[v.NOTEQUAL,v.NOTEQUAL];break;case A.NONE:t.stencilTest=!1;break;default:console.warn("maskMode ".concat(e," not in specification, please set stencil params seperately"))}}t.TextureLoadAction=void 0,(Pr=t.TextureLoadAction||(t.TextureLoadAction={}))[Pr.whatever=0]="whatever",Pr[Pr.clear=2]="clear",t.TextureSourceType=void 0,(Fr=t.TextureSourceType||(t.TextureSourceType={}))[Fr.none=0]="none",Fr[Fr.data=1]="data",Fr[Fr.image=2]="image",Fr[Fr.compressed=3]="compressed",Fr[Fr.video=4]="video",Fr[Fr.canvas=5]="canvas",Fr[Fr.framebuffer=6]="framebuffer",Fr[Fr.mipmaps=7]="mipmaps";var Ur=function(){function t(){this.callbacks={}}return t.prototype.downloadJSON=function(t,e,r){this.download(t,"json",e,r)},t.prototype.downloadBinary=function(t,e,r){this.download(t,"arraybuffer",e,r)},t.prototype.downloadBlob=function(t,e,r){this.download(t,"blob",e,r)},t.prototype.download=function(t,e,r,i){var n=this;if(void 0===e&&(e="json"),!this.start(t,r,i)){var o=new XMLHttpRequest,s=function(){n.finish(t,o.status,o.response)};o.responseType=e,o.addEventListener("load",(function(){200==o.status||0==o.status?n.finish(t,200,o.response):s()})),o.addEventListener("error",s),o.open("GET",t,!0),o.send()}},t.prototype.start=function(t,e,r){var i=this.callbacks[t];try{if(i)return!0;this.callbacks[t]=i=[]}finally{i.push(e,r)}},t.prototype.finish=function(t,e,r){var i=this.callbacks[t];delete this.callbacks[t];for(var n=200==e||0==e?[r]:[e,r],o=n.length-1,s=i.length;o<s;o+=2)i[o].apply(null,n)},t}(),kr=!1;function Gr(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return!kr&&e?[3,2]:[4,Xr(t)];case 1:case 5:return[2,{image:r.sent(),url:t}];case 2:return r.trys.push([2,4,,6]),[4,Xr(e)];case 3:return[2,{image:r.sent(),url:e}];case 4:return r.sent(),kr=!0,[4,Xr(t)];case 6:return[2]}}))}))}function Xr(t){return n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){if(e="",t instanceof HTMLImageElement){if(t.complete)return[2,t];e=t.src}else t instanceof Blob?(e=URL.createObjectURL(t),r=!0):"string"==typeof t&&(e=t);if(!e)throw new Error("Invalid url type: ".concat(JSON.stringify(t)));return[2,new Promise((function(t,i){var n=new Image;/^data:/.test(e)||(n.crossOrigin="*"),n.onload=function(){return n.onload=null,r&&URL.revokeObjectURL(e),t(n)},n.onerror=function(t){return n.onerror=null,r&&URL.revokeObjectURL(e),i("Load image fail: ".concat(e,", reason: ").concat(JSON.stringify(t)))},n.src=e}))]}))}))}function Hr(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e,r){(new Ur).downloadBinary(t,e,(function(e,i){r("Couldn't load bins ".concat(t,": status ").concat(e,", ").concat(i))}))}))]}))}))}function Yr(t){return n(this,void 0,void 0,(function(){var e;return o(this,(function(r){return e=document.createElement("video"),"string"==typeof t?e.src=t:e.srcObject=t,e.crossOrigin="anonymous",e.muted=!0,ft()&&e.setAttribute("renderer","standard"),e.setAttribute("playsinline","playsinline"),[2,new Promise((function(t,r){var i=e.play();i?i.then((function(){return t(e)})):e.addEventListener("loadeddata",(function r(){t(e),e.removeEventListener("loadeddata",r)}),!0),e.addEventListener("error",(function(t){r(t)}))}))]}))}))}function jr(e,r,s){return void 0===s&&(s=[]),n(this,void 0,void 0,(function(){var n,a,u,c,l,h,f;return o(this,(function(o){switch(o.label){case 0:return 34067!==e.target?[3,2]:(u=(n=e).mipmaps,c=n.target,l=u.map((function(t){return Promise.all(t.map((function(t){return Wr(t,r)})))})),[4,Promise.all(l)]);case 1:return h=o.sent(),f=s[u[0][0][1][0]].url,[2,i(i({keepImageSource:!1},e),{mipmaps:h,sourceFrom:{target:c,bin:f,type:t.TextureSourceType.mipmaps,mipmaps:u.map((function(t){return t.map((function(t){return[t[1][1],t[1][2]]}))}))}})];case 2:return u=(a=e).mipmaps,c=a.target,l=u.map((function(t){return Wr(t,r)})),[4,Promise.all(l)];case 3:return h=o.sent(),f=s[u[0][1][0]].url,[2,i(i({keepImageSource:!1},e),{mipmaps:h,sourceType:t.TextureSourceType.mipmaps,sourceFrom:{target:c,bin:f,type:t.TextureSourceType.mipmaps,mipmaps:u.map((function(t){return[t[1][1],t[1][2]]}))}})]}}))}))}function Wr(t,e){return n(this,void 0,void 0,(function(){var r,i,n,s,u;return o(this,(function(o){if(r=a(t[1],3),i=r[0],n=r[1],s=r[2],!(u=e[i]))throw new Error("invalid bin pointer: ".concat(JSON.stringify(t)));return[2,Xr(new Blob([new Uint8Array(u,n,s)]))]}))}))}var Zr=1,qr=function(){function e(){this.destroyed=!1,this.id="Tex"+Zr++}return Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),e.prototype.getWidth=function(){return this.width||0},e.prototype.getHeight=function(){return this.height||0},e.prototype.uploadCurrentVideoFrame=function(){},e.prototype.offloadData=function(){},e.prototype.reloadData=function(){},e.prototype.initialize=function(){},e.prototype.assembleOptions=function(e){var r=e.target,n=void 0===r?v.TEXTURE_2D:r,o=e.format,s=void 0===o?v.RGBA:o;return e.sourceType||(e.sourceType="image"in e?t.TextureSourceType.image:"data"in e?t.TextureSourceType.data:"video"in e?t.TextureSourceType.video:0),i({minFilter:v.NEAREST,magFilter:v.NEAREST,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE,target:n,format:v.RGBA,internalFormat:s,type:v.UNSIGNED_BYTE},e)},e}();function Kr(t,e,r,i){var n,o,s=e.length/r/i;return o=n=4===s||0===s?v.RGBA:3===s?v.RGB:2===s?v.LUMINANCE_ALPHA:v.LUMINANCE,qr.createWithData(t,{data:e,width:r,height:i},{type:v.HALF_FLOAT,format:n,internalFormat:o,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE})}var Qr=function(){function t(t,e,r){void 0===r&&(r=0),this.arrayBuffer=t,this.baseOffset=r;var i=new Uint8Array(this.arrayBuffer,this.baseOffset,12);if(171!==i[0]||75!==i[1]||84!==i[2]||88!==i[3]||32!==i[4]||49!==i[5]||49!==i[6]||187!==i[7]||13!==i[8]||10!==i[9]||26!==i[10]||10!==i[11])throw Error("texture missing KTX identifier");var n=Uint32Array.BYTES_PER_ELEMENT,o=new DataView(this.arrayBuffer,this.baseOffset+12,13*n),s=67305985===o.getUint32(0,!0);this.glType=o.getUint32(1*n,s),this.glTypeSize=o.getUint32(2*n,s),this.glFormat=o.getUint32(3*n,s),this.glInternalFormat=o.getUint32(4*n,s),this.glBaseInternalFormat=o.getUint32(5*n,s),this.pixelWidth=o.getUint32(6*n,s),this.pixelHeight=o.getUint32(7*n,s),this.pixelDepth=o.getUint32(8*n,s),this.numberOfArrayElements=o.getUint32(9*n,s),this.numberOfFaces=o.getUint32(10*n,s),this.numberOfMipmapLevels=o.getUint32(11*n,s),this.bytesOfKeyValueData=o.getUint32(12*n,s),this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels),0!==this.pixelHeight&&0===this.pixelDepth?0===this.numberOfArrayElements?this.numberOfFaces===e?0===this.glType?this.loadType=0:this.loadType=2:Je.warn("Number of faces expected"+e+", but found "+this.numberOfFaces):Je.warn("Texture arrays not currently supported"):Je.warn("Only 2D textures currently supported")}return t.prototype.mipmaps=function(t){for(var e=[],r=64+this.bytesOfKeyValueData,i=this.pixelWidth,n=this.pixelHeight,o=t?this.numberOfMipmapLevels:1,s=0;s<o;s++){for(var a=new Int32Array(this.arrayBuffer,this.baseOffset+r,1)[0],u=0;u<this.numberOfFaces;u++){var c=new Uint8Array(this.arrayBuffer,this.baseOffset+r+4,a);e.push({data:c,width:i,height:n}),r+=a+4,r+=3-(a+3)%4}i=Math.max(1,.5*i),n=Math.max(1,.5*n)}return e},t}();function Jr(e){var r=new Qr(e,1),i=r.numberOfMipmapLevels,n=r.pixelWidth,o=r.pixelHeight,s=r.glType,a=r.numberOfFaces,u=r.glInternalFormat,c=r.glFormat,l=i>=Math.floor(Math.log2(Math.max(n,o))+1);return{sourceType:t.TextureSourceType.compressed,type:s,target:6===a?v.TEXTURE_CUBE_MAP:v.TEXTURE_2D,internalFormat:u,format:c,mipmaps:r.mipmaps(l)}}var $r,ti=function(){function e(){this.reloadPending={}}return e.prototype.reload=function(t){return n(this,void 0,void 0,(function(){var e,r;return o(this,(function(i){switch(i.label){case 0:return e=t.id,this.reloadPending[e]?[2]:t.sourceFrom?(this.reloadPending[e]=!0,[4,this.loadSource(t.sourceFrom)]):[3,2];case 1:return r=i.sent(),t.updateSource(r),this.reloadPending[e]=!1,[3,3];case 2:throw new Error("No source from");case 3:return[2]}}))}))},e.prototype.canOffloadTexture=function(e){if(e){var r=e.type;if(r===t.TextureSourceType.compressed||r===t.TextureSourceType.image){var i=e,n=i.target,o=i.map,s=e.url;return n===v.TEXTURE_CUBE_MAP?"object"==typeof o&&!!o:tr(s)&&s.length>0}if(r===t.TextureSourceType.mipmaps){var a=e,u=a.bin,c=a.mipmaps,l=e,h=(n=l.target,l.maps),f=e.urls;return u?c.length>0:n===v.TEXTURE_CUBE_MAP?h.every((function(t){return"object"==typeof t&&t})):f.every((function(t){return tr(t)&&t.length>0}))}}return!1},e.prototype.loadSource=function(e,r){return n(this,void 0,void 0,(function(){var n,s,a,u,c,l,h,f,p,d,m,y,g,x,T,E,b,S=this;return o(this,(function(o){switch(o.label){case 0:return n=e.type,s=e.target,a=e.map,u=e.url,l=(c=e).bin,h=c.mipmaps,f=e.urls,p=e.maps,s!==v.TEXTURE_CUBE_MAP||n===t.TextureSourceType.mipmaps?[3,2]:[4,this.loadCubeMap(a)];case 1:return d=o.sent(),[2,i(i({},r),{cube:d,target:v.TEXTURE_CUBE_MAP,sourceType:t.TextureSourceType.image,sourceFrom:{type:t.TextureSourceType.image,map:i({},a),target:v.TEXTURE_CUBE_MAP}})];case 2:return n!==t.TextureSourceType.image?[3,4]:[4,Xr(u)];case 3:return m=o.sent(),[2,i(i({},r),{image:m,sourceType:t.TextureSourceType.image,sourceFrom:{type:n,url:u,target:v.TEXTURE_2D}})];case 4:return n!==t.TextureSourceType.video?[3,6]:[4,Yr(u)];case 5:return y=o.sent(),[2,i(i({},r),{video:y,sourceType:t.TextureSourceType.video})];case 6:return n!==t.TextureSourceType.compressed?[3,8]:[4,Hr(u)];case 7:return g=o.sent(),[2,i(i(i({},Jr(g)),r),{sourceFrom:{url:u,type:t.TextureSourceType.compressed}})];case 8:return n!==t.TextureSourceType.mipmaps?[3,17]:l?[4,Hr(l)]:[3,13];case 9:return x=o.sent(),T=null!=s?s:v.TEXTURE_2D,E=T===v.TEXTURE_2D?h.slice():h.map((function(t){return t.slice()})),b=void 0,s!==v.TEXTURE_CUBE_MAP?[3,11]:[4,Promise.all(h.map((function(t){return S.loadMipmapImages(t,x)})))];case 10:return b=o.sent(),[3,12];case 11:b=this.loadMipmapImages(h,x),o.label=12;case 12:return[2,i(i({},r),{mipmaps:b,target:T,sourceType:t.TextureSourceType.mipmaps,sourceFrom:{bin:l,mipmaps:E,target:T,type:t.TextureSourceType.mipmaps}})];case 13:return s!==v.TEXTURE_2D&&s?[3,15]:[4,Promise.all(f.map((function(t){return Xr(t)})))];case 14:return b=o.sent(),[2,i(i({},r),{mipmaps:b,target:v.TEXTURE_2D,sourceType:t.TextureSourceType.mipmaps,sourceFrom:{type:n,urls:f.slice(),target:v.TEXTURE_2D}})];case 15:return s!==v.TEXTURE_CUBE_MAP?[3,17]:[4,Promise.all(p.map((function(t){return S.loadCubeMap(t)})))];case 16:return b=o.sent(),[2,i(i({},r),{mipmaps:b,target:v.TEXTURE_CUBE_MAP,sourceType:t.TextureSourceType.mipmaps,sourceFrom:{type:n,maps:p.map((function(t){return i({},t)})),target:v.TEXTURE_CUBE_MAP}})];case 17:throw new Error("Invalid resource type: ".concat(n))}}))}))},e.prototype.loadMipmapImages=function(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){return[2,Promise.all(t.map((function(t){return Xr(new Blob([new Uint8Array(e,t[0],t[1])]))})))]}))}))},e.prototype.loadCubeMap=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){return[2,Promise.all(t.map((function(t){return Xr(t)})))]}))}))},e}();function ei(){return $r||($r=new ti),$r}var ri,ii=function(){function t(t){this.destroyed=!1;var e=t.name,r=void 0===e?"defaultDataBlock":e;this.name=r}return t.prototype.setUniformValues=function(t){var e=this;Object.keys(t).forEach((function(r){e.setUniformValue(r,t[r])}))},t.prototype.invalidAllFlags=function(){},t.prototype.updateUniformSubData=function(t,e,r){},t}();function ni(t){return"object"==typeof t&&t&&void 0===t.length&&t instanceof qr}t.MaterialRenderType=void 0,(ri=t.MaterialRenderType||(t.MaterialRenderType={}))[ri.normal=0]="normal",ri[ri.transformFeedback=1]="transformFeedback";var oi,si,ai=1,ui=function(){function e(e){this.props=e,this.destroyed=!1,this.initialized=!1;var r=e.name,n=void 0===r?"Material"+ai++:r,o=e.renderType,s=void 0===o?t.MaterialRenderType.normal:o,a=e.shader,u=e.uniformSemantics;this.name=n,this.renderType=s,this.shaderSource=a,this.uniformSemantics=i({},u)}return Object.defineProperty(e.prototype,"blending",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blendFunction",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blendEquation",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthTest",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthMask",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilTest",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilRef",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilFunc",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpZPass",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"culling",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"frontFace",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cullFace",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"blendColor",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthRange",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthFunc",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffsetFill",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"polygonOffset",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"sampleAlphaToCoverage",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"colorMask",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilMask",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpFail",{set:function(t){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilOpZFail",{set:function(t){},enumerable:!1,configurable:!0}),e.prototype.initialize=function(){},e.prototype.use=function(t,e){},e}(),ci="uniform vec2 uFilterSourceSize;uniform sampler2D uFilterSource;\n#define INTERPOLATION 1\nvec4 filterMain(vec2 texCoord,sampler2D tex){\n#ifdef INTERPOLATION\nvec2 texInPixel=texCoord*uFilterSourceSize;vec2 coordMin=floor(texInPixel);vec2 pp=texInPixel-coordMin;vec4 fCoord=vec4(coordMin/uFilterSourceSize,(coordMin+vec2(1.))/uFilterSourceSize);vec4 cLT=texture2D(uFilterSource,vec2(fCoord.x,fCoord.w));vec4 cLB=texture2D(uFilterSource,vec2(fCoord.x,fCoord.y));vec4 cRT=texture2D(uFilterSource,vec2(fCoord.z,fCoord.w));vec4 cRB=texture2D(uFilterSource,vec2(fCoord.z,fCoord.y));return mix(mix(cLB,cRB,pp.x),mix(cLT,cRT,pp.x),pp.y);\n#else\nreturn texture2D(uFilterSource,texCoord);\n#endif\n}";t.ShaderCompileResultStatus=void 0,(oi=t.ShaderCompileResultStatus||(t.ShaderCompileResultStatus={}))[oi.noShader=0]="noShader",oi[oi.success=1]="success",oi[oi.fail=2]="fail",oi[oi.compiling=3]="compiling",t.GLSLVersion=void 0,(si=t.GLSLVersion||(t.GLSLVersion={})).GLSL1="100",si.GLSL3="300 es";var li=function(t){this.source=t},hi="effects-internal-copy",fi="effects-internal-copy-mesh",pi="\n#ifdef WEBGL2\n#define vsIn in\n#define vsOut out\n#else\n#define vsIn attribute\n#define vsOut varying\n#endif\nprecision highp float;\nvsIn vec2 aPos;\nvsOut vec2 vTex;\nvoid main(){\n    gl_Position = vec4(aPos,0.,1.0);\n    vTex = (aPos + vec2(1.0))/2.;\n}",di="precision mediump float;\n#ifdef WEBGL2\n#define fsIn in\n#define fsOut out\n#define texture2D texture\n#else\n#define fsIn varying\n#endif\n".concat(ci,"\nfsIn vec2 vTex;\n#ifdef WEBGL2\nlayout (location = 0) out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n\n#ifdef DEPTH_TEXTURE\nuniform sampler2D uDepth;\n#ifndef WEBGL2\n#extension GL_EXT_frag_depth : enable\n#define gl_FragDepth gl_FragDepthEXT\n#endif\n#endif\nvoid main(){\n    fragColor = filterMain(vTex,uFilterSource);\n    #ifdef DEPTH_TEXTURE\n    gl_FragDepth = texture2D(uDepth,vTex).r;\n    #endif\n}\n");function mi(e,r){var i=2===e,n=i?"#version 300 es":"";return{name:hi,vertex:Nr([],n+"\n"+pi,t.ShaderType.vertex,e),fragment:Nr([],n+"\n"+di,t.ShaderType.fragment,e),glslVersion:i?t.GLSLVersion.GLSL3:t.GLSLVersion.GLSL1,marcos:[["WEBGL2",!!i],["DEPTH_TEXTURE",!!r]],cacheId:fi+ +r}}var vi,yi={format:v.RGBA,type:v.UNSIGNED_BYTE,minFilter:v.LINEAR,magFilter:v.LINEAR,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE},gi=Symbol("dispose"),xi=function(){function e(t){this.textureCache={},this.textureRef={},this.engine=t}return e.prototype.requestColorAttachmentTexture=function(e){var r=this,i=e.width,n=e.height,o=e.name,s={sourceType:t.TextureSourceType.framebuffer,data:{width:i,height:n},name:o},a=[o];Object.getOwnPropertyNames(yi).forEach((function(t){var r,i=null!==(r=e[t])&&void 0!==r?r:yi[t];s[t]=i,a.push(t,i)}));var u=a.join(":"),c=this.textureCache[u];if(c)this.textureRef[u]++;else{var l=this.engine;Tt(l),c=qr.create(l,s),this.textureCache[u]=c,this.textureRef[u]=1,c[gi]=c.dispose,c.dispose=function(){return r.removeTexture(u)}}return c},e.prototype.removeTexture=function(t){var e=this.textureRef[t];if(e<=1){e<0&&console.error("ref count < 0");var r=this.textureCache[t];r&&(r[gi](),r.dispose=r[gi]),delete this.textureCache[t],delete this.textureRef[t]}else this.textureRef[t]=e-1},e.prototype.dispose=function(){var t=this;Object.keys(this.textureCache).forEach((function(e){var r=t.textureCache[e];r[gi](),r.dispose=r[gi]})),this.textureCache={},this.textureRef={},this.engine=void 0},e}(),Ti=function(){function t(t){void 0===t&&(t={}),this.semantics=i({},t)}return t.prototype.toObject=function(){return i({},this.semantics)},t.prototype.setSemantic=function(t,e){void 0===e?delete this.semantics[t]:this.semantics[t]=e},t.prototype.getSemanticValue=function(t,e){var r=this.semantics[t];return rr(r)?r(e):r},t.prototype.hasSemanticValue=function(t){return t in this.semantics},t.prototype.dispose=function(){var t=this;Object.keys(this.semantics).forEach((function(e){delete t.semantics[e]}))},t}(),Ei=((vi={})[v.FLOAT]=Float32Array.BYTES_PER_ELEMENT,vi[v.INT]=Int32Array.BYTES_PER_ELEMENT,vi[v.SHORT]=Int16Array.BYTES_PER_ELEMENT,vi[v.BYTE]=Int8Array.BYTES_PER_ELEMENT,vi),bi=function(){function t(t){this.name=t}return t.prototype.initialize=function(){},t.prototype.flush=function(){},t}();function Si(t){return t===v.INT?new Int32Array(0):t===v.SHORT?new Int16Array(0):new Float32Array(0)}var Ai="lookup_texture",Ri="offscreen_canvas",Ci={};function _i(t){return Ci[t]}var wi,Oi,Mi=1,Li=function(){function e(t,e){this.engine=t,this.destroyed=!1,this.visible=!0;var r=e.material,i=e.geometry,n=e.name,o=void 0===n?"<unnamed>":n,s=e.priority,a=void 0===s?0:s,u=e.worldMatrix,c=void 0===u?Nt.fromIdentity():u;this.id="Mesh"+Mi++,this.name=o,this.geometry=i,this.material=r,this.priority=a,this.worldMatrix=c}return Object.defineProperty(e.prototype,"priority",{get:function(){return this._priority},set:function(t){this._priority=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),e.prototype.setVisible=function(t){this.visible=t},e.prototype.render=function(t){var e=t.renderingData,r=this.material;e.currentFrame.globalUniforms&&(e.currentCamera&&(t.setGlobalMatrix("effects_MatrixInvV",e.currentCamera.getInverseViewMatrix()),t.setGlobalMatrix("effects_MatrixV",e.currentCamera.getViewMatrix()),t.setGlobalMatrix("effects_MatrixVP",e.currentCamera.getViewProjectionMatrix()),t.setGlobalMatrix("_MatrixP",e.currentCamera.getProjectionMatrix())),t.setGlobalMatrix("effects_ObjectToWorld",this.worldMatrix)),e.currentFrame.editorTransform&&r.setVector4("uEditorTransform",e.currentFrame.editorTransform),r.use(t,e.currentFrame.globalUniforms);var i=this.geometry;i.flush(),t.drawGeometry(i,r)},e.prototype.getVisible=function(){return this.visible},e.prototype.firstGeometry=function(){return this.geometry},e.prototype.setMaterial=function(e,r){r!==t.DestroyOptions.keep&&this.material.dispose(r),this.material=e},e.prototype.restore=function(){},e.prototype.dispose=function(e){if(!this.destroyed){(null==e?void 0:e.geometries)!==t.DestroyOptions.keep&&this.geometry.dispose();var r=null==e?void 0:e.material;r!==t.DestroyOptions.keep&&this.material.dispose(r),this.destroyed=!0,void 0!==this.engine&&(this.engine.removeMesh(this),this.engine=void 0)}},e}(),Ii=1e3;t.RenderPassAttachmentStorageType=void 0,(wi=t.RenderPassAttachmentStorageType||(t.RenderPassAttachmentStorageType={}))[wi.none=0]="none",wi[wi.color=1]="color",wi[wi.stencil_8_opaque=2]="stencil_8_opaque",wi[wi.depth_16_opaque=3]="depth_16_opaque",wi[wi.depth_stencil_opaque=4]="depth_stencil_opaque",wi[wi.depth_16_texture=5]="depth_16_texture",wi[wi.depth_24_stencil_8_texture=6]="depth_24_stencil_8_texture",t.TextureStoreAction=void 0,(Oi=t.TextureStoreAction||(t.TextureStoreAction={}))[Oi.store=0]="store",Oi[Oi.clear=2]="clear";var Pi,Fi=function(){function e(e,r){if(this.destroyed=!1,r){var n=r.texture,o=r.size;if(n instanceof qr)this.texture=n,this.externalTexture=!0;else if(n){var s=n.wrapT,a=n.wrapS,u=n.minFilter,c=n.magFilter,l=n.internalFormat,h=n.format,f=void 0===h?v.RGBA:h,p=n.type,d=void 0===p?v.UNSIGNED_BYTE:p;this.externalTexture=!1,this.textureOptions={size:o,format:f,type:d,internalFormat:l||f,wrapT:s,wrapS:a,minFilter:u,magFilter:c,name:r.name},this.texture=qr.create(e,i(i({},this.textureOptions),{sourceType:t.TextureSourceType.framebuffer,data:{width:o[0],height:o[1]}}))}}}return e.prototype.dispose=function(){this.destroyed||(this.texture.dispose(),this.destroyed=!0)},Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"storageType",{get:function(){return t.RenderPassAttachmentStorageType.color},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){var t=this.texture;return t?[t.getWidth(),t.getHeight()]:[0,0]},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.texture.getWidth()||0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this.texture.getHeight()||0},enumerable:!1,configurable:!0}),e}();t.RenderPassDestroyAttachmentType=void 0,(Pi=t.RenderPassDestroyAttachmentType||(t.RenderPassDestroyAttachmentType={}))[Pi.force=0]="force",Pi[Pi.keep=1]="keep",Pi[Pi.keepExternal=2]="keepExternal",Pi[Pi.destroy=0]="destroy";var Vi=1,Ni=function(){function e(e,r){this.attachments=[],this.destroyed=!1,this.initialized=!1;var n=r.name,o=void 0===n?"RenderPass_"+Vi++:n,s=r.clearAction,a=r.semantics,u=r.depthStencilAttachment,c=r.storeAction,l=r.priority,h=void 0===l?0:l,f=r.meshOrder,p=void 0===f?t.OrderType.ascending:f,d=r.meshes,m=void 0===d?[]:d,v=r.delegate,y=void 0===v?{}:v;this.name=o,this.renderer=e,this.priority=h,this.meshOrder=p,this.meshes=vt(m.slice(),this.meshOrder),this.depthStencilType=(null==u?void 0:u.storageType)||t.RenderPassAttachmentStorageType.none,this.clearAction=i({},s),this.storeAction=i({colorAction:t.TextureStoreAction.store,depthAction:t.TextureStoreAction.store,stencilAction:t.TextureStoreAction.store},c),this.semantics=new Ti(a),this.options=r,this.delegate=y,this.setViewportOptions(r)}return Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"viewport",{get:function(){return this.getViewport()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"stencilAttachment",{get:function(){return this.getStencilAttachment()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"depthAttachment",{get:function(){return this.getDepthAttachment()},enumerable:!1,configurable:!0}),e.prototype.addMesh=function(t){yt(this.meshes,t,this.meshOrder)},e.prototype.removeMesh=function(t){it(this.meshes,t)},e.prototype.setMeshes=function(t){var e;return this.meshes.length=0,(e=this.meshes).splice.apply(e,u([0,0],a(t),!1)),vt(this.meshes,this.meshOrder),this.meshes},e.prototype.getInitAttachments=function(){return this.attachments.length>0?this.attachments:this.options.attachments},e.prototype.configure=function(t){if(this.frameBuffer)t.setFrameBuffer(this.frameBuffer);else{var e=a(this.getViewport(),4),r=e[0],i=e[1],n=e[2],o=e[3];t.setViewport(r,i,n,o)}},e.prototype.execute=function(t){t.clear(this.clearAction),t.renderMeshes(this.meshes),t.clear(this.storeAction)},e.prototype.frameCleanup=function(t){},e.prototype.resetColorAttachments=function(e){var r=this;if(e.length||this.resetAttachments({attachments:[]}),this.attachments.length){var i=e.map((function(e){return e.updateSource({sourceType:t.TextureSourceType.framebuffer}),new Fi(r.renderer.engine,{texture:e})}));this.attachments.forEach((function(t){return!t.externalTexture&&t.dispose()})),this.attachments=i,this.frameBuffer&&(this.frameBuffer.bind(),this.frameBuffer.resetColorTextures(e.map((function(t){return t}))))}else this.resetAttachments({attachments:e.map((function(t){return{texture:t}}))})},e.prototype.resetAttachments=function(t){this.options=t,this.setViewportOptions(t),this.renderer&&this._resetAttachments()},e.prototype.setViewportOptions=function(t){if(t.viewport){if(this.isCustomViewport=!0,this.viewportScale=1,this.customViewport=t.viewport.slice(0,4),this.frameBuffer){var e=this.customViewport;this.frameBuffer.isCustomViewport=!1,this.frameBuffer.resize(e[0],e[1],e[2],e[3])}}else this.isCustomViewport=!1,this.viewportScale=t.viewportScale||1,this.frameBuffer&&(this.frameBuffer.isCustomViewport=!0,this.frameBuffer.viewportScale=this.viewportScale)},e.prototype._resetAttachments=function(){var e,r,n=this,o=this.renderer,s=this.options;this.attachments.length&&(this.attachments.forEach((function(t){return!t.externalTexture&&t.dispose()})),this.attachments.length=0,null===(e=this.frameBuffer)||void 0===e||e.dispose({depthStencilAttachment:t.RenderPassDestroyAttachmentType.keepExternal}),this.frameBuffer=null);var a=this.viewportScale,u=this.isCustomViewport?this.customViewport:[0,0,o.getWidth()*a,o.getHeight()*a],c=[u[2],u[3]],l=this.name;if(null===(r=s.attachments)||void 0===r?void 0:r.length){var h=s.attachments.map((function(t,e){var r;return new Fi(n.renderer.engine,i({size:c,name:(null===(r=t.texture)||void 0===r?void 0:r.name)||"".concat(l,"##color_").concat(e)},t))}));this.attachments=h;var f=Sn.create({storeAction:this.storeAction,name:l,viewport:u,viewportScale:this.viewportScale,isCustomViewport:this.isCustomViewport,attachments:h.map((function(t){return t.texture})),depthStencilAttachment:s.depthStencilAttachment||{storageType:t.RenderPassAttachmentStorageType.none}},o);f.bind(),f.unbind(),this.frameBuffer=f}else this.attachments.length=0},e.prototype.getViewport=function(){var t,e=(null===(t=this.frameBuffer)||void 0===t?void 0:t.viewport)||this.customViewport;if(e)return e;var r=this.renderer,i=this.viewportScale;return r?[0,0,r.getWidth()*i,r.getHeight()*i]:[0,0,0,0]},e.prototype.getDepthAttachment=function(){var t=this.frameBuffer;if(t)return{storageType:t.depthStencilStorageType,storage:t.depthStorage,texture:t.getDepthTexture()?this.getDepthTexture(t.getDepthTexture(),t.externalStorage):void 0}},e.prototype.getStencilAttachment=function(){var t=this.frameBuffer;if(t)return{storageType:t.depthStencilStorageType,storage:t.stencilStorage,texture:t.getStencilTexture()?this.getStencilTexture(t.getStencilTexture(),t.externalStorage):void 0}},e.prototype.getDepthTexture=function(t,e){var r;if(!this.depthTexture){var i=null===(r=this.options.depthStencilAttachment)||void 0===r?void 0:r.texture,n=t===i?i:t;return e||(this.depthTexture=n),n}return this.depthTexture},e.prototype.getStencilTexture=function(t,e){var r;if(!this.stencilTexture){var i=null===(r=this.options.depthStencilAttachment)||void 0===r?void 0:r.texture,n=t===i?i:t;return e||(this.stencilTexture=n),n}return this.stencilTexture},e.prototype.initialize=function(t){return this.initialized||(this._resetAttachments(),this.initialized=!0),this},e.prototype.dispose=function(e){var r,i;if(!this.destroyed){var n=(null==e?void 0:e.meshes)||void 0;n!==t.DestroyOptions.keep&&this.meshes.forEach((function(t){t.dispose(n)})),this.meshes.length=0;var o=(null==e?void 0:e.colorAttachment)?e.colorAttachment:t.RenderPassDestroyAttachmentType.force;this.attachments.forEach((function(e){e.externalTexture&&o===t.RenderPassDestroyAttachmentType.keepExternal||o===t.RenderPassDestroyAttachmentType.keep||e.dispose()})),this.attachments.length=0,(null==e?void 0:e.semantics)!==t.DestroyOptions.keep&&this.semantics.dispose(),this.destroyed=!0;var s=(null==e?void 0:e.depthStencilAttachment)?e.depthStencilAttachment:t.RenderPassDestroyAttachmentType.force,a=this.frameBuffer;a&&(a.dispose({depthStencilAttachment:s}),a.externalStorage&&s===t.RenderPassDestroyAttachmentType.keepExternal||s===t.RenderPassDestroyAttachmentType.keep||(null===(r=this.stencilTexture)||void 0===r||r.dispose(),null===(i=this.depthTexture)||void 0===i||i.dispose())),this.options=this.renderer=null,this.initialize=or}},e}(),Di="#version 300 es\nprecision highp float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout(location=0)out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\nvec4 blendColor(vec4 color,vec4 vc,float mode){vec4 ret=color*vc;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat alpha=vc.a;\n#else\nfloat alpha=ret.a;\n#endif\nif(mode==1.){ret.rgb*=alpha;}else if(mode==2.){ret.rgb*=alpha;ret.a=dot(ret.rgb,vec3(0.33333333));}else if(mode==3.){alpha=color.r*alpha;ret=vec4(vc.rgb*alpha,alpha);}return ret;}in vec4 vColor;in vec4 vTexCoord;in highp vec2 vParams;uniform vec3 uFrameColor;void main(){fragColor=vec4(uFrameColor.xyz,1.0);}",zi="#version 300 es\nprecision highp float;\n#define SHADER_VERTEX 1\n#define SPRITE_SHADER 1\nin vec4 aPoint;in vec2 aIndex;uniform mat4 uMainData[MAX_ITEM_COUNT];uniform vec4 uTexParams[MAX_ITEM_COUNT];uniform vec4 uTexOffset[MAX_ITEM_COUNT];uniform mat4 effects_ObjectToWorld;uniform mat4 effects_MatrixInvV;uniform mat4 effects_MatrixVP;out vec4 vColor;out vec4 vTexCoord;\n#ifdef ADJUST_LAYER\nout vec2 vFeatherCoord;\n#endif\nout highp vec3 vParams;const float d2r=3.141592653589793/180.;\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvec4 filterMain(float t,vec4 position);\n#pragma FILTER_VERT\nvec3 rotateByQuat(vec3 a,vec4 quat){vec3 qvec=quat.xyz;vec3 uv=cross(qvec,a);vec3 uuv=cross(qvec,uv)*2.;return a+(uv*2.*quat.w+uuv);}void main(){int index=int(aIndex.x);vec4 texParams=uTexParams[index];mat4 mainData=uMainData[index];float life=mainData[1].z;if(life<0.||life>1.){gl_Position=vec4(3.,3.,3.,1.);}else{vec4 _pos=mainData[0];vec2 size=mainData[1].xy;vec3 point=rotateByQuat(vec3(aPoint.xy*size,0.),mainData[2]);vec4 pos=vec4(_pos.xyz,1.0);float renderMode=texParams.z;if(renderMode==0.){pos=effects_ObjectToWorld*pos;pos.xyz+=effects_MatrixInvV[0].xyz*point.x+effects_MatrixInvV[1].xyz*point.y;}else if(renderMode==1.){pos.xyz+=point;pos=effects_ObjectToWorld*pos;}else if(renderMode==2.){pos=effects_ObjectToWorld*pos;pos.xy+=point.xy;}else if(renderMode==3.){pos=effects_ObjectToWorld*pos;pos.xyz+=effects_MatrixInvV[0].xyz*point.x+effects_MatrixInvV[2].xyz*point.y;}gl_Position=effects_MatrixVP*pos;\n#ifdef ADJUST_LAYER\nvec4 filter_Position=filterMain(life,pos);\n#endif\ngl_PointSize=6.0;\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#ifdef ADJUST_LAYER\nfilter_Position=vec4(filter_Position.xy*uEditorTransform.xy+uEditorTransform.zw*filter_Position.w,filter_Position.zw);\n#endif\n#endif\n#ifdef ADJUST_LAYER\nvTexCoord=vec4(filter_Position.xy/filter_Position.w+1.,gl_Position.xy/gl_Position.w+1.)/2.;vFeatherCoord=aPoint.zw;\n#else\nvec4 texOffset=uTexOffset[index];vTexCoord=vec4(aPoint.zw*texOffset.zw+texOffset.xy,texParams.xy);\n#endif\nvColor=mainData[3];vParams=vec3(aIndex.y,texParams.y,texParams.x);}}",Bi="#version 300 es\nprecision highp float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout(location=0)out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\nvec4 blendColor(vec4 color,vec4 vc,float mode){vec4 ret=color*vc;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat alpha=vc.a;\n#else\nfloat alpha=ret.a;\n#endif\nif(mode==1.){ret.rgb*=alpha;}else if(mode==2.){ret.rgb*=alpha;ret.a=dot(ret.rgb,vec3(0.33333333));}else if(mode==3.){alpha=color.r*alpha;ret=vec4(vc.rgb*alpha,alpha);}return ret;}\n#define SPRITE_SHADER 1\nin vec4 vColor;in vec4 vTexCoord;in highp vec3 vParams;\n#ifdef ADJUST_LAYER\nuniform sampler2D uSamplerPre;vec4 filterMain(vec2 coord,sampler2D tex);in vec2 vFeatherCoord;uniform sampler2D uFeatherSampler;\n#endif\nuniform sampler2D uSampler0;uniform sampler2D uSampler1;uniform sampler2D uSampler2;uniform sampler2D uSampler3;uniform sampler2D uSampler4;uniform sampler2D uSampler5;uniform sampler2D uSampler6;uniform sampler2D uSampler7;\n#if MAX_FRAG_TEX == 16\nuniform sampler2D uSampler8;uniform sampler2D uSampler9;uniform sampler2D uSampler10;uniform sampler2D uSampler11;uniform sampler2D uSampler12;uniform sampler2D uSampler13;uniform sampler2D uSampler14;uniform sampler2D uSampler15;\n#endif\nvec4 texture2DbyIndex(float index,vec2 coord);\n#pragma FILTER_FRAG\n#ifndef WEBGL2\n#define round(a) floor(0.5+a)\n#endif\nvoid main(){vec4 color=vec4(0.);\n#ifdef ADJUST_LAYER\nvec2 featherCoord=abs(vFeatherCoord-vec2(0.5))/0.5;float cc=sqrt(max(featherCoord.x,featherCoord.y));float blend=vColor.a*texture2D(uFeatherSampler,vec2(cc,0.)).r;if(blend>=1.){color=filterMain(vTexCoord.xy,uSamplerPre);}else if(blend<=0.){color=texture2D(uSamplerPre,vTexCoord.zw);}else{color=mix(texture2D(uSamplerPre,vTexCoord.zw),filterMain(vTexCoord.xy,uSamplerPre),blend);}\n#else\nvec4 texColor=texture2DbyIndex(round(vParams.x),vTexCoord.xy);color=blendColor(texColor,vColor,round(vParams.y));if(vParams.z==0.&&color.a<0.04){discard;}\n#endif\ncolor.a=clamp(color.a,0.0,1.0);fragColor=color;}vec4 texture2DbyIndex(float index,vec2 coord){\n#ifndef ADJUST_LAYER\nif(index==0.){return texture2D(uSampler0,coord);}if(index==1.){return texture2D(uSampler1,coord);}if(index==2.){return texture2D(uSampler2,coord);}if(index==3.){return texture2D(uSampler3,coord);}if(index==4.){return texture2D(uSampler4,coord);}if(index==5.){return texture2D(uSampler5,coord);}if(index==6.){return texture2D(uSampler6,coord);}if(index==7.){return texture2D(uSampler7,coord);}\n#if MAX_FRAG_TEX == 16\nif(index==8.){return texture2D(uSampler8,coord);}if(index==9.){return texture2D(uSampler9,coord);}if(index==10.){return texture2D(uSampler10,coord);}if(index==11.){return texture2D(uSampler11,coord);}if(index==12.){return texture2D(uSampler12,coord);}if(index==13.){return texture2D(uSampler13,coord);}if(index==14.){return texture2D(uSampler14,coord);}if(index==15.){return texture2D(uSampler15,coord);}\n#endif\nreturn texture2D(uSampler0,coord);\n#else\nreturn vec4(0.);\n#endif\n}",Ui="#version 300 es\nprecision mediump float;\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout(location=0)out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\nvec4 blendColor(vec4 color,vec4 vc,float mode){vec4 ret=color*vc;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat alpha=vc.a;\n#else\nfloat alpha=ret.a;\n#endif\nif(mode==1.){ret.rgb*=alpha;}else if(mode==2.){ret.rgb*=alpha;ret.a=dot(ret.rgb,vec3(0.33333333));}else if(mode==3.){alpha=color.r*alpha;ret=vec4(vc.rgb*alpha,alpha);}return ret;}\n#define PATICLE_SHADER 1\nin float vLife;in vec2 vTexCoord;in vec4 vColor;uniform vec3 emissionColor;uniform float emissionIntensity;uniform sampler2D uMaskTex;uniform vec4 uColorParams;uniform vec2 uTexOffset;\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n#ifdef USE_SPRITE\nin vec4 vTexCoordBlend;\n#ifdef USE_FILTER\nuniform vec4 uFSprite;\n#endif\n#endif\nin float vSeed;\n#ifdef PREVIEW_BORDER\nuniform vec4 uPreviewColor;\n#endif\n#ifdef USE_SPRITE\nvec4 getTextureColor(sampler2D tex,vec2 texCoord){if(vTexCoordBlend.w>0.){return mix(texture2D(tex,texCoord),texture2D(tex,vTexCoordBlend.xy+texCoord),vTexCoordBlend.z);}return texture2D(tex,texCoord);}\n#else\n#define getTextureColor texture2D\n#endif\n#ifndef WEBGL2\n#define round(a) floor(0.5+a)\n#endif\n#ifdef PREVIEW_BORDER\nvoid main(){fragColor=uPreviewColor;}\n#else\n#pragma FILTER_FRAG\nvoid main(){vec4 color=vec4(1.0);vec4 tempColor=vColor;vec2 texOffset=uTexOffset;if(vLife<0.){discard;}\n#ifdef USE_FILTER\n#ifdef USE_SPRITE\ntexOffset=uTexOffset/uFSprite.xy;\n#endif\ncolor=filterMain(vTexCoord,uMaskTex);\n#else\nif(uColorParams.x>0.0){color=getTextureColor(uMaskTex,vTexCoord);}\n#endif\n#ifdef COLOR_OVER_LIFETIME\n#ifndef ENABLE_VERTEX_TEXTURE\ntempColor*=texture2D(uColorOverLifetime,vec2(vLife,0.));\n#endif\n#endif\ncolor=blendColor(color,tempColor,round(uColorParams.y));if(color.a<=0.01&&uColorParams.w>0.){float _at=texture2D(uMaskTex,vTexCoord+texOffset).a+texture2D(uMaskTex,vTexCoord+texOffset*-1.).a;if(_at<=0.02){discard;}}vec3 emission=emissionColor*pow(2.0,emissionIntensity);color=vec4(pow(pow(color.rgb,vec3(2.2))+emission,vec3(1.0/2.2)),color.a);fragColor=color;}\n#endif\n",ki="#version 300 es\nprecision mediump float;\n#define SHADER_VERTEX 1\n#define PATICLE_SHADER 1\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#else\n#endif\n#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n#if CURVE_VALUE_COUNT > 0\n#if LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n#endif\n#else\n#define lookup_curve(i) vec4(0.)\n#endif\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n#define NONE_CONST_INDEX 1\n#ifdef SHADER_VERTEX\nin float aSeed;out float vSeed;\n#endif\n#ifdef SHADER_VERTEX\n#define MAX_C VERT_MAX_KEY_FRAME_COUNT\n#else\n#define MAX_C FRAG_MAX_KEY_FRAME_COUNT\n#endif\nmat4 cubicBezierMatrix=mat4(1.0,-3.0,3.0,-1.0,0.0,3.0,-6.0,3.0,0.0,0.0,3.0,-3.0,0.0,0.0,0.0,1.0);float cubicBezier(float t,float y1,float y2,float y3,float y4){vec4 tVec=vec4(1.0,t,t*t,t*t*t);vec4 yVec=vec4(y1,y2,y3,y4);vec4 result=tVec*cubicBezierMatrix*yVec;return result.x+result.y+result.z+result.w;}float binarySearchT(float x,float x1,float x2,float x3,float x4){float left=0.0;float right=1.0;float mid=0.0;float computedX;for(int i=0;i<8;i++){mid=(left+right)*0.5;computedX=cubicBezier(mid,x1,x2,x3,x4);if(abs(computedX-x)<0.0001){break;}else if(computedX>x){right=mid;}else{left=mid;}}return mid;}float valueFromBezierCurveFrames(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);for(int i=0;i<ITR_END;i+=2){if(i>=count){break;}vec4 k0=lookup_curve(i+start);vec4 k1=lookup_curve(i+1+start);if(i==0&&time<k0.x){return k0.y;}if(i==int(frameCount-2.)&&time>=k1.x){return k1.y;}if(time>=k0.x&&time<=k1.x){float t=(time-k0.x)/(k1.x-k0.x);float nt=binarySearchT(time,k0.x,k0.z,k1.z,k1.x);return cubicBezier(nt,k0.y,k0.w,k1.w,k1.y);}}}float evaluteLineSeg(float t,vec2 p0,vec2 p1){return p0.y+(p1.y-p0.y)*(t-p0.x)/(p1.x-p0.x);}float valueFromLineSegs(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);int end=start+count;for(int i=0;i<ITR_END;i++){if(i>count){return lookup_curve(i).w;}vec4 seg=lookup_curve(i+start);vec2 p0=seg.xy;vec2 p1=seg.zw;if(time>=p0.x&&time<=p1.x){return evaluteLineSeg(time,p0,p1);}vec2 p2=lookup_curve(i+start+1).xy;if(time>p1.x&&time<=p2.x){return evaluteLineSeg(time,p1,p2);}}return lookup_curve(0).y;}float getValueFromTime(float time,vec4 value){float type=value.x;if(type==0.){return value.y;}if(type==1.){return mix(value.y,value.z,time/value.w);}if(type==3.){return valueFromLineSegs(time,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed);}if(type==5.){return valueFromBezierCurveFrames(time,value.z,value.w);}return 0.;}float calculateMovement(float t,vec2 p1,vec2 p2,vec2 p3,vec2 p4){float movement=0.0;float h=(t-p1.x)*0.05;for(int i=0;i<=20;i++){float t=float(i)*h;float nt=binarySearchT(t,p1.x,p2.x,p3.x,p4.x);float y=cubicBezier(nt,p1.y,p2.y,p3.y,p4.y);float weight=(i==0||i==20)? 1.0 :(mod(float(i),2.)!=0.)? 4.0 : 2.0;movement+=weight*y;}movement*=h/3.;return movement;}float integrateFromBezierCurveFrames(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i+=2){vec4 k0=lookup_curve(i+start);vec4 k1=lookup_curve(i+1+start);if(i==0&&time<k0.x){return ret;}vec2 p1=vec2(k0.x,k0.y);vec2 p2=vec2(k0.z,k0.w);vec2 p3=vec2(k1.z,k1.w);vec2 p4=vec2(k1.x,k1.y);if(time>=k1.x){ret+=calculateMovement(k1.x,p1,p2,p3,p4);}if(time>=k0.x&&time<k1.x){return ret+calculateMovement(time,p1,p2,p3,p4);}}return ret;}float integrateByTimeLineSeg(float t,vec2 p0,vec2 p1){float t0=p0.x;float t1=p1.x;float y0=p0.y;float y1=p1.y;vec4 tSqr=vec4(t,t,t0,t0);tSqr=tSqr*tSqr;vec4 a=vec4(2.*t,3.,-t0,3.)*tSqr;float t1y0=t1*y0;vec4 b=vec4(y0-y1,t0*y1-t1y0,2.*y0+y1,t1y0);float r=dot(a,b);return r/(t0-t1)*0.16666667;}float integrateLineSeg(float time,vec2 p0,vec2 p1){float h=time-p0.x;float y0=p0.y;return(y0+y0+(p1.y-y0)*h/(p1.x-p0.x))*h/2.;}float integrateFromLineSeg(float time,float frameStart,float frameCount){if(time==0.){return 0.;}int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i++){if(i>count){return ret;}vec4 ks=lookup_curve(i+start);vec2 k0=ks.xy;vec2 k1=ks.zw;if(time>k0.x&&time<=k1.x){return ret+integrateLineSeg(time,k0,k1);}ret+=integrateLineSeg(k1.x,k0,k1);vec2 k2=lookup_curve(i+start+1).xy;if(time>k1.x&&time<=k2.x){return ret+integrateLineSeg(time,k1,k2);}ret+=integrateLineSeg(k2.x,k1,k2);}return ret;}float integrateByTimeFromLineSeg(float time,float frameStart,float frameCount){if(time==0.){return 0.;}int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i++){if(i>count){return ret;}vec4 ks=lookup_curve(i+start);vec2 k0=ks.xy;vec2 k1=ks.zw;if(time>k0.x&&time<=k1.x){return ret+integrateByTimeLineSeg(time,k0,k1);}ret+=integrateByTimeLineSeg(k1.x,k0,k1);vec2 k2=lookup_curve(i+start+1).xy;if(time>k1.x&&time<=k2.x){return ret+integrateByTimeLineSeg(time,k1,k2);}ret+=integrateByTimeLineSeg(k2.x,k1,k2);}return ret;}float getIntegrateFromTime0(float t1,vec4 value){float type=value.x;if(type==0.){return value.y*t1;}if(type==1.){vec2 p0=vec2(0.,value.y);vec2 p1=vec2(value.w,value.z);return integrateLineSeg(t1,p0,p1);}if(type==3.){return integrateFromLineSeg(t1,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed)*t1;}if(type==5.){return integrateFromBezierCurveFrames(t1,value.z,value.w);}return 0.;}float getIntegrateByTimeFromTime(float t0,float t1,vec4 value){float type=value.x;if(type==0.){return value.y*(t1*t1-t0*t0)/2.;}else if(type==1.){vec2 p0=vec2(0.,value.y);vec2 p1=vec2(value.w,value.z);return integrateByTimeLineSeg(t1,p0,p1)-integrateByTimeLineSeg(t0,p0,p1);}if(type==3.){return integrateByTimeFromLineSeg(t1,value.y,value.z)-integrateByTimeFromLineSeg(t0,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed)*(t1*t1-t0*t0)/2.;}if(type==5.){return integrateFromBezierCurveFrames(t1,value.z,value.w)-integrateFromBezierCurveFrames(t0,value.z,value.w);}return 0.;}const float d2r=3.141592653589793/180.;in vec3 aPos;in vec4 aOffset;in vec3 aVel;in vec3 aRot;in vec4 aColor;in vec3 aDirX;in vec3 aDirY;\n#ifdef USE_SPRITE\nin vec3 aSprite;uniform vec4 uSprite;struct UVDetail{vec2 uv0;vec3 uv1;};UVDetail getSpriteUV(vec2 uv,float lifeTime);out vec4 vTexCoordBlend;\n#endif\n#ifdef FINAL_TARGET\nuniform vec3 uFinalTarget;uniform vec4 uForceCurve;\n#endif\nuniform mat4 effects_ObjectToWorld;uniform mat4 effects_MatrixV;uniform mat4 effects_MatrixVP;uniform vec4 uParams;uniform vec4 uAcceleration;uniform vec4 uGravityModifierValue;uniform vec4 uOpacityOverLifetimeValue;\n#ifdef ROT_X_LIFETIME\nuniform vec4 uRXByLifeTimeValue;\n#endif\n#ifdef ROT_Y_LIFETIME\nuniform vec4 uRYByLifeTimeValue;\n#endif\n#ifdef ROT_Z_LIFETIME\nuniform vec4 uRZByLifeTimeValue;\n#endif\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\n#if LINEAR_VEL_X\nuniform vec4 uLinearXByLifetimeValue;\n#endif\n#if LINEAR_VEL_Y\nuniform vec4 uLinearYByLifetimeValue;\n#endif\n#if LINEAR_VEL_Z\nuniform vec4 uLinearZByLifetimeValue;\n#endif\n#endif\n#ifdef SPEED_OVER_LIFETIME\nuniform vec4 uSpeedLifetimeValue;\n#endif\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\n#if ORB_VEL_X\nuniform vec4 uOrbXByLifetimeValue;\n#endif\n#if ORB_VEL_Y\nuniform vec4 uOrbYByLifetimeValue;\n#endif\n#if ORB_VEL_Z\nuniform vec4 uOrbZByLifetimeValue;\n#endif\nuniform vec3 uOrbCenter;\n#endif\nuniform vec4 uSizeByLifetimeValue;\n#ifdef SIZE_Y_BY_LIFE\nuniform vec4 uSizeYByLifetimeValue;\n#endif\nout float vLife;out vec4 vColor;out vec2 vTexCoord;\n#ifdef USE_FILTER\n#pragma FILTER_VERT\n#endif\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvec3 calOrbitalMov(float _life,float _dur){vec3 orb=vec3(0.0);\n#ifdef AS_ORBITAL_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#if ORB_VEL_X\norb.x=FUNC(uOrbXByLifetimeValue);\n#endif\n#if ORB_VEL_Y\norb.y=FUNC(uOrbYByLifetimeValue);\n#endif\n#if ORB_VEL_Z\norb.z=FUNC(uOrbZByLifetimeValue);\n#endif\n#undef FUNC\nreturn orb;}vec3 calLinearMov(float _life,float _dur){vec3 mov=vec3(0.0);\n#ifdef AS_LINEAR_MOVEMENT\n#define FUNC(a) getValueFromTime(_life,a)\n#else\n#define FUNC(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#if LINEAR_VEL_X\nmov.x=FUNC(uLinearXByLifetimeValue);\n#endif\n#if LINEAR_VEL_Y\nmov.y=FUNC(uLinearYByLifetimeValue);\n#endif\n#if LINEAR_VEL_Z\nmov.z=FUNC(uLinearZByLifetimeValue);\n#endif\n#undef FUNC\nreturn mov;}mat3 mat3FromRotation(vec3 rotation){vec3 sinR=sin(rotation*d2r);vec3 cosR=cos(rotation*d2r);return mat3(cosR.z,-sinR.z,0.,sinR.z,cosR.z,0.,0.,0.,1.)*mat3(cosR.y,0.,sinR.y,0.,1.,0.,-sinR.y,0,cosR.y)*mat3(1.,0.,0.,0,cosR.x,-sinR.x,0.,sinR.x,cosR.x);}\n#ifdef USE_SPRITE\nUVDetail getSpriteUV(vec2 uv,float lifeTime){float t=fract(clamp((lifeTime-aSprite.x)/aSprite.y,0.0,1.)*aSprite.z);float frame=uSprite.z*t;float frameIndex=max(ceil(frame)-1.,0.);float row=floor((frameIndex+0.1)/uSprite.x);float col=frameIndex-row*uSprite.x;vec2 retUV=(vec2(col,row)+uv)/uSprite.xy;UVDetail ret;if(uSprite.w>0.){float blend=frame-frameIndex;float frameIndex1=min(ceil(frame),uSprite.z-1.);float row1=floor((frameIndex1+0.1)/uSprite.x);float col1=frameIndex1-row1*uSprite.x;vec2 coord=(vec2(col1,row1)+uv)/uSprite.xy-retUV;ret.uv1=vec3(coord.x,1.-coord.y,blend);}ret.uv0=vec2(retUV.x,1.-retUV.y);return ret;}\n#endif\nvec3 calculateTranslation(vec3 vel,float t0,float t1,float dur){float dt=t1-t0;float d=getIntegrateByTimeFromTime(0.,dt,uGravityModifierValue);vec3 acc=uAcceleration.xyz*d;\n#ifdef SPEED_OVER_LIFETIME\nreturn vel*getIntegrateFromTime0(dt/dur,uSpeedLifetimeValue)*dur+acc;\n#endif\nreturn vel*dt+acc;}mat3 transformFromRotation(vec3 rot,float _life,float _dur){vec3 rotation=rot;\n#ifdef ROT_LIFETIME_AS_MOVEMENT\n#define FUNC1(a) getValueFromTime(_life,a)\n#else\n#define FUNC1(a) getIntegrateFromTime0(_life,a) * _dur\n#endif\n#ifdef ROT_X_LIFETIME\nrotation.x+=FUNC1(uRXByLifeTimeValue);\n#endif\n#ifdef ROT_Y_LIFETIME\nrotation.y+=FUNC1(uRYByLifeTimeValue);\n#endif\n#ifdef ROT_Z_LIFETIME\nrotation.z+=FUNC1(uRZByLifeTimeValue);\n#endif\nif(dot(rotation,rotation)==0.0){return mat3(1.0);}\n#undef FUNC1\nreturn mat3FromRotation(rotation);}void main(){float time=uParams.x-aOffset.z;float dur=aOffset.w;if(time<0.||time>dur){gl_Position=vec4(-3.,-3.,-3.,1.);}else{float life=clamp(time/dur,0.0,1.0);vLife=life;\n#ifdef USE_SPRITE\nUVDetail uvD=getSpriteUV(aOffset.xy,time);vTexCoord=uvD.uv0;vTexCoordBlend=vec4(uvD.uv1,uSprite.w);\n#else\nvTexCoord=aOffset.xy;\n#endif\nvColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(life,0.));\n#endif\n#endif\nvColor.a*=clamp(getValueFromTime(life,uOpacityOverLifetimeValue),0.,1.);vec3 size=vec3(vec2(getValueFromTime(life,uSizeByLifetimeValue)),1.0);\n#ifdef SIZE_Y_BY_LIFE\nsize.y=getValueFromTime(life,uSizeYByLifetimeValue);\n#endif\nvec3 point=transformFromRotation(aRot,life,dur)*(aDirX*size.x+aDirY*size.y);vec3 pt=calculateTranslation(aVel,aOffset.z,uParams.x,dur);vec3 _pos=aPos+pt;\n#if ORB_VEL_X + ORB_VEL_Y + ORB_VEL_Z\n_pos=mat3FromRotation(calOrbitalMov(life,dur))*(_pos-uOrbCenter);_pos+=uOrbCenter;\n#endif\n#if LINEAR_VEL_X + LINEAR_VEL_Y + LINEAR_VEL_Z\n_pos.xyz+=calLinearMov(life,dur);\n#endif\n#ifdef FINAL_TARGET\nfloat force=getValueFromTime(life,uForceCurve);vec4 pos=vec4(mix(_pos,uFinalTarget,force),1.);\n#else\nvec4 pos=vec4(_pos,1.0);\n#endif\n#if RENDER_MODE == 1\npos.xyz+=point;pos=effects_ObjectToWorld*pos;\n#elif RENDER_MODE == 3\npos=effects_ObjectToWorld*pos;pos.xyz+=effects_MatrixV[0].xyz*point.x+effects_MatrixV[2].xyz*point.y;\n#elif RENDER_MODE == 2\npos=effects_ObjectToWorld*pos;pos.xy+=point.xy;\n#elif RENDER_MODE == 0\npos=effects_ObjectToWorld*pos;pos.xyz+=effects_MatrixV[0].xyz*point.x+effects_MatrixV[1].xyz*point.y;\n#endif\ngl_Position=effects_MatrixVP*pos;vSeed=aSeed;gl_PointSize=6.0;\n#ifdef USE_FILTER\nfilterMain(life);\n#endif\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#endif\n}}",Gi="#version 300 es\nprecision mediump float;\n#define SHADER_VERTEX 1\n#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#else\n#endif\n#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n#if CURVE_VALUE_COUNT > 0\n#if LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n#endif\n#else\n#define lookup_curve(i) vec4(0.)\n#endif\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n#define NONE_CONST_INDEX 1\n#ifdef SHADER_VERTEX\nin float aSeed;out float vSeed;\n#endif\n#ifdef SHADER_VERTEX\n#define MAX_C VERT_MAX_KEY_FRAME_COUNT\n#else\n#define MAX_C FRAG_MAX_KEY_FRAME_COUNT\n#endif\nmat4 cubicBezierMatrix=mat4(1.0,-3.0,3.0,-1.0,0.0,3.0,-6.0,3.0,0.0,0.0,3.0,-3.0,0.0,0.0,0.0,1.0);float cubicBezier(float t,float y1,float y2,float y3,float y4){vec4 tVec=vec4(1.0,t,t*t,t*t*t);vec4 yVec=vec4(y1,y2,y3,y4);vec4 result=tVec*cubicBezierMatrix*yVec;return result.x+result.y+result.z+result.w;}float binarySearchT(float x,float x1,float x2,float x3,float x4){float left=0.0;float right=1.0;float mid=0.0;float computedX;for(int i=0;i<8;i++){mid=(left+right)*0.5;computedX=cubicBezier(mid,x1,x2,x3,x4);if(abs(computedX-x)<0.0001){break;}else if(computedX>x){right=mid;}else{left=mid;}}return mid;}float valueFromBezierCurveFrames(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);for(int i=0;i<ITR_END;i+=2){if(i>=count){break;}vec4 k0=lookup_curve(i+start);vec4 k1=lookup_curve(i+1+start);if(i==0&&time<k0.x){return k0.y;}if(i==int(frameCount-2.)&&time>=k1.x){return k1.y;}if(time>=k0.x&&time<=k1.x){float t=(time-k0.x)/(k1.x-k0.x);float nt=binarySearchT(time,k0.x,k0.z,k1.z,k1.x);return cubicBezier(nt,k0.y,k0.w,k1.w,k1.y);}}}float evaluteLineSeg(float t,vec2 p0,vec2 p1){return p0.y+(p1.y-p0.y)*(t-p0.x)/(p1.x-p0.x);}float valueFromLineSegs(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);int end=start+count;for(int i=0;i<ITR_END;i++){if(i>count){return lookup_curve(i).w;}vec4 seg=lookup_curve(i+start);vec2 p0=seg.xy;vec2 p1=seg.zw;if(time>=p0.x&&time<=p1.x){return evaluteLineSeg(time,p0,p1);}vec2 p2=lookup_curve(i+start+1).xy;if(time>p1.x&&time<=p2.x){return evaluteLineSeg(time,p1,p2);}}return lookup_curve(0).y;}float getValueFromTime(float time,vec4 value){float type=value.x;if(type==0.){return value.y;}if(type==1.){return mix(value.y,value.z,time/value.w);}if(type==3.){return valueFromLineSegs(time,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed);}if(type==5.){return valueFromBezierCurveFrames(time,value.z,value.w);}return 0.;}in vec4 aPos;in vec3 aDir;in vec3 aInfo;in vec4 aColor;in float aTime;\n#ifdef ATTR_TRAIL_START\nin float aTrailStart;\n#else\nuniform float uTrailStart[64];in float aTrailStartIndex;\n#endif\nuniform mat4 effects_MatrixInvV;uniform mat4 effects_ObjectToWorld;uniform mat4 effects_MatrixVP;uniform vec4 uTextureMap;uniform float uTime;uniform vec4 uParams;uniform vec4 uColorParams;uniform vec4 uOpacityOverLifetimeValue;uniform vec4 uWidthOverTrail;\n#ifdef COLOR_OVER_TRAIL\nuniform sampler2D uColorOverTrail;\n#endif\n#ifdef COLOR_OVER_LIFETIME\nuniform sampler2D uColorOverLifetime;\n#endif\nout float vLife;out vec2 vTexCoord;out vec4 vColor;\n#ifdef ENV_EDITOR\nuniform vec4 uEditorTransform;\n#endif\nvoid main(){vec4 _pa=effects_MatrixVP*vec4(aPos.xyz,1.);vec4 _pb=effects_MatrixVP*vec4(aPos.xyz+aDir,1.);vec2 dir=normalize(_pb.xy/_pb.w-_pa.xy/_pa.w);vec2 screen_xy=vec2(-dir.y,dir.x);vec4 pos=effects_ObjectToWorld*vec4(aPos.xyz,1.);\n#ifdef ATTR_TRAIL_START\nfloat ts=aTrailStart;\n#else\nfloat ts=uTrailStart[int(aTrailStartIndex)];\n#endif\nfloat trail=(ts-aInfo.y)/uParams.y;float width=aPos.w*getValueFromTime(trail,uWidthOverTrail)/max(abs(screen_xy.x),abs(screen_xy.y));pos.xyz+=(effects_MatrixInvV[0].xyz*screen_xy.x+effects_MatrixInvV[1].xyz*screen_xy.y)*width;float time=min((uTime-aTime)/aInfo.x,1.0);gl_Position=effects_MatrixVP*pos;vColor=aColor;\n#ifdef COLOR_OVER_LIFETIME\n#ifdef ENABLE_VERTEX_TEXTURE\nvColor*=texture2D(uColorOverLifetime,vec2(time,0.));\n#endif\n#endif\n#ifdef COLOR_OVER_TRAIL\nvColor*=texture2D(uColorOverTrail,vec2(trail,0.));\n#endif\nvColor.a*=clamp(getValueFromTime(time,uOpacityOverLifetimeValue),0.,1.);vLife=time;vTexCoord=uTextureMap.xy+vec2(trail,aInfo.z)*uTextureMap.zw;vSeed=aSeed;\n#ifdef ENV_EDITOR\ngl_Position=vec4(gl_Position.xy*uEditorTransform.xy+uEditorTransform.zw*gl_Position.w,gl_Position.zw);\n#endif\n}",Xi="uniform vec4 uTexRange;uniform vec2 uFilterSourceSize;\n#define INTERPOLATION 0\nvec4 filterMain(vec2 texCoord,sampler2D source){float x=uTexRange.x+texCoord.x*uTexRange.y;\n#if INTERPOLATION\nvec2 texInPixel=texCoord*uFilterSourceSize;vec2 coordMin=floor(texInPixel);vec2 pp=texInPixel-coordMin;vec4 fCoord=vec4(coordMin/uFilterSourceSize,(coordMin+vec2(1.))/uFilterSourceSize);vec4 cLT=texture2D(uFilterSource,vec2(fCoord.x,fCoord.w));vec4 cLB=texture2D(uFilterSource,vec2(fCoord.x,fCoord.y));vec4 cRT=texture2D(uFilterSource,vec2(fCoord.z,fCoord.w));vec4 cRB=texture2D(uFilterSource,vec2(fCoord.z,fCoord.y));vec4 color=mix(mix(cLB,cRB,pp.x),mix(cLT,cRT,pp.x),pp.y);\n#else\nvec4 color=texture2D(source,vec2(x,texCoord.y));\n#endif\nx=uTexRange.z+texCoord.x*uTexRange.w;vec4 opacity=texture2D(source,vec2(x,texCoord.y));return vec4(color.rgb,opacity.r);}",Hi="uniform sampler2D uAlphaXSample;uniform sampler2D uAlphaYSample;vec4 filterMain(vec2 texCoord,sampler2D source){vec4 color=texture2D(source,texCoord);float x=texture2D(uAlphaXSample,vec2(vFeatherCoord.x,0.)).r;float y=texture2D(uAlphaYSample,vec2(vFeatherCoord.y,0.)).r;return vec4(color.rgb,color.a*min(x,y));}",Yi="uniform mat4 uMoveCameraViewPro;vec4 filterMain(float p,vec4 pos){return uMoveCameraViewPro*pos;}",ji="uniform sampler2D uLastSource;uniform vec4 uParams;vec4 filterMain(vec2 coord,sampler2D tex){vec4 c1=texture2D(tex,coord);if(uParams.x<1.){return c1;}vec4 c2=texture2D(uLastSource,coord);return mix(c1,c2,uParams.y);}",Wi="uniform vec4 uWaveParams;\n#ifdef PATICLE_SHADER\nin vec4 vWaveParams;\n#else\nuniform vec4 vWaveParams;\n#endif\nvec4 filterMain(vec2 texCoord,sampler2D tex){vec2 vp=texCoord-uWaveParams.xy;float xx=dot(vp,uWaveParams.zw);float d=sin(vWaveParams.x*xx+vWaveParams.y)*vWaveParams.z;vec2 up=vec2(-uWaveParams.w,uWaveParams.z)*d;return texture2D(tex,clamp(texCoord+up,0.,1.));}",Zi="uniform vec4 uMovementValue;uniform vec4 uStrengthValue;uniform vec4 uPeriodValue;out vec4 vWaveParams;void filterMain(float lifetime){const float pi2=3.14159265;vWaveParams=vec4(getValueFromTime(lifetime,uPeriodValue)*pi2,getValueFromTime(lifetime,uMovementValue)*pi2,getValueFromTime(lifetime,uStrengthValue),0.);}",qi="uniform sampler2D uBloomBlur;uniform vec4 uBloomParams;vec4 filterMain(vec2 coord,sampler2D tex){const vec3 gamma=vec3(1./2.2);vec4 c1=texture2D(tex,coord);vec4 bloomColor=texture2D(uBloomBlur,coord);float alpha=max(c1.a,bloomColor.a);vec3 color=max(c1.rgb*c1.a,bloomColor.rgb*bloomColor.a)/alpha*uBloomParams.y+bloomColor.rgb*uBloomParams.x;return vec4(color,alpha);}",Ki="uniform vec4 uColorThreshold;vec4 filterMain(vec2 coord,sampler2D tex){vec4 c1=texture2D(tex,coord);vec3 color=c1.rgb*c1.a;vec3 s=step(uColorThreshold.xyz,color);float m=min(s.r+s.g+s.b,1.);return c1*m;}",Qi="precision highp float;attribute vec2 aPos;varying vec2 uv;void main(){gl_Position=vec4(aPos,0.,1.0);uv=(aPos+vec2(1.0))/2.;}",Ji="precision highp float;\n#define HALF_MAX 60000.0\n#define ACEScc_MIDGRAY 0.4135884\nvarying vec2 uv;uniform sampler2D _GaussianTex;uniform sampler2D _SceneTex;uniform float _BloomIntensity;uniform float _Brightness;uniform float _Saturation;uniform float _Contrast;uniform bool _UseBloom;uniform bool _UseToneMapping;mat3 LinearToACES=mat3(0.59719,0.07600,0.02840,0.35458,0.90834,0.13383,0.04823,0.01566,0.83777);mat3 ACESToLinear=mat3(1.60475,-0.10208,-0.00327,-0.53108,1.10813,-0.07276,-0.07367,-0.00605,1.07602);float log10(float x){return log(x)/log(10.0);}vec3 log10(vec3 v){return vec3(log10(v.x),log10(v.y),log10(v.z));}vec3 LinearToLogC(vec3 x){return 0.244161*log10(5.555556*x+0.047996)+0.386036;}vec3 LogCToLinear(vec3 x){return(pow(vec3(10.0),(x-0.386036)/0.244161)-0.047996)/5.555556;}vec3 rrt_and_odt_fit(vec3 col){vec3 a=col*(col+0.0245786)-0.000090537;vec3 b=col*(0.983729*col+0.4329510)+0.238081;return a/b;}vec3 ACESToneMapping(vec3 col){vec3 aces=LinearToACES*col;aces=rrt_and_odt_fit(aces);col=ACESToLinear*aces;return col;}vec3 LinearToSrgb(vec3 c){return mix(1.055*pow(c,vec3(1./2.4))-0.055,12.92*c,step(c,vec3(0.0031308)));}vec3 GammaCorrection(vec3 c){return pow(c,vec3(1.0/2.2));}void main(){vec4 hdrColor=texture2D(_SceneTex,uv);hdrColor.rgb=pow(hdrColor.rgb,vec3(2.2));vec3 finalColor=hdrColor.rgb;if(_UseBloom){vec4 bloomColor=texture2D(_GaussianTex,uv);bloomColor.rgb*=_BloomIntensity;finalColor+=bloomColor.rgb;}finalColor=finalColor*_Brightness;vec3 colorLog=LinearToLogC(finalColor);colorLog=(colorLog-ACEScc_MIDGRAY)*_Contrast+ACEScc_MIDGRAY;finalColor=LogCToLinear(colorLog);finalColor=max(finalColor,0.0);float luminance=0.2125*finalColor.r+0.7154*finalColor.g+0.0721*finalColor.b;vec3 luminanceColor=vec3(luminance,luminance,luminance);finalColor=(finalColor-luminanceColor)*_Saturation+luminanceColor;finalColor=max(finalColor,0.0);if(_UseToneMapping){finalColor=ACESToneMapping(finalColor);}gl_FragColor=vec4(clamp(GammaCorrection(finalColor),0.0,1.0),1.0);}",$i="precision highp float;varying vec2 uv;uniform sampler2D _MainTex;uniform vec2 _TextureSize;vec3 GaussH(sampler2D tex,vec2 uv){vec3 color=vec3(0.0);float offsets[9];offsets[0]=-4.0;offsets[1]=-3.0;offsets[2]=-2.0;offsets[3]=-1.0;offsets[4]=0.0;offsets[5]=1.0;offsets[6]=2.0;offsets[7]=3.0;offsets[8]=4.0;float weights[9];weights[0]=0.01621622;weights[1]=0.05405405;weights[2]=0.12162162;weights[3]=0.19459459;weights[4]=0.22702703;weights[5]=0.19459459;weights[6]=0.12162162;weights[7]=0.05405405;weights[8]=0.01621622;for(int i=0;i<9;i++){vec2 offset=vec2(offsets[i]*2.0*(1.0/_TextureSize.x),0);color+=texture2D(tex,uv+offset).rgb*weights[i];}return color;}void main(){vec3 color=GaussH(_MainTex,uv);gl_FragColor=vec4(color,1.0);}",tn="precision highp float;varying vec2 uv;uniform sampler2D _MainTex;uniform vec2 _TextureSize;vec3 GaussV(sampler2D tex,vec2 uv){vec3 color=vec3(0.0);float offsets[5];offsets[0]=-3.23076923;offsets[1]=-1.38461538;offsets[2]=0.0;offsets[3]=1.38461538;offsets[4]=3.23076923;float weights[5];weights[0]=0.07027027;weights[1]=0.31621622;weights[2]=0.22702703;weights[3]=0.31621622;weights[4]=0.07027027;for(int i=0;i<5;i++){vec2 offset=vec2(0,offsets[i]*(1.0/_TextureSize.y));color+=texture2D(tex,uv+offset).rgb*weights[i];}return color;}void main(){vec3 color=GaussV(_MainTex,uv);gl_FragColor=vec4(color,1.0);}",en="precision highp float;varying vec2 uv;uniform sampler2D _MainTex;uniform sampler2D _GaussianDownTex;uniform vec2 _GaussianDownTextureSize;float GaussWeight2D(float x,float y,float sigma){float PI=3.14159265358;float E=2.71828182846;float sigma_2=pow(sigma,2.0);float a=-(x*x+y*y)/(2.0*sigma_2);return pow(E,a)/(2.0*PI*sigma_2);}vec3 GaussNxN(sampler2D tex,vec2 uv,vec2 stride,float sigma){vec3 color=vec3(0.,0.,0.);const int r=1;float weight=0.0;for(int i=-r;i<=r;i++){for(int j=-r;j<=r;j++){float w=GaussWeight2D(float(i),float(j),sigma);vec2 coord=uv+vec2(i,j)*stride;color+=texture2D(tex,coord).rgb*w;weight+=w;}}color/=weight;return color;}void main(){vec3 lowResColor=GaussNxN(_MainTex,uv,0.5/_GaussianDownTextureSize,1.0);vec3 highResColor=GaussNxN(_GaussianDownTex,uv,1.0/_GaussianDownTextureSize,1.0);vec3 color=mix(highResColor,lowResColor,0.7);gl_FragColor=vec4(color,1.0);}",rn="precision highp float;varying vec2 uv;uniform sampler2D _MainTex;uniform float _Threshold;void main(){vec4 mainColor=texture2D(_MainTex,uv);mainColor.rgb=pow(mainColor.rgb,vec3(2.2));float brightness=max(mainColor.r,max(mainColor.g,mainColor.b));float w=max(0.0,brightness-_Threshold)/max(brightness,0.00001);mainColor.rgb*=w;gl_FragColor=vec4(mainColor.rgb,1.0);}",nn=function(e){function i(r,i){var n=e.call(this,r,i)||this,o=n.renderer.engine,s=bi.create(o,{mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),a=ui.create(o,{shader:{vertex:Qi,fragment:rn,glslVersion:t.GLSLVersion.GLSL1}});return a.blending=!1,a.depthTest=!1,a.culling=!1,n.screenMesh=Li.create(o,{geometry:s,material:a,priority:0}),n.priority=5e3,n}return r(i,e),i.prototype.configure=function(t){this.mainTexture=t.getFrameBuffer().getColorTextures()[0],this.sceneTextureHandle.texture=this.mainTexture,t.setFrameBuffer(this.frameBuffer)},i.prototype.execute=function(e){e.clear({colorAction:t.TextureStoreAction.clear,depthAction:t.TextureStoreAction.clear,stencilAction:t.TextureStoreAction.clear}),this.screenMesh.material.setTexture("_MainTex",this.mainTexture);var r=e.renderingData.currentFrame.globalVolume.threshold;this.screenMesh.material.setFloat("_Threshold",r),e.renderMeshes([this.screenMesh])},i}(Ni),on=function(e){function i(r,i,n){var o=e.call(this,r,n)||this;o.type=i;var s=o.renderer.engine,a="PostProcess",u=bi.create(s,{name:a,mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),c={vertex:Qi,fragment:"H"==i?$i:tn,glslVersion:t.GLSLVersion.GLSL1},l=ui.create(s,{name:a,shader:c});return l.blending=!1,l.depthTest=!1,l.culling=!1,o.screenMesh=Li.create(s,{name:a,geometry:u,material:l,priority:0}),o.priority=5e3,o}return r(i,e),i.prototype.configure=function(t){this.mainTexture=t.getFrameBuffer().getColorTextures()[0],t.setFrameBuffer(this.frameBuffer)},i.prototype.execute=function(e){e.clear({colorAction:t.TextureStoreAction.clear,depthAction:t.TextureStoreAction.clear,stencilAction:t.TextureStoreAction.clear}),this.screenMesh.material.setTexture("_MainTex",this.mainTexture),this.screenMesh.material.setVector2("_TextureSize",fn(this.mainTexture)),e.renderMeshes([this.screenMesh]),"V"===this.type&&(this.gaussianResult.texture=e.getFrameBuffer().getColorTextures()[0])},i}(Ni),sn=function(e){function i(t,r){var i=e.call(this,t,r)||this,n="PostProcess",o=i.renderer.engine,s=bi.create(o,{name:n,mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),a={vertex:Qi,fragment:en},u=ui.create(o,{name:n,shader:a});return u.blending=!1,u.depthTest=!1,u.culling=!1,i.screenMesh=Li.create(o,{name:n,geometry:s,material:u,priority:0}),i.priority=5e3,i}return r(i,e),i.prototype.configure=function(t){this.mainTexture=t.getFrameBuffer().getColorTextures()[0],t.setFrameBuffer(this.frameBuffer)},i.prototype.execute=function(e){e.clear({colorAction:t.TextureStoreAction.clear,depthAction:t.TextureStoreAction.clear,stencilAction:t.TextureStoreAction.clear}),this.screenMesh.material.setTexture("_MainTex",this.mainTexture),this.screenMesh.material.setTexture("_GaussianDownTex",this.gaussianDownSampleResult.texture),this.screenMesh.material.setVector2("_GaussianDownTextureSize",fn(this.gaussianDownSampleResult.texture)),e.renderMeshes([this.screenMesh])},i}(Ni),an=function(e){function i(r,i){var n=e.call(this,r,{})||this,o="PostProcess",s=n.renderer.engine;n.sceneTextureHandle=i||new Fi(s);var a=bi.create(s,{name:o,mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),u=ui.create(s,{name:o,shader:{vertex:Qi,fragment:Ji,glslVersion:t.GLSLVersion.GLSL1}});return u.blending=!1,u.depthTest=!1,u.culling=!1,n.screenMesh=Li.create(s,{name:o,geometry:a,material:u,priority:0}),n.priority=5e3,n}return r(i,e),i.prototype.configure=function(t){this.mainTexture=t.getFrameBuffer().getColorTextures()[0],this.sceneTextureHandle.texture||(this.sceneTextureHandle.texture=this.mainTexture),t.setFrameBuffer(null)},i.prototype.execute=function(e){e.clear({colorAction:t.TextureStoreAction.clear,depthAction:t.TextureStoreAction.clear,stencilAction:t.TextureStoreAction.clear});var r=e.renderingData.currentFrame.globalVolume,i=r.bloomIntensity,n=r.brightness,o=r.saturation,s=r.contrast,a=r.useBloom,u=r.useToneMapping;this.screenMesh.material.setTexture("_SceneTex",this.sceneTextureHandle.texture),this.screenMesh.material.setFloat("_Brightness",n),this.screenMesh.material.setFloat("_Saturation",o),this.screenMesh.material.setFloat("_Contrast",s),this.screenMesh.material.setInt("_UseBloom",a),a&&(this.screenMesh.material.setTexture("_GaussianTex",this.mainTexture),this.screenMesh.material.setFloat("_BloomIntensity",i)),this.screenMesh.material.setInt("_UseToneMapping",u),e.renderMeshes([this.screenMesh])},i}(Ni),un={useHDR:!1,usePostProcessing:!1,useBloom:1,threshold:1,bloomIntensity:1,brightness:1,saturation:1,contrast:1,useToneMapping:1},cn="_effects_default_",ln=1,hn=function(){function e(e){var r;this.destroyed=!1,this.renderPassInfoMap=new WeakMap;var n=e.camera,o=e.keepColorBuffer,s=e.renderer,a=e.editorTransform,u=void 0===a?[1,1,0,0]:a,c=e.globalVolume,l=e.clearAction,h=void 0===l?{colorAction:t.TextureLoadAction.whatever,stencilAction:t.TextureLoadAction.clear,depthAction:t.TextureLoadAction.whatever}:l,f=s.engine;c&&(this.globalVolume=i(i({},un),c)),this.globalUniforms=new dn;var p,d=[],m={};if(this.renderer=s,this.globalVolume){var y=this.globalVolume.useHDR?v.HALF_FLOAT:v.UNSIGNED_BYTE;d=[{texture:{format:v.RGBA,type:y,magFilter:v.LINEAR,minFilter:v.LINEAR}}],p={storageType:t.RenderPassAttachmentStorageType.depth_stencil_opaque},m={colorAction:t.TextureLoadAction.clear,stencilAction:t.TextureLoadAction.clear,depthAction:t.TextureLoadAction.clear}}var g=[new Ni(s,{name:cn,priority:Ii,meshOrder:t.OrderType.ascending,depthStencilAttachment:p,attachments:d,clearAction:m})];if(this.setRenderPasses(g),this.globalVolume){var x=this.globalVolume.useBloom,T=new Fi(f);if(x){var E=[0,0,this.renderer.getWidth()/2,this.renderer.getHeight()/2],b=new Array(7),S=(y=this.globalVolume.useHDR?v.HALF_FLOAT:v.UNSIGNED_BYTE,new nn(s,{name:"BloomThresholdPass",attachments:[{texture:{format:v.RGBA,type:y,minFilter:v.LINEAR,magFilter:v.LINEAR}}]}));S.sceneTextureHandle=T,this.addRenderPass(S);for(var A=0;A<7;A++){b[A]=new Fi(f);var R=new on(s,"H",{name:"GaussianDownPassH"+A,viewport:E,attachments:[{texture:{format:v.RGBA,type:y,minFilter:v.LINEAR,magFilter:v.LINEAR}}]}),C=new on(s,"V",{name:"GaussianDownPassV"+A,viewport:E,attachments:[{texture:{format:v.RGBA,type:y,minFilter:v.LINEAR,magFilter:v.LINEAR}}]});C.gaussianResult=b[A],this.addRenderPass(R),this.addRenderPass(C),E[2]/=2,E[3]/=2}for(E[2]*=4,E[3]*=4,A=0;A<6;A++){var _=new sn(s,{name:"GaussianUpPass"+A,viewport:E,attachments:[{texture:{format:v.RGBA,type:y,minFilter:v.LINEAR,magFilter:v.LINEAR}}]});_.gaussianDownSampleResult=b[5-A],this.addRenderPass(_),E[2]*=2,E[3]*=2}}var w=void 0;w=x?new an(s,T):new an(s),this.addRenderPass(w)}this.semantics=new Ti(e.semantics),this.clearAction=h,this.name="RenderFrame".concat(ln++);var O=g[0],M={type:v.UNSIGNED_BYTE,format:v.RGBA,internalFormat:v.RGBA,wrapS:v.MIRRORED_REPEAT,wrapT:v.MIRRORED_REPEAT,minFilter:v.NEAREST,magFilter:v.NEAREST};this.emptyTexture=qr.create(f,i({data:{width:1,height:1,data:new Uint8Array([255,255,255,255])},sourceType:t.TextureSourceType.data},M)),this.transparentTexture=qr.create(f,i({data:{width:1,height:1,data:new Uint8Array([0,0,0,0])},sourceType:t.TextureSourceType.data},M)),this.camera=n,this.keepColorBuffer=o,this.renderPassInfoMap.set(O,{listStart:0,listEnd:0,renderPass:O,intermedia:!1}),this.editorTransform=kt.fromArray(u),e.clearAction||this.resetClearActions(),this.passTextureCache=new xi(f);var L=f.gpuCapability,I=L.detail,P=mi(L.level,I.readableDepthStencilTextures&&I.writableFragDepth);null===(r=this.renderer.getShaderLibrary())||void 0===r||r.addShader(P)}return Object.defineProperty(e.prototype,"renderPasses",{get:function(){return this._renderPasses.slice()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),e.prototype.addMeshToDefaultRenderPass=function(t){for(var e=this.renderPasses,r=this.renderPassInfoMap,i=t.priority,n=1;n<e.length;n++){var o=e[n-1],s=r.get(e[n]),a=r.get(o);if(s&&a&&s.listStart>i&&(i>a.listEnd||1===n))return this.addToRenderPass(o,t)}for(var u=e.length-1,c=e[u];u>=0&&!c.name.includes(cn);)c=e[--u];return this.addToRenderPass(c,t)},e.prototype.removeMeshFromDefaultRenderPass=function(e){for(var r,n,o,s=this,a=this.renderPasses,u=this.renderPassInfoMap,c=a.length-1;c>=0;c--){var l=a[c],h=u.get(l);if(h&&h.listStart<=e.priority&&h.listEnd>=e.priority){var f=l.meshes.indexOf(e);if(-1===f)return;var p=1===f&&l.meshes[0].name===hi;if(l.removeMesh(e),p){var d=a[c+1],m=l.meshes;h.intermedia||null===(r=h.preRenderPass)||void 0===r||r.resetColorAttachments([]);for(var v=1;v<m.length;v++)null===(n=h.preRenderPass)||void 0===n||n.addMesh(m[v]);var y=null===(o=l.attachments[0])||void 0===o?void 0:o.texture,g=y===this.resource.color_a||y===this.resource.color_b;l.dispose({meshes:t.DestroyOptions.keep,colorAttachment:g?t.RenderPassDestroyAttachmentType.keep:t.RenderPassDestroyAttachmentType.destroy,depthStencilAttachment:t.RenderPassDestroyAttachmentType.keep}),it(a,l),this.removeRenderPass(l),u.delete(l),d&&this.updateRenderInfo(d),h.preRenderPass&&this.updateRenderInfo(h.preRenderPass),h.prePasses&&h.prePasses.forEach((function(e){if(s.removeRenderPass(e.pass),!1!==(null==e?void 0:e.destroyOptions)){e.pass.attachments.forEach((function(t){t.texture===s.resource.color_b&&t.texture===s.resource.color_a||t.texture.dispose()}));var r=i(i({},(null==e?void 0:e.destroyOptions)?e.destroyOptions:{}),{depthStencilAttachment:t.RenderPassDestroyAttachmentType.keep});e.pass.dispose(r)}})),this.resetRenderPassDefaultAttachment(a,Math.max(c-1,0)),1===a.length&&(a[0].resetColorAttachments([]),this.removeRenderPass(this.resource.finalCopyRP))}return this.resetClearActions()}}},e.prototype.splitDefaultRenderPassByMesh=function(e,r){var i,n,o,s=this.findMeshRenderPassIndex(e),c=this.renderPasses[s];this.createResource();var l=c.meshes.indexOf(e),h=c.meshes.slice(0,l),f=c.meshes.slice(l),p=this.renderPassInfoMap;if(!(null===(i=r.attachments)||void 0===i?void 0:i.length))throw Error("should include at least one color attachment");var d=this.renderPasses,m=d.indexOf(c);d[m-1],it(d,c);var y=p.get(c);p.delete(c);var g=2===this.renderer.engine.gpuCapability.level?v.LINEAR:v.NEAREST,x=new Ni(this.renderer,{name:cn+m,priority:c.priority,attachments:[{texture:{sourceType:t.TextureSourceType.framebuffer,format:v.RGBA,name:"frame_a",minFilter:g,magFilter:g}}],clearAction:c.clearAction||{colorAction:t.TextureLoadAction.clear},storeAction:c.storeAction,depthStencilAttachment:this.resource.depthStencil,meshes:h,meshOrder:t.OrderType.ascending});f.unshift(this.createCopyMesh());var T=this.renderPasses;T[s]=x;var E=[],b=f.slice();r.prePasses&&(r.prePasses.forEach((function(t,e){t.priority=c.priority+1+e,t.setMeshes(f),E.push(t)})),T.splice.apply(T,u([s+1,0],a(E),!1)),b.splice(0,2));var S=this.resource.finalCopyRP;T.includes(S)||T.push(S);var A=E[E.length-1];A.initialize(this.renderer);var R=new Ni(this.renderer,{name:cn+(m+1),priority:c.priority+1+((null===(n=r.prePasses)||void 0===n?void 0:n.length)||0),meshes:b,meshOrder:t.OrderType.ascending,depthStencilAttachment:this.resource.depthStencil,storeAction:r.storeAction,clearAction:{depthAction:t.TextureLoadAction.whatever,stencilAction:t.TextureLoadAction.whatever,colorAction:t.TextureLoadAction.whatever}});return T.splice(s+1+((null===(o=r.prePasses)||void 0===o?void 0:o.length)||0),0,R),this.setRenderPasses(T),this.updateRenderInfo(A),this.updateRenderInfo(x),this.updateRenderInfo(R),p.get(x).prePasses=y.prePasses,E.pop(),p.get(A).prePasses=E.map((function(t,e){return{pass:t,destroyOptions:!1}})),this.resetClearActions(),A},e.prototype.dispose=function(e){var r,i;(null==e?void 0:e.semantics)!==t.DestroyOptions.keep&&this.semantics.dispose();var n=(null==e?void 0:e.passes)?e.passes:void 0;n!==t.DestroyOptions.keep&&this._renderPasses.forEach((function(t){t.dispose(n)})),this.passTextureCache.dispose(),this._renderPasses.length=0,this.emptyTexture.dispose(),this.transparentTexture.dispose(),this.resource&&(this.resource.color_a.dispose(),this.resource.color_b.dispose(),null===(i=null===(r=this.resource.depthStencil)||void 0===r?void 0:r.texture)||void 0===i||i.dispose(),this.resource.finalCopyRP.dispose(),this.resource.resRP.dispose(),this.resource=null),this.destroyed=!0},e.prototype.resetRenderPassDefaultAttachment=function(t,e){for(var r,i,n,o=this.resource,s=o.color_a,a=o.color_b,u=e;u<t.length;u++){var c=t[u],l=null===(r=c.attachments[0])||void 0===r?void 0:r.texture;if(l&&n===l){var h=l===s?a:s;c.resetColorAttachments([h])}(l=null===(i=c.attachments[0])||void 0===i?void 0:i.texture)&&(n=l)}},e.prototype.findMeshRenderPassIndex=function(t){var e=-1;return this.renderPasses.every((function(r,i){return!r.name.startsWith(cn)||!r.meshes.includes(t)||(e=i,!1)})),e},e.prototype.addToRenderPass=function(t,e){var r=this.renderPassInfoMap.get(t),i=e.priority;0===t.meshes.length?r.listStart=r.listEnd=i:i<r.listStart?r.listStart=i:i>r.listEnd&&(r.listEnd=i),t.addMesh(e)},e.prototype.getRPAttachments=function(t,e){var r;if(1===(null==t?void 0:t.length)){var i=t[0],n=i.texture,o=i.persistent,s=n.format,a=null!==(r=null==e?void 0:e.getInitAttachments())&&void 0!==r?r:[];if(s===v.RGBA&&!o){var u=this.resource.color_a;return 0===a.length?[{texture:u}]:[{texture:a[0].texture===u?this.resource.color_b:u}]}}return t},e.prototype.resetClearActions=function(){var e=this.renderPasses.length>1?t.TextureLoadAction.clear:t.TextureLoadAction.whatever;this.clearAction.stencilAction=e,this.clearAction.depthAction=e,this.clearAction.colorAction=e,this.keepColorBuffer&&(this.clearAction.colorAction=t.TextureLoadAction.whatever)},e.prototype.updateRenderInfo=function(e){var r,i=this,n=this.renderPassInfoMap,o=this.renderPasses;n.has(e)?r=n.get(e):(r={intermedia:!1,renderPass:e,listStart:0,listEnd:0},n.set(e,r)),r.intermedia=e.attachments.length>0;var s=e.meshes;s[0]?(r.listStart=(s[0].name===hi?s[1]:s[0]).priority,r.listEnd=s[s.length-1].priority):(r.listStart=0,r.listEnd=0);var a=o.indexOf(e),u=0===a?t.TextureLoadAction.clear:t.TextureLoadAction.whatever;return 0===a&&(e.clearAction.colorAction=t.TextureLoadAction.clear),e.clearAction.depthAction=u,e.clearAction.stencilAction=u,a>-1?e.semantics.setSemantic("EDITOR_TRANSFORM",(function(){return i.editorTransform})):e.semantics.setSemantic("EDITOR_TRANSFORM",void 0),r.preRenderPass=o[a-1],r},e.prototype.setRenderPasses=function(t){var e=this;void 0!==this.renderer&&t.forEach((function(t){return t.initialize(e.renderer)})),this._renderPasses=t.slice()},e.prototype.addRenderPass=function(t){void 0!==this.renderer&&t.initialize(this.renderer),this._renderPasses.push(t)},e.prototype.createResource=function(){var e,r=this.renderer.engine;if(!this.resource){var i=r.gpuCapability,n=i.detail,o=i.level,s=this.renderer.getWidth(),a=this.renderer.getHeight(),u=2===o?v.LINEAR:v.NEAREST,c=qr.create(r,{sourceType:t.TextureSourceType.framebuffer,format:v.RGBA,name:"frame_a",minFilter:u,magFilter:u}),l=qr.create(r,{sourceType:t.TextureSourceType.framebuffer,format:v.RGBA,data:{width:s,height:a},minFilter:u,magFilter:u,name:"frame_b"}),h=n.readableDepthStencilTextures&&n.writableFragDepth?t.RenderPassAttachmentStorageType.depth_24_stencil_8_texture:t.RenderPassAttachmentStorageType.depth_stencil_opaque,f=new Ni(this.renderer,{depthStencilAttachment:{storageType:h},attachments:[{texture:c}]}).initialize(this.renderer),p=new pn(this.renderer,{name:"effects-final-copy",priority:1600,clearAction:{depthAction:t.TextureLoadAction.clear,stencilAction:t.TextureLoadAction.clear,colorAction:t.TextureLoadAction.clear},meshOrder:t.OrderType.ascending,meshes:[this.createCopyMesh({blend:!0,depthTexture:null===(e=f.getDepthAttachment())||void 0===e?void 0:e.texture})]});this.resource={color_a:f.attachments[0].texture,color_b:l,finalCopyRP:p,depthStencil:f.depthAttachment,resRP:f}}},e.prototype.createCopyMesh=function(t){var e=hi,r=this.renderer.engine,i=bi.create(r,{name:e,mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),n=mi(r.gpuCapability.level,!!(null==t?void 0:t.depthTexture));this.renderer.getShaderLibrary().addShader(n);var o=ui.create(r,{uniformValues:{uDepth:null==t?void 0:t.depthTexture},name:e,shader:n});return o.blending=!1,o.depthTest=!1,o.culling=!1,(null==t?void 0:t.blend)&&(o.blending=!0,o.blendFunction=[v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA,v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA]),Li.create(r,{name:e,geometry:i,material:o,priority:0})},e.prototype.removeRenderPass=function(t){it(this._renderPasses,t)},e}();function fn(t){return t?new Lt(t.getWidth(),t.getHeight()):new Lt}var pn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.configure=function(t){this.prePassTexture=t.getFrameBuffer().getColorTextures()[0],t.setFrameBuffer(null)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[0].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[0].material.setVector2("uFilterSourceSize",fn(this.prePassTexture)),t.renderMeshes(this.meshes),this.storeAction&&t.clear(this.storeAction)},e}(Ni),dn=function(){this.floats={},this.ints={},this.matrices={},this.samplers=[],this.uniforms=[]},mn=function(){function t(t){this.size=[0,0],this.multiSample=1,this.destroyed=!1;var e=t.storageType,r=t.format,i=t.attachment;this.storageType=e,this.format=r,this.attachment=i}return Object.defineProperty(t.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),t}(),vn="function"==typeof WebGL2RenderingContext,yn=function(){function t(t){this.setupCapability(t)}return t.prototype.setupCapability=function(t){var e,r=vn&&t instanceof WebGL2RenderingContext?2:1,i=2===r,n=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),o=t.getExtension("WEBGL_depth_texture"),s=!!t.getExtension("OES_texture_half_float_linear"),a=!!t.getExtension("OES_texture_float_linear");this.level=r,this.type=i?"webgl2":"webgl",this.vaoExt=t.getExtension("OES_vertex_array_object"),this.glAsyncCompileExt=t.getExtension("KHR_parallel_shader_compile"),this.UNSIGNED_INT_24_8=t.UNSIGNED_INT_24_8,this.drawBufferExtension=t.getExtension("WEBGL_draw_buffers"),o&&(this.UNSIGNED_INT_24_8=o.UNSIGNED_INT_24_8_WEBGL),i&&!s&&(s=gn(t,t.HALF_FLOAT)),i&&!a&&(a=gn(t,t.FLOAT)),this.internalFormatDepth16=i?t.DEPTH_COMPONENT16:t.DEPTH_COMPONENT,this.internalFormatDepth24_stencil8=i?t.DEPTH24_STENCIL8:t.DEPTH_STENCIL;var u=i||t.getExtension("OES_texture_float")?t.FLOAT:0,c=i?WebGL2RenderingContext.HALF_FLOAT:(null===(e=t.getExtension("OES_texture_half_float"))||void 0===e?void 0:e.HALF_FLOAT_OES)||0,l={floatTexture:u,halfFloatTexture:c,maxSample:i?t.getParameter(t.MAX_SAMPLES):1,maxVertexUniforms:t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),maxVertexTextures:t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxFragmentUniforms:t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),maxFragmentTextures:t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),floatColorAttachment:i?!!t.getExtension("EXT_color_buffer_float"):u>0&&!!t.getExtension("WEBGL_color_buffer_float"),halfFloatColorAttachment:i?!!t.getExtension("EXT_color_buffer_float"):c>0&&!!t.getExtension("EXT_color_buffer_half_float"),maxTextureSize:t.getParameter(t.MAX_TEXTURE_SIZE),maxShaderTexCount:t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),compressedTexture:bn(t),halfFloatLinear:s,floatLinear:a,maxTextureAnisotropy:n?t.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,shaderTextureLod:i||!!t.getExtension("EXT_shader_texture_lod"),instanceDraw:i||!!t.getExtension("ANGLE_instanced_arrays"),drawBuffers:i||!!this.drawBufferExtension,asyncShaderCompile:!!t.getExtension("KHR_parallel_shader_compile"),intIndexElementBuffer:!!t.getExtension("OES_element_index_uint"),standardDerivatives:i||!!t.getExtension("OES_standard_derivatives"),readableDepthStencilTextures:i||!!o,writableFragDepth:i||!!t.getExtension("EXT_frag_depth")};this.detail=l,n&&(this.textureMaxAnisotropyExt=n.TEXTURE_MAX_ANISOTROPY_EXT)},t.prototype.framebufferTexture2D=function(t,e,r,i,n){var o=this.drawBufferExtension;if(1===this.level&&!o&&r>0)throw new Error("draw multiple color buffers not available");var s=o?o["COLOR_ATTACHMENT".concat(r,"_WEBGL")]:t["COLOR_ATTACHMENT".concat(r)];s?t.framebufferTexture2D(e,s,i,n,0):console.error("invalid color attachment index: "+r)},t.prototype.drawBuffers=function(t,e){var r=this.drawBufferExtension;if(1!==this.level||r){var i=e.map((function(e,i){return e?r?r["COLOR_ATTACHMENT".concat(i,"_WEBGL")]:t["COLOR_ATTACHMENT".concat(i)]:t.NONE}));r?r.drawBuffersWEBGL(i):t.drawBuffers(i)}else if(e.length>1)throw Error("draw buffers not available")},t.prototype.setTextureAnisotropic=function(t,e,r){var i=this.detail.maxTextureAnisotropy;i&&t.texParameterf(e,this.textureMaxAnisotropyExt,Math.min(i,r||4))},t}();function gn(t,e){var r=t.createTexture(),i=!1;return t.getError(),t.bindTexture(t.TEXTURE_2D,r),t.texImage2D(t.TEXTURE_2D,0,t.R16F,1,1,0,t.RED,e,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.getError()||(i=!0),t.deleteTexture(r),i}var xn,Tn,En={NONE:0,PVRTC:1,ASTC:2};function bn(t){return t.getExtension("WEBGL_compressed_texture_astc")?En.ASTC:t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc")?En.PVRTC:En.NONE}t.FilterMode=void 0,(xn=t.FilterMode||(t.FilterMode={}))[xn.Nearest=0]="Nearest",xn[xn.Linear=1]="Linear",t.RenderTextureFormat=void 0,(Tn=t.RenderTextureFormat||(t.RenderTextureFormat={}))[Tn.RGBA32=0]="RGBA32",Tn[Tn.RGBAHalf=1]="RGBAHalf";var Sn=function(){function t(){}return t.prototype.resize=function(t,e,r,i){},t.prototype.resetColorTextures=function(t){},t.prototype.unbind=function(){},t.prototype.bind=function(){},Object.defineProperty(t.prototype,"stencilStorage",{get:function(){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"depthStorage",{get:function(){},enumerable:!1,configurable:!0}),t.prototype.getDepthTexture=function(){},t.prototype.getStencilTexture=function(){},t.prototype.getColorTextures=function(){return[]},t.prototype.dispose=function(t){},t}(),An=function(){function t(){}return t.prototype.setGlobalFloat=function(t,e){},t.prototype.setGlobalInt=function(t,e){},t.prototype.setGlobalMatrix=function(t,e){},t.prototype.getFrameBuffer=function(){return null},t.prototype.setFrameBuffer=function(t){},t.prototype.setViewport=function(t,e,r,i){},t.prototype.resize=function(t,e){},t.prototype.clear=function(t){},t.prototype.getWidth=function(){return 0},t.prototype.getHeight=function(){return 0},t.prototype.addLostHandler=function(t){},t.prototype.addRestoreHandler=function(t){},t.prototype.lost=function(t){},t.prototype.restore=function(){},t.prototype.getShaderLibrary=function(){},t.prototype.renderRenderFrame=function(t){},t.prototype.renderMeshes=function(t){},t.prototype.drawGeometry=function(t,e){},t.prototype.getTemporaryRT=function(t,e,r,i,n,o){return null},t.prototype.dispose=function(t){},t}(),Rn=1,Cn=function(){function e(t,e,r,i){this.transform=r,this.engine=i,this.color=t.options.previewColor;var n=this.createMaterial(e),o=this.createGeometry();this.mesh=this.createMesh(o,n),this.updateMesh()}return e.prototype.updateMesh=function(){var t=this.mesh.material,e=t.getVector2("uSize").clone(),r=t.getVector4("uPos").clone(),i=new It,n=new Pt,o=this.transform.scale.clone();this.transform.assignWorldTRS(i,n,o),e.x=o.x,e.y=o.y,r.x=i.x,r.y=i.y,r.z=i.z,t.setVector2("uSize",e),t.setVector4("uPos",r),t.setQuaternion("uQuat",n)},e.prototype.createMaterial=function(e){var r,i=[["ENV_EDITOR",(null===(r=this.engine.renderer)||void 0===r?void 0:r.env)===l]],n=Be(this.color).getValue(0),o=this.engine.gpuCapability.level,s={shader:{vertex:Nr(i,"\nprecision highp float;\n\nattribute vec2 aPoint;\nuniform vec4 uPos;\nuniform vec2 uSize;\nuniform vec4 uQuat;\nuniform vec4 uColor;\nuniform mat4 effects_ObjectToWorld;\nuniform mat4 effects_MatrixInvV;\nuniform mat4 effects_MatrixVP;\nvarying vec4 vColor;\n#ifdef ENV_EDITOR\n  uniform vec4 uEditorTransform;\n#endif\n\nvec3 rotateByQuat(vec3 a, vec4 quat){\n  vec3 qvec = quat.xyz;\n  vec3 uv = cross(qvec, a);\n  vec3 uuv = cross(qvec, uv) * 2.;\n  return a +(uv * 2. * quat.w + uuv);\n}\n\nvoid main() {\n  vec4 _pos = uPos;\n  vec3 point = rotateByQuat(vec3(aPoint.xy * uSize, 0.),uQuat);\n  vec4 pos = vec4(_pos.xyz, 1.0);\n  pos = effects_ObjectToWorld * pos;\n  pos.xyz += effects_MatrixInvV[0].xyz * point.x+ effects_MatrixInvV[1].xyz * point.y;\n  gl_Position = effects_MatrixVP * pos;\n  vColor = uColor;\n  #ifdef ENV_EDITOR\n    gl_Position = vec4(gl_Position.xy * uEditorTransform.xy + uEditorTransform.zw * gl_Position.w, gl_Position.zw);\n  #endif\n}\n",t.ShaderType.vertex,o),fragment:Nr(i,"\nprecision highp float;\n\n#define fragColor gl_FragColor\n\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vColor;\n}\n",t.ShaderType.fragment,o),glslVersion:t.GLSLVersion.GLSL1,cacheId:"".concat(e.cachePrefix,"_effects_interact")},uniformSemantics:{effects_MatrixVP:"VIEWPROJECTION",effects_MatrixInvV:"VIEWINVERSE",effects_ObjectToWorld:"MODEL",uEditorTransform:"EDITOR_TRANSFORM"}},a=ui.create(this.engine,s);return a.depthTest=!1,a.setVector4("uPos",new kt(0,0,0,0)),a.setVector2("uSize",new Lt(1,1)),a.setVector4("uColor",new kt(n[0]/255,n[1]/255,n[2]/255,n[3])),a.setQuaternion("uQuat",new Pt(0,0,0,0)),a},e.prototype.createGeometry=function(){var t=new Uint8Array([0,1,1,2,2,3,3,0]);return bi.create(this.engine,{attributes:{aPoint:{size:2,offset:0,stride:2*Float32Array.BYTES_PER_ELEMENT,data:new Float32Array([-.5,.5,.5,.5,.5,-.5,-.5,-.5])}},drawCount:t.length,indices:{data:t},mode:v.LINES,maxVertex:4})},e.prototype.createMesh=function(t,e){return Li.create(this.engine,{name:"Interact_preview"+Rn++,priority:0,worldMatrix:Nt.fromIdentity(),geometry:t,material:e})},e}(),_n=function(e){function n(t,r){var i,n=e.call(this,t,r)||this;return n.downgrade=.95,n.dragRatio=[1,1],n.engine=null===(i=n.composition)||void 0===i?void 0:i.getEngine(),n}return r(n,e),Object.defineProperty(n.prototype,"type",{get:function(){return O.interact},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"enable",{get:function(){return this.enabled},set:function(t){this.enabled=t,t||(this.bouncingArg=null)},enumerable:!1,configurable:!0}),n.prototype.onConstructed=function(t){this.ui=t.content,this.enabled=!0},n.prototype.onLifetimeBegin=function(t){var e,r,i,n=this.ui.options,o=(null!==(r=null===(e=this.engine)||void 0===e?void 0:e.renderer)&&void 0!==r?r:{}).env;null===(i=this.composition)||void 0===i||i.addInteractiveItem(this,n.type),n.type===_.DRAG&&(o!==l||n.enableInEditor)&&t.event&&this.beginDragTarget(n,t.event)},n.prototype.onItemUpdate=function(){var t;null===(t=this.previewContent)||void 0===t||t.updateMesh(),this.dragEvent&&this.bouncingArg&&(this.bouncingArg.vx*=this.downgrade,this.bouncingArg.vy*=this.downgrade,this.bouncingArg.dy+=this.bouncingArg.vy,this.bouncingArg.dx+=this.bouncingArg.vx,wn(this.bouncingArg)?(this.dragEvent=null,this.bouncingArg=null):this.handleDragMove(this.dragEvent,this.bouncingArg))},n.prototype.onEnd=function(){this.composition&&this.composition.removeInteractiveItem(this,this.ui.options.type)},n.prototype.onItemRemoved=function(){var t;this.clickable=!1,null===(t=this.previewContent)||void 0===t||t.mesh.dispose(),this.endDragTarget()},n.prototype.getBoundingBox=function(){var e=this.transform.getWorldMatrix(),r=le(It.ZERO,.5,.5);return r.forEach((function(t){e.transformPoint(t.p0),e.transformPoint(t.p1),e.transformPoint(t.p2)})),{type:t.HitTestType.triangle,area:r}},n.prototype.getHitTestParams=function(){if(this.clickable&&this.canInteract()){var t=this.ui.options.behavior,e=this.getBoundingBox();return e?{type:e.type,triangles:e.area,behavior:t}:void 0}},n.prototype.doCreateContent=function(t){var e,r=this.ui.options,i=r.type,n=r.showPreview,o=this.engine,s=(null!==(e=null==o?void 0:o.renderer)&&void 0!==e?e:{}).env;if(Tt(o),i===_.CLICK&&(this.clickable=!0,n&&s===l)){var a=t.getRendererOptions();this.previewContent=new Cn(this.ui,a,this.transform,o)}return{}},n.prototype.beginDragTarget=function(t,e){var r=this;if("camera"===t.target){var n,o={touchstart:function(t){var e;if(r.canInteract()){r.dragEvent=null,r.bouncingArg=null;var i=null===(e=r.composition)||void 0===e?void 0:e.camera;n={x:t.x,y:t.y,cameraParam:{position:(null==i?void 0:i.position.toArray())||[0,0,8],fov:(null==i?void 0:i.fov)||60}}}},touchmove:function(t){r.handleDragMove(n,t),r.bouncingArg=t},touchend:function(t){if(r.canInteract()){var e=r.bouncingArg;!wn(e,3)&&e&&(e.vx*=5,e.vy*=5,r.dragEvent=i({},n)),n=null}}};Object.keys(o).forEach((function(t){e.addEventListener(t,o[t])})),o.touchmove({dx:0,dy:0,width:1,height:1}),this.endDragTarget=function(){Object.keys(o).forEach((function(t){e.removeEventListener(t,o[t])}))}}},n.prototype.endDragTarget=function(){},n.prototype.handleDragMove=function(t,e){var r,i;if((null==t?void 0:t.cameraParam)&&this.canInteract()&&this.composition){var n=this.ui.options,o=t.cameraParam,s=o.position,u=o.fov,c=e.dy,l=e.dx*e.width/e.height,h=s[2],f=Math.tan(u*Math.PI/180/2)*Math.abs(h),p=c*f,d=l*f,m=s[0]-this.dragRatio[0]*d,v=s[1]-this.dragRatio[1]*p;if(n.dxRange){var y=a(n.dxRange,2);(m=Ot(m,g=y[0],x=y[1]))!==g&&m!==x&&g!==x&&(null===(r=e.origin)||void 0===r||r.preventDefault())}if(n.dyRange){var g,x,T=a(n.dyRange,2);(v=Ot(v,g=T[0],x=T[1]))!==g&&v!==x&&g!==x&&(null===(i=e.origin)||void 0===i||i.preventDefault())}this.composition.camera.position=new It(m,v,h)}},n.prototype.canInteract=function(){var t;return Boolean(null===(t=this.composition)||void 0===t?void 0:t.interactive)&&this.enabled},n}(lr);function wn(t,e){var r=1e-5*(e||1);return t&&Math.abs(t.vx||0)<r&&Math.abs(t.vy||0)<r}var On=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.mesh=[],e}return r(e,t),e.prototype.onCompositionItemLifeBegin=function(t,e){e instanceof _n&&e.previewContent&&this.addMesh(e.previewContent.mesh)},e.prototype.onCompositionItemRemoved=function(t,e){e instanceof _n&&e.previewContent&&this.removeMesh(e.previewContent.mesh,t.renderFrame)},e.prototype.prepareRenderFrame=function(t,e){return this.mesh&&this.mesh.forEach((function(t){return e.addMeshToDefaultRenderPass(t)})),this.mesh=[],!1},e.prototype.addMesh=function(t){this.mesh.push(t)},e.prototype.removeMesh=function(t,e){e.removeMeshFromDefaultRenderPass(t)},e}(xr),Mn=function(){};t.maxSpriteMeshItemCount=8,t.maxSpriteTextureCount=8;var Ln=1,In=function(){function e(t,e,r){this.engine=t,this.composition=r,this.items=[],this.dirty=!1;var i=e.wireframe,n=this.createGeometry(i?v.LINES:v.TRIANGLES),o=this.createMaterial(e,2);this.wireframe=i,this.mesh=Li.create(t,{name:"MSprite"+Ln++,priority:0,worldMatrix:Nt.fromIdentity(),geometry:n,material:o})}return e.prototype.setItems=function(e){var r,i,n,o,s,a=[],u=[],c=2,l=0,h=0,f=0;if(!e.length)return this.mesh.setVisible(!1),!0;for(var p=0;p<e.length;p++)if(e[p].renderInfo){s=e[p].renderInfo;break}if(!s)return!0;this.items=e.slice(),e.length>2&&(c=t.maxSpriteMeshItemCount),this.mtlSlotCount!==c&&this.mesh.setMaterial(this.createMaterial(s,c),{textures:t.DestroyOptions.keep});var d=null!==(o=null===(n=null===(i=null===(r=s.filter)||void 0===r?void 0:r.passSplitOptions)||void 0===i?void 0:i.attachments)||void 0===n?void 0:n.length)&&void 0!==o?o:0;for(this.splitLayer=d>0,p=0;p<e.length;p++)(C=null==(m=e[p])?void 0:m.renderer.texture)&&rt(u,C),m.mesh=this;for(p=0;p<e.length;p++){var m,y=(C=null==(m=e[p])?void 0:m.renderer.texture)?u.indexOf(C):-1,g=this.getItemInitData(m,p,f,y);l+=g.aPoint.length,h+=g.index.length,a.push(g),f+=g.aPoint.length/6,this.updateItem(m,!0)}var x={aPoint:new Float32Array(l),index:new Uint16Array(h)},T={aPoint:0,index:0},E=function(t){var e=a[t];Object.keys(x).forEach((function(t){var r=x[t],i=e[t];r.set(i,T[t]),T[t]+=i.length}))};for(p=0;p<a.length;p++)E(p);var b=this.mesh,S=b.material,A=b.geometry,R=x.index;for(A.setIndexData(R),A.setAttributeData("aPoint",x.aPoint),A.setDrawCount(h),this.mesh.setVisible(!!A.getDrawCount()),this.mesh.priority=e[0].listIndex,p=0;p<u.length;p++){var C=u[p];S.setTexture("uSampler"+p,C)}for(var _=e[0].emptyTexture,w=u.length;w<t.maxSpriteMeshItemCount;w++)S.setTexture("uSampler"+w,_);if(this.splitLayer){var O=function(t,e){var r;if(e){for(var i=128,n=new Uint8Array(i),o=0,s=i-1;o<i;o++){var a=o/s,u=e.getValue(a);n[o]=Math.round(255*u)}r=qr.createWithData(t,{width:i,height:1,data:n},{name:"feather",format:v.LUMINANCE,minFilter:v.LINEAR,magFilter:v.LINEAR,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE})}else r=qr.createWithData(t);return r}(this.engine,e[0].feather);S.setTexture("uFeatherSampler",O)}},e.prototype.updateItem=function(t,e){var r=this.items.indexOf(t);if(!(r<=-1)){var i=this.mesh.material.getVector4Array("uTexParams"),n=4*r,o=t.getRenderData(t.time,e),s=this.mesh.material.getMatrixArray("uMainData"),c=16*r,l=c,h=c+4,f=c+8,p=c+12,d=new It,m=new Pt,v=new It,y=o.color||[s[p],s[p+1],s[p+2],s[p+3]];if(o.visible)o.transform.assignWorldTRS(d,m,v);else if(!e)return void(s[h+2]=-1);var g=u(u([],a(d.toArray()),!1),[0],!1),x=u(u([],a(v.toArray()),!1),[0],!1),T=m.toArray();isNaN(t.getCustomOpacity())||(y[3]=t.getCustomOpacity());for(var E=0;E<4;E++)s[l+E]=g[E],s[f+E]=T[E],s[h+E]=x[E],s[p+E]=y[E];if(x[2]=o.life,s[h+2]=o.life,e){var b=t.renderer;i[n]=b.occlusion?+b.transparentOcclusion:1,i[n+2]=b.renderMode,i[n+1]=+this.preMultiAlpha}if(o.texOffset){var S=this.mesh.material.getVector4Array("uTexOffset");for(E=0;E<4;E++)S[4*r+E]=o.texOffset[E]}}},e.prototype.applyChange=function(){this.dirty&&(this.setItems(this.items),this.dirty=!1)},e.prototype.getItemInitData=function(t,e,r,i){var n=t.geoData;this.lineMode?n=this.getItemGeometryData(t,e):n||(n=t.geoData=this.getItemGeometryData(t,e));var o=n.aPoint;if(o[4]!==e||o[5]!==i)for(var s=0;s<o.length;s+=6)o[s+4]=e,o[s+5]=i;var a=n.index,u=a.length,c=this.wireframe?new Uint8Array([0,1,1,3,2,3,2,0]):new a.constructor(u);if(!this.wireframe)for(s=0;s<u;s++)c[s]=r+a[s];return{aPoint:n.aPoint,index:c}},e.prototype.getItemRegionData=function(t){var e=this.items.indexOf(t);if(e>-1){var r=this.mesh.material.getMatrixArray("uMainData"),i=16*e;if(null===r)return;return{position:[r[i]||0,r[i+1]||0,r[i+2]||0],size:[r[i+4],r[i+5]],quat:[r[i+8],r[i+9],r[i+10],r[i+11]],color:[r[i+12],r[i+13],r[i+14],r[i+15]]}}},e.prototype.invalidMaterial=function(){this.mtlSlotCount=0},e.prototype.createGeometry=function(e){var r=Float32Array.BYTES_PER_ELEMENT;return bi.create(this.engine,{attributes:{aPoint:{size:4,offset:0,stride:c*r,releasable:!0,type:v.FLOAT,data:new Float32Array(0)},aIndex:{size:2,offset:4*r,stride:c*r,dataSource:"aPoint",type:v.FLOAT}},indices:{data:new Uint16Array(0),releasable:!0},mode:e,maxVertex:4*t.maxSpriteMeshItemCount})},e.prototype.createMaterial=function(t,e){var r,n,o,a=t.filter,u=t.side,c=t.occlusion,l=t.blending,h=t.maskMode,f=t.mask,p=(null==a?void 0:a.mesh)||{},d=this.engine,m={shader:Dn(t,e,d.gpuCapability.level,null===(o=d.renderer)||void 0===o?void 0:o.env)};this.preMultiAlpha=Ir(l),this.mtlSlotCount=e;var v=ui.create(d,m),y=i({side:u,blending:!0,blendMode:l,mask:f,maskMode:h,depthTest:!0,depthMask:c},p.materialStates);v.blending=y.blending,v.stencilRef=void 0!==y.mask?[y.mask,y.mask]:void 0,v.depthTest=y.depthTest,v.depthMask=y.depthMask,y.blending&&Dr(v,y.blendMode),v.blendFunction=y.blendFunction,Br(v,y.maskMode),zr(v,y.side);var g=p.uniformValues;if(g)try{for(var x=s(Object.keys(g)),T=x.next();!T.done;T=x.next()){var E=T.value,b=g[E];b instanceof qr?v.setTexture(E,b):"number"==typeof b?v.setFloat(E,b):2===b.length?v.setVector2(E,Lt.fromArray(b)):4===b.length?v.setVector4(E,kt.fromArray(b)):v.setMatrix(E,Nt.fromArray(b))}}catch(t){r={error:t}}finally{try{T&&!T.done&&(n=x.return)&&n.call(x)}finally{if(r)throw r.error}}for(var S=[],A=[],R=[],C=0;C<e;C++)S.push(Nt.fromIdentity()),A.push(new kt),R.push(new kt);return v.hasUniform("uMainData")||v.setMatrixArray("uMainData",S),v.hasUniform("uTexParams")||v.setVector4Array("uTexParams",A),v.hasUniform("uTexOffset")||v.setVector4Array("uTexOffset",R),v},e.prototype.getItemGeometryData=function(t,e){var r=t.splits,i=t.renderer,n=t.textureSheetAnimation,o=t.startSize,s=o.x,a=o.y;if(i.shape){for(var u=i.shape,c=u.index,l=u.aPoint,h=new Float32Array(l),f=0;f<h.length;f+=6)h[f]*=s,h[f+1]*=a;return{index:c,aPoint:Array.from(h)}}var p=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],d=[],m=[],v=2,y=2;1===r.length&&(v=1,y=1);for(var g=0;g<v;g++)for(var x=0;x<y;x++){var T=4*(2*x+g),E=n?[0,0,1,1,r[0][4]]:r[2*x+g],b=E[4]?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0],S=((g+g+1)/v-1)/2,A=((x+x+1)/y-1)/2,R=E[0],C=E[1],_=E[4]?E[3]:E[2],w=E[4]?E[2]:E[3],O=[p[0]/v+S,p[1]/y+A,p[2]/v+S,p[3]/y+A,p[4]/v+S,p[5]/y+A,p[6]/v+S,p[7]/y+A];d.push(O[0]*s,O[1]*a,b[0]*_+R,b[1]*w+C,e,0,O[2]*s,O[3]*a,b[2]*_+R,b[3]*w+C,e,0,O[4]*s,O[5]*a,b[4]*_+R,b[5]*w+C,e,0,O[6]*s,O[7]*a,b[6]*_+R,b[7]*w+C,e,0),this.lineMode?m.push(T,1+T,1+T,3+T,3+T,2+T,2+T,T):m.push(T,1+T,2+T,2+T,1+T,3+T)}return{index:m,aPoint:d}},e}();function Pn(e){return t.maxSpriteTextureCount=Math.min(e.maxFragmentTextures,16),e.maxVertexUniforms>=256?t.maxSpriteMeshItemCount=32:e.maxVertexUniforms>=128?t.maxSpriteMeshItemCount=16:void(t.maxSpriteTextureCount=8)}function Fn(t){var e,r=t.renderer,i=t.filter,n=r.blending,o=r.side,s=r.occlusion,a=r.mask,u=r.maskMode,c=r.order,l=+n,h=t.cachePrefix||"-",f=(null===(e=null==i?void 0:i.mesh)||void 0===e?void 0:e.shaderCacheId)||"$F$";return{side:o,occlusion:s,blending:n,mask:a,maskMode:u,cachePrefix:h,filter:i,cacheId:"".concat(h,".").concat(f,".").concat(+o,"+").concat(+s,"+").concat(l,"+").concat(c,"+").concat(u,".").concat(a)}}function Vn(e,r,i){var n=null!=i?i:{},o=n.count,s=void 0===o?2:o,a=n.env,u=void 0===a?"":a,c=n.ignoreBlend,h=n.wireframe,f=[["MAX_ITEM_COUNT",s],["PRE_MULTIPLY_ALPHA",!1],["ENV_EDITOR",u===l],["ADJUST_LAYER",!!r],["USE_BLEND",!c],["MAX_FRAG_TEX",t.maxSpriteTextureCount>=16?16:8]],p=h?Di:Bi.replace(/#pragma\s+FILTER_FRAG/,(null==r?void 0:r.fragment)||""),d=zi.replace(/#pragma\s+FILTER_VERT/,(null==r?void 0:r.vertex)||"vec4 filterMain(float t,vec4 pos){return effects_MatrixVP * pos;}");return{fragment:Nr(f,p,t.ShaderType.fragment,e),vertex:Nr(f,d,t.ShaderType.vertex,e),glslVersion:1===e?t.GLSLVersion.GLSL1:t.GLSLVersion.GLSL3,marcos:f,shared:!0}}function Nn(t,e){return t.filter?"".concat(t.filter.mesh.shaderCacheId,"_effects_filter"):"".concat(t.cachePrefix,"_effects_sprite_").concat(e)}function Dn(t,e,r,i){var n=t.filter,o=t.wireframe,s=Vn(r,null==n?void 0:n.mesh,{count:e,wireframe:o,env:i});return s.shared=!0,o||(s.cacheId=Nn(t,e)),s}var zn="listIndex",Bn=function(){function e(t){this.composition=t,this.meshSplits=[],this.items=[],this.meshes=[],this.time=0,this.itemsToRemove=[],this.itemsToAdd=[],this.engine=t.getEngine()}return e.prototype.resetMeshSplits=function(){this.meshSplits.length=0,this.meshes.length=0,this.items.length=0,this.itemsToAdd.length=0,this.itemsToRemove.length=0},e.prototype.diffMeshSplits=function(){for(var e,r,i,n,o,s,c=this.meshSplits,l=this.itemsToRemove,h=this.itemsToAdd,f=[],p=[],d=[],m=[],v=this.items,y={layerToAdd:[]},g=[],x=0;x<l.length;x++)if(Un(b=l[x]))f.push.apply(f,u([],a(this.removeMeshSplitsItem(v,b,c,l)),!1)),this.check();else{var T=v.indexOf(b);T>-1&&(v.splice(T,1),g.length=0,T>0&&(g=this.combineSplits(v,T-1,c),f.push.apply(f,u([],a(g),!1))),!g.length&&T<=v.length-1&&(g=this.combineSplits(v,T,c),f.push.apply(f,u([],a(g),!1))),this.check())}var E=!1;for(x=0;x<h.length;x++)for(var b=h[x],S=this.addMeshSplitsItem(v,b,c),A=0;A<S.length;A++){var R=S[A];if(R.spriteMesh)throw new Error("no sprite mesh in neo split");var C=R.spriteMesh=new In(this.engine,R.renderInfo,this.composition);p.push(C.mesh),C.setItems(R.items.map((function(t){return t.content}))),C.applyChange(),C.splitLayer&&(null===(e=y.layerToAdd)||void 0===e||e.push(C)),R.dirty=!1,this.check(),E=!0}if(E){var _,w=function(e){var a=c[e],u=c[e+1];if(u.cacheId===a.cacheId&&!(null===(r=u.spriteMesh)||void 0===r?void 0:r.splitLayer)&&!(null===(i=a.spriteMesh)||void 0===i?void 0:i.splitLayer)&&a.items.length+u.items.length<=t.maxSpriteMeshItemCount){var l=a.items[0],h=u.items[u.items.length-1],f=O.getMeshSplits(v,v.indexOf(l),v.indexOf(h));if(1===f.length){Object.keys(f[0]).forEach((function(t){a[t]=f[0][t]})),null===(n=a.spriteMesh)||void 0===n||n.setItems(a.items.map((function(t){return t.content}))),null===(o=a.spriteMesh)||void 0===o||o.applyChange();var m=null===(s=u.spriteMesh)||void 0===s?void 0:s.mesh;a.spriteMesh&&a.spriteMesh.mesh&&(a.spriteMesh.mesh.priority=u.indexEnd),p.includes(m)?it(p,m):rt(d,m),c.splice(e+1,1),e--}}_=e},O=this;for(x=0;x<c.length-1;x++)w(x),x=_}for(l.length=0,x=0;x<c.length;x++){var M=(I=c[x]).spriteMesh;if(0===I.items.length)throw new Error("split not combined");if(I.dirty){var L=I.indexStart;M.mesh.priority!==L&&(M.mesh.priority=L,m.push(M.mesh)),M.setItems(I.items.map((function(t){return t.content})))}M.applyChange(),I.dirty=!1}if(f.length)for(x=0;x<f.length;x++){var I,P=(C=(I=f[x]).spriteMesh).mesh;P.dispose({material:{textures:t.DestroyOptions.keep}}),d.push(P)}if(this.itemsToRemove.length=0,this.itemsToAdd.length=0,p.length+d.length+m.length){var F=this.meshes;return this.meshSplits.forEach((function(t,e){return F[e]=t.spriteMesh.mesh})),F.length=this.meshSplits.length,{add:p.length?p:void 0,remove:d.length?d:void 0,modify:m.length?m:void 0,layer:y.layerToAdd.length>0?y:void 0}}},e.prototype.addItem=function(t){this.items.includes(t)?it(this.itemsToRemove,t):rt(this.itemsToAdd,t)},e.prototype.removeItem=function(t){this.items.includes(t)?Un(t)?this.itemsToRemove.unshift(t):this.itemsToRemove.push(t):it(this.itemsToAdd,t)},e.prototype.getSpriteMesh=function(t){for(var e=this.meshSplits,r=0;r<e.length;r++){var i=e[r].spriteMesh;if(i.items.indexOf(t)>-1)return i}},e.prototype.onUpdate=function(t){for(var e=this.meshSplits,r=0;r<e.length;r++){for(var i=e[r].spriteMesh,n=i.items,o=0;o<n.length;o++){var s=n[o];s.ended||i.updateItem(s)}i.applyChange()}},e.prototype.dispose=function(){this.meshSplits.forEach((function(t){var e;null===(e=t.spriteMesh)||void 0===e||e.mesh.dispose()}))},e.prototype.check=function(){},e.prototype.addMeshSplitsItem=function(t,e,r){if(-1!==t.indexOf(e))throw Error("item has been added");if(!r[0]){if(nt(t,e,zn),Un(e)){var i=e.createContent(),n={indexStart:e.listIndex,indexEnd:e.listIndex,items:[e],renderInfo:i.renderInfo,cacheId:i.renderInfo.cacheId,textures:[e.content.renderer.texture]};return r.unshift(n),[n]}return[]}for(var o=function(i){var n=r[i],o=e.listIndex;if(Un(e)){if(o<=n.indexEnd){nt(t,e,zn);var a=t.indexOf(e),u=Math.min(a,t.indexOf(n.items[0])),c=Math.max(a,t.indexOf(n.items[n.items.length-1])),l=s.getMeshSplits(t,u,c),h=l.findIndex((function(t){return t.items.includes(e)}));if(2===l.length)return r.splice(i+h,0,l[h]),Object.keys(l[1-h]).forEach((function(t){n[t]=l[1-h][t]})),{value:[l[h]]};if(3===l.length){if(Object.keys(l[0]).forEach((function(t){n[t]=l[0][t]})),r.splice(i+1,0,l[1],l[2]),1!==h)throw Error("neo split not in middle");return{value:[l[1],l[2]]}}if(1!==l.length)throw Error("invalid splits 1");return Object.keys(l[0]).forEach((function(t){n[t]=l[0][t]})),{value:[]}}}else{if(o<n.indexStart||o===n.indexEnd)return nt(t,e,zn),{value:[]};if(o<n.indexEnd){nt(t,e,zn);var f=n.items[n.items.length-1],p=t.indexOf(f),d=s.getMeshSplits(t,t.indexOf(n.items[0]),p);if(Object.keys(d[0]).forEach((function(t){n[t]=d[0][t]})),2===d.length)return r.splice(i+1,0,d[1]),{value:[d[1]]};if(1!==d.length)throw Error("invalid splits 2")}}},s=this,a=0;a<r.length;a++){var u=o(a);if("object"==typeof u)return u.value}if(nt(t,e,zn),Un(e)){var c=r[r.length-1],l=this.getMeshSplits(t,t.indexOf(c.items[0]),t.indexOf(e));if(Object.keys(l[0]).forEach((function(t){c[t]=l[0][t]})),2===l.length)return r.push(l[1]),[l[1]];if(1!==l.length)throw Error("invalid splits 3")}return[]},e.prototype.removeMeshSplitsItem=function(t,e,r,i){for(var n,o,s=null,a=-1,u=[],c=0;c<r.length;c++){var l=r[c];if(l.indexStart<=e.listIndex&&l.indexEnd>=e.listIndex){s=l,a=c;break}}if(s){var h=s.items.indexOf(e);if(h<0){if(null==i?void 0:i.includes(e))return[];throw Error("item not found")}if(s.items.splice(h,1),s.dirty=!0,it(t,e),0===s.items.length){if(it(r,s),u.push(s),s=r[a-=1],!r.length||a<0)return u}else s.indexEnd=s.items[s.items.length-1].listIndex,s.indexStart=s.items[0].listIndex;if(0===a||a===r.length-2){var f=r[a],p=r[a+1];if(f&&p){var d=f.items[0],m=p.items[p.items.length-1];1===(v=this.getMeshSplits(t,t.indexOf(d),t.indexOf(m))).length&&(v[0].spriteMesh=r[a].spriteMesh,null===(n=v[0].spriteMesh)||void 0===n||n.invalidMaterial(),r[a]=v[0],u.push(r.splice(a+1,1)[0]))}}else if(a===r.length-1)0===s.items.length?u.push(r.splice(a,1)[0]):(f=r[a-1],p=r[a],d=f.items[0],m=p.items[p.items.length-1],1===(v=this.getMeshSplits(t,t.indexOf(d),t.indexOf(m))).length&&(v[0].spriteMesh=r[a-1].spriteMesh,null===(o=v[0].spriteMesh)||void 0===o||o.invalidMaterial(),r[a-1]=v[0],u.push(r.splice(a,1)[0])));else{var v;f=r[a-1],p=r[a+1],d=f.items[0],m=p.items[p.items.length-1],2===(v=this.getMeshSplits(t,t.indexOf(d),t.indexOf(m))).length&&(v[0].spriteMesh=r[a].spriteMesh,v[1].spriteMesh=r[a+1].spriteMesh,r[a]=v[0],r[a+1]=v[1],u.push(r.splice(a-1,1)[0]))}}return u},e.prototype.combineSplits=function(t,e,r){var i=t[e],n=[];if(Un(i)&&i.composition){for(var o=void 0,s=0;s<r.length;s++)if(r[s].items.includes(i)){o=s;break}var a=void 0,u=void 0;if(0===o?(a=r[o],u=r[o+1]):(a=r[o-1],u=r[o]),a&&u){var c=t.indexOf(a.items[0]),l=t.indexOf(u.items[u.items.length-1]);if(Number.isInteger(c)&&Number.isInteger(l)){var h=this.getMeshSplits(t,c,l);1===h.length&&(h[0].spriteMesh=r[o].spriteMesh,0===o?(r[0]=h[0],n.push(r.splice(1,1)[0])):(n.push(r.splice(o-1,1)[0]),r[o-1]=h[0]))}}}return n},e.prototype.getMeshSplits=function(e,r,i,n){void 0===r&&(r=0),void 0===i&&(i=e.length-1);for(var o=null,s=[],a=r;a<=i;a++){var u=e[a];if(n||u.started&&!(u.lifetime<0))if(Un(u)){var c=u.createContent().renderInfo.cacheId,l=u.content.renderer.texture,h=!0;if(o){var f=o.textures.includes(l)?0:1;o.cacheId===c&&lr.isSprite(u)&&o.items.length<t.maxSpriteMeshItemCount&&f+o.textures.length<=t.maxSpriteTextureCount?(nt(o.items,u,zn),rt(o.textures,l),h=!1):s.push(o)}h&&(o={indexStart:u.listIndex,cacheId:c,renderInfo:u.content.renderInfo,items:[u],textures:[l]})}else{if(n&&!u.contentVisible)continue;o&&(s.push(o),o=null)}}return o&&s.push(o),s.forEach((function(t){t.indexEnd=t.items[t.items.length-1].listIndex,t.dirty=!0})),s},e}();function Un(t){return lr.isSprite(t)||lr.isFilterSprite(t)}var kn={blending:0,cacheId:"-",mask:0,maskMode:0,occlusion:!1,side:0,cachePrefix:"-"},Gn=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="sprite",t}return r(i,e),i.precompile=function(e,r,i){var n,o=r.getShaderLibrary(),s=r.engine.gpuCapability,a=s.level,u=s.detail,c=(null!=i?i:{}).env;if(!o.shaderResults[Nn(kn,2)]){o.addShader(Dn(kn,2,a,c)),o.addShader(Dn(kn,t.maxSpriteMeshItemCount,a,c));var l=!1;null===(n=e[0])||void 0===n||n.items.forEach((function(e){t.Item.isFilter(e)&&e.content.filter&&(l=!0,tt(e.content.filter).forEach((function(t){if(!t.isParticle){var e=Vn(a,t,t);t.shaderCacheId&&(e.cacheId="".concat(t.shaderCacheId,"_effects_filter")),o.addShader(e)}})))})),l&&o.addShader(mi(a,!1)),u.writableFragDepth&&o.addShader(mi(a,!0))}return Promise.resolve()},i.prototype.onCompositionDestroyed=function(t){t.loaderData.spriteGroup.dispose(),delete t.loaderData.spriteGroup},i.prototype.onCompositionReset=function(t,e){if(!t.loaderData.spriteGroup){var r=new Bn(t);t.loaderData.spriteGroup=r,r.resetMeshSplits()}},i.prototype.onCompositionItemLifeBegin=function(t,e){var r=t.loaderData.spriteGroup;e.type!==O.composition&&r.addItem(e)},i.prototype.onCompositionItemRemoved=function(t,e){t.loaderData.spriteGroup.removeItem(e)},i.prototype.onCompositionUpdate=function(t,e){t.loaderData.spriteGroup.onUpdate(e)},i.prototype.prepareRenderFrame=function(t,e){var r,i,n,o=t.loaderData.spriteGroup.diffMeshSplits();return!!o&&(null===(r=o.remove)||void 0===r||r.forEach((function(t){return e.removeMeshFromDefaultRenderPass(t)})),null===(i=o.add)||void 0===i||i.forEach((function(t){return e.addMeshToDefaultRenderPass(t)})),null===(n=o.modify)||void 0===n||n.forEach((function(t){e.removeMeshFromDefaultRenderPass(t),e.addMeshToDefaultRenderPass(t)})),!!(this.layerInfo=o.layer))},i.prototype.postProcessFrame=function(t,e){var r,i;null===(i=null===(r=this.layerInfo)||void 0===r?void 0:r.layerToAdd)||void 0===i||i.forEach((function(t){var r=t.items[0].filter;if(void 0!==r){var i=r.passSplitOptions,n=e.splitDefaultRenderPassByMesh(t.mesh,i);r.renderPassDelegate&&(n.delegate=r.renderPassDelegate),r.onRenderPassCreated&&r.onRenderPassCreated(n,e)}})),this.layerInfo=void 0},i}(xr),Xn=new Ut,Hn=new It(1,1,1);new It;var Yn=function(){function t(t,e){var r;this.vfxItem=e,this.active=!1,this.transform=e.transform;var i=this.transform.scale;this.basicTransform={position:this.transform.position.clone(),rotation:this.transform.getRotation(),scale:new It(i.x,i.y,i.x)};var n=t.rotationOverLifetime,o=t.sizeOverLifetime,s=t.positionOverLifetime,a=void 0===s?{}:s;if(a){a.path&&(this.basicTransform.path=Be(a.path));var u=a.linearX||a.linearY||a.linearZ;u&&(this.linearVelOverLifetime={x:a.linearX&&Be(a.linearX),y:a.linearY&&Be(a.linearY),z:a.linearZ&&Be(a.linearZ),asMovement:a.asMovement,enabled:!!u});var c=a.orbitalX||a.orbitalY||a.orbitalZ;c&&(this.orbitalVelOverLifetime={x:a.orbitalX&&Be(a.orbitalX),y:a.orbitalY&&Be(a.orbitalY),z:a.orbitalZ&&Be(a.orbitalZ),center:ee(a.orbCenter),asRotation:a.asRotation,enabled:!!c}),this.speedOverLifetime=a.speedOverLifetime&&Be(a.speedOverLifetime)}if(o&&(o.separateAxes?(this.sizeSeparateAxes=!0,this.sizeXOverLifetime=Be(o.x||1),this.sizeYOverLifetime=Be(o.y||1),this.sizeZOverLifetime=Be(o.z||1)):this.sizeXOverLifetime=Be(o.size||1)),n&&(this.rotationOverLifetime={asRotation:n.asRotation,separateAxes:n.separateAxes,z:Be(n.z||0)},n.separateAxes)){var l=this.rotationOverLifetime;l.x=Be(n.x||0),l.y=Be(n.y||0)}this.options={reusable:!!e.reusable,delay:e.delay||0,startSpeed:a.startSpeed||0,startSize:i&&i.x||1,sizeAspect:i&&i.x/(i.y||1)||1,duration:e.duration||0,looping:e.endBehavior&&e.endBehavior===D.loop,endBehavior:e.endBehavior||0,gravity:It.fromArray(a.gravity||[]),gravityModifier:Be(null!==(r=a.gravityOverLifetime)&&void 0!==r?r:0),direction:a.direction?It.fromArray(a.direction).normalize():new It},this.id=e.id,this.time=0,this.name=e.name,this.visible=e.getVisible()}return Object.defineProperty(t.prototype,"ended",{get:function(){return this.time>this.options.duration&&!this.options.looping&&!this.options.reusable},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startSize",{get:function(){return this.basicTransform.scale},set:function(t){this.basicTransform.scale=t},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"velocity",{get:function(){return this._velocity||(this._velocity=this.options.direction.clone(),this._velocity.multiply(this.options.startSpeed)),this._velocity},enumerable:!1,configurable:!0}),t.prototype.getWillTranslate=function(){return!!(this.linearVelOverLifetime&&this.linearVelOverLifetime.enabled||this.orbitalVelOverLifetime&&this.orbitalVelOverLifetime.enabled||this.options.gravityModifier&&!this.options.gravity.isZero()||this.options.startSpeed&&!this.options.direction.isZero())},t.prototype.updateTime=function(t){var e=t-this.options.delay,r=this.options.duration;if(e>=r&&this.options.looping){for(var i=e-r;i>r;)i-=r;this.time=i}else{var n=4===this.options.endBehavior;this.time=n?Math.min(r,e):e}},t.prototype.getRenderData=function(t,e){var r=this.options,i=Hn.setFromNumber(1),n=Xn.set(0,0,0),o=!1,s=!1,a=t<0?t:Math.max(t,0),u=r.duration,c=a/u,l={life:c,transform:this.transform};c=c<0?0:c>1?1:c,this.sizeXOverLifetime&&(i.x=this.sizeXOverLifetime.getValue(c),this.sizeSeparateAxes?(i.y=this.sizeYOverLifetime.getValue(c),i.z=this.sizeZOverLifetime.getValue(c)):i.z=i.y=i.x,o=!0),this.calculateScaling(o,i,e);var h,f=this.rotationOverLifetime;if(f){var p=function(t){return f.asRotation?t.getValue(c):t.getIntegrateValue(0,c,u)},d=p(f.z),m=f.separateAxes;n.x=m?p(f.x):0,n.y=m?p(f.y):0,n.z=d,s=!0}if(s||e){var v=Xn.addEulers(this.basicTransform.rotation,n);l.transform.setRotation(v.x,v.y,v.z)}return(this.getWillTranslate()||e)&&te(h=new It,this,this.options.gravity,a,u,this.basicTransform.position,this.velocity),this.basicTransform.path&&(h||(h=this.basicTransform.position.clone()),h.add(this.basicTransform.path.getValue(c))),h&&this.transform.setPosition(h.x,h.y,h.z),l.active=this.active,l},t.prototype.calculateScaling=function(t,e,r){this.transform.setScale(e.x*this.startSize.x,e.y*this.startSize.y,e.z*this.startSize.z)},t}(),jn=[[0,0,1,1,void 0]],Wn=[1,1,1,1],Zn=function(t){function e(e,r,n){var o,s,a,u,c,l,h,f,p=t.call(this,e,n)||this;p.startColor=[1,1,1,1];var d=e.interaction,m=e.renderer,v=e.options,y=e.listIndex,g=void 0===y?0:y,x=r.emptyTexture,T=n.transform.scale;p.options=i(i({},p.options),{startColor:v.startColor||[1,1,1,1]}),p.interaction=d,p.renderer={renderMode:null!==(o=m.renderMode)&&void 0!==o?o:M.BILLBOARD,blending:null!==(s=m.blending)&&void 0!==s?s:b.ALPHA,texture:p.initTexture(m.texture,x),occlusion:!!m.occlusion,transparentOcclusion:!!m.transparentOcclusion||m.maskMode===A.MASK,side:null!==(a=m.side)&&void 0!==a?a:S.DOUBLE,shape:m.shape,mask:null!==(u=m.mask)&&void 0!==u?u:0,maskMode:null!==(c=m.maskMode)&&void 0!==c?c:A.NONE,order:g};var E=ae(m.anchor,m.particleOrigin);m.anchor||void 0===m.particleOrigin||p.basicTransform.position.add([-E[0]*T.x,-E[1]*T.y,0]),p.transform.setAnchor(E[0]*T.x,E[1]*T.y,0);var R=e.colorOverLifetime;return R&&(p.opacityOverLifetime=Be(null!==(l=R.opacity)&&void 0!==l?l:1),R.color&&R.color[0]===V.GRADIENT_COLOR&&(p.colorOverLifetime=ut(R.color[1]))),(null===(h=e.filter)||void 0===h?void 0:h.feather)&&1!==(null===(f=e.filter)||void 0===f?void 0:f.feather)&&(p.feather=Be(e.filter.feather)),p.emptyTexture=x,p.splits=e.splits||jn,p.listIndex=n.listIndex||0,p.textureSheetAnimation=e.textureSheetAnimation,p.cachePrefix="-",p.parentId=n.parentId,p.reusable=n.reusable,p._renderInfo=Fn(p),p}return r(e,t),Object.defineProperty(e.prototype,"filter",{get:function(){return this._filter},set:function(t){this._filter=t,this._renderInfo.filter=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"renderInfo",{get:function(){return this._renderInfo},enumerable:!1,configurable:!0}),e.prototype.initTexture=function(t,e){return null!=t?t:e},e.prototype.getTextures=function(){var t=[],e=this.renderer.texture;return e&&t.push(e),t},e.prototype.setColor=function(t,e,r,i){this.customColor=[t,e,r,i]},e.prototype.setOpacity=function(t){this.customOpacity=t},e.prototype.getCustomOpacity=function(){return this.customOpacity},e.prototype.getRenderData=function(e,r){var i,n=t.prototype.getRenderData.call(this,e,r),o=re(Wn,1),s=e<0?e:Math.max(e,0),a=this.options.duration,u=s/a<0?0:s/a>1?1:s/a;if(this.customColor)n.color=this.customColor;else{var c=this.opacityOverLifetime,l=this.colorOverLifetime;l&&(o=at(l,u,!0),i=!0),c&&(o[3]*=c.getValue(u),i=!0),(i||r)&&(n.color=oe(this.startColor,o,this.options.startColor))}var h=this.textureSheetAnimation;if(h){var f=h.total||h.row*h.col,p=0,d=0,m=1,v=1,y=void 0;if(this.splits){var g=this.splits[0];y=g[4],p=g[0],d=g[1],y?(m=g[3],v=g[2]):(m=g[2],v=g[3])}var x=void 0,T=void 0;y?(x=1/h.row*m,T=1/h.col*v):(x=1/h.col*m,T=1/h.row*v);var E=void 0;if(h.animate){var b=Math.round(u*(f-1)),S=Math.floor(b/h.col),A=b-S*h.col;E=y?[x*S,T*(h.col-A)]:[x*A,T*(1+S)]}else E=[0,T];n.texOffset=[p+E[0],v+d-E[1],x,T]}else r&&(n.texOffset=[0,0,1,1]);return n.visible=this.vfxItem.contentVisible,n.startSize=this.startSize,n},e.prototype.calculateScaling=function(t,e,r){(t||r)&&this.transform.setScale(e.x,e.y,e.z)},e}(Yn),qn=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return r(n,e),Object.defineProperty(n.prototype,"type",{get:function(){return O.sprite},enumerable:!1,configurable:!0}),n.prototype.onConstructed=function(t){this.sprite=t.content},n.prototype.onLifetimeBegin=function(t,e){e.active=!0},n.prototype.onItemRemoved=function(t,e){e&&(delete e.mesh,t.destroyTextures(e.getTextures()))},n.prototype.onItemUpdate=function(t,e){var r;null===(r=this.content)||void 0===r||r.updateTime(this.time)},n.prototype.getCurrentPosition=function(){var t=new It;return this.transform.assignWorldTRS(t),t},n.prototype.setColor=function(t,e,r,i){this.content.setColor(t,e,r,i)},n.prototype.setOpacity=function(t){this.content.setOpacity(t)},n.prototype.getBoundingBox=function(){var e=this.content;if(e&&this.transform){var r=this.transform.getWorldMatrix(),i=e.startSize,n=le(It.ZERO,i.x/2,i.y/2);return n.forEach((function(t){r.transformPoint(t.p0),r.transformPoint(t.p1),r.transformPoint(t.p2)})),{type:t.HitTestType.triangle,area:n}}},n.prototype.getHitTestParams=function(t){var e,r,i=this.content,n=null===(e=this.composition)||void 0===e?void 0:e.loaderData.spriteGroup,o=i&&i.interaction;if((t||o)&&n&&i){var s=this.getBoundingBox();if(s)return{behavior:(null===(r=i.interaction)||void 0===r?void 0:r.behavior)||0,type:s.type,triangles:s.area,backfaceCulling:i.renderer.side===S.FRONT}}},n.prototype.getRenderData=function(){return this.content.getRenderData(this.content.time)},n.prototype.doCreateContent=function(t){var e=t.getRendererOptions().emptyTexture,r=new Zn(this.sprite,{emptyTexture:e},this);return r.getRenderData(0,!0),r},n.prototype.createWireframeMesh=function(t,e){var r=new In(this.composition.getEngine(),i({wireframe:!0},t.renderInfo),this.composition);return r.setItems([t]),r.mesh.material.setVector3("uFrameColor",It.fromArray(e)),r.mesh.priority=999,r},n}(lr),Kn=1,Qn=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return O.filter},enumerable:!1,configurable:!0}),e.prototype.onConstructed=function(e){t.prototype.onConstructed.call(this,e),this.filterOptions=e.content.filter,this.cachePrefix="filter:"+Kn++,this.sprite.renderer.texture=this.composition.renderFrame.transparentTexture},e.prototype.onItemUpdate=function(e,r){var i,n,o,a,u;t.prototype.onItemUpdate.call(this,e,r);var c=null===(o=this._content)||void 0===o?void 0:o.mesh;if(c){var l=this.filter.mesh.variables;if(l){var h=c.mesh.material;try{for(var f=s(Object.keys(l)),p=f.next();!p.done;p=f.next()){var d=p.value,m=l[d](r);m.length>4?h.setMatrix(d,Nt.fromArray(m)):h.setVector4(d,kt.fromArray(m))}}catch(t){i={error:t}}finally{try{p&&!p.done&&(n=f.return)&&n.call(f)}finally{if(i)throw i.error}}}}null===(u=(a=this.filter).onItemUpdate)||void 0===u||u.call(a,e,this)},e.prototype.onItemRemoved=function(e,r){var i,n;null===(n=(i=this.filter).onItemRemoved)||void 0===n||n.call(i,this),t.prototype.onItemRemoved.call(this,e,r)},e.prototype.doCreateContent=function(e){var r,i=t.prototype.doCreateContent.call(this,e),n=et(this.filterOptions,e);this.filter=n,i.renderInfo.filter=n,i.filter=n,i.renderInfo.cacheId=i.renderInfo.cacheId.replace("$F$",null!==(r=n.mesh.shaderCacheId)&&void 0!==r?r:"");var o=n.mesh.variables;return n.mesh.uniformValues||(n.mesh.uniformValues={}),o&&Object.keys(o).forEach((function(t){var e=o[t];n.mesh.uniformValues[t]=e(0)})),i},e}(qn),Jn=function(t){this.content=t},$n=function(){function t(t){this.sort=t,this.length=0}return t.prototype.findNodeByContent=function(t){var e=this.first;if(e)do{if(t(e.content))return e}while(e=e.next)},t.prototype.insertNode=function(t,e){var r=t.next;t.next=e,e.pre=t,e.next=r,r&&(r.pre=e)},t.prototype.shiftNode=function(t){var e=new Jn(t);if(this.length++,1===this.length)return this.first=this.last=e;for(var r=this.first;r;){if(!(this.sort(r.content,e.content)<=0))return r.pre?this.insertNode(r.pre,e):(this.first=e,e.next=r,r.pre=e),e;if(!r.next)return this.insertNode(r,e),this.last=e;r=r.next}},t.prototype.pushNode=function(t){var e=new Jn(t);if(this.length++,1===this.length)return this.last=this.first=e;for(var r=this.last;r;){if(!(this.sort(e.content,r.content)<=0))return this.insertNode(r,e),r===this.last&&(this.last=e),e;if(this.first===r)return r.pre=e,e.next=r,this.first=e;r=r.pre}},t.prototype.removeNode=function(t){var e=this.first;if(this.length--,e===t)(r=this.first=e.next)&&(r.pre=null);else if((e=this.last)===t){var r;(r=this.last=e.pre)&&(r.next=null)}else if(t){var i=t.pre,n=t.next;i.next=n,n&&(n.pre=i)}t.pre=null,t.next=null},t.prototype.forEach=function(t,e){var r=this.first,i=0;if(r)do{t.call(e||this,r.content,i++)}while(r=r.next)},t.prototype.forEachReverse=function(t,e){var r=this.last,i=this.length-1;if(r)do{t.call(e||this,r.content,i--)}while(r=r.pre)},t}(),to=function(){function t(t){var e=this;Object.keys(t).forEach((function(r){e[r]=t[r]}))}return t.prototype.generate=function(t){var e=eo(this.arc,this.arcMode,t)*At,r=Math.cos(e)*this.radius,i=Math.sin(e)*this.radius,n=new It(r,i,0),o=Math.tan(this.angle*At),s=n.clone().multiply(o);return s.z+=1,{position:n.multiply(nr(0,1)),direction:s.normalize()}},t}();function eo(t,e,r){if(e===U.RANDOM)t=nr(0,t);else if(e===U.UNIDIRECTIONAL_CYCLE){var i=r.index%(r.total+1);t=t/r.total*i}else if(e===U.BIDIRECTIONAL_CYCLE){var n=(i=r.index/(r.total+1))-Math.floor(i);t*=Math.floor(i)%2?1-n:n}else e===U.UNIFORM_BURST&&(t=t*r.burstIndex/r.burstCount);return t}var ro,io=function(){function t(t){var e=this;Object.keys(t).forEach((function(r){e[r]=t[r]}))}return t.prototype.generate=function(t){var e=eo(this.arc,this.arcMode,t)*At,r=new It(Math.cos(e),Math.sin(e),0),i=this.radius;return{direction:r,position:r.clone().multiply(i)}},t}(),no=function(){function t(t){this._d=(t.width||1)/2,this._h=(t.height||1)/2}return t.prototype.generate=function(t){var e=nr(-this._d,this._d),r=nr(-this._h,this._h);return{direction:new It(0,0,1),position:new It(e,r,0)}},t}(),oo=function(){function t(t){this._d=(t.width||1)/2,this._h=(t.height||1)/2,this.arcMode=t.arcMode,this.arc=t.arc}return t.prototype.generate=function(t){var e=eo(this.arc,this.arcMode,t)*At,r=new It(Math.cos(e),Math.sin(e),0),i=this._d,n=this._h,o=Math.atan2(n,i),s=Math.tan(e),a=new It;return e<o?a.set(i,i*s,0):e>=o&&e<Math.PI-o?a.set(n/s,n,0):e<Math.PI+o?a.set(-i,-i*s,0):e<2*Math.PI-o?a.set(-n/s,-n,0):a.set(i,i*s,0),{direction:r,position:a}},t}(),so=function(){function t(t){this._d=t.width||1,this.arcMode=t.arcMode}return t.prototype.generate=function(t){var e=this.arcMode===U.UNIFORM_BURST?t.burstIndex%t.burstCount/(t.burstCount-1):nr(0,1);return{direction:new It(0,1,0),position:new It(this._d*(e-.5),0,0)}},t}(),ao=new Nt,uo=function(){function t(t){var e=this;Object.keys(t).forEach((function(r){e[r]=t[r]}))}return t.prototype.generate=function(t){var e=this.donutRadius,r=this.radius-e,i=nr(0,2*Math.PI),n=eo(this.arc,this.arcMode,t)*At,o=ao.setFromRotationZ(n),s=new It(Math.cos(i),Math.sin(i),0),a=new It(r+Math.cos(i)*e,0,Math.sin(i)*e);return{direction:o.transformNormal(s),position:o.transformPoint(a)}},t}(),co=new Nt,lo=function(){function t(t){var e=this;Object.keys(t).forEach((function(r){e[r]=t[r]}))}return t.prototype.getHorizontalAngle=function(){return nr(-90,90)},t.prototype.generate=function(t){var e=eo(this.arc,this.arcMode,t)*At,r=this.getHorizontalAngle()*At,i=this.radius,n=new It(Math.cos(r),0,Math.sin(r)),o=co.setFromRotationZ(e).transformNormal(n);return{position:o.clone().multiply(i),direction:o}},t}(),ho=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.getHorizontalAngle=function(){return nr(0,90)},e}(lo),fo=function(){function t(t){var e=t.detail||{anchors:[.5,.5],block:[0,0]};this.anchors=new Float32Array(e.anchors),this.width=t.width||1,this.height=t.height||1,this.block=e.block,this.arcMode=t.arcMode,this.random=Ot(t.random||0,0,1)}return t.prototype.generate=function(t){var e=this.anchors,r=e.length/2-1,i=Math.floor(eo(r,this.arcMode,t)),n=(e[2*i]+this.block[0]*this.random*Math.random())%1-.5,o=(e[2*i+1]+this.block[1]*this.random*Math.random())%1-.5,s=new It(n,o,0);return{position:new It(n*this.width,o*this.height,0),direction:s.normalize()}},t}(),po=function(){function t(){}return t.prototype.generate=function(){return{position:new It,direction:new It}},t}(),mo=((ro={})[R.NONE]=po,ro[R.CONE]=to,ro[R.SPHERE]=lo,ro[R.HEMISPHERE]=ho,ro[R.CIRCLE]=io,ro[R.DONUT]=uo,ro[R.RECTANGLE]=no,ro[R.EDGE]=so,ro[R.RECTANGLE_EDGE]=oo,ro[R.TEXTURE]=fo,ro);function vo(t){if(!t)return new po;var e=i({radius:1,arc:360,angle:0,arcMode:U.RANDOM},t),r=t.type,n=mo[r];if(!n)throw Error("invalid shape:"+r);var o=new n(e);if(r!==R.NONE){var s=t,a=s.alignSpeedDirection,u=s.upDirection,c=void 0===u?[0,0,1]:u;o.alignSpeedDirection=a,o.upDirection=It.fromArray(c).normalize()}return o}function yo(t,e,r,i,n){var o,s;if(n===function(t,e,r,i){for(var n=0,o=e,s=r-i;o<r;o+=i)n+=(t[s]-t[o])*(t[o+1]+t[s+1]),s=o;return n}(t,e,r,i)>0)for(o=e;o<r;o+=i)s=Vo(o,t[o],t[o+1],s);else for(o=r-i;o>=e;o-=i)s=Vo(o,t[o],t[o+1],s);return s&&Oo(s,s.next)&&(No(s),s=s.next),s}function go(t,e){if(!t)return t;e||(e=t);var r,i=t;do{if(r=!1,i.steiner||!Oo(i,i.next)&&0!==wo(i.prev,i,i.next))i=i.next;else{if(No(i),(i=e=i.prev)===i.next)break;r=!0}}while(r||i!==e);return e}function xo(t){var e=t.prev,r=t,i=t.next;if(wo(e,r,i)>=0)return!1;for(var n=t.next.next;n!==t.prev;){if(Co(e.x,e.y,r.x,r.y,i.x,i.y,n.x,n.y)&&wo(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function To(t,e,r,i){var n=t.prev,o=t,s=t.next;if(wo(n,o,s)>=0)return!1;for(var a=n.x<o.x?n.x<s.x?n.x:s.x:o.x<s.x?o.x:s.x,u=n.y<o.y?n.y<s.y?n.y:s.y:o.y<s.y?o.y:s.y,c=n.x>o.x?n.x>s.x?n.x:s.x:o.x>s.x?o.x:s.x,l=n.y>o.y?n.y>s.y?n.y:s.y:o.y>s.y?o.y:s.y,h=Ao(a,u,e,r,i),f=Ao(c,l,e,r,i),p=t.prevZ,d=t.nextZ;p&&p.z>=h&&d&&d.z<=f;){if(p!==t.prev&&p!==t.next&&Co(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&wo(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,d!==t.prev&&d!==t.next&&Co(n.x,n.y,o.x,o.y,s.x,s.y,d.x,d.y)&&wo(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(;p&&p.z>=h;){if(p!==t.prev&&p!==t.next&&Co(n.x,n.y,o.x,o.y,s.x,s.y,p.x,p.y)&&wo(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;d&&d.z<=f;){if(d!==t.prev&&d!==t.next&&Co(n.x,n.y,o.x,o.y,s.x,s.y,d.x,d.y)&&wo(d.prev,d,d.next)>=0)return!1;d=d.nextZ}return!0}function Eo(t,e){return t.x-e.x}function bo(t,e){if(e=function(t,e){var r,i=e,n=t.x,o=t.y,s=-1/0;do{if(o<=i.y&&o>=i.next.y&&i.next.y!==i.y){var a=i.x+(o-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=n&&a>s){if(s=a,a===n){if(o===i.y)return i;if(o===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!r)return null;if(n===s)return r;var u,c=r,l=r.x,h=r.y,f=1/0;i=r;do{n>=i.x&&i.x>=l&&n!==i.x&&Co(o<h?n:s,o,l,h,o<h?s:n,o,i.x,i.y)&&(u=Math.abs(o-i.y)/(n-i.x),Po(i,t)&&(u<f||u===f&&(i.x>r.x||i.x===r.x&&So(r,i)))&&(r=i,f=u)),i=i.next}while(i!==c);return r}(t,e),e){var r=Fo(e,t);go(e,e.next),go(r,r.next)}}function So(t,e){return wo(t.prev,t,e.prev)<0&&wo(e.next,t,t.next)<0}function Ao(t,e,r,i,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Ro(t){var e=t,r=t;do{(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next}while(e!==t);return r}function Co(t,e,r,i,n,o,s,a){return(n-s)*(e-a)-(t-s)*(o-a)>=0&&(t-s)*(i-a)-(r-s)*(e-a)>=0&&(r-s)*(o-a)-(n-s)*(i-a)>=0}function _o(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&Mo(r,r.next,t,e))return!0;r=r.next}while(r!==t);return!1}(t,e)&&(Po(t,e)&&Po(e,t)&&function(t,e){var r=t,i=!1,n=(t.x+e.x)/2,o=(t.y+e.y)/2;do{r.y>o!=r.next.y>o&&r.next.y!==r.y&&n<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,e)&&(wo(t.prev,t,e.prev)||wo(t,e.prev,e))||Oo(t,e)&&wo(t.prev,t,t.next)>0&&wo(e.prev,e,e.next)>0)}function wo(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function Oo(t,e){return t.x===e.x&&t.y===e.y}function Mo(t,e,r,i){var n=Io(wo(t,e,r)),o=Io(wo(t,e,i)),s=Io(wo(r,i,t)),a=Io(wo(r,i,e));return n!==o&&s!==a||!(0!==n||!Lo(t,r,e))||!(0!==o||!Lo(t,i,e))||!(0!==s||!Lo(r,t,i))||!(0!==a||!Lo(r,e,i))}function Lo(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function Io(t){return t>0?1:t<0?-1:0}function Po(t,e){return wo(t.prev,t,t.next)<0?wo(t,e,t.next)>=0&&wo(t,t.prev,e)>=0:wo(t,e,t.prev)<0||wo(t,t.next,e)<0}function Fo(t,e){var r=new Do(t.i,t.x,t.y),i=new Do(e.i,e.x,e.y),n=t.next,o=e.prev;return t.next=e,e.prev=t,r.next=n,n.prev=r,i.next=r,r.prev=i,o.next=i,i.prev=o,i}function Vo(t,e,r,i){var n=new Do(t,e,r);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function No(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Do(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}var zo=0;function Bo(t,e,r,i){r=r||2,zo=i||0;var n,o,s,a,u,c,l,h=e&&e.length,f=h?e[0]*r:t.length,p=yo(t,0,f,r,!0),d=[];if(!p||p.next===p.prev)return d;if(h&&(p=function(t,e,r,i){var n,o,s,a=[];for(n=0,o=e.length;n<o;n++)(s=yo(t,e[n]*i,n<o-1?e[n+1]*i:t.length,i,!1))===s.next&&(s.steiner=!0),a.push(Ro(s));for(a.sort(Eo),n=0;n<a.length;n++)bo(a[n],r),r=go(r,r.next);return r}(t,e,p,r)),t.length>80*r){n=s=t[0],o=a=t[1];for(var m=r;m<f;m+=r)(u=t[m])<n&&(n=u),(c=t[m+1])<o&&(o=c),u>s&&(s=u),c>a&&(a=c);l=0!==(l=Math.max(s-n,a-o))?1/l:0}return Uo(p,d,r,n,o,l),d}function Uo(t,e,r,i,n,o,s){if(t){!s&&o&&function(t,e,r,i){var n=t;do{null===n.z&&(n.z=Ao(n.x,n.y,e,r,i)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,r,i,n,o,s,a,u,c=1;do{for(r=t,t=null,o=null,s=0;r;){for(s++,i=r,a=0,e=0;e<c&&(a++,i=i.nextZ);e++);for(u=c;a>0||u>0&&i;)0!==a&&(0===u||!i||r.z<=i.z)?(n=r,r=r.nextZ,a--):(n=i,i=i.nextZ,u--),o?o.nextZ=n:t=n,n.prevZ=o,o=n;r=i}o.nextZ=null,c*=2}while(s>1)}(n)}(t,i,n,o);for(var a,u,c=t;t.prev!==t.next;)if(a=t.prev,u=t.next,o?To(t,i,n,o):xo(t))e.push(a.i/r+zo),e.push(t.i/r+zo),e.push(u.i/r+zo),No(t),t=u.next,c=u.next;else if((t=u)===c){s?1===s?Uo(t=ko(go(t),e,r),e,r,i,n,o,2):2===s&&Go(t,e,r,i,n,o):Uo(go(t),e,r,i,n,o,1);break}}}function ko(t,e,r){var i=t;do{var n=i.prev,o=i.next.next;!Oo(n,o)&&Mo(n,i,i.next,o)&&Po(n,o)&&Po(o,n)&&(e.push(n.i/r+zo),e.push(i.i/r+zo),e.push(o.i/r+zo),No(i),No(i.next),i=t=o),i=i.next}while(i!==t);return go(i)}function Go(t,e,r,i,n,o){var s=t;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&_o(s,a)){var u=Fo(s,a);return s=go(s,s.next),u=go(u,u.next),Uo(s,e,r,i,n,o),void Uo(u,e,r,i,n,o)}a=a.next}s=s.next}while(s!==t)}var Xo=2;function Ho(t,e){for(var r=t.s,i=t.p,n=r[1],o=i[1],s=0,a=0;a<n.length;a++)s+=(E=n[a]).length-1;var u,l=new Float32Array(s*c),h=e.indexBase,f=void 0===h?0:h,p=e.uvTransform,d=0,m=0,v=0,y=1,g=1;p&&(m=p[0],v=p[1],u=p[4],y=u?p[3]:p[2],g=u?p[2]:p[3]);var x=[0,0],T=0===u?0:-Math.PI/2;for(a=0;a<n.length;a++)for(var E=n[a],b=o[a],S=o[a+1]||o[0],A=E,R=[0,0],C=0;C<A.length-1;C++)Wo(R,A[C],b,S,b[4],b[5],S[2],S[3]),w(R[0],R[1]);var _=Bo(Array.from(l),null,c,f);return{aPoint:l,index:new Uint16Array(_)};function w(t,e){l[d++]=t/2,l[d++]=e/2,p?(x[0]=t,x[1]=e,jo(x,x,T),l[d++]=m+(x[0]+1)/2*y,l[d++]=v+(x[1]+1)/2*g):(l[d++]=(t+1)/2,l[d++]=(e+1)/2),d+=Xo}}function Yo(t,e){for(var r=[],i=function(t){var e=[];return t.gs?t.gs.forEach((function(t){e.push({p:[V.SHAPE_POINTS,t.p],s:[V.SHAPE_SPLITS,t.s]})})):t.g?e.push({p:[V.SHAPE_POINTS,t.g.p],s:[V.SHAPE_SPLITS,t.g.s]}):e.push(t),e}(t),n=0,o=0,s=0,a=0;a<i.length;a++)n+=(f=Ho(i[a],{indexBase:n,uvTransform:e})).aPoint.length/5,r.push(f),o+=f.aPoint.length,s+=f.index.length;if(1===r.length)return r[0];for(var u=new Float32Array(o),c=new Uint16Array(s),l=(a=0,0),h=0;a<r[a];a++){var f=r[a];u.set(f.aPoint,l),l+=f.aPoint.length,c.set(f.index,h),h+=f.index.length}return{aPoint:u,index:c}}function jo(t,e,r){var i=Math.cos(r),n=Math.sin(r),o=e[0],s=e[1];return t[0]=i*o+n*s,t[1]=-n*o+i*s,t}function Wo(t,e,r,i,n,o,s,a){var u=1-e,c=u*u*u,l=3*e*u*u,h=3*e*e*u,f=e*e*e;return t[0]=c*r[0]+l*n+h*s+f*i[0],t[1]=c*r[1]+l*o+h*a+f*i[1],t}var Zo=function(){function t(t){var e=t.time,r=t.interval,i=t.count,n=t.cycles,o=t.probability;this.time=+e||0,this.interval=+r||1,this.count=i instanceof we?i:Be(i),this.cycles=+n||1/0,this.probability=isNaN(o)?1:+o,this.reset()}return t.prototype.getGeneratorOptions=function(t,e){if(t-this.time-this.now>this.interval*this.index&&this.internalCycles>0)return this.internalCycles--,this.index++,Math.random()<=this.probability?{index:this.index,total:1/this.interval,count:this.count.getValue(e),cycleIndex:this.cycles-this.internalCycles-1}:null},t.prototype.reset=function(){this.internalCycles=this.cycles,this.index=0,this.now=0},t.prototype.clone=function(){return new t(this)},t}(),qo=new It,Ko=new It,Qo=function(){function e(e,r){var i;this.pointStart=[];var n=e.colorOverLifetime,o=e.colorOverTrail,s=e.maxTrailCount,a=e.opacityOverLifetime,u=void 0===a?Be(1):a,c=e.widthOverTrail,h=e.name,f=e.occlusion,p=e.blending,d=e.maskMode,m=e.order,y=e.textureMap,g=void 0===y?[0,0,1,1]:y,x=e.texture,T=e.transparentOcclusion,E=e.minimumVertexDistance,b=e.lifetime,S=e.matrix,A=r.gpuCapability,R=A.detail,C=A.level,_=Math.max(e.pointCountPerTrail,2),w={curves:[],index:0,max:0,lineSegCount:0,curveCount:0},O=R.maxVertexTextures>0,M=(null!==(i=r.renderer)&&void 0!==i?i:{}).env,L={},I=[["ENABLE_VERTEX_TEXTURE",O],["LOOKUP_TEXTURE_CURVE",0],["ENV_EDITOR",M===l]],P=s>64,F=0;n&&(I.push(["COLOR_OVER_LIFETIME",!0]),F|=1,L.uColorOverLifetime=qr.createWithData(r,mt(n))),o&&(I.push(["COLOR_OVER_TRAIL",!0]),F|=4,L.uColorOverTrail=qr.createWithData(r,mt(o))),P?(I.push(["ATTR_TRAIL_START",1]),F|=8):L.uTrailStart=new Float32Array(s),L.uOpacityOverLifetimeValue=u.toUniform(w);var V=c.toUniform(w);I.push(["VERT_CURVE_VALUE_COUNT",w.index],["VERT_MAX_KEY_FRAME_COUNT",w.max]),L.uVCurveValues=we.getAllData(w);var N={shader:{vertex:Nr(I,Gi,t.ShaderType.vertex,C),fragment:Nr(I,Ui,t.ShaderType.fragment,C),marcos:I,glslVersion:1===C?t.GLSLVersion.GLSL1:t.GLSLVersion.GLSL3,shared:!0,name:"trail#".concat(h),cacheId:"-t:+".concat(F,"+").concat(w.index,"+").concat(w.max)},uniformSemantics:{effects_MatrixVP:"VIEWPROJECTION",effects_MatrixInvV:"VIEWINVERSE",effects_ObjectToWorld:"MODEL",uEditorTransform:"EDITOR_TRANSFORM"}},D=_*s*2,z=(_-1)*s,B=Float32Array.BYTES_PER_ELEMENT,U=12*B,k={attributes:{aColor:{size:4,stride:U,data:new Float32Array(12*D)},aSeed:{size:1,stride:U,offset:4*B,dataSource:"aColor"},aInfo:{size:3,stride:U,offset:5*B,dataSource:"aColor"},aPos:{size:4,stride:U,offset:8*B,dataSource:"aColor"},aTime:{size:1,data:new Float32Array(D)},aDir:{size:3,data:new Float32Array(3*D)}},indices:{data:new Uint16Array(6*D)},drawCount:6*z,name:"trail#".concat(h),bufferUsage:v.DYNAMIC_DRAW};if(P)k.attributes.aTrailStart={size:1,data:new Float32Array(D)};else{var G=new Float32Array(D);k.attributes.aTrailStartIndex={size:1,data:G};for(var X=0;X<s;X++)for(var H=2*_,Y=X*H,j=0;j<H;j++)G[Y+j]=X}var W=Ir(p),Z=ui.create(r,N);Z.blending=!0,Z.depthMask=f,Z.depthTest=!0,Br(Z,d),Dr(Z,p);var q=this.mesh=Li.create(r,{name:"MTrail_".concat(h),material:Z,geometry:bi.create(r,k),priority:m}),K=null!=x?x:qr.createWithData(r);Object.keys(L).map((function(t){var e=L[t];if(e instanceof qr)Z.setTexture(t,e);else if("uTrailStart"===t)Z.setFloats("uTrailStart",e);else if("uVCurveValues"===t){for(var r=[],i=0;i<e.length;i+=4){var n=new kt(e[i],e[i+1],e[i+2],e[i+3]);r.push(n)}Z.setVector4Array(t,r)}else Z.setVector4(t,kt.fromArray(e))})),Z.setFloat("uTime",0),Z.setVector4("uWidthOverTrail",kt.fromArray(V)),Z.setVector2("uTexOffset",new Lt(0,0)),Z.setVector4("uTextureMap",kt.fromArray(g)),Z.setVector4("uParams",new kt(0,_-1,0,0)),Z.setTexture("uMaskTex",K),Z.setVector4("uColorParams",new kt(x?1:0,+W,0,+(f&&!T))),this.maxTrailCount=s,this.pointCountPerTrail=_,this.checkVertexDistance=E>0,this.minimumVertexDistance=Math.pow(E||.001,2),this.useAttributeTrailStart=P,this.lifetime=b,S&&(this.mesh.worldMatrix=S),this.geometry=q.firstGeometry(),this.trailCursors=new Uint16Array(s)}return Object.defineProperty(e.prototype,"time",{get:function(){return this.mesh.material.getFloat("uTime")||0},set:function(t){this.mesh.material.setFloat("uTime",null!=t?t:0)},enumerable:!1,configurable:!0}),e.prototype.addPoint=function(t,e,r){r=r||{};var i=this.trailCursors[t],n=this.pointCountPerTrail,o=this.geometry,s=n-1,a=i%n,u=(i-1)%n,c=(i-2)%n,l=this.getTrailPosition(t,u,qo);if(!(l&&this.checkVertexDistance&&(null==l?void 0:l.distanceSquared(e))<this.minimumVertexDistance)){var h=t*n+a,f=es(l,e),p=r.time||this.time,d=[Math.random(),r.lifetime||this.lifetime,i],m=r.size||1,v=6*h,y=new Float32Array(6);y.set(f,0),y.set(f,3),o.setAttributeSubData("aDir",v,y),o.setAttributeSubData("aTime",2*h,new Float32Array([p,p]));var g=r.color||[1,1,1,1],x=new Float32Array(24),T=e.toArray();if(x.set(g,0),x.set(d,4),x[7]=0,x.set(T,8),x[11]=.5*m,x.set(g,12),x.set(d,16),x[19]=1,x.set(T,20),x[23]=-.5*m,o.setAttributeSubData("aColor",24*h,x),u>=0){var E=this.getTrailPosition(t,c,Ko),b=new Float32Array(es(E,l,e)),S=6*(t*n+u);o.setAttributeSubData("aDir",S,b),o.setAttributeSubData("aDir",S+3,b);var A=t*n*2,R=new Uint16Array([2*u+A,2*u+1+A,2*a+A,2*a+A,2*u+1+A,2*a+1+A]),C=6*(t*s+(i-1)%s);o.setIndexSubData(C,R)}i=++this.trailCursors[t];var _=this.mesh.material,w=_.getVector4("uParams"),O=d[2];if(this.useAttributeTrailStart){for(var M=2*n,L=new Float32Array(M),I=0;I<M;I++)L[I]=O;o.setAttributeSubData("aTrailStart",t*L.length,L)}else{var P=_.getFloats("uTrailStart");null!=P&&(P[t]=O,_.setFloats("uTrailStart",P))}w&&(w.y=Math.max(w.y,i-1)-Math.max(0,i-n),_.setVector4("uParams",w))}},e.prototype.getTrailPosition=function(t,e,r){var i=this.pointCountPerTrail;if(e>=0&&e<i){var n=24*(t*i+e)+8,o=this.geometry.getAttributeData("aColor");return r.x=o[n],r.y=o[1+n],r.z=o[2+n],r}},e.prototype.clearAllTrails=function(){var t=this.geometry;this.trailCursors=new Uint16Array(this.trailCursors.length),t.setIndexData(new Uint16Array(t.getIndexData().length))},e.prototype.minusTime=function(t){for(var e=this.geometry.getAttributeData("aTime"),r=0;r<e.length;r++)e[r]-=t;this.geometry.setAttributeData("aTime",e),this.time-=t},e.prototype.clearTrail=function(t){if(0!==this.trailCursors[t]){var e=6*(this.pointCountPerTrail-1),r=this.geometry.getIndexData();null==r||r.set(new Uint16Array(e),t*e),this.geometry.setIndexData(r),this.trailCursors[t]=0}},e.prototype.getPointStartPos=function(t){return this.pointStart[t]},e.prototype.setPointStartPos=function(t,e){this.pointStart[t]=e},e.prototype.onUpdate=function(t){},e}(),Jo=new It,$o=new It,ts=new It;function es(t,e,r){var i=Jo;return t||r?(t?r?($o.subtractVectors(e,t).normalize(),$o.subtractVectors(r,e),ts.copyFrom($o).normalize(),i.addVectors($o,ts)):i.subtractVectors(e,t):i.subtractVectors(r,e),i.normalize().toArray()):[0,0,0]}var rs=function(){function t(t,e,r){var i,n,o,s,a,u,c=r.composition,l=r.endBehavior,h=r.name;if(c){var f,p=c.getEngine(),d=e.cachePrefix,m=void 0===d?"":d,v=t.options,y=t.positionOverLifetime,g=t.shape,x=r.duration||1,T=y.gravityOverLifetime,E=ee(y.gravity),R=t.textureSheetAnimation,C=R?{animationDelay:Be(R.animationDelay||0),animationDuration:Be(R.animationDuration||1),cycles:Be(R.cycles||1),animate:R.animate,col:R.col,row:R.row,total:R.total||R.col*R.row}:void 0,_=Nt.fromIdentity(),w=!!(g&&g.turbulenceX||g.turbulenceY||g.turbulenceZ);w&&(f=[Be(null!==(i=g.turbulenceX)&&void 0!==i?i:0),Be(null!==(n=g.turbulenceY)&&void 0!==n?n:0),Be(null!==(o=g.turbulenceZ)&&void 0!==o?o:0)]),this.name=h,this.shape=vo(g),this.emission={rateOverTime:Be(t.emission.rateOverTime),burstOffsets:fs(null!==(s=t.emission.burstOffsets)&&void 0!==s?s:[]),bursts:(t.emission.bursts||[]).map((function(t){return new Zo(t)}))},this.textureSheetAnimation=C;var O,L=t.renderer||{},I={},P=t.rotationOverLifetime;P&&(I.asRotation=!!P.asRotation,I.z=P.z?Be(P.z):Be(0),P.separateAxes&&(I.x=P.x&&Be(P.x),I.y=P.y&&Be(P.y))),y.forceTarget&&(O={target:y.target||[0,0,0],curve:Be(y.forceCurve||[V.LINE,[[0,0],[1,1]]])});var F={x:y.linearX&&Be(y.linearX||0),y:y.linearY&&Be(y.linearY||0),z:y.linearZ&&Be(y.linearZ||0),asMovement:y.asMovement},N={x:y.orbitalX&&Be(y.orbitalX),y:y.orbitalY&&Be(y.orbitalY),z:y.orbitalZ&&Be(y.orbitalZ),center:y.orbCenter,asRotation:y.asRotation},z=t.sizeOverLifetime||{},B=t.colorOverLifetime,U=r.listIndex,k=m,G=(null==z?void 0:z.separateAxes)?{separateAxes:!0,x:Be(z.x),y:Be(z.y)}:{separateAxes:!1,x:Be(("size"in z?z.size:z.x)||1)},X=Lt.fromArray(ae(L.anchor,L.particleOrigin));this.options={particleFollowParent:!!v.particleFollowParent,startLifetime:Be(v.startLifetime),startDelay:Be(v.startDelay||0),startSpeed:Be(y.startSpeed||0),startColor:Be(v.startColor),endBehavior:l,duration:x,looping:l===D.loop,maxCount:null!==(a=v.maxCount)&&void 0!==a?a:0,gravityModifier:Be(T||0).scaleXCoord(x),gravity:E,start3DSize:!!v.start3DSize,startTurbulence:w,turbulence:f,speedOverLifetime:y.speedOverLifetime&&Be(y.speedOverLifetime),linearVelOverLifetime:F,orbitalVelOverLifetime:N,forceTarget:O},v.startRotationZ&&(this.options.startRotation=Be(v.startRotationZ||0)),(v.startRotationX||v.startRotationY)&&(this.options.start3DRotation=!0,this.options.startRotationX=Be(v.startRotationX||0),this.options.startRotationY=Be(v.startRotationY||0),this.options.startRotationZ=Be(v.startRotationZ||0)),v.start3DSize?(this.options.startSizeX=Be(v.startSizeX),this.options.startSizeY=Be(v.startSizeY)):(this.options.startSize=Be(v.startSize),this.options.sizeAspect=Be(v.sizeAspect||1));var H={listIndex:U,meshSlots:v.meshSlots,name:h,matrix:_,filter:t.filter,shaderCachePrefix:k,renderMode:L.renderMode||M.BILLBOARD,side:L.side||S.DOUBLE,gravity:E,duration:r.duration,blending:L.blending||b.ALPHA,rotationOverLifetime:I,gravityModifier:this.options.gravityModifier,linearVelOverLifetime:this.options.linearVelOverLifetime,orbitalVelOverLifetime:this.options.orbitalVelOverLifetime,speedOverLifetime:this.options.speedOverLifetime,sprite:C,occlusion:!!L.occlusion,transparentOcclusion:!!L.transparentOcclusion,maxCount:v.maxCount,mask:L.mask,maskMode:null!==(u=L.maskMode)&&void 0!==u?u:A.NONE,forceTarget:O,diffuse:L.texture,sizeOverLifetime:G,anchor:X};if(B){var Y=B.color,j=B.opacity;H.colorOverLifetime={},j&&(H.colorOverLifetime.opacity=Be(B.opacity)),Y&&(Y[0]===V.GRADIENT_COLOR?H.colorOverLifetime.color=B.color[1]:Y[0]===V.RGBA_COLOR?H.colorOverLifetime.color=qr.createWithData(p,{data:new Uint8Array(Y[1]),width:1,height:1}):Y instanceof qr&&(H.colorOverLifetime.color=Y))}var W,Z=[],q=[0,0,1,1];if(t.splits){var K=t.splits[0];q=(W=K[4])?[K[0],K[1],K[3],K[2]]:[K[0],K[1],K[2],K[3]]}if(C&&!C.animate)for(var Q=W?C.row:C.col,J=W?C.col:C.row,$=C.total||Q*J,tt=0,et=0;et<Q;et++)for(var rt=0;rt<J&&tt<$;rt++,tt++)Z.push([et*q[2]/Q+q[0],rt*q[3]/J+q[1],q[2]/Q,q[3]/J]);else Z.push(q);H.textureFlip=W,this.uvs=Z,this.particleMesh=new vs(H,{composition:c});var it=t.trails;if(it){this.trails={lifetime:Be(it.lifetime),dieWithParticles:!1!==it.dieWithParticles,sizeAffectsWidth:!!it.sizeAffectsWidth,sizeAffectsLifetime:!!it.sizeAffectsLifetime,inheritParticleColor:!!it.inheritParticleColor,parentAffectsPosition:!!it.parentAffectsPosition};var nt={name:r.name+"_trail",matrix:_,minimumVertexDistance:it.minimumVertexDistance||.02,maxTrailCount:v.maxCount,pointCountPerTrail:Math.round(it.maxPointPerTrail)||32,blending:it.blending,texture:it.texture,opacityOverLifetime:Be(it.opacityOverLifetime||1),widthOverTrail:Be(it.widthOverTrail||1),order:U+(it.orderOffset||0),shaderCachePrefix:k,lifetime:this.trails.lifetime,occlusion:!!it.occlusion,transparentOcclusion:!!it.transparentOcclusion,textureMap:it.textureMap,mask:L.mask,maskMode:L.maskMode};it.colorOverLifetime&&it.colorOverLifetime[0]===V.GRADIENT_COLOR&&(nt.colorOverLifetime=it.colorOverLifetime[1]),it.colorOverTrail&&it.colorOverTrail[0]===V.GRADIENT_COLOR&&(nt.colorOverTrail=it.colorOverTrail[1]),this.trailMesh=new Qo(nt,p)}this.transform=r.transform;var ot,st=this.transform.position.clone(),at=this.transform.rotation.clone(),ut=t.emitterTransform&&t.emitterTransform.path;ut&&(ut[0]===V.CONSTANT_VEC3?st.add(ut[1]):ot=Be(ut)),this.basicTransform={position:st,rotation:at,path:ot},this.updateEmitterTransform(0);var ct=[this.particleMesh.mesh];this.trailMesh&&ct.push(this.trailMesh.mesh),this.meshes=ct,this.reusable=r.reusable,this.setVisible(r.contentVisible);var lt=t.interaction;lt&&(this.interaction={multiple:lt.multiple,radius:lt.radius,behavior:lt.behavior})}}return Object.defineProperty(t.prototype,"timePassed",{get:function(){return this.lastUpdate-this.loopStartTime},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"lifetime",{get:function(){return this.timePassed/this.options.duration},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"particleCount",{get:function(){return this.particleLink.length},enumerable:!1,configurable:!0}),t.prototype.updateEmitterTransform=function(t){var e=this.transform.parentTransform,r=this.basicTransform,i=r.path,n=r.position.clone();if(i){var o=this.options.duration;n.add(i.getValue(t/o))}if(this.transform.setPosition(n.x,n.y,n.z),this.options.particleFollowParent&&e){var s=e.getWorldMatrix();this.particleMesh.mesh.worldMatrix=s,this.trailMesh&&(this.trailMesh.mesh.worldMatrix=s)}},t.prototype.addParticle=function(t,e){var r,i=this.particleLink,n=[t.delay+t.lifetime,0,t.delay,t];if(i.length<e)r=n[1]=i.length;else{var o=i.first;i.removeNode(o),r=n[1]=o.content[1]}i.pushNode(n),this.particleMesh.setPoint(t,r),this.clearPointTrail(r),this.trailMesh&&this.trailMesh.setPointStartPos(r,this.transform.parentTransform.position.clone())},t.prototype.setVisible=function(t){this.particleMesh.mesh.setVisible(t),this.trailMesh&&this.trailMesh.mesh.setVisible(t)},t.prototype.setOpacity=function(t){var e,r=this.particleMesh.mesh.material,i=this.particleMesh.mesh.geometry,n=(null===(e=r.getVector4("uOpacityOverLifetimeValue"))||void 0===e?void 0:e.toArray())||[1,1,1,1];r.setVector4("uOpacityOverLifetimeValue",new kt(n[0],n[1],n[2],t));for(var o=i.getAttributeData("aColor")||[],s=0;s<o.length;s+=32)o[8*s+7]=t},t.prototype.setColor=function(t,e,r,i){var n,o=this.particleMesh.mesh.material,s=this.particleMesh.mesh.geometry,a=(null===(n=o.getVector4("uOpacityOverLifetimeValue"))||void 0===n?void 0:n.toArray())||[1,1,1,1];o.setVector4("uOpacityOverLifetimeValue",new kt(a[0],a[1],a[2],i));for(var u=s.getAttributeData("aColor")||[],c=0;c<u.length;c+=32)u[8*c+4]=t,u[8*c+5]=e,u[8*c+6]=r,u[8*c+7]=i},t.prototype.setParentTransform=function(t){},t.prototype.getTextures=function(){var t=[],e=this.particleMesh.mesh.material.textures;if(Object.keys(e).forEach((function(r){t.push(e[r])})),this.trailMesh){var r=this.trailMesh.mesh.material.textures;Object.keys(r).forEach((function(e){t.push(r[e])}))}return t},t.prototype.start=function(){this.started&&!this.ended||(this.reset(),this.started=!0,this.ended=!1)},t.prototype.stop=function(){this.ended=!0,this.started=!1},t.prototype.reset=function(){var t;this.particleMesh.clearPoints(),null===(t=this.trailMesh)||void 0===t||t.clearAllTrails(),this.lastUpdate=0,this.loopStartTime=0,this.lastEmitTime=-1/this.emission.rateOverTime.getValue(0),this.generatedCount=0,this.particleLink=new $n((function(t,e){return t[0]-e[0]})),this.emission.bursts.forEach((function(t){return t.reset()})),this.frozen=!1},t.prototype.onUpdate=function(t){var e,r=this;if(this.started&&!this.frozen){var i=this.lastUpdate+t/1e3,n=this.particleMesh,o=this.trailMesh,s=this.options,c=this.loopStartTime,l=this.emission;this.lastUpdate=i,this.upDirectionWorld=null,n.time=i,o&&(o.time=i,o.onUpdate(t));var h=this.particleLink,f=(i-c)/s.duration,p=this.timePassed,d=!1,m=function(){r.trails&&!d&&(d=!0,h.forEach((function(t){var e=a(t,4),i=e[0],n=e[1],o=e[2],s=e[3];i<p?r.clearPointTrail(n):p>o&&r.updatePointTrail(n,f,s,o)})))};if(this.ended){if(!s.looping)if(this.reusable);else if(0===s.endBehavior){var v=h.last;v&&v.content[0]-c<p&&(this.onUpdate=function(){return r.onDestroy()})}}else{var y=s.duration,g=this.lifetime;if(p<y){var x=1/l.rateOverTime.getValue(g),T=Math.floor((p-this.lastEmitTime)/x),E=T,b=x/T,S=i,A=s.maxCount;this.updateEmitterTransform(p);for(var R=function(){var t=h.first;return r.emissionStopped||h.length===A&&t&&t.content[0]-c>p},C=0;C<E&&C<A&&!R();C++)(F=this.createPoint(g)).delay+=S+C*b,this.addParticle(F,A),this.lastEmitTime=p;for(var _=l.bursts,w=(null==_?void 0:_.length)-1,O=0;w>=0&&O<A&&!R();w--){var M=_[w],L=!M.disabled&&M.getGeneratorOptions(p,g);if(L){var I=l.burstOffsets[w],P=I&&I[L.cycleIndex]||[0,0,0];for(M.once&&this.removeBurst(w),C=0;C<L.count&&O<A&&!R();C++){var F;(F=this.initPoint(this.shape.generate({total:L.total,index:L.index,burstIndex:C,burstCount:L.count}))).delay+=S,O++,(e=F.transform).translate.apply(e,u([],a(P),!1)),this.addParticle(F,A)}}}}else s.looping?(m(),this.loopStartTime=i-y,this.lastEmitTime-=y,this.lastUpdate-=y,l.bursts.forEach((function(t){return t.reset()})),this.particleLink.forEach((function(t){t[0]-=y,t[2]-=y,t[3].delay-=y})),n.minusTime(y),o&&o.minusTime(y),this.onIterate(this)):(this.ended=!0,this.onEnd(this),4===s.endBehavior&&(this.frozen=!0))}m()}},t.prototype.onDestroy=function(){},t.prototype.getParticleBoxes=function(){var t=this.particleLink,e=this.particleMesh,r=[],i=this.particleCount,n=0;if(!t||!e)return r;for(var o=t.last,s=!1;!s;){var a=o.content[0],u=o.content[3];if(a>this.timePassed){var c=this.getPointPosition(u);r.push({center:c,size:u.transform.scale}),o.pre?o=o.pre:s=!0}++n>i&&(s=!0)}return r},t.prototype.raycast=function(t){var e=this.particleLink,r=this.particleMesh;if(e&&r){var i=e.last,n=[],o=new It,s=!1;if(i&&i.content)do{var u=a(i.content,4),c=u[0],l=u[1];u[2];var h=u[3];if(!(c>this.timePassed))break;var f=this.getPointPosition(h),p=t.ray,d=!1;p&&(d=!!p.intersectSphere({center:f,radius:t.radius},o)),d&&(t.removeParticle&&(r.removePoint(l),this.clearPointTrail(l),i.content[0]=0),n.push(f),t.multiple||(s=!0))}while((i=i.pre)&&!s);return n}},t.prototype.clearPointTrail=function(t){var e;this.trails&&this.trails.dieWithParticles&&(null===(e=this.trailMesh)||void 0===e||e.clearTrail(t))},t.prototype.updatePointTrail=function(t,e,r,i){if(this.trailMesh){var n=this.trails,o=this.particleMesh,s=this.getPointPosition(r),a=n.inheritParticleColor?o.getPointColor(t):[1,1,1,1],u=r.transform.getWorldScale().toArray(),c=1,l=n.lifetime.getValue(e);if(n.sizeAffectsWidth&&(c*=u[0]),n.sizeAffectsLifetime&&(l*=u[0]),n.parentAffectsPosition&&this.transform.parentTransform){s.add(this.transform.parentTransform.position);var h=this.trailMesh.getPointStartPos(t);h&&s.subtract(h)}this.trailMesh.addPoint(t,s,{color:a,lifetime:l,size:c,time:i})}},t.prototype.getPointPosition=function(t){var e=t.transform,r=t.vel,i=t.lifetime,n=t.delay,o=t.gravity,s=void 0===o?[]:o,a=this.options.forceTarget,u=this.lastUpdate-n,c=new It,l=It.fromArray(s);e.assignWorldTRS(c);var h=te(new It,this.options,l,u,i,c,r);if(a){var f=a.target||[0,0,0],p=a.curve.getValue(u/i),d=1-p;h.x=h.x*d+f[0]*p,h.y=h.y*d+f[1]*p,h.z=h.z*d+f[2]*p}return h},t.prototype.onEnd=function(t){},t.prototype.onIterate=function(t){},t.prototype.initPoint=function(t){var e=this.options,r=this.lifetime,i=this.shape,n=e.startSpeed.getValue(r),o=e.particleFollowParent?this.transform.getMatrix():this.transform.getWorldMatrix(),s=o.transformPoint(t.position,new It),a=new cr({position:s,valid:!0}),u=t.direction;if(u=o.transformNormal(u,is).normalize(),e.startTurbulence&&e.turbulence){for(var c=0;c<3;c++)us.setElement(c,e.turbulence[c].getValue(r));cs.setFromVector3(us.negate()),hs.setFromEuler(cs).transformNormal(u).normalize()}var l,h=ss,f=as;i.alignSpeedDirection?(f.copyFrom(u),this.upDirectionWorld||(i.upDirection?this.upDirectionWorld=i.upDirection.clone():this.upDirectionWorld=It.Z.clone(),o.transformNormal(this.upDirectionWorld)),h.crossVectors(f,this.upDirectionWorld).normalize(),h.isZero()&&h.set(1,0,0)):(h.set(1,0,0),f.set(0,1,0));var p=this.textureSheetAnimation;p&&p.animate&&((l=ls)[0]=p.animationDelay.getValue(r),l[1]=p.animationDuration.getValue(r),l[2]=p.cycles.getValue(r));var d=os;e.start3DRotation?d.set(e.startRotationX.getValue(r),e.startRotationY.getValue(r),e.startRotationZ.getValue(r)):e.startRotation?d.set(0,0,e.startRotation.getValue(r)):d.set(0,0,0),a.setRotation(d.x,d.y,d.z);var m=e.startColor.getValue(r);3===m.length&&(m[3]=1);var v=ns;if(e.start3DSize)v.x=e.startSizeX.getValue(r),v.y=e.startSizeY.getValue(r);else{var y=e.startSize.getValue(r),g=e.sizeAspect.getValue(r);v.x=y,v.y=0===g?0:y/g}var x=u.clone();if(x.multiply(n),!e.particleFollowParent){var T=new It;this.transform.assignWorldTRS(void 0,void 0,T),v.x*=T.x,v.y*=T.y}return a.setScale(v.x,v.y,1),{size:v,vel:x,color:m,delay:e.startDelay.getValue(r),lifetime:e.startLifetime.getValue(r),uv:ps(this.uvs,!0),gravity:e.gravity,sprite:l,dirY:f,dirX:h,transform:a}},t.prototype.addBurst=function(t,e){var r=!1;if(this.emission.bursts.includes(t)||(this.emission.bursts.push(t),r=!0),r&&e instanceof Array){var i=this.emission.bursts.indexOf(t);return this.emission.burstOffsets[i]=e,i}return-1},t.prototype.removeBurst=function(t){t<this.emission.bursts.length&&(this.emission.burstOffsets[t]=null,this.emission.bursts.splice(t,1))},t.prototype.createPoint=function(t){var e={total:this.emission.rateOverTime.getValue(t),index:this.generatedCount,burstIndex:0,burstCount:0};return this.generatedCount++,this.initPoint(this.shape.generate(e))},t}(),is=new It,ns=new Lt,os=new Ut,ss=new It,as=new It,us=new It,cs=new Ut,ls=[0,0,0],hs=new Nt;function fs(t){var e={};return Array.isArray(t)&&t.forEach((function(t){var r=t instanceof Array,i=r?t[0]:t.index,n=e[i];n||(n=e[i]=[]),r?n.push(t.slice(1,4)):n.push([+t.x,+t.y,+t.z])})),e}function ps(t,e){var r=Math.floor(Math.random()*t.length),i=t[r];return e||t.splice(r,1),i}var ds=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.destroyed=!1,t}return r(i,e),Object.defineProperty(i.prototype,"type",{get:function(){return O.particle},enumerable:!1,configurable:!0}),i.prototype.onConstructed=function(t){this.particle=t.content,this.composition&&(this._content=new rs(this.particle,this.composition.getRendererOptions(),this))},i.prototype.onLifetimeBegin=function(t,e){var r=this;return e&&(e.name=this.name,e.start(),e.onDestroy=function(){r.destroyed=!0}),e},i.prototype.onItemUpdate=function(t,e){var r;if(this.content){var i=!this.visible,n=this.parentId&&(null===(r=this.composition)||void 0===r?void 0:r.getItemByID(this.parentId));if(!i&&n){var o=n.getRenderData();o&&(o.visible||(i=!1))}i?this.content.setVisible(!1):(this.content.setVisible(!0),this.content.onUpdate(t))}},i.prototype.onItemRemoved=function(e,r){r&&(e.destroyTextures(r.getTextures()),r.meshes.forEach((function(e){return e.dispose({material:{textures:t.DestroyOptions.keep}})})))},i.prototype.setColor=function(t,e,r,i){this.content.setColor(t,e,r,i)},i.prototype.setOpacity=function(t){this.content.setOpacity(t)},i.prototype.stopParticleEmission=function(){this.content&&(this.content.emissionStopped=!0)},i.prototype.resumeParticleEmission=function(){this.content&&(this.content.emissionStopped=!1)},i.prototype.doCreateContent=function(t){return this.content?this.content:new rs(this.particle,t.getRendererOptions(),this)},i.prototype.isEnded=function(t){return e.prototype.isEnded.call(this,t)&&this.destroyed},i.prototype.getBoundingBox=function(){var e=this.content;if(e){var r=e.getParticleBoxes();return{type:t.HitTestType.sphere,area:r}}},i.prototype.getHitTestParams=function(e){var r,i=this,n=null===(r=this.content)||void 0===r?void 0:r.interaction;if(e||n)return{type:t.HitTestType.custom,collect:function(t){var e;return null===(e=i.content)||void 0===e?void 0:e.raycast({radius:(null==n?void 0:n.radius)||.4,multiple:!!(null==n?void 0:n.multiple),removeParticle:(null==n?void 0:n.behavior)===B.removeParticle,ray:t})}}},i}(lr),ms={uSprite:"vec4",uParams:"vec4",uAcceleration:"vec4",uGravityModifierValue:"vec4",uOpacityOverLifetimeValue:"vec4",uRXByLifeTimeValue:"vec4",uRYByLifeTimeValue:"vec4",uRZByLifeTimeValue:"vec4",uLinearXByLifetimeValue:"vec4",uLinearYByLifetimeValue:"vec4",uLinearZByLifetimeValue:"vec4",uSpeedLifetimeValue:"vec4",uOrbXByLifetimeValue:"vec4",uOrbYByLifetimeValue:"vec4",uOrbZByLifetimeValue:"vec4",uSizeByLifetimeValue:"vec4",uSizeYByLifetimeValue:"vec4",uColorParams:"vec4",uFSprite:"vec4",uPreviewColor:"vec4",uVCurveValues:"vec4Array",uFCurveValues:"vec4",uFinalTarget:"vec3",uForceCurve:"vec4",uOrbCenter:"vec3",uTexOffset:"vec2",uPeriodValue:"vec4",uMovementValue:"vec4",uStrengthValue:"vec4",uWaveParams:"vec4"},vs=function(){function e(e,r){var i,n,o,s;this.particleCount=0;var a,u,c=r.composition.getEngine(),f=(null!==(i=c.renderer)&&void 0!==i?i:{}).env,p=e.speedOverLifetime,d=e.colorOverLifetime,m=e.linearVelOverLifetime,v=e.orbitalVelOverLifetime,y=e.sizeOverLifetime,g=e.rotationOverLifetime,x=e.sprite,T=e.gravityModifier,E=e.maxCount,b=e.duration,S=e.textureFlip,A=e.useSprite,R=e.name,C=e.filter,_=e.gravity,w=e.forceTarget,O=e.side,M=e.occlusion,L=e.anchor,I=e.blending,P=e.maskMode,F=e.mask,V=e.transparentOcclusion,N=e.listIndex,D=e.meshSlots,z=e.renderMode,B=void 0===z?0:z,U=e.diffuse,k=void 0===U?qr.createWithData(c):U,G=c.gpuCapability.detail,X=G.halfFloatTexture,H=G.maxVertexUniforms,Y=[["RENDER_MODE",+B],["PRE_MULTIPLY_ALPHA",!1],["ENV_EDITOR",f===l]],j=c.gpuCapability.level,W={curves:[],index:0,max:0,lineSegCount:0,curveCount:0},Z={curves:[],index:0,max:0,lineSegCount:0,curveCount:0},q=H>0,K={},Q=0,J=0;if(this.useSprite=A,q&&Y.push(["ENABLE_VERTEX_TEXTURE",!0]),p&&(Y.push(["SPEED_OVER_LIFETIME",!0]),J|=2,K.uSpeedLifetimeValue=p.toUniform(W)),(null==x?void 0:x.animate)&&(Y.push(["USE_SPRITE",!0]),J|=4,K.uFSprite=K.uSprite=new Float32Array([x.col,x.row,x.total,x.blend?1:0]),this.useSprite=!0),C&&C.name!==h){Y.push(["USE_FILTER",!0]),J|=8;var $=et(C,r.composition);if(!$.particle)throw new Error("particle filter ".concat(C.name," not implement"));a=$.particle,Object.keys(null!==(n=a.uniforms)&&void 0!==n?n:{}).forEach((function(t){var e,r=null===(e=a.uniforms)||void 0===e?void 0:e[t];if(K[t])throw new Error("conflict uniform name:"+t);K[t]=null==r?void 0:r.toUniform(W)})),Object.keys(null!==(o=a.uniformValues)&&void 0!==o?o:{}).forEach((function(t){var e,r=null===(e=a.uniformValues)||void 0===e?void 0:e[t];if(K[t])throw new Error("conflict uniform name:"+t);K[t]=r}))}(null==d?void 0:d.color)&&(Y.push(["COLOR_OVER_LIFETIME",!0]),J|=16,K.uColorOverLifetime=d.color instanceof qr?d.color:qr.createWithData(c,mt(d.color))),(null==d?void 0:d.opacity)?K.uOpacityOverLifetimeValue=d.opacity.toUniform(W):K.uOpacityOverLifetimeValue=Be(1).toUniform(W),["x","y","z"].forEach((function(t,e){var r=0,i=0;(null==m?void 0:m[t])&&(K["uLinear".concat(t.toUpperCase(),"ByLifetimeValue")]=m[t].toUniform(W),r=1,J|=1<<7+e,m.enabled=!0),Y.push(["LINEAR_VEL_".concat(t.toUpperCase()),r]),(null==v?void 0:v[t])&&(K["uOrb".concat(t.toUpperCase(),"ByLifetimeValue")]=v[t].toUniform(W),i=1,J|=1<<10+e,u=!0,v.enabled=!0),Y.push(["ORB_VEL_".concat(t.toUpperCase()),i])})),(null==m?void 0:m.asMovement)&&(Y.push(["AS_LINEAR_MOVEMENT",!0]),J|=32),u&&((null==v?void 0:v.asRotation)&&(Y.push(["AS_ORBITAL_MOVEMENT",!0]),J|=64),K.uOrbCenter=new Float32Array((null==v?void 0:v.center)||[0,0,0])),K.uSizeByLifetimeValue=null==y?void 0:y.x.toUniform(W),(null==y?void 0:y.separateAxes)&&(Y.push(["SIZE_Y_BY_LIFE",1]),J|=16384,K.uSizeYByLifetimeValue=null===(s=null==y?void 0:y.y)||void 0===s?void 0:s.toUniform(W)),(null==g?void 0:g.z)&&(K.uRZByLifeTimeValue=g.z.toUniform(W),J|=32768,Y.push(["ROT_Z_LIFETIME",1])),(null==g?void 0:g.x)&&(K.uRXByLifeTimeValue=g.x.toUniform(W),J|=65536,Y.push(["ROT_X_LIFETIME",1])),(null==g?void 0:g.y)&&(K.uRYByLifeTimeValue=g.y.toUniform(W),J|=1<<17,Y.push(["ROT_Y_LIFETIME",1])),(null==g?void 0:g.asRotation)&&(Y.push(["ROT_LIFETIME_AS_MOVEMENT",1]),J|=1<<18),K.uGravityModifierValue=T.toUniform(W),w&&(Y.push(["FINAL_TARGET",!0]),J|=1<<19,K.uFinalTarget=new Float32Array(w.target||[0,0,0]),K.uForceCurve=w.curve.toUniform(W)),X&&Z.max?(J|=1<<20,K.uFCurveValueTexture=Kr(c,we.getAllData(Z,!0),Z.index,1)):K.uFCurveValues=we.getAllData(Z);var tt=W.max+W.curves.length-32>H;if(2===j&&(W.max=-1,W.index=D?D[0]:gs(W.index),Z.index>0&&(Z.max=-1,Z.index=D?D[1]:gs(Z.index))),tt&&X&&q){var rt=Kr(c,we.getAllData(W,!0),W.index,1);K.uVCurveValueTexture=rt,Q=1}else K.uVCurveValues=we.getAllData(W);var it=["-p:",B,J,W.index,W.max,Z.index,Z.max].join("+");Y.push(["VERT_CURVE_VALUE_COUNT",W.index],["FRAG_CURVE_VALUE_COUNT",Z.index],["VERT_MAX_KEY_FRAME_COUNT",W.max],["FRAG_MAX_KEY_FRAME_COUNT",Z.max]);var nt=C?Ui.replace(/#pragma\s+FILTER_FRAG/,a.fragment):Ui,ot="#define LOOKUP_TEXTURE_CURVE ".concat(Q,"\n").concat(ki),st=C?ot.replace(/#pragma\s+FILTER_VERT/,a.vertex||"void filterMain(float t){}\n"):ot,at={fragment:Nr(Y,nt,t.ShaderType.fragment,j),vertex:Nr(Y,st,t.ShaderType.vertex,j),glslVersion:1===j?t.GLSLVersion.GLSL1:t.GLSLVersion.GLSL3,shared:!0,cacheId:it,marcos:Y,name:"particle#".concat(R)};C&&(at.cacheId+=C.name);var ut={shader:at,uniformSemantics:{effects_MatrixV:"VIEW",effects_MatrixVP:"VIEWPROJECTION",uEditorTransform:"EDITOR_TRANSFORM",effects_ObjectToWorld:"MODEL"}},ct=Ir(I);K.uTexOffset=new Float32Array(k?[1/k.getWidth(),1/k.getHeight()]:[0,0]),K.uMaskTex=k,K.uColorParams=new Float32Array([k?1:0,+ct,0,+(!!M&&!V)]),K.uParams=[0,b,0,0],K.uAcceleration=[(null==_?void 0:_[0])||0,(null==_?void 0:_[1])||0,(null==_?void 0:_[2])||0,0];var lt=ui.create(c,ut);lt.blending=!0,lt.depthTest=!0,lt.depthMask=!!M,lt.stencilRef=F?[F,F]:void 0,Br(lt,P),Dr(lt,I),zr(lt,O),Object.keys(K).map((function(t){var e=K[t];if(e instanceof qr)lt.setTexture(t,e);else{var r=[];switch(ms[t]){case"vec4":lt.setVector4(t,kt.fromArray(e));break;case"vec3":lt.setVector3(t,It.fromArray(e));break;case"vec2":lt.setVector2(t,Lt.fromArray(e));break;case"vec4Array":for(var i=0;i<e.length;i+=4){var n=new kt(e[i],e[i+1],e[i+2],e[i+3]);r.push(n)}lt.setVector4Array(t,r),r.length=0;break;default:console.warn("uniform ".concat(t,"'s type not in typeMap"))}}})),lt.setVector3("emissionColor",new It(0,0,0)),lt.setFloat("emissionIntensity",0);var ht=bi.create(c,function(t,e,r){var i=Float32Array.BYTES_PER_ELEMENT,n=12*i,o={aPos:{size:3,offset:0,stride:n,data:new Float32Array(0)},aVel:{size:3,offset:3*i,stride:n,dataSource:"aPos"},aDirX:{size:3,offset:6*i,stride:n,dataSource:"aPos"},aDirY:{size:3,offset:9*i,stride:n,dataSource:"aPos"},aRot:{size:3,offset:0,stride:8*i,data:new Float32Array(0)},aSeed:{size:1,offset:3*i,stride:8*i,dataSource:"aRot"},aColor:{size:4,offset:4*i,stride:8*i,dataSource:"aRot"},aOffset:{size:4,stride:4*i,data:new Float32Array(0)}};return e&&(o.aSprite={size:3,data:new Float32Array(0)}),{attributes:o,indices:{data:new Uint16Array(0)},name:r,maxVertex:t}}(4*E,this.useSprite,"particle#".concat(R))),ft=Li.create(c,{name:"MParticle_".concat(R),priority:N,material:lt,geometry:ht});this.anchor=L,this.mesh=ft,this.geometry=ft.firstGeometry(),this.forceTarget=w,this.sizeOverLifetime=y,this.speedOverLifetime=p,this.linearVelOverLifetime=m,this.orbitalVelOverLifetime=v,this.orbitalVelOverLifetime=v,this.gravityModifier=T,this.maxCount=E,this.duration=b,this.textureOffsets=S?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0]}return Object.defineProperty(e.prototype,"time",{get:function(){return this.mesh.material.getVector4("uParams").x},set:function(t){this.mesh.material.setVector4("uParams",new kt(+t,this.duration,0,0))},enumerable:!1,configurable:!0}),e.prototype.getPointColor=function(t){var e=this.geometry.getAttributeData("aRot"),r=32*t+4;return[e[r],e[r+1],e[r+2],e[r+3]]},e.prototype.getPointPosition=function(t){var e=this.geometry,r=48*t,i=e.getAttributeData("aPos"),n=e.getAttributeData("aOffset"),o=this.time-n[16*t+2],s=n[16*t+3],a=this.mesh.material,u=a.getVector4("uAcceleration").toVector3(),c=It.fromArray(i,r),l=It.fromArray(i,r+3),h=te(new It,this,u,o,s,c,l);if(this.forceTarget){var f=a.getVector3("uFinalTarget"),p=this.forceTarget.curve.getValue(o/s),d=1-p;h.x=h.x*d+f.x*p,h.y=h.y*d+f.y*p,h.z=h.z*d+f.z*p}return h},e.prototype.clearPoints=function(){this.resetGeometryData(this.geometry),this.particleCount=0,this.geometry.setDrawCount(0),this.maxParticleBufferCount=0},e.prototype.resetGeometryData=function(t){for(var e=t.getAttributeNames(),r=t.getIndexData(),i=0;i<e.length;i++){var n=e[i],o=t.getAttributeData(n);o&&t.setAttributeData(n,new o.constructor(0))}t.setIndexData(new r.constructor(0))},e.prototype.minusTime=function(t){for(var e=this.geometry.getAttributeData("aOffset"),r=0;r<e.length;r+=4)e[r+2]-=t;this.geometry.setAttributeData("aOffset",e),this.time-=t},e.prototype.removePoint=function(t){t<this.particleCount&&this.geometry.setAttributeSubData("aOffset",16*t,new Float32Array(16))},e.prototype.setPoint=function(t,e){var r=this.maxCount;if(e<r){var i=e+1,n=4*i,o=this.geometry,s=i>this.maxParticleBufferCount,a=1;this.particleCount>300?a=(this.particleCount+100)/this.particleCount:this.particleCount>100?a=1.4:this.particleCount>0&&(a=2);var u={aPos:new Float32Array(48),aRot:new Float32Array(32),aOffset:new Float32Array(16)},c=this.useSprite;c&&(u.aSprite=new Float32Array(12));var l=new It,h=new Pt,f=new It(1,1,1);t.transform.assignWorldTRS(l,h,f);var p=cr.getRotation(h,new Ut),d=l.toArray(),m=p.toArray(),v=this.textureOffsets,y=[0,0,t.delay,t.lifetime],g=[0,0,1,1],x=t.vel,T=t.color,E=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],b=Math.random(),S=void 0;c&&(S=t.sprite);for(var A=0;A<4;A++){var R=2*A,C=3*A,_=4*A,w=12*A,O=8*A;u.aPos.set(d,w),x.fill(u.aPos,w+3),u.aRot.set(m,O),u.aRot[O+3]=b,u.aRot.set(T,O+4),c&&u.aSprite.set(S,C);var M=t.uv||g;if(M){var L=c?1-v[R+1]:v[R+1];y[0]=M[0]+v[R]*M[2],y[1]=M[1]+L*M[3]}u.aOffset.set(y,_);for(var I=A+A,P=(E[I]-this.anchor.x)*f.x,F=(E[I+1]-this.anchor.y)*f.y,V=0;V<3;V++)u.aPos[w+6+V]=t.dirX.getElement(V)*P,u.aPos[w+9+V]=t.dirY.getElement(V)*F}var N=new Uint16Array([0,1,2,2,1,3].map((function(t){return t+4*e})));if(s){var D=ot(o.getIndexData(),6*i,a,6*r);D.set(N,6*e),o.setIndexData(D),this.maxParticleBufferCount=D.length/6}else o.setIndexSubData(6*e,N);Object.keys(u).forEach((function(t){var i=u[t],c=o.getAttributeStride(t)/Float32Array.BYTES_PER_ELEMENT;if(s){var l=ot(o.getAttributeData(t),n*c,a,4*r*c);l.set(i,i.length*e),o.setAttributeData(t,l)}else o.setAttributeSubData(t,i.length*e,i)})),this.particleCount=Math.max(i,this.particleCount),o.setDrawCount(6*this.particleCount)}},e}(),ys=[10,32,64,160];function gs(t){for(var e=0;e<ys.length;e++){var r=ys[e];if(r>t)return r}return t||ys[0]}function xs(t,e,r){var i,n,o,s,a;void 0===e&&(e="");var u=t.content,c=+((null===(i=u.renderer)||void 0===i?void 0:i.renderMode)||0),f=[["RENDER_MODE",c],["PRE_MULTIPLY_ALPHA",!1],["ENV_EDITOR",e===l]],p=r.level,d=r.detail,m={curves:[],index:0,max:0,lineSegCount:0,curveCount:0},v={curves:[],index:0,max:0,lineSegCount:0,curveCount:0},y=d.maxVertexUniforms>0,g=(null!==(n=u.positionOverLifetime)&&void 0!==n?n:{}).speedOverLifetime,x=0,T=0;y&&f.push(["ENABLE_VERTEX_TEXTURE",!0]),g&&(f.push(["SPEED_OVER_LIFETIME",!0]),T|=2,Ge(m,g));var E=u.textureSheetAnimation;E&&E.animate&&(f.push(["USE_SPRITE",!0]),T|=4);var b=void 0;if(u.filter&&u.filter.name!==h){f.push(["USE_FILTER",!0]),T|=8;var S=tt(u.filter).find((function(t){return t.isParticle}));if(!S)throw Error("particle filter ".concat(u.filter.name," not implement"));b=S,null===(o=S.uniforms)||void 0===o||o.forEach((function(t){return Ge(m,t)}))}var A=u.colorOverLifetime;A&&A.color&&(f.push(["COLOR_OVER_LIFETIME",!0]),T|=16);var R=A&&A.opacity;R&&Ge(m,R);var C,_=u.positionOverLifetime;if(["x","y","z"].forEach((function(t,e){var r=0,i="linear"+t.toUpperCase(),n="orbital"+t.toUpperCase();(null==_?void 0:_[i])&&(Ge(m,_[i]),r=1,T|=1<<7+e),f.push(["LINEAR_VEL_".concat(t.toUpperCase()),r]);var o=0;(null==_?void 0:_[n])&&(Ge(m,_[n]),o=1,T|=1<<10+e,C=!0),f.push(["ORB_VEL_".concat(t.toUpperCase()),o])})),(null==_?void 0:_.asMovement)&&(f.push(["AS_LINEAR_MOVEMENT",!0]),T|=32),C&&(null==_?void 0:_.asRotation)&&(f.push(["AS_ORBITAL_MOVEMENT",!0]),T|=64),u.sizeOverLifetime){var w=u.sizeOverLifetime;w.separateAxes?(Ge(m,w.x),f.push(["SIZE_Y_BY_LIFE",1]),T|=16384,Ge(m,w.y)):Ge(m,w.size)}if(u.rotationOverLifetime){var O=u.rotationOverLifetime;O.z&&(Ge(m,null==O?void 0:O.z),T|=32768,f.push(["ROT_Z_LIFETIME",1])),O.separateAxes&&(O.x&&(Ge(m,O.x),T|=65536,f.push(["ROT_X_LIFETIME",1])),O.y&&(Ge(m,O.y),T|=1<<17,f.push(["ROT_Y_LIFETIME",1]))),(null==O?void 0:O.asRotation)&&(f.push(["ROT_LIFETIME_AS_MOVEMENT",1]),T|=1<<18)}Ge(m,null==_?void 0:_.gravityOverLifetime),(null==_?void 0:_.forceTarget)&&(f.push(["FINAL_TARGET",!0]),T|=1<<19,Ge(m,_.forceCurve));var M=d.halfFloatTexture;M&&v.max&&(T|=1<<20);var L=d.maxVertexUniforms,I=m.max+m.curves.length-32>L;_i(Ai)&&(I=!0),2===p&&(m.max=-1,v.index>0&&(v.max=-1)),I&&M&&y&&(x=1);var P=["-p:",c,T,m.index,m.max,v.index,v.max].join("+"),F={fragment:Ui,vertex:"#define LOOKUP_TEXTURE_CURVE ".concat(x,"\n").concat(ki),shared:!0,cacheId:P,marcos:f,name:"particle#".concat(t.name)};return b&&(F.fragment=F.fragment.replace(/#pragma\s+FILTER_FRAG/,null!==(s=b.fragment)&&void 0!==s?s:""),F.vertex=F.vertex.replace(/#pragma\s+FILTER_VERT/,b.vertex||"void filterMain(float t){}\n"),F.cacheId+="+"+(null===(a=u.filter)||void 0===a?void 0:a.name)),f.push(["VERT_CURVE_VALUE_COUNT",m.index],["FRAG_CURVE_VALUE_COUNT",v.index],["VERT_MAX_KEY_FRAME_COUNT",m.max],["FRAG_MAX_KEY_FRAME_COUNT",v.max]),{shader:F,vertex:m.index,fragment:v.index}}function Ts(t,e,r){var i,n=null===(i=t.cacheId)||void 0===i?void 0:i.split("+");if(n[3]=e,n[5]=r,t.cacheId=n.join("+"),t.marcos)for(var o=0;o<t.marcos.length;o++){var s=t.marcos[o];if("VERT_CURVE_VALUE_COUNT"===s[0])s[1]=e;else if("FRAG_CURVE_VALUE_COUNT"===s[0]){s[1]=r;break}}}var Es,bs=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.meshes=[],t}return r(i,e),i.precompile=function(e,r,i){var n=r.engine.gpuCapability,o=n.level,s=(null!=i?i:{}).env,a=r.getShaderLibrary(),u=[],c=[],h=0,f=0;return e.forEach((function(e){e.items.forEach((function(e){t.Item.isParticle(e)&&u.push(e)}))})),u.forEach((function(e){var r,i,u=xs(e,s,n),p=u.shader,d=u.fragment,m=u.vertex;if(c.push(p),h=Math.max(h,d),f=Math.max(f,m),e.content.trails){var v=function(t,e,r,i,n){void 0===i&&(i="");var o=0,s=_i(Ai)?1:0,a=[["ENABLE_VERTEX_TEXTURE",n.detail.maxVertexTextures>0],["LOOKUP_TEXTURE_CURVE",s],["ENV_EDITOR",i===l]],u={curves:[],index:0,max:0,lineSegCount:0,curveCount:0};return t.colorOverLifetime&&(a.push(["COLOR_OVER_LIFETIME",!0]),o|=1),t.colorOverTrail&&(a.push(["COLOR_OVER_TRAIL",!0]),o|=4),e>64&&(a.push(["ATTR_TRAIL_START",1]),o|=8),Ge(u,t.opacityOverLifetime),Ge(u,t.widthOverTrail),a.push(["VERT_CURVE_VALUE_COUNT",u.index],["VERT_MAX_KEY_FRAME_COUNT",u.max]),{vertex:Gi,fragment:Ui,marcos:a,shared:!0,name:"trail#"+r,cacheId:"-t:+".concat(o,"+").concat(u.index,"+").concat(u.max)}}(e.content.trails,e.content.options.maxCount,e.name,s,n);v.vertex=Nr(null!==(r=v.marcos)&&void 0!==r?r:[],v.vertex,t.ShaderType.vertex,o),v.fragment=Nr(null!==(i=v.marcos)&&void 0!==i?i:[],v.fragment,t.ShaderType.fragment,o),v.glslVersion=2===o?t.GLSLVersion.GLSL3:t.GLSLVersion.GLSL1,a.addShader(v)}})),c.forEach((function(e){var r,i;2===o?(Ts(e,f,h),e.glslVersion=t.GLSLVersion.GLSL3):e.glslVersion=t.GLSLVersion.GLSL1,e.vertex=Nr(null!==(r=e.marcos)&&void 0!==r?r:[],e.vertex,t.ShaderType.vertex,o),e.fragment=Nr(null!==(i=e.marcos)&&void 0!==i?i:[],e.fragment,t.ShaderType.fragment,o),a.addShader(e)})),2===o&&u.forEach((function(t){t.content.options.meshSlots=[f,h]})),Promise.resolve()},i.prototype.onCompositionItemLifeBegin=function(t,e){e instanceof ds&&this.add(e.content)},i.prototype.onCompositionItemRemoved=function(t,e){e instanceof ds&&e.content&&this.remove(e.content,t.renderFrame)},i.prototype.prepareRenderFrame=function(t,e){return this.meshes.forEach((function(t){return e.addMeshToDefaultRenderPass(t)})),this.meshes.length=0,!1},i.prototype.add=function(t){var e=this;t.meshes.forEach((function(t){return rt(e.meshes,t)}))},i.prototype.remove=function(t,e){var r=this;t.meshes.forEach((function(t){it(r.meshes,t),e.removeMeshFromDefaultRenderPass(t)}))},i}(xr),Ss=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e}(xr),As=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._v_priority=1,e.childrenVisible=!0,e}return r(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return O.null},enumerable:!1,configurable:!0}),e.prototype.onConstructed=function(t){this.cal=t.content,this.relative=t.relative},e.prototype.onLifetimeBegin=function(t,e){e.active=!0},e.prototype.onItemRemoved=function(t,e){},e.prototype.onItemUpdate=function(t,e){this.content&&(this.content.updateTime(this.time),this.renderData=this.content.getRenderData(this.content.time))},e.prototype.setScale=function(t,e,r){this.content.startSize=new It(t,e,r)},e.prototype.scale=function(t,e,r){var i=this.content.startSize.clone();this.content.startSize=new It(t*i.x,e*i.y,r*i.z)},e.prototype.getHitTestParams=function(t){},e.prototype.getRenderData=function(){return this.renderData},e.prototype.getChildrenVisible=function(){return this.childrenVisible},e.prototype.setChildrenVisible=function(t){this.childrenVisible!==t&&(this.childrenVisible=!!t,this.handleVisibleChanged(this.visible))},e.prototype.doCreateContent=function(t){var e=new Yn(this.cal,this);return e.renderData=e.getRenderData(0,!0),e},e.prototype.handleVisibleChanged=function(t){this.content&&(this.content.visible=t||this.childrenVisible)},e}(lr),Rs=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.getItemGeometryData=function(t,e){var r=t,i=r.splits,n=r.renderer,o=r.textureSheetAnimation,s=r.startSize;r.textLayout;var a=s.x,u=s.y;if(n.shape){for(var c=n.shape,l=c.index,h=c.aPoint,f=new Float32Array(h),p=0;p<f.length;p+=6)f[p]*=a,f[p+1]*=u;return{index:l,aPoint:Array.from(f)}}var d=.5,m=.5,v=[-d,m,-d,-m,d,m,d,-m],y=[],g=[],x=2,T=2;1===i.length&&(x=1,T=1);for(var E=0;E<x;E++)for(var b=0;b<T;b++){var S=4*(2*b+E),A=o?[0,0,1,1,i[0][4]]:i[2*b+E],R=A[4]?[0,0,1,0,0,1,1,1]:[0,1,0,0,1,1,1,0],C=((E+E+1)/x-1)/2,_=((b+b+1)/T-1)/2,w=A[0],O=A[1],M=A[4]?A[3]:A[2],L=A[4]?A[2]:A[3],I=[v[0]/x+C,v[1]/T+_,v[2]/x+C,v[3]/T+_,v[4]/x+C,v[5]/T+_,v[6]/x+C,v[7]/T+_];y.push(I[0]*a,I[1]*u,R[0]*M+w,R[1]*L+O,e,0,I[2]*a,I[3]*u,R[2]*M+w,R[3]*L+O,e,0,I[4]*a,I[5]*u,R[4]*M+w,R[5]*L+O,e,0,I[6]*a,I[7]*u,R[6]*M+w,R[7]*L+O,e,0),this.lineMode?g.push(S,1+S,1+S,3+S,3+S,2+S,2+S,S):g.push(S,1+S,2+S,2+S,1+S,3+S)}return{index:g,aPoint:y}},e}(In),Cs=function(t){var e,r,i,n,o,s;this.isUnderline=!1,this.underlineHeight=1,this.isOutlined=!1,this.outlineWidth=0,this.hasShadow=!1,this.fontDesc="",this.fontScale=2,this.fontOffset=0;var a=t.textColor,u=void 0===a?[1,1,1,1]:a,c=t.fontSize,l=void 0===c?40:c,h=t.outline,f=t.shadow,p=t.fontWeight,d=void 0===p?"normal":p,m=t.fontStyle,v=void 0===m?"normal":m,y=t.fontFamily,g=void 0===y?"sans-serif":y;this.textColor=u,this.textWeight=d,this.fontStyle=v,this.fontFamily=g,this.fontSize=l,h&&(this.isOutlined=!0,this.outlineColor=null!==(e=h.outlineColor)&&void 0!==e?e:[1,1,1,1],this.outlineWidth=null!==(r=h.outlineWidth)&&void 0!==r?r:1,this.fontOffset+=this.outlineWidth),f&&(this.hasShadow=!0,this.shadowBlur=null!==(i=f.shadowBlur)&&void 0!==i?i:2,this.shadowColor=null!==(n=f.shadowColor)&&void 0!==n?n:[0,0,0,1],this.shadowOffsetX=null!==(o=f.shadowOffsetX)&&void 0!==o?o:0,this.shadowOffsetY=null!==(s=f.shadowOffsetY)&&void 0!==s?s:0),this.fontStyle!==q.normal&&(this.fontOffset+=this.fontSize*Math.tan(.20943951))},_s=function(){function t(){}return t.measureFont=function(e){if(t._fonts[e])return t._fonts[e];var r={ascent:0,descent:0,fontSize:0},i=t._canvas,n=i.getContext("2d",{willReadFrequently:!0});n.font=e;var o=t.METRICS_STRING+t.BASELINE_SYMBOL,s=Math.ceil(n.measureText(o).width),a=Math.ceil(n.measureText(t.BASELINE_SYMBOL).width),u=Math.ceil(t.HEIGHT_MULTIPLIER*a);a=a*t.BASELINE_MULTIPLIER|0,i.width=s,i.height=u,n.fillStyle="#f00",n.fillRect(0,0,s,u),n.font=e,n.textBaseline="alphabetic",n.fillStyle="#000",n.fillText(o,0,a);var c=n.getImageData(0,0,s,u).data,l=c.length,h=4*s,f=0,p=0,d=!1;for(f=0;f<a;++f){for(var m=0;m<h;m+=4)if(255!==c[p+m]){d=!0;break}if(d)break;p+=h}for(r.ascent=a-f,p=l-h,d=!1,f=u;f>a;--f){for(m=0;m<h;m+=4)if(255!==c[p+m]){d=!0;break}if(d)break;p-=h}return r.descent=f-a,r.fontSize=r.ascent+r.descent,t._fonts[e]=r,r},Object.defineProperty(t,"_canvas",{get:function(){var e;return _i(Ri)?(e=window._createOffscreenCanvas(10,10),t.__canvas=e):t.__canvas||((e=document.createElement("canvas")).width=e.height=10,t.__canvas=e),t.__canvas},enumerable:!1,configurable:!0}),t._fonts={},t.METRICS_STRING="|q",t.BASELINE_SYMBOL="M",t.BASELINE_MULTIPLIER=1.4,t.HEIGHT_MULTIPLIER=2,t}(),ws=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];t.QTextWrapMode=void 0,(Es=t.QTextWrapMode||(t.QTextWrapMode={}))[Es.Default=0]="Default",Es[Es.Clip=1]="Clip",Es[Es.Ellipsis=2]="Ellipsis";var Os=function(){function e(e,r){var i,n,o,s,a,u,c,l,h,f;this.left=0,this.top=0,this.fontSize=48,this.fontFamily="Arial",this.color="black",this.letterSpacing=0,this.maxLineWidth=0,this.wrap=t.QTextWrapMode.Clip,this.scaleX=1,this.scaleY=1,this.angle=0,this.active=!0,this.padding=0,this.borderColor="#ffffffff",this.borderWidth=1,this.fontProperties={ascent:0,descent:0,fontSize:0},this.fontVariant="normal",this.originX="left",this.originY="top",this.ellipsis="",this.text=e,this.left=null!==(i=r.left)&&void 0!==i?i:0,this.top=null!==(n=r.top)&&void 0!==n?n:0,this.maxLineWidth=null!==(o=r.maxWidth)&&void 0!==o?o:0,this.letterSpacing=null!==(s=r.letterSpacing)&&void 0!==s?s:0,this.originX="left",this.originY="top",this.color=null!==(a=r.color)&&void 0!==a?a:"black",this.fontFamily=null!==(u=r.fontFamily)&&void 0!==u?u:"Arial",this.fontSize=null!==(c=r.fontSize)&&void 0!==c?c:48,this.wrap=null!==(l=r.wrap)&&void 0!==l?l:t.QTextWrapMode.Clip,this.fontStyle=null!==(h=r.fontStyle)&&void 0!==h?h:"normal",this.textAlign="left",this.textBaseline="alphabetic",this.fontWeight="normal",this.angle=null!==(f=r.angle)&&void 0!==f?f:0,this.name=r.name||""}return e.prototype.update=function(){this.updateDimension()},e.prototype.render=function(){if(void 0!==this.viewer){var t=this.viewer.renderContext;void 0!==t&&(t.save(),this.setRenderTransform(t),this.renderText(t),this.active&&this.drawBorders(t),t.restore())}},e.prototype.init=function(t){this.viewer=t,this.updateDimension()},e.prototype.getLayout=function(){var t=this.viewer.scaleX,e=this.viewer.scaleY;return{x:this.left*t,y:this.top*e,width:this.width*t,height:this.height*e}},e.prototype.updateDimension=function(){var t=this.viewer.renderContext;this.configTextStyle(t),this.configTextLayout(t);var e=this.getFontDesc();this.fontProperties=_s.measureFont(e),0===this.fontProperties.fontSize&&(this.fontProperties.fontSize=this.fontSize,this.fontProperties.ascent=this.fontSize);var r=this.createCharsFromText(t,this.text),i=0;if(r.length>0){var n=r[r.length-1];i=n.left+n.width}this.chars=r,this.maxLineWidth=i,void 0===this.height&&(this.height=this.fontProperties.fontSize),void 0===this.width&&(this.width=this.maxLineWidth)},e.prototype.configTextStyle=function(t){t.font=this.getFontDesc(),t.fillStyle=this.color},e.prototype.getFontDesc=function(){for(var t="number"==typeof this.fontSize?"".concat(this.fontSize,"px"):this.fontSize,e=this.fontFamily.split(","),r=e.length-1;r>=0;r--){var i=e[r].trim();/([\"\'])[^\'\"]+\1/.test(i)||ws.includes(i)||(i='"'.concat(i,'"')),e[r]=i}return e.push("Arial, Helvetica, sans-serif"),"".concat(this.fontStyle," ").concat(this.fontVariant," ").concat(this.fontWeight," ").concat(t," ").concat(e.join(","))},e.prototype.configTextLayout=function(t){t.textBaseline=this.textBaseline,t.textAlign=this.textAlign},e.prototype.setRenderTransform=function(t){t.scale(this.scaleX,this.scaleY),t.translate(this.left,this.top)},e.prototype.renderText=function(t){this.drawCharsInTextBox(t,{min:[0,0],max:[0+this.width,0+this.height]})},e.prototype.drawCharsInTextBox=function(e,r){var i=this.chars,n=0;if(i.length>0){var o=i[i.length-1];n=o.left+o.width}var s=r.max[0]-r.min[0],a=0;"left"===this.textAlign?a=0:"center"===this.textAlign?a=.5*(s-n):"right"===this.textAlign&&(a=s-n),this.addOffsetToChars(i,a);var u=this.cloneChars(this.clipCharsWithTextBox(i,r)),c=u;this.wrap===t.QTextWrapMode.Ellipsis&&0===(c=this.replaceCharWithEllipsis(e,u,r)).length&&0!==i.length&&this.addEllipsisToChars(e,c,r),this.drawCharsFromLeft(e,c)},e.prototype.addEllipsisToChars=function(t,e,r){var i,n,o,s=t.measureText(this.ellipsis).width;if("left"===this.textAlign)e.push({char:this.ellipsis,left:r.min[0],top:0,width:s,heigh:null!==(i=this.height)&&void 0!==i?i:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:!0,scale:1,index:0});else if("right"===this.textAlign)e.push({char:this.ellipsis,left:r.max[0]-s,top:0,width:s,heigh:null!==(n=this.height)&&void 0!==n?n:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:!0,scale:1,index:0});else{var a=.5*(r.max[0]+r.min[0]);e.push({char:this.ellipsis,left:a-.5*s,top:0,width:s,heigh:null!==(o=this.height)&&void 0!==o?o:0,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:!0,scale:1,index:0})}},e.prototype.createCharsFromText=function(t,e){var r=e.split(""),i=0,n=0;"top"===this.textBaseline?n=0:"middle"===this.textBaseline?n+=.5*this.fontProperties.ascent:"alphabetic"===this.textBaseline&&(n+=this.fontProperties.ascent);for(var o=[],s=0;s<r.length;++s){var a=r[s],u=Math.floor(t.measureText(a).width),c={left:i,top:n,width:u,heigh:this.fontSize,char:a,font:this.fontFamily,fontSize:this.fontSize,isEllipsis:!1,scale:1,index:s};o.push(c),i+=u+this.letterSpacing}return o},e.prototype.addOffsetToChars=function(t,e){return t.forEach((function(t){t.left+=e})),t},e.prototype.clipCharsWithTextBox=function(t,e){for(var r=[],i=0;i<t.length;++i){var n=t[i];n.left>=e.min[0]&&n.left+n.width<e.max[0]+.5&&r.push(n)}return r},e.prototype.cloneChars=function(t){return t.map((function(t){return i({},t)}))},e.prototype.replaceCharWithEllipsis=function(t,e,r){var n=t.measureText(this.ellipsis).width;if(e.length>0){0!==e[0].index&&((o=i({},e[0])).char=this.ellipsis,o.isEllipsis=!0,o.width=n,e=this.findEllipsisPositionAndReplaceCharsFromLeft(e,o,r));var o,s=e.length-1,a=this.chars.length;e[s].index!==a-1&&((o=i({},e[0])).char=this.ellipsis,o.isEllipsis=!0,o.width=n,e=this.findEllipsisPositionAndReplaceCharsFromRight(e,o,r))}return e},e.prototype.findEllipsisPositionAndReplaceCharsFromLeft=function(t,e,r){for(var i=0,n=0;n<t.length;++n){var o=t[n];if(i=n,o.left+o.width-e.width>=r.min[0])break}var s=t[i];for(e.left=s.left+s.width-e.width,n=0;n<i+1;++n)t.shift();return[e].concat(t)},e.prototype.findEllipsisPositionAndReplaceCharsFromRight=function(t,e,r){for(var i=t.length-1,n=i;n>=0;--n)if(i=n,t[n].left+e.width<=r.max[0])break;for(e.left=t[i].left,n=t.length-1;n>=i;--n)t.pop();return t.concat([e])},e.prototype.drawCharsFromLeft=function(t,e){var r=t.textAlign||"left";t.textAlign="left";for(var i=0;i<e.length;++i){var n=e[i];t.fillText(n.char,n.left,n.top)}t.textAlign=r},e.prototype.drawBorders=function(t){this.padding;var e=this.borderWidth;t.strokeStyle=this.borderColor,t.lineWidth=e;var r=this.width,i=this.height,n=0,o=0;"center"===this.originX?n-=this.width/2:"right"===this.originX&&(n-=this.width),"center"===this.originY?o-=this.height/2:"bottom"===this.originY&&(o-=this.height),t.strokeRect(n+e/2,o+e/2,r-e,i-e)},e}(),Ms=function(){function t(t,e,r,i,n,o){var s;this.textList=[],s="string"==typeof t?document.getElementById(t):t,this.scaleX=null!=i?i:1,this.scaleY=null!=n?n:1,this.flipY=null!=o&&o,this.width=e,this.height=r,s.style.width="".concat(e*this.scaleX,"px"),s.style.height="".concat(r*this.scaleY,"px"),this.devicePixelRatio=1,s.width=1*e*this.scaleX,s.height=1*r*this.scaleY,s.className="lower-canvas",this.renderCanvas=s,this.renderContext=this.renderCanvas.getContext("2d"),this.renderContext.scale(1*this.scaleX,1*this.scaleY)}return t.prototype.initDimension=function(t,e,r,i){this.width=t,this.height=e,this.scaleX=null!=r?r:1,this.scaleY=null!=i?i:1,this.renderCanvas.style.width="".concat(t*this.scaleX,"px"),this.renderCanvas.style.height="".concat(e*this.scaleY,"px");var n=this.devicePixelRatio;this.renderCanvas.width=n*t*this.scaleX,this.renderCanvas.height=n*e*this.scaleY,this.flipY&&(this.renderContext.translate(0,this.height),this.renderContext.scale(1,-1)),this.renderContext.scale(n*this.scaleX,n*this.scaleY)},t.prototype.clearText=function(){this.textList=[]},t.prototype.clearCanvasWithContext=function(t){t.clearRect(0,0,this.width,this.height)},t.prototype.clearCanvas=function(){this.clearCanvasWithContext(this.renderContext)},t.prototype.addObject=function(t){t.init(this),this.textList.push(t)},t.prototype.render=function(){this.clearCanvasWithContext(this.renderContext),this.renderContext.fillStyle="rgba(255, 255, 255, 0.0039)",this.renderContext.fillRect(0,0,this.width,this.height);var t=this.background;t&&void 0!==t.width&&void 0!==t.height&&this.renderContext.drawImage(t,0,0,t.width,t.height,0,0,this.width,this.height);for(var e=0;e<this.textList.length;++e){this.renderContext.save();var r=this.textList[e];r.update(),r.render(),this.renderContext.restore()}},t}();function Ls(t,e){return e=e||{},new Promise((function(r,i){var n=new XMLHttpRequest;n.responseType=(null==e?void 0:e.responseType)||"json",n.addEventListener("load",(function(){return r(n.response)})),n.addEventListener("error",(function(){return i(Error("load ".concat(t," fail")))})),n.open((null==e?void 0:e.method)||"get",t),n.send(null==e?void 0:e.data)}))}function Is(t,e,r,i,s){return n(this,void 0,void 0,(function(){var n,a,u,c,l,h,f,p,d,m;return o(this,(function(o){switch(o.label){case 0:return n={},a=[],i=i||{},r=r||{},e.asImage?(u=e.content.replace(/\$/g,""),c=r[u]||e.variables[u],l=function(t){var r=(null==i?void 0:i.canvas)||document.createElement("canvas"),n=r.width=e.backgroundWidth,o=r.height=e.backgroundHeight,a=r.getContext("2d");return null==a||a.clearRect(0,0,n,o),s&&(null==a||a.translate(0,o),null==a||a.scale(1,-1)),null==a||a.drawImage(t,0,0,t.width,t.height,0,0,n,o),r},c?[2,Xr(c).then(l)]:[2,Ps(t).then(l)]):(h=i.templateScale||1,Object.keys(e.variables).forEach((function(t){var i=e.variables[t];if(r.hasOwnProperty(t)&&(i=r[t]),/^image_/.test(t)){var o=i instanceof Array,s=o?i[0]:i;a.push(function(t,e){return r(t,(function(i){return e?r(e,(function(){return t})):t}));function r(t,e){return/^(https?:)?\/\//.test(t)?Ls(t,{responseType:"blob"}).then(Fs,e):Promise.resolve(t)}}(s,o&&i[1]).then((function(e){return n[t]=e})))}else n[t]=i})),[4,Promise.all(a)]);case 1:return o.sent(),[4,Xr(t)];case 2:return f=o.sent(),p=e.content.replace(/\$([\w_]+)\$/g,(function(t,e){return n[e]})).replace('width="'.concat(e.width,'px"'),'width="'.concat(e.width*h,'px"')).replace('height="'.concat(e.height,'px"'),'height="'.concat(e.height*h,'px"')),[4,Xr("data:image/svg+xml,".concat(encodeURIComponent(p)))];case 3:return d=o.sent(),(m=(null==i?void 0:i.canvas)||document.createElement("canvas")).width=f.width*h,m.height=f.height*h,[2,new Promise((function(t,r){var i=m.getContext("2d");i.clearRect(0,0,m.width,m.height),s&&(i.translate(0,m.height),i.scale(1,-1)),i.drawImage(f,0,0,f.width,f.height,0,0,m.width,m.height),i.drawImage(d,0,0,d.width,d.height,(e.x||0)*h,(e.y||0)*h,e.width*h/e.backgroundWidth*f.width,e.height*h/e.backgroundHeight*f.height),t(m)}))]}}))}))}function Ps(t){return tr(t)?Xr(t):Promise.resolve(t)}function Fs(t){return new Promise((function(e,r){var i=new FileReader;i.readAsDataURL(t),i.onload=function(){e(i.result)},i.onerror=r}))}var Vs=["serif","sans-serif","monospace","courier"],Ns=800,Ds=600,zs=new Map,Bs=new(function(){function t(){this.elements=[]}return t.prototype.dispose=function(){this.elements.forEach((function(t){return t.remove()})),this.elements=[]},t.prototype.getCanvas=function(){if(this.elements.length)return this.elements.shift();if(_i(Ri))return window._createOffscreenCanvas(10,10);var t=document.createElement("canvas");return t.getContext("2d",{willReadFrequently:!0}),t},t.prototype.saveCanvas=function(t){t.width=t.height=1,this.elements.length<3?rt(this.elements,t):t.remove()},t}());function Us(t,e){var r,i,n;if(null===(r=null==t?void 0:t.background)||void 0===r?void 0:r.name){var o=t.background.name;e&&e[o]?n=e[o]:(null===(i=t.background)||void 0===i?void 0:i.url)&&(n=t.background.url)}return n}function ks(t,e){return n(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:if(!Array.isArray(t))return[3,5];r.label=1;case 1:return r.trys.push([1,3,,5]),[4,e(t[0])];case 2:return[2,r.sent()];case 3:return r.sent(),[4,e(t[1])];case 4:return[2,r.sent()];case 5:return[2,e(t)]}}))}))}function Gs(e,r,s,a,u){var c;return n(this,void 0,void 0,(function(){var n,l,h,f,p,d,m,v,y,g,x;return o(this,(function(o){switch(o.label){case 0:if(!r)throw Error("image not provided");return n=(null==u?void 0:u.templateScale)||1,l=n,h=n,f=r,p=r.width,d=r.height,s?(p=s.width,d=s.height,r.width===p&&r.height===d||(l*=r.width/s.width,h*=r.height/s.height),(m=Us(s,a))&&m!==r.src?tr(m)?[4,Xr(m)]:[3,2]:[3,4]):[3,5];case 1:return v=o.sent(),[3,3];case 2:v=m,o.label=3;case 3:f=v,o.label=4;case 4:(y=s.content)&&(g=function(e,r,i){var n=e.fonts,o=[];return e.texts.forEach((function(s){var a,u=s.t,c=s.x,l=s.y,h={weight:400,family:"serif",size:48,style:q.normal};void 0!==s.f&&(h=n[s.f]);var f=s.n;f&&r&&r.hasOwnProperty(f)&&(u="".concat(r[f]));var p=new Os(u,{left:c,top:l,fontSize:h.size,fontFamily:h.family,fontWeight:"".concat(h.weight),fontStyle:"normal",name:f});if(void 0!==s.r&&(p.angle=s.r*Math.PI/180),p.active=null!==(a=null==i?void 0:i.debug)&&void 0!==a&&a,void 0!==s.w&&(p.width=s.w),void 0!==h.letterSpace&&(p.letterSpacing=h.letterSpace),s.of===Y.display?p.wrap=t.QTextWrapMode.Default:s.of===Y.clip?p.wrap=t.QTextWrapMode.Clip:s.of===Y.ellipsis&&(p.wrap=t.QTextWrapMode.Ellipsis),void 0!==s.c){var d=e.colors[s.c][1],m=1;void 0!==d[3]&&(m=d[3]/255),p.color="rgba(".concat(d[0],", ").concat(d[1],", ").concat(d[2],", ").concat(m,")")}s.a===W.left?p.textAlign="left":s.a===W.middle?p.textAlign="center":s.a===W.right&&(p.textAlign="right"),h.style===q.normal?p.fontStyle="normal":h.style===q.italic?p.fontStyle="italic":h.style===q.oblique&&(p.fontStyle="oblique"),void 0!==h.weight&&(p.fontWeight=String(h.weight)),(null==i?void 0:i.borderColor)&&(p.borderColor=i.borderColor),void 0!==(null==i?void 0:i.borderWidth)&&(p.borderWidth=i.borderWidth),o.push(p)})),o}(y,a,i(i({},u),{scaleX:l,scaleY:h})),g.forEach((function(t){e.addObject(t)}))),o.label=5;case 5:return e.flipY=null!==(c=null==u?void 0:u.flipY)&&void 0!==c&&c,e.initDimension(p,d,l,h),e.background=f,e.render(),(x=null==u?void 0:u.textLayouts)&&(x.length=0,e.textList.forEach((function(t){var e=t.getLayout(),r={x:e.x,y:e.y,width:e.width,height:e.height};x.push(r)}))),[2]}}))}))}function Xs(t){return n(this,void 0,void 0,(function(){var e,r,i;return o(this,(function(n){switch(n.label){case 0:if(!t.content||!t.content.fonts)return[3,4];e=t.content.fonts,r=function(t){var r,i,n,s,a;return o(this,(function(o){switch(o.label){case 0:return r=e[t].family,i=e[t].url,n=!1,Vs.includes(r)?n=!0:void 0!==document.fonts&&document.fonts.forEach((function(t){t.family===r&&(n=!0)})),n||void 0===i||""===i?[3,2]:(s="url(".concat(i,")"),void 0===document.fonts?[3,2]:[4,(a=new FontFace("".concat(r),s)).load()]);case 1:o.sent(),document.fonts.add(a),o.label=2;case 2:return[2]}}))},i=0,n.label=1;case 1:return i<e.length?[5,r(i)]:[3,4];case 2:n.sent(),n.label=3;case 3:return++i,[3,1];case 4:return[2]}}))}))}function Hs(t,e,r,s,a){return n(this,void 0,void 0,(function(){var n,u,c;return o(this,(function(o){switch(o.label){case 0:return n=i(i({},s),{flipY:a}),u=function(t,e,r){var i,n=(null==r?void 0:r.templateScale)||1,o=(null==r?void 0:r.flipY)||!1;if(null==r?void 0:r.canvas){if(!(i=zs.get(r.canvas))){var s=new Ms(r.canvas,t,e,n,n,o);zs.set(r.canvas,s),i=s}}else{var a=Bs.getCanvas();i=new Ms(a,Ns,Ds,n,n,o)}return i}(Ns,Ns,n),void 0===e?[3,2]:[4,Xs(e)];case 1:o.sent(),o.label=2;case 2:return u.clearText(),"string"!=typeof t?[3,5]:[4,Xr(t)];case 3:return c=o.sent(),[4,Gs(u,c,e,r,n)];case 4:return o.sent(),[2,u.renderCanvas];case 5:return[4,Gs(u,t,e,r,n)];case 6:return o.sent(),[2,u.renderCanvas]}}))}))}function Ys(t,e,r,i,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){return 2===e.v?[2,Hs(t,e,r,{templateScale:null==i?void 0:i.templateScale,toData:!0},s)]:[2,Is(t,e,r,i,s)]}))}))}var js=function(){function t(t){this.width=0,this.height=0;var e=t.textHeight,r=void 0===e?100:e,i=t.textWidth,n=void 0===i?100:i,o=t.textOverflow,s=void 0===o?Y.display:o,a=t.textBaseline,u=void 0===a?j.top:a,c=t.textAlign,l=void 0===c?W.left:c,h=t.text,f=t.letterSpace,p=void 0===f?0:f,d=t.autoWidth,m=void 0!==d&&d,v=t.fontSize,y=t.lineHeight,g=void 0===y?v:y,x=v+p;this.autoWidth=m,this.maxTextWidth=h.length*x,this.width=n,this.height=r,this.letterSpace=p,this.overFlow=s,this.textBaseline=u,this.textAlign=l,this.lineHeight=g}return t.prototype.getOffsetY=function(t,e,r,i){var n=0,o=t.outlineWidth,s=t.fontScale,a=(r-i)/3,u=i+o*s,c=r*(e-1);switch(this.textBaseline){case j.top:n=u+a;break;case j.middle:n=(this.height*s-c+u)/2;break;case j.bottom:n=this.height*s-c-a}return n},t.prototype.getOffsetX=function(t,e){var r=0;switch(this.textAlign){case W.left:r=t.outlineWidth*t.fontScale;break;case W.middle:r=(this.width*t.fontScale-e)/2;break;case W.right:r=this.width*t.fontScale-e}return r},t.prototype.setSize=function(t,e){this.width=t,this.height=e},t}(),Ws=function(t){function e(e,r,i){var n=t.call(this,e,r,i)||this;n.isDirty=!0,n.lineCount=0;var o=e.options;return n.canvas=Bs.getCanvas(),Bs.saveCanvas(n.canvas),n.context=n.canvas.getContext("2d",{willReadFrequently:!0}),n.engine=i.composition.getEngine(),n.textStyle=new Cs(o),n.textLayout=new js(o),n.text=o.text.toString(),n.lineCount=n.getLineCount(o.text,!0),n.mesh=new Rs(n.engine,n.renderInfo,i.composition),n}return r(e,t),e.prototype.getLineCount=function(t,e){for(var r,i,n=this.context,o=this.textLayout.letterSpace,s=e?this.textStyle.fontSize/10:1/this.textStyle.fontScale,a=this.textLayout.width+this.textStyle.fontOffset,u=1,c=0,l=0;l<t.length;l++){var h=t[l],f=(null!==(i=null===(r=null==n?void 0:n.measureText(h))||void 0===r?void 0:r.width)&&void 0!==i?i:0)*s;((c+=o)+f>a&&l>0||"\n"===h)&&(u++,c=0),"\n"!==h&&(c+=f)}return u},e.prototype.setFontSize=function(t){if(this.textStyle.fontSize!==t){var e=this.textStyle.fontSize-t;this.textLayout.lineHeight+=e,this.textStyle.fontSize=t,this.isDirty=!0}},e.prototype.setFontWeight=function(t){this.textStyle.textWeight!==t&&(this.textStyle.textWeight=t,this.isDirty=!0)},e.prototype.setFontStyle=function(t){this.textStyle.fontStyle!==t&&(this.textStyle.fontStyle=t,this.isDirty=!0)},e.prototype.setText=function(t){this.text!==t&&(this.text=t.toString(),this.lineCount=this.getLineCount(t,!1),this.isDirty=!0)},e.prototype.setTextAlign=function(t){this.textLayout.textAlign!==t&&(this.textLayout.textAlign=t,this.isDirty=!0)},e.prototype.setTextBaseline=function(t){this.textLayout.textBaseline!==t&&(this.textLayout.textBaseline=t,this.isDirty=!0)},e.prototype.setTextColor=function(t){this.textStyle.textColor!==t&&(this.textStyle.textColor=t,this.isDirty=!0)},e.prototype.setFontFamily=function(t){this.textStyle.fontFamily!==t||Et(t)?(this.textStyle.fontFamily=t,this.isDirty=!0):console.warn("The font is either the current font or an risky font family.")},e.prototype.setOutlineColor=function(t){this.textStyle.outlineColor!==t&&(this.textStyle.outlineColor=t,this.isDirty=!0)},e.prototype.setOutlineWidth=function(t){this.textStyle.outlineWidth!==t&&(this.textStyle.outlineWidth=t,this.isDirty=!0)},e.prototype.setShadowBlur=function(t){this.textStyle.shadowBlur!==t&&(this.textStyle.shadowBlur=t,this.isDirty=!0)},e.prototype.setShadowColor=function(t){this.textStyle.shadowColor!==t&&(this.textStyle.shadowColor=t,this.isDirty=!0)},e.prototype.setShadowOffsetX=function(t){this.textStyle.shadowOffsetX!==t&&(this.textStyle.shadowOffsetX=t,this.isDirty=!0)},e.prototype.setShadowOffsetY=function(t){this.textStyle.shadowOffsetY!==t&&(this.textStyle.shadowOffsetY=t,this.isDirty=!0)},e.prototype.setFontScale=function(t){this.textStyle.fontScale!==t&&(this.textStyle.fontScale=t,this.isDirty=!0)},e.prototype.updateTexture=function(){var t;if(this.isDirty&&this.context&&this.canvas){var e=this.context,r=this.textStyle,i=this.textLayout,n=r.fontScale,o=(i.width+r.fontOffset)*n,s=i.height*n,a=r.fontSize*n,u=i.lineHeight*n;this.char=(this.text||"").split(""),this.canvas.width=o,this.canvas.height=s,e.clearRect(0,0,o,this.canvas.height),e.fillStyle="rgba(255, 255, 255, 0.0039)",e.fillRect(0,0,o,this.canvas.height),r.fontDesc=this.getFontDesc(),e.font=r.fontDesc,r.hasShadow&&this.setupShadow(),r.isOutlined&&this.setupOutline(),e.fillStyle="rgba(".concat(r.textColor[0],", ").concat(r.textColor[1],", ").concat(r.textColor[2],", ").concat(r.textColor[3],")");for(var c=[],l=0,h=i.getOffsetY(r,this.lineCount,u,a),f=[],p=[],d=0;d<this.char.length;d++){var m=this.char[d],y=e.measureText(m);((l+=i.letterSpace*n)+y.width>o&&d>0||"\n"===m)&&(c.push({y:h,width:l,chars:f,charOffsetX:p}),l=0,h+=u,f=[],p=[]),"\n"!==m&&(f.push(m),p.push(l),l+=y.width)}c.push({y:h,width:l,chars:f,charOffsetX:p}),c.forEach((function(t){var n=i.getOffsetX(r,t.width);t.chars.forEach((function(i,o){r.isOutlined&&e.strokeText(i,n+t.charOffsetX[o],t.y),e.fillText(i,n+t.charOffsetX[o],t.y)}))})),r.hasShadow&&(e.shadowColor="transparent");var g=e.getImageData(0,0,this.canvas.width,this.canvas.height);null===(t=this.mesh)||void 0===t||t.mesh.material.setTexture("uSampler0",qr.createWithData(this.engine,{data:new Uint8Array(g.data),width:g.width,height:g.height},{flipY:!0,magFilter:v.LINEAR,minFilter:v.LINEAR,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE})),this.isDirty=!1}},e.prototype.getFontDesc=function(){var t=this.textStyle,e="".concat((t.fontSize*t.fontScale).toString(),"px ");return Vs.includes(t.fontFamily)?e+=t.fontFamily:e+='"'.concat(t.fontFamily,'"'),t.textWeight!==Z.normal&&(e="".concat(t.textWeight," ").concat(e)),t.fontStyle!==q.normal&&(e="".concat(t.fontStyle," ").concat(e)),e},e.prototype.setupOutline=function(){var t=this.context,e=this.textStyle;t.strokeStyle="rgba(".concat(255*e.outlineColor[0],", ").concat(255*e.outlineColor[1],", ").concat(255*e.outlineColor[2],", ").concat(e.outlineColor[3],")"),t.lineWidth=2*e.outlineWidth},e.prototype.setupShadow=function(){var t=this.context,e=this.textStyle;t.shadowColor="rgba(".concat(255*e.shadowColor[0],", ").concat(255*e.shadowColor[1],", ").concat(255*e.shadowColor[2],", ").concat(e.shadowColor[3],")"),t.shadowBlur=e.shadowBlur,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=-e.shadowOffsetY},e}(Zn),Zs=function(e){function n(){return null!==e&&e.apply(this,arguments)||this}return r(n,e),Object.defineProperty(n.prototype,"type",{get:function(){return O.text},enumerable:!1,configurable:!0}),n.prototype.onConstructed=function(t){this.textContext=t.content},n.prototype.onLifetimeBegin=function(t,e){var r,i;e.active=!0,null===(i=null===(r=this.content)||void 0===r?void 0:r.mesh)||void 0===i||i.setItems([this.content]),this.content.updateTexture()},n.prototype.onItemRemoved=function(t,e){e&&(delete e.mesh,t.destroyTextures(e.getTextures()))},n.prototype.onItemUpdate=function(t,e){var r;this.content&&(null===(r=this.content)||void 0===r||r.updateTime(this.time))},n.prototype.getCurrentPosition=function(){var t=new It;return this.transform.assignWorldTRS(t),t},n.prototype.getBoundingBox=function(){var e=this.content;if(e&&this.transform){var r=this.transform.getWorldMatrix(),i=e.startSize,n=le(It.ZERO,i.x/2,i.y/2);return n.forEach((function(t){r.transformPoint(t.p0),r.transformPoint(t.p1),r.transformPoint(t.p2)})),{type:t.HitTestType.triangle,area:n}}},n.prototype.getHitTestParams=function(t){var e,r,i=this.content,n=i&&i.interaction;if((t||n)&&(null===(e=i.mesh)||void 0===e?void 0:e.mesh)&&i){var o=this.getBoundingBox();if(o)return{behavior:(null===(r=i.interaction)||void 0===r?void 0:r.behavior)||0,type:o.type,triangles:o.area,backfaceCulling:i.renderer.side===S.FRONT}}},n.prototype.getRenderData=function(){return this.content.getRenderData(this.content.time)},n.prototype.doCreateContent=function(t){var e=t.getRendererOptions().emptyTexture;return new Ws(this.textContext,{emptyTexture:e},this)},n.prototype.createWireframeMesh=function(t,e){var r=new Rs(this.composition.getEngine(),i({wireframe:!0},t.renderInfo),this.composition);return r.mesh.setVisible(!0),r.setItems([t]),r.mesh.material.setVector3("uFrameColor",It.fromArray(e)),r.mesh.priority=999,r},n}(lr),qs=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="text",t.addItems=[],t.removeItems=[],t.meshes=[],t}return r(i,e),i.prototype.onCompositionDestroyed=function(e){e.reusable?this.addItems.forEach((function(e){var r;null===(r=e.content.mesh)||void 0===r||r.mesh.dispose({material:{textures:t.DestroyOptions.keep}})})):this.addItems.forEach((function(t){var e;null===(e=t.content.mesh)||void 0===e||e.mesh.dispose()}))},i.prototype.onCompositionUpdate=function(t,e){this.addItems.forEach((function(t){var e,r,i;t.contentVisible?(null===(r=t.content.mesh)||void 0===r||r.mesh.setVisible(!0),t.content.updateTexture(),!t.content.ended&&t.content.mesh&&(t.content.mesh.updateItem(t.content),null===(i=t.content.mesh)||void 0===i||i.applyChange())):null===(e=t.content.mesh)||void 0===e||e.mesh.setVisible(!1)}))},i.prototype.onCompositionItemLifeBegin=function(t,e){var r;e instanceof Zs&&e.content&&(this.addItems.includes(e)||(rt(this.addItems,e),!e.content.ended&&e.content.mesh&&e.content.mesh.updateItem(e.content),null===(r=e.content.mesh)||void 0===r||r.applyChange()))},i.prototype.onCompositionReset=function(t,e){},i.prototype.onCompositionItemRemoved=function(e,r){var i;r instanceof Zs&&r&&(rt(this.removeItems,r),this.addItems.includes(r)&&(null===(i=r.content)||void 0===i?void 0:i.mesh)&&(it(this.addItems,r),r.content.mesh.mesh.dispose({material:{textures:t.DestroyOptions.keep}}),r.dispose()))},i.prototype.prepareRenderFrame=function(e,r){var i=this;return this.removeItems.map((function(e){var n,o;(null===(n=e.content)||void 0===n?void 0:n.mesh)&&(r.removeMeshFromDefaultRenderPass(null===(o=e.content.mesh)||void 0===o?void 0:o.mesh),it(i.addItems,e),e.content.mesh.mesh.dispose({material:{textures:t.DestroyOptions.keep}}),e.dispose())})),this.addItems.forEach((function(t){var e;t.content.mesh&&r.addMeshToDefaultRenderPass(null===(e=t.content.mesh)||void 0===e?void 0:e.mesh)})),this.removeItems.length=0,!1},i}(xr);function Ks(t,e,r){return function(t,e,r){var n=i(i({},e.material.props),{shader:r}),o=e.material.clone(n);return o.blending=!1,o.depthTest=!1,o.culling=!1,Li.create(t,{geometry:e.geometry,material:o})}(t,e,Vn(t.gpuCapability.level,{fragment:r.fragment},{ignoreBlend:!0}))}var Qs=function(e){function i(t,r,i,n,o,s){var a=e.call(this,t,s)||this;return a.uTexStep=i,a.pluginSystem=n,a.fragShader=o,a.type=r,a}return r(i,e),i.prototype.configure=function(e){if(this.prePassTexture=e.getFrameBuffer().getColorTextures()[0]?e.getFrameBuffer().getColorTextures()[0]:e.renderingData.currentFrame.transparentTexture,"H"===this.type&&(this.preDefaultPassAttachment.texture=this.prePassTexture),this.preDefaultPassTexture=this.preDefaultPassAttachment.texture,!this.mframeBuffer){var r=qr.create(e.engine,{sourceType:t.TextureSourceType.framebuffer,minFilter:v.LINEAR,magFilter:v.LINEAR,name:this.type,internalFormat:v.RGBA,format:v.RGBA,type:v.UNSIGNED_BYTE});this.mframeBuffer=Sn.create({name:this.type,storeAction:{},viewport:this.viewport,viewportScale:1,isCustomViewport:!0,attachments:[r],depthStencilAttachment:{storageType:t.RenderPassAttachmentStorageType.none}},e)}e.setFrameBuffer(this.mframeBuffer)},i.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[0].material.setTexture("uFilterSource",this.preDefaultPassTexture),this.meshes[0].material.setVector2("uFilterSourceSize",fn(this.preDefaultPassTexture)),this.meshes[1].material.setVector2("uTexStep",this.uTexStep),this.meshes[1].material.setTexture("uBlurSource",this.uBlurSource?this.uBlurSource:this.prePassTexture),this.meshes[1].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[1].material.setTexture("uSamplerPre",this.preDefaultPassTexture),this.meshes[1].material.setVector2("uFilterSourceSize",fn(this.prePassTexture));var e=[this.meshes[0],Ks(t.engine,this.meshes[1],{fragment:this.fragShader})];t.renderMeshes(e)},i.prototype.dispose=function(t){e.prototype.dispose.call(this,t);var r=this.mframeBuffer;r&&r.dispose(t)},i}(Ni),Js=function(t){function e(e,r,i){var n=t.call(this,e,r)||this;return i&&(n.preDefaultPassAttachment=i),n}return r(e,t),e.prototype.configure=function(t){this.prePassTexture=t.getFrameBuffer().getColorTextures()[0],this.preDefaultPassAttachment||(this.preDefaultPassAttachment=new Fi(t.engine,{}),this.preDefaultPassAttachment.texture=this.prePassTexture),t.setFrameBuffer(this.frameBuffer)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[0].material.setTexture("uFilterSource",this.preDefaultPassAttachment.texture),this.meshes[0].material.setVector2("uFilterSourceSize",fn(this.preDefaultPassAttachment.texture)),this.meshes[1].material.setTexture("uFrameSource",this.prePassTexture),this.meshes[1].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[1].material.setTexture("uSamplerPre",this.preDefaultPassAttachment.texture),this.meshes[1].material.setVector2("uFilterSourceSize",fn(this.prePassTexture));var e=[this.meshes[0],this.meshes[1]];t.renderMeshes(e)},e}(Ni);function $s(t){for(var e=t.radius<=3?1:2,r=t.radius/e,i=t.maxStep||4;r>10&&e<i;)e*=2,r=t.radius/e;for(var n=1+t.radius%e/e/e,o=function(t){for(var e=(t+1)/3.329,r=[],i=-t;i<=t;i++)r.push(ta(i,e));return r}(r=Math.floor(r)),s=[],a=-r;a<=r;a++){var u=o[a+r];s.push("color += texture2D(uBlurSource,getTexCoord(".concat(a.toFixed(1),")) * ").concat(u,";"))}return{shader:"\n  uniform sampler2D uBlurSource;\n  uniform vec2 uTexSize;\n  uniform vec2 uTexStep;\n  #define getTexCoord(i) coord + uTexStep/uTexSize * i\n  vec4 filterMain(vec2 coord,sampler2D tex){\n    vec4 color = vec4(0.);\n    vec2 texCoord;\n    ".concat(s.join("\n"),"\n\n    return color;\n  }\n  "),step:n,downSample:e,radius:r}}function ta(t,e){return Math.exp(-t*t/(2*e*e))/Math.sqrt(2*Math.PI)/e}var ea=function(t){function e(e,r){return t.call(this,e,r)||this}return r(e,t),e.prototype.configure=function(t){var e=t.getFrameBuffer();this.preDefaultPassAttachment.texture=e?e.getColorTextures()[0]:t.renderingData.currentFrame.transparentTexture,t.setFrameBuffer(this.frameBuffer)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[1].material.setTexture("uSamplerPre",this.preDefaultPassAttachment.texture),this.meshes[1].material.setVector2("uTexSize",fn(this.preDefaultPassAttachment.texture));var e=[Ks(t.engine,this.meshes[1],{fragment:this.fragShader})];t.renderMeshes(e)},e}(Ni),ra=function(t){function e(e,r,i,n,o,s,a){var u=t.call(this,e,s)||this;return u.uTexStep=i,u.pluginSystem=n,u.fragShader=o,u.type=r,a&&(u.uBlurSource=a),u}return r(e,t),e.prototype.configure=function(t){this.prePassTexture=t.getFrameBuffer().getColorTextures()[0],this.preDefaultPassTexture=this.preDefaultPassAttachment.texture,t.setFrameBuffer(this.frameBuffer),this.uBlurSource||(this.uBlurSource=this.prePassTexture)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[1].material.setVector2("uTexStep",this.uTexStep),this.meshes[1].material.setTexture("uBlurSource",this.uBlurSource),this.meshes[1].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[1].material.setTexture("uSamplerPre",this.preDefaultPassTexture),this.meshes[1].material.setVector2("uFilterSourceSize",fn(this.prePassTexture)),this.meshes[1].material.setVector2("uTexSize",fn(this.uBlurSource));var e=[Ks(t.engine,this.meshes[1],{fragment:this.fragShader})];t.renderMeshes(e)},e}(Ni),ia=function(t){function e(e,r,i){var n=t.call(this,e,r)||this;return n.preDefaultPassAttachment=i,n}return r(e,t),e.prototype.configure=function(t){this.prePassTexture=t.getFrameBuffer().getColorTextures()[0],t.setFrameBuffer(this.frameBuffer)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[0].material.setTexture("uFilterSource",this.preDefaultPassAttachment.texture),this.meshes[0].material.setVector2("uFilterSourceSize",fn(this.preDefaultPassAttachment.texture)),this.meshes[1].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[1].material.setTexture("uSamplerPre",this.preDefaultPassAttachment.texture),this.meshes[1].material.setVector2("uFilterSourceSize",fn(this.prePassTexture)),this.meshes[1].material.setVector2("uTexSize",fn(this.preDefaultPassAttachment.texture));var e=[this.meshes[0],this.meshes[1]];t.renderMeshes(e)},e}(Ni),na=function(t){function e(e,r){return t.call(this,e,r)||this}return r(e,t),e.prototype.configure=function(t){this.prePassTexture=t.getFrameBuffer().getColorTextures()[0],t.setFrameBuffer(this.frameBuffer)},e.prototype.execute=function(t){t.clear(this.clearAction),this.meshes[0].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[0].material.setVector2("uFilterSourceSize",fn(this.prePassTexture)),this.meshes[1].material.setTexture("uFilterSource",this.prePassTexture),this.meshes[1].material.setTexture("uSamplerPre",this.prePassTexture),this.meshes[1].material.setVector2("uFilterSourceSize",fn(this.prePassTexture));var e=[this.meshes[0],this.meshes[1]];t.renderMeshes(e)},e}(Ni);function oa(t,e,r){for(var i=Be(e||1),n=e?256:1,o=new Uint8Array(n),s=0;s<n;s++){var a=s/(n-1);o[s]=Math.round(255*i.getValue(r?1-a:a))}return qr.createWithData(t,{width:n,height:1,data:o},{format:v.LUMINANCE})}var sa,aa,ua,ca,la,ha,fa,pa,da,ma,va,ya=new It(1,1,1),ga=function(){function t(t,e){void 0===e&&(e={}),this.name=t,this.viewMatrix=Nt.fromIdentity(),this.projectionMatrix=Nt.fromIdentity(),this.viewProjectionMatrix=Nt.fromIdentity(),this.inverseViewMatrix=Nt.fromIdentity(),this.dirty=!0;var r=e.near,i=void 0===r?.1:r,n=e.far,o=void 0===n?20:n,s=e.fov,a=void 0===s?60:s,u=e.aspect,c=void 0===u?1:u,l=e.clipMode,h=void 0===l?I.portrait:l,f=e.position,p=void 0===f?[0,0,8]:f,d=e.rotation,m=void 0===d?[0,0,0]:d;this.options={near:i,far:o,fov:a,aspect:c,clipMode:h,position:It.fromArray(p),rotation:Ut.fromArray(m)},this.dirty=!0,this.updateMatrix()}return Object.defineProperty(t.prototype,"near",{get:function(){return this.options.near},set:function(t){this.options.near!==t&&(this.options.near=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"far",{get:function(){return this.options.far},set:function(t){this.options.far!==t&&(this.options.far=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"fov",{get:function(){return this.options.fov},set:function(t){this.options.fov!==t&&(this.options.fov=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"aspect",{get:function(){return this.options.aspect},set:function(t){this.options.aspect!==t&&(this.options.aspect=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"clipMode",{get:function(){return this.options.clipMode},set:function(t){void 0!==t&&this.options.clipMode!==t&&(this.options.clipMode=t,this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this.options.position.clone()},set:function(t){this.options.position.equals(t)||(this.options.position.copyFrom(t),this.dirty=!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rotation",{get:function(){return this.options.rotation.clone()},set:function(t){this.options.rotation.equals(t)||(this.options.rotation.copyFrom(t),this.dirty=!0,this.options.quat=void 0)},enumerable:!1,configurable:!0}),t.prototype.getViewMatrix=function(){return this.updateMatrix(),this.viewMatrix.clone()},t.prototype.getInverseViewMatrix=function(){return this.updateMatrix(),this.inverseViewMatrix.clone()},t.prototype.getProjectionMatrix=function(){return this.updateMatrix(),this.projectionMatrix.clone()},t.prototype.getInverseProjectionMatrix=function(){var t;return this.updateMatrix(),null===(t=this.inverseProjectionMatrix)||void 0===t?void 0:t.clone()},t.prototype.getViewProjectionMatrix=function(){return this.updateMatrix(),this.viewProjectionMatrix.clone()},t.prototype.getInverseViewProjectionMatrix=function(){return this.updateMatrix(),this.inverseViewProjectionMatrix||(this.inverseViewProjectionMatrix=this.viewProjectionMatrix.clone(),this.inverseViewProjectionMatrix.invert()),this.inverseViewProjectionMatrix.clone()},t.prototype.getModelViewProjection=function(t,e){return t.multiplyMatrices(this.viewProjectionMatrix,e)},t.prototype.getInverseVPRatio=function(t){var e=new It(this.position.x,this.position.y,t),r=this.getViewProjectionMatrix(),i=this.getInverseViewProjectionMatrix(),n=r.projectPoint(e).z,o=i.projectPoint(new It(1,1,n)),s=o.x,a=o.y,u=i.projectPoint(new It(-1,-1,n)),c=u.x,l=u.y;return new It((s-c)/2,(a-l)/2,0)},t.prototype.setQuat=function(t){void 0===this.options.quat?(this.options.quat=t.clone(),this.dirty=!0):this.options.quat.equals(t)||(this.options.quat.copyFrom(t),this.dirty=!0),this.dirty&&this.setRotationByQuat(t)},t.prototype.getQuat=function(){var t=this.options.quat;if(void 0===t){t=new Pt;var e=this.options.rotation;e&&t.setFromEuler(e),this.options.quat=t}return t},t.prototype.getOptions=function(){return this.options},t.prototype.copy=function(t){var e=t.near,r=t.far,i=t.fov,n=t.clipMode,o=t.aspect,s=t.position,a=t.rotation;this.near=e,this.far=r,this.fov=i,this.clipMode=n,this.aspect=o,this.position=s,this.rotation=a,this.updateMatrix()},t.prototype.updateMatrix=function(){if(this.dirty){var t=this.options,e=t.fov,r=t.aspect,i=t.near,n=t.far,o=t.clipMode,s=t.position;this.projectionMatrix.perspective(e*At,r,i,n,o===I.portrait),this.inverseViewMatrix.compose(s,this.getQuat(),ya),this.viewMatrix.copyFrom(this.inverseViewMatrix).invert(),this.viewProjectionMatrix.multiplyMatrices(this.projectionMatrix,this.viewMatrix),this.inverseViewProjectionMatrix=null,this.dirty=!1}},t.prototype.setRotationByQuat=function(t){cr.getRotation(t,this.options.rotation)},t}(),xa={lum:[function(e,r){var i=r.renderer,n=2===i.engine.gpuCapability.level?v.LINEAR:v.NEAREST,o=new Js(i,{name:"lumCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:n,magFilter:n}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{mesh:{fragment:ci,uniformValues:{uFilterParams:[1,0,0,0]},materialStates:{blending:!1,depthTest:!1,culling:!1}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}]},prePasses:[o],renderPassDelegate:{}}},function(){return[{fragment:ci}]}],alphaFrame:[function(e,r){var i=e,n=i.colorRange,o=void 0===n?[.5,1]:n,s=i.alphaRange,a=void 0===s?[0,.5]:s,u=[a[0],a[1]-a[0],o[0],o[1]-o[0]],c=r.renderer,l=2===c.engine.gpuCapability.level?v.LINEAR:v.NEAREST,h=new Js(c,{name:"alphaFrameCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:l,magFilter:l}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{particle:{fragment:Xi,uniformValues:{uTexRange:u}},mesh:{fragment:Xi,shaderCacheId:"alpha-frame",materialStates:{blending:!1},uniformValues:{uTexRange:u}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[h]}}},function(){return[{fragment:Xi,shaderCacheId:"alpha-frame"},{fragment:Xi,isParticle:!0}]}],cameraMove:[function(e,r){var i=e.position,n=void 0===i?[0,0,0]:i,o=n;Number.isFinite(n[0])&&Number.isFinite(n[1])&&(o=[V.CONSTANT_VEC3,n]);var s=Be(o),a=new ga("camera_move"),u=new It,c=r.renderer,l=2===c.engine.gpuCapability.level?v.LINEAR:v.NEAREST,h=new Js(c,{name:"cameraCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:l,magFilter:l}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{mesh:{vertex:Yi,fragment:ci,shaderCacheId:"camera-move",materialStates:{blending:!1,depthTest:!1,culling:!1},variables:{uMoveCameraViewPro:function(t){a.copy(r.camera);var e=s.getValue(t);return u.addVectors(r.camera.position,new It(-e[0],-e[1],-e[2])),a.position=u,a.getViewProjectionMatrix().toArray()}}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[h]}}},function(){return[{vertex:Yi,fragment:ci,shaderCacheId:"camera-move"}]}],alphaMask:[function(e,r){var i=e,n=i.xOpacity,o=i.yOpacity,s=r.renderer.engine,a=r.renderer,u=oa(s,n),c=oa(s,o,!0),l=2===s.gpuCapability.level?v.LINEAR:v.NEAREST,h=new Js(a,{name:"alphaMaskCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:l,magFilter:l}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{mesh:{fragment:Hi,shaderCacheId:"alpha-mask",materialStates:{blending:!1,depthTest:!1,culling:!1},uniformValues:{uAlphaXSample:u,uAlphaYSample:c}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[h]}}},function(){return[{fragment:Hi,shaderCacheId:"alpha-mask"}]}],distortion:[function(e,r){var i=e,n=i.center,o=void 0===n?[.5,.5]:n,s=i.direction,a=void 0===s?[1,0]:s,u=i.period,c=i.waveMovement,l=i.strength,h=ne(a),f=[o[0],o[1],h[0],h[1]],p=Be(u),d=Be(c),m=Be(l),y=2*Math.PI,g=r.renderer,x=2===g.engine.gpuCapability.level?v.LINEAR:v.NEAREST,T=new Js(g,{name:"distortionCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:x,magFilter:x}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{particle:{fragment:Wi,vertex:Zi,uniforms:{uPeriodValue:p,uMovementValue:d,uStrengthValue:m},uniformValues:{uWaveParams:f}},mesh:{shaderCacheId:"distortion",fragment:Wi,materialStates:{blending:!1,culling:!1},variables:{vWaveParams:function(t){return[p.getValue(t)*y,d.getValue(t)*y,m.getValue(t),0]}},uniformValues:{uWaveParams:f}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[T]}}},function(t){var e=t,r=e.period,i=e.waveMovement,n=e.strength;return[{fragment:Wi,shaderCacheId:"distortion"},{fragment:Wi,vertex:Zi,isParticle:!0,uniforms:[r,i,n]}]}],bloom:[function(e,r){var i=e,n=i.radius,o=void 0===n?30:n,s=i.bloomAddon,a=void 0===s?.4:s,u=i.colorAddon,c=void 0===u?1:u,l=i.colorThreshold,h=void 0===l?[255,255,255]:l,f=r.getEngine().gpuCapability.level,p=$s({radius:o}),d=r.renderer.engine,m=r.renderer,y=Math.round(r.width/p.downSample),g=Math.round(r.width/p.downSample);1===f&&(y=ue(y),g=ue(g));var x=[0,0,y,g],T=r.renderFrame.passTextureCache.requestColorAttachmentTexture({format:v.RGBA,magFilter:v.LINEAR,minFilter:v.LINEAR,name:"gaussianV",width:y,height:g}),E=r.renderFrame.passTextureCache.requestColorAttachmentTexture({format:v.RGBA,magFilter:v.LINEAR,minFilter:v.LINEAR,name:"gaussianH",width:y,height:g}),b=Be(a),S=Be(c),A=new Fi(d),R=new ea(m,{name:"threshold",attachments:[{texture:T}],viewport:x,clearAction:{colorAction:t.TextureLoadAction.clear}});R.pluginSystem=r.pluginSystem,R.fragShader=Ki,R.preDefaultPassAttachment=A;var C=new ra(m,"H",new Lt(p.step,0),r.pluginSystem,p.shader,{name:"gaussianH",viewport:x,attachments:[{texture:E}],clearAction:{colorAction:t.TextureLoadAction.clear}},T);C.preDefaultPassAttachment=A;var _=new ra(m,"V",new Lt(0,p.step),r.pluginSystem,p.shader,{name:"gaussianV",viewport:x,attachments:[{texture:T}]},E);_.preDefaultPassAttachment=A;var w=2===f?v.LINEAR:v.NEAREST,O=new ia(m,{name:"bloomCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:w,magFilter:w}}],clearAction:{colorAction:t.TextureLoadAction.clear}},A);return{mesh:{name:"bloom-".concat(p.step),fragment:qi,shaderCacheId:"bloom-".concat(p.step),variables:{uBloomParams:function(t){return[b.getValue(t),S.getValue(t),0,1]}},uniformValues:{uColorThreshold:[h[0]/255||1.1,h[1]/255||1.1,h[2]/255||1.1,0],uBloomBlur:T},materialStates:{blending:!1,culling:!1}},onItemRemoved:function(){T.dispose(),E.dispose()},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[R,C,_,O]}}},function(t){var e=t.radius,r=$s({radius:void 0===e?30:e});return[{fragment:qi,shaderCacheId:"bloom-".concat(r.step)},{fragment:Ki,ignoreBlend:!0},{fragment:r.shader,ignoreBlend:!0}]}],gaussian:[function(e,r){var i=e.radius,n=r.getEngine().gpuCapability.level,o=r.renderer.engine,s=r.renderer,a=$s({radius:i}),u=a.downSample,c=a.step,l=a.shader,h=Math.round(r.width/u),f=Math.round(r.height/u);1===n&&(f=ue(f),h=ue(h));var p=[0,0,h,f],d=r.renderFrame.passTextureCache.requestColorAttachmentTexture({minFilter:v.LINEAR,magFilter:v.LINEAR,name:"gaussianV",width:h,height:f}),m=r.renderFrame.passTextureCache.requestColorAttachmentTexture({minFilter:v.LINEAR,magFilter:v.LINEAR,name:"gaussianH",width:h,height:f}),y=new Fi(o,{}),g=new Qs(s,"H",new Lt(0,c),r.pluginSystem,l,{name:"gaussianH",viewport:p,attachments:[{texture:m}],clearAction:{colorAction:t.TextureLoadAction.clear}});g.preDefaultPassAttachment=y;var x=new Qs(s,"V",new Lt(c,0),r.pluginSystem,l,{name:"gaussianV",viewport:p,attachments:[{texture:d}],clearAction:{colorAction:t.TextureLoadAction.clear}});x.preDefaultPassAttachment=y;var T=2===n?v.LINEAR:v.NEAREST,E=new Js(s,{name:"gaussianCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:T,magFilter:T}}],clearAction:{colorAction:t.TextureLoadAction.clear}},y);return E.preDefaultPassAttachment=y,{mesh:{fragment:ci,shaderCacheId:"gaussian-".concat(c),uniformValues:{uTexSize:[h,f]},materialStates:{blending:!1,culling:!1}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[g,x,E]}}},function(t){var e=$s({radius:t.radius});return[{fragment:ci,shaderCacheId:"gaussian-".concat(e.step)},{fragment:e.shader,ignoreBlend:!0}]}],delay:[function(e,r){var i=r.renderer,n=qr.create(i.engine,{sourceType:t.TextureSourceType.framebuffer}),o=[0,.96,0,0],s=2===i.engine.gpuCapability.level?v.LINEAR:v.NEAREST,a=new na(i,{name:"delayCopyPass",attachments:[{texture:{format:v.RGBA,minFilter:s,magFilter:s}}],clearAction:{colorAction:t.TextureLoadAction.clear}});return{mesh:{fragment:ji,shaderCacheId:"delay",uniformValues:{uLastSource:n},variables:{uParams:function(){return o}},materialStates:{blending:!0,blendFunction:[v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA,v.SRC_ALPHA,v.ONE_MINUS_SRC_ALPHA],depthTest:!1,culling:!1}},passSplitOptions:{attachments:[{texture:{format:v.RGBA}}],prePasses:[a]},onItemRemoved:function(){n.dispose()},renderPassDelegate:{didEndRenderPass:function(t){i.extension.copyTexture(t.attachments[0].texture,n),o[0]=2}}}},function(){return[{fragment:ji,shaderCacheId:"delay"}]}]};!function(t){t.S="S",t.APlus="A+",t.A="A",t.BPlus="B+",t.B="B"}(sa||(sa={})),function(t){t[t.ALPHA=0]="ALPHA",t[t.ADD=1]="ADD",t[t.MULTIPLY=2]="MULTIPLY",t[t.BRIGHTNESS=3]="BRIGHTNESS",t[t.SUBTRACTION=4]="SUBTRACTION",t[t.STRONG_LIGHT=5]="STRONG_LIGHT",t[t.WEAK_LIGHT=6]="WEAK_LIGHT",t[t.SUPERPOSITION=7]="SUPERPOSITION"}(aa||(aa={})),function(t){t[t.DOUBLE=1032]="DOUBLE",t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK"}(ua||(ua={})),function(t){t[t.NONE=0]="NONE",t[t.MASK=1]="MASK",t[t.OBSCURED=2]="OBSCURED",t[t.REVERSE_OBSCURED=3]="REVERSE_OBSCURED"}(ca||(ca={})),function(t){t[t.NONE=0]="NONE",t[t.SPHERE=1]="SPHERE",t[t.CONE=2]="CONE",t[t.HEMISPHERE=3]="HEMISPHERE",t[t.CIRCLE=4]="CIRCLE",t[t.DONUT=5]="DONUT",t[t.RECTANGLE=6]="RECTANGLE",t[t.RECTANGLE_EDGE=7]="RECTANGLE_EDGE",t[t.EDGE=8]="EDGE",t[t.TEXTURE=9]="TEXTURE"}(la||(la={})),function(t){t[t.GYROSCOPE=0]="GYROSCOPE",t[t.SPINE=1]="SPINE"}(ha||(ha={})),function(t){t[t.CLICK=0]="CLICK",t[t.MESSAGE=1]="MESSAGE",t[t.DRAG=2]="DRAG"}(fa||(fa={})),function(t){t[t.NONE=0]="NONE",t[t.NOTIFY=1]="NOTIFY",t[t.RESUME_PLAYER=2]="RESUME_PLAYER",t[t.REMOVE=3]="REMOVE",t[t.PAUSE=4]="PAUSE"}(pa||(pa={})),function(t){t.base="0",t.sprite="1",t.particle="2",t.null="3",t.interact="4",t.plugin="5",t.camera="6",t.composition="7",t.filter="8",t.spine="spine",t.mesh="mesh",t.tree="tree",t.text="text",t.light="light",t.skybox="skybox"}(da||(da={})),function(t){t[t.BILLBOARD=0]="BILLBOARD",t[t.MESH=1]="MESH",t[t.VERTICAL_BILLBOARD=2]="VERTICAL_BILLBOARD",t[t.HORIZONTAL_BILLBOARD=3]="HORIZONTAL_BILLBOARD"}(ma||(ma={})),function(t){t[t.PARTICLE_ORIGIN_CENTER=0]="PARTICLE_ORIGIN_CENTER",t[t.PARTICLE_ORIGIN_LEFT_TOP=1]="PARTICLE_ORIGIN_LEFT_TOP",t[t.PARTICLE_ORIGIN_LEFT_CENTER=2]="PARTICLE_ORIGIN_LEFT_CENTER",t[t.PARTICLE_ORIGIN_LEFT_BOTTOM=3]="PARTICLE_ORIGIN_LEFT_BOTTOM",t[t.PARTICLE_ORIGIN_CENTER_TOP=4]="PARTICLE_ORIGIN_CENTER_TOP",t[t.PARTICLE_ORIGIN_CENTER_BOTTOM=5]="PARTICLE_ORIGIN_CENTER_BOTTOM",t[t.PARTICLE_ORIGIN_RIGHT_TOP=6]="PARTICLE_ORIGIN_RIGHT_TOP",t[t.PARTICLE_ORIGIN_RIGHT_CENTER=7]="PARTICLE_ORIGIN_RIGHT_CENTER",t[t.PARTICLE_ORIGIN_RIGHT_BOTTOM=8]="PARTICLE_ORIGIN_RIGHT_BOTTOM"}(va||(va={}));var Ta,Ea,ba,Sa,Aa,Ra,Ca,_a,wa,Oa,Ma,La,Ia,Pa,Fa,Va,Na,Da,za=0;!function(t){t[t.portrait=1]="portrait",t[t.landscape=za]="landscape"}(Ta||(Ta={})),function(t){t[t.destroy=0]="destroy",t[t.pause=1]="pause",t[t.restart=5]="restart",t[t.forward=2]="forward",t[t.pause_destroy=3]="pause_destroy"}(Ea||(Ea={})),function(t){t.video="video",t.image="image"}(ba||(ba={})),function(t){t[t.CONSTANT=0]="CONSTANT",t[t.CONSTANT_VEC2=1]="CONSTANT_VEC2",t[t.CONSTANT_VEC3=2]="CONSTANT_VEC3",t[t.CONSTANT_VEC4=3]="CONSTANT_VEC4",t[t.RANDOM=4]="RANDOM",t[t.LINE=5]="LINE",t[t.CURVE=6]="CURVE",t[t.BEZIER_PATH=7]="BEZIER_PATH",t[t.RGBA_COLOR=8]="RGBA_COLOR",t[t.GRADIENT_COLOR=9]="GRADIENT_COLOR",t[t.SHAPE_POINTS=10]="SHAPE_POINTS",t[t.SHAPE_SPLITS=11]="SHAPE_SPLITS",t[t.LINEAR_PATH=12]="LINEAR_PATH",t[t.COLORS=13]="COLORS",t[t.BINARY=20]="BINARY",t[t.BEZIER_CURVE=21]="BEZIER_CURVE",t[t.BEZIER_CURVE_PATH=22]="BEZIER_CURVE_PATH"}(Sa||(Sa={})),function(t){t[t.AUTO=0]="AUTO",t[t.EASE=1]="EASE",t[t.EASE_IN=2]="EASE_IN",t[t.EASE_OUT=3]="EASE_OUT",t[t.LINE=4]="LINE",t[t.HOLD=5]="HOLD",t[t.LINE_OUT=6]="LINE_OUT"}(Aa||(Aa={})),function(t){t[t.destroy=0]="destroy",t[t.loop=5]="loop",t[t.freeze=4]="freeze"}(Ra||(Ra={})),function(t){t[t.destroyChildren=6]="destroyChildren"}(Ca||(Ca={})),function(t){t[t.none=0]="none",t[t.removeParticle=1]="removeParticle"}(_a||(_a={})),function(t){t[t.RANDOM=0]="RANDOM",t[t.UNIDIRECTIONAL_CYCLE=1]="UNIDIRECTIONAL_CYCLE",t[t.BIDIRECTIONAL_CYCLE=2]="BIDIRECTIONAL_CYCLE",t[t.UNIFORM_BURST=3]="UNIFORM_BURST"}(wa||(wa={})),function(t){t[t.box=2]="box",t[t.sphere=3]="sphere"}(Oa||(Oa={})),function(t){t.unlit="unlit",t.pbr="pbr",t.hair="hair"}(Ma||(Ma={})),function(t){t[t.opaque=100]="opaque",t[t.masked=101]="masked",t[t.translucent=102]="translucent",t[t.additive=103]="additive"}(La||(La={})),function(t){t.none="none",t.uv="uv",t.normal="normal",t.basecolor="basecolor",t.alpha="alpha",t.metallic="metallic",t.roughness="roughness",t.ao="ao",t.emissive="emissive"}(Ia||(Ia={})),function(t){t[t.display=0]="display",t[t.clip=1]="clip",t[t.ellipsis=2]="ellipsis"}(Pa||(Pa={})),function(t){t[t.top=0]="top",t[t.middle=1]="middle",t[t.bottom=2]="bottom"}(Fa||(Fa={})),function(t){t[t.left=0]="left",t[t.middle=1]="middle",t[t.right=2]="right"}(Va||(Va={})),function(t){t.normal="normal",t.bold="bold",t.lighter="lighter"}(Na||(Na={})),function(t){t.normal="normal",t.italic="italic",t.oblique="oblique"}(Da||(Da={}));var Ba=function(){return Ba=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},Ba.apply(this,arguments)};function Ua(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],i=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function ka(t,e){if(!t.includes(e))return t.push(e),!0}function Ga(t,e,r){if(t)for(var i in t)Object.hasOwnProperty.call(t,i)&&e.call(r,t[i],i);return t}function Xa(t){if(Number.isFinite(t))return[Sa.CONSTANT,t];if(t){var e=t[0],r=t[1];if(Array.isArray(e))return;if("static"===e||e===Sa.CONSTANT)return[Sa.CONSTANT,t[1]];if("lines"===e)return[Sa.LINE,t[1]];if(e===Sa.LINE){var i=r.map((function(t){return[Aa.LINE,t]}));return[Sa.BEZIER_CURVE,i]}return"curve"===e||e===Sa.CURVE?[Sa.BEZIER_CURVE,ou(r)]:t}}function Ha(t,e){return Array.isArray(t)&&"random"===t[0]?[Sa.CONSTANT,t[1][e]]:Xa(t)}function Ya(t){return t&&"color"===t[0]?qa(t[1],!0):[1,1,1,1]}function ja(t,e){if(t)return"colors"===t[0]?[Sa.COLORS,t[1].map((function(t){return qa(t,e)}))]:"gradient"===t[0]?Za(t[1],e):"color"===t[0]?[Sa.RGBA_COLOR,qa(t[1],e)]:t}function Wa(t){return t&&"random"===t[0]?[Sa.RANDOM,t[1]]:Xa(t)}function Za(t,e){if(t){var r=[];return Object.getOwnPropertyNames(t).forEach((function(i){var n=function(t){var e=/^(-)?([\d+.]+)%$/.exec(t);return e?+e[2]/100*(e[1]?-1:1):+t}(i),o=qa(t[i],e);r.push([n,o[0],o[1],o[2],o[3]])})),r=r.sort((function(t,e){return t[0]-e[0]})),[Sa.GRADIENT_COLOR,r]}}function qa(t,e){var r;if("string"==typeof t){t=t.replace(/[\s\t\r\n]/g,"");var i=/rgba?\(([.\d]+),([.\d]+),([.\d]+),?([.\d]+)?\)/.exec(t);if(i){var n=+i[4];r=[+i[1],+i[2],+i[3],isNaN(n)?255:Math.round(255*n)]}else/^#[a-f\d]{3}$/i.test(t)?r=[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16),255]:(i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t))&&(r=[parseInt(i[1],16),parseInt(i[2],16),parseInt(i[3],16),255]||[0,0,0,255])}else t instanceof Array&&(r=[t[0],t[1],t[2],isNaN(t[3])?255:Math.round(255*t[3])]);return e&&(r=function(t){if(Array.isArray(t))return t.map((function(t){return Number.isFinite(t/255)?Number((t/255).toFixed(6)):0}))}(r)),r}function Ka(t,e){return Array.isArray(t)?t[0]===Sa.GRADIENT_COLOR?t:("gradient"===t[0]||"color"===t[0])&&Za(t[1],e):Za(t,e)}function Qa(t){if(t){if(3===t.length)return[Sa.CONSTANT_VEC3,t];var e=t[0];if("path"===e||"bezier"===e||e===Sa.BEZIER_PATH||e===Sa.LINEAR_PATH){var r=t[1],i=r[0],n=r[1],o=r[2],s=ou(i);if(!o){o=[];for(var a=0;a<n.length;a++){var u=n[a].slice();0===a?o.push(u):a<n.length-1?(o.push(u),o.push(u)):o.push(u)}}return[Sa.BEZIER_CURVE_PATH,[s,n,o]]}return t}}function Ja(t){var e,r;try{for(var i=Ua(Object.keys(t)),n=i.next();!n.done;n=i.next()){var o=n.value;t[o]=Number(t[o])}}catch(t){e={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return t}function $a(t){var e,r;try{for(var i=Ua(Object.keys(t)),n=i.next();!n.done;n=i.next()){var o=n.value;void 0===t[o]&&delete t[o]}}catch(t){e={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return t}"function"==typeof SuppressedError&&SuppressedError;var tu=Math.cos,eu=Math.sin,ru=Math.PI/180,iu=180/Math.PI;function nu(t,e,r,i){var n=r[0],o=r[1],s=i[0],a=s-n;return[[n+(s-n)/3,o+(t*=a)/3],[s-(s-n)/3,i[1]-(e*=a)/3]]}function ou(t){for(var e=-1e6,r=1e6,i=0;i<t.length;i++)e=Math.max(e,t[i][1]),r=Math.min(r,t[i][1]);var n=[[t[0][0],t[0][1]]];for(i=0;i<t.length-1;i++){var o=t[i][3]*(e-r),s=t[i+1][2]*(e-r),a=[t[i][0],t[i][1]],u=[t[i+1][0],t[i+1][1]];if(a[0]!=u[0]){var c=nu(o,s,a,u),l=c[0],h=c[1];n[n.length-1].push(l[0]),n[n.length-1].push(l[1]),n.push([h[0],h[1],u[0],u[1]])}else n[n.length-1].push(u[0]),n[n.length-1].push(u[1])}return n.map((function(t,e){return 0===e?[Aa.EASE_OUT,t]:e===n.length-1?[Aa.EASE_IN,t]:[Aa.EASE,t]}))}function su(t){var e,r=t.options,i=t.transform,n={type:la.NONE};if(t.shape){var o=null===(e=t.shape.shape)||void 0===e?void 0:e.replace(/([A-Z])/g,"_$1").toUpperCase().replace(/^_/,"");if(n=Ba(Ba({},t.shape),{type:la[o]}),t.shape.upDirection){var s=function(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var i,n,o=r.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)s.push(i.value)}catch(t){n={error:t}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return s}(t.shape.upDirection,3),a=s[0],u=s[1],c=s[2];0===a&&0===u&&0===c&&delete n.upDirection}}r.startTurbulence&&(n.turbulenceX=Wa(r.turbulenceX),n.turbulenceY=Wa(r.turbulenceY),n.turbulenceZ=Wa(r.turbulenceZ));var l=t.emission;l.bursts&&l.bursts.length>0&&(l.bursts=l.bursts.map((function(t){return Ja(t)}))),l.burstOffsets&&l.burstOffsets.length>0&&(l.burstOffsets=l.burstOffsets.map((function(t){return Ja(t)}))),l.rateOverTime&&(l.rateOverTime=Wa(l.rateOverTime));var h={renderer:t.renderer,shape:n,splits:t.splits,emission:l,options:{startLifetime:Wa(r.startLifetime),start3DSize:!!r.start3DSize,startSize:Wa(r.startSize),startSizeX:Wa(r.startSizeX),startSizeY:Wa(r.startSizeY),sizeAspect:Wa(r.sizeAspect),maxCount:r.maxCount,startDelay:Wa(r.startDelay),startColor:ja(r.startColor,!0),startRotationZ:Wa(r.startRotation||r.startRotationZ),particleFollowParent:r.particleFollowParent}};if(r.start3DRotation&&(h.options.startRotationX=Wa(r.startRotationX),h.options.startRotationY=Wa(r.startRotationY)),t.filter){var f={};Ga(t.filter,(function(t,e){var r;f[e]=(r=t,Array.isArray(r)&&"string"==typeof r[0]&&(Wa(r)||Qa(r)||ja(r))||r)})),h.filter=f}i&&i.path&&(h.emitterTransform={path:Qa(i.path)});var p=t.sizeOverLifetime;p&&(p.separateAxes?h.sizeOverLifetime={separateAxes:!0,x:Wa(p.x),y:Wa(p.y)}:h.sizeOverLifetime={size:Wa(p.size)});var d=t.velocityOverLifetime||{},m=d.speedOverLifetime;m=m?Xa(m):void 0,h.positionOverLifetime={gravity:r.gravity,gravityOverLifetime:Xa(r.gravityModifier),startSpeed:Wa(r.startSpeed),speedOverLifetime:m,asMovement:d.asMovement,linearX:Wa(d.linearX),linearY:Wa(d.linearY),linearZ:Wa(d.linearZ),asRotation:d.asRotation,orbCenter:d.orbCenter,orbitalX:Wa(d.orbitalX),orbitalY:Wa(d.orbitalY),orbitalZ:Wa(d.orbitalZ),forceTarget:d.forceTarget,target:d.target,forceCurve:Xa(d.forceCurve)},$a(h.positionOverLifetime);var v=t.rotationOverLifetime;v&&(h.rotationOverLifetime={separateAxes:v.separateAxes,asRotation:v.asRotation,z:Wa(v.separateAxes?v.z:v.angularVelocity)},v.separateAxes&&(h.rotationOverLifetime.y=Xa(v.y),h.rotationOverLifetime.x=Xa(v.x)));var y=t.colorOverLifetime;if(y){var g=h.colorOverLifetime={opacity:Xa(y.opacity)};y.color&&(g.color=Ka(y.color))}var x=t.textureSheetAnimation;x&&(h.textureSheetAnimation={row:x.row,col:x.col,total:x.total,animate:x.animate,cycles:Xa(x.cycles),animationDelay:Ha(x.animationDelay,0),animationDuration:Ha(x.animationDuration,0)});var T=t.trails;T&&(h.trails={lifetime:Wa(T.lifetime),dieWithParticles:T.dieWithParticles,maxPointPerTrail:T.maxPointPerTrail,minimumVertexDistance:T.minimumVertexDistance,widthOverTrail:Xa(T.widthOverTrail),colorOverTrail:T.colorOverTrail&&Ka(T.colorOverTrail,!1),blending:T.blending,colorOverLifetime:T.colorOverLifetime&&Ka(T.colorOverLifetime,!1),inheritParticleColor:T.inheritParticleColor,occlusion:T.occlusion,transparentOcclusion:T.transparentOcclusion,orderOffset:T.orderOffset,sizeAffectsLifetime:T.sizeAffectsLifetime,sizeAffectsWidth:T.sizeAffectsWidth,texture:T.texture,parentAffectsPosition:T.parentAffectsPosition,opacityOverLifetime:Wa(T.opacityOverLifetime)}),h.trails&&$a(h.trails);var E=t.interaction;return E&&(h.interaction={behavior:E.behavior,radius:E.radius,multiple:E.multiple}),h}function au(t,e){var r,i=t.options,n=t.velocityOverLifetime||{},o={path:Qa(null===(r=t.transform)||void 0===r?void 0:r.path),gravity:i.gravity,gravityOverLifetime:Xa(i.gravityModifier),direction:i.direction,startSpeed:i.startSpeed,asMovement:n.asMovement,linearX:Xa(n.linearX),linearY:Xa(n.linearY),linearZ:Xa(n.linearZ),asRotation:n.asRotation,orbCenter:n.orbCenter,orbitalX:Xa(n.orbitalX),orbitalY:Xa(n.orbitalY),orbitalZ:Xa(n.orbitalZ),speedOverLifetime:Xa(n.speedOverLifetime)};$a(o);var s={options:{startColor:Ya(i.startColor)},positionOverLifetime:o};i.startSize&&(e.scale=[i.startSize,i.startSize/(i.sizeAspect||1),1]),i.startRotation&&(e.rotation?e.rotation[2]+=i.startRotation:e.rotation=[0,0,i.startRotation]);var a=t.rotationOverLifetime;if(a){var u=s.rotationOverLifetime={separateAxes:a.separateAxes,asRotation:a.asRotation};u.separateAxes?(u.x=Xa(a.x),u.y=Xa(a.y),u.z=Xa(a.z)):u.z=Xa(a.angularVelocity)}var c=t.colorOverLifetime;if(c){var l=s.colorOverLifetime={opacity:Xa(c.opacity)};c.color&&(l.color=Ka(c.color))}var h=t.sizeOverLifetime;return h&&(s.sizeOverLifetime={separateAxes:h.separateAxes,size:Xa(h.size),x:Xa(h.x),y:Xa(h.y),z:Xa(h.z)}),s}function uu(t,e){var r=au(t,e),i=t.textureSheetAnimation;return i&&(r.textureSheetAnimation={row:i.row,col:i.col,total:i.total||void 0,animate:i.animate}),r.renderer=t.renderer,t.splits&&(r.splits=t.splits),t.interaction&&(r.interaction=t.interaction),r}var cu=["strength","bloomAddon","colorAddon","period","waveMovement","colorThreshold","xOpacity","yOpacity","feather"],lu=["path","position"];function hu(t){return t.compositions.forEach((function(t){t.items.forEach((function(t){t.type===da.null&&t.endBehavior===Ra.destroy&&(t.endBehavior=Ra.freeze)}))})),t.version="2.1",t}function fu(t){var e,r;if(t)try{for(var i=Ua(Object.keys(t)),n=i.next();!n.done;n=i.next()){var o=n.value,s=t[o],a=Array.isArray(s);a&&2===s.length&&Array.isArray(s[1])?t[o]="path"===o?Qa(s):Xa(s):a||"object"!=typeof s||fu(s)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}var pu=/^(\d+)\.(\d+)\.(\d+)(-(\w+)\.\d+)?$/,du=/^(\d+)\.(\d+)$/,mu=!1;function vu(t){var e;if(!t||"object"!=typeof t)throw Error("expect a json object");if(function(t){var e,r=null===(e=t.version)||void 0===e?void 0:e.split(".");!r||Number(r[0])>2||2===Number(r[0])&&Number(r[1])>=2||t.compositions.forEach((function(t){t.items.forEach((function(t){t.type!==da.mesh&&t.type!==da.light||(t.endBehavior=1===t.endBehavior?Ra.destroy:t.endBehavior)}))}))}(t),pu.test(t.version))return mu="0"===(null===(e=/^(\d+)/.exec(t.version))||void 0===e?void 0:e[0]),hu(function(t){var e,r;yu="1.0";var i=t.plugins||[];(null===(e=t.bins)||void 0===e?void 0:e.length)&&(yu="1.3");var n=(t.requires||[]).slice(),o=t.images.map((function(e,r){return gu(e,r,t.imageTags||[])})),s=t.textures||o.map((function(t,e){return{source:e,flipY:!0}})),a={plugins:i,shapes:t.shapes||[],type:"ge",version:yu,playerVersion:null!==(r=t.playerVersion)&&void 0!==r?r:{web:"",native:""},compositionId:t.compositionId+"",compositions:t.compositions.map((function(t){return xu(t,{plugins:i,requires:n})})),images:o,imgUsage:t._imgs,binUsage:t.binUsage,spines:t.spines,requires:t.requires,textures:s,bins:(t.bins||[]).slice()};return t._textures&&(a._textures=t._textures),a}(t));var r=du.exec(t.version)||[],i=Number(r[1]),n=Number(r[2]);if(i)return(i<2||2===i&&n<4)&&function(t){t.compositions.map((function(t){var e,r;try{for(var i=Ua(t.items),n=i.next();!n.done;n=i.next())fu(n.value.content)}catch(t){e={error:t}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}}))}(t),i<2?hu(t):t;throw Error("invalid json version "+t.version)}var yu="1.0";function gu(t,e,r){var i=r[e],n=t.oriY;if("string"==typeof t)return{renderLevel:i,url:t,oriY:n};if(t.template)return{url:t.url,template:t.template,webp:t.webp,renderLevel:i,oriY:n};if(t.compressed)return{url:t.url,oriY:n,compressed:{astc:t.compressed.android,pvrtc:t.compressed.iOS},webp:t.webp,renderLevel:i};if(t.url)return{url:t.url,webp:t.webp,renderLevel:i,oriY:n};if(t&&t.sourceType)return t;throw Error("invalid image type")}function xu(t,e){var r;void 0===e&&(e={});var i={id:t.id+"",camera:Object.assign({clipMode:za},t.camera),duration:t.duration,endBehavior:t.endBehavior,items:t.items.map((function(t){return Su(t,e)})),name:t.name},n=t.startTime||t.st;n&&(i.startTime=n);var o=null===(r=t.meta)||void 0===r?void 0:r.previewSize;return o&&o[0]===o[1]&&0===o[0]&&(o=void 0),o&&(i.previewSize=o),i}var Tu,Eu=[0,0,0,1],bu=.5;function Su(t,e){var r,i,n;void 0===e&&(e={});var o,s,a,u,c,l,h=da.base,f=t.endBehavior,p=NaN;if(t.content?(h=t.type||da.plugin,l=t.pn,c=t.pluginName,a=t.content,s=t.content,isNaN(l)&&!c&&(c=a.options.type),t.duration&&(p=t.duration),o=t.transform||y(s.transform),h===da.filter&&(yu<"1.1"&&(yu="1.1"),(a=uu(s,o)).filter=function(t){var e={};return Ga(t,(function(t,r){cu.includes(r)?e[r]=Xa(t):lu.includes(r)?e[r]=Qa(t):e[r]=t})),e}(s.filter))):t.particle?(h=da.particle,o=y((s=t.particle).transform,mu,!0),a=su(s)):t.sprite?(h=da.sprite,a=uu(s=t.sprite,o=y(s.transform,!1,!0))):t.cal?(h=da.null,a=au(s=t.cal,o=y(s.transform,!1,!0))):t.ui?(h=da.interact,o=y((s=t.ui).transform),a=function(t){var e,r=t.options;switch(r.type){case"click":e={type:fa.CLICK,showPreview:r.showPreview,previewColor:r.previewColor&&Ya(r.previewColor),behavior:r.behavior||pa.NOTIFY};break;case"drag":e={type:fa.DRAG,enableInEditor:!!r.enableInEditor,dxRange:r.dxRange,dyRange:r.dyRange,target:r.target};break;case"message":e={type:fa.MESSAGE}}return{options:e}}(s),o.scale=[s.options.width||1,s.options.height||1,1]):t.model&&(s=t.model,1===t.model.options.type&&(h=da.camera,o=y(s.transform),a=function(t){var e,r,i=t.options,n={options:{fov:i.fov,far:i.far,near:i.near,clipMode:i.clipMode}},o=t.velocityOverLifetime;if(o||(null===(e=t.transform)||void 0===e?void 0:e.path)){var s={path:Qa(null===(r=t.transform)||void 0===r?void 0:r.path),linearX:Xa(null==o?void 0:o.translateX),linearY:Xa(null==o?void 0:o.translateY),linearZ:Xa(null==o?void 0:o.translateZ)};$a(s),n.positionOverLifetime=s}var a=t.rotationOverLifetime;if(a){var u={separateAxes:a.separateAxes,x:Xa(null==a?void 0:a.rotateX),y:Xa(null==a?void 0:a.rotateY),z:a.separateAxes?Xa(null==a?void 0:a.rotateZ):Xa(a.rotation)};$a(u),n.rotationOverLifetime=u}return n}(s))),null===(r=a.renderer)||void 0===r?void 0:r.anchor){var d=new Float32Array(a.renderer.anchor);d[0]==bu&&d[1]==bu?delete a.renderer.anchor:e.requires&&ka(e.requires,"anchor")}if(s){var m=null===(i=s.options)||void 0===i?void 0:i.looping;f=m?Array.isArray(m)?m[1]?Ra.loop:Ra.destroy:Ra.loop:f||(null===(n=null==s?void 0:s.options)||void 0===n?void 0:n.endBehavior)||Ra.destroy,s.options.renderLevel&&(u=s.options.renderLevel),isNaN(p)&&(p=s.options.duration)}var v={type:h,name:t.name,delay:t.delay,duration:p,id:t.id+"",transform:o,endBehavior:f,renderLevel:u,content:a};return c?e.plugins?(ka(e.plugins,c),v.pn=e.plugins.indexOf(c)):v.pluginName=c:Number.isInteger(l)&&(v.pn=l),t.parentId&&(v.parentId=t.parentId+""),v;function y(t,e,r){if(t){var i={},n=t.rotation;if(n&&(i.rotation=e?[-n[0],-n[1],-n[2]]:[n[0],n[1],n[2]],r)){var o=(s=Eu,a=i.rotation[0],u=i.rotation[1],c=i.rotation[2],l=tu(a*ru/2),h=tu(u*ru/2),f=tu(c*ru/2),p=eu(a*ru/2),d=eu(u*ru/2),m=eu(c*ru/2),s[0]=p*h*f+l*d*m,s[1]=l*d*f-p*h*m,s[2]=l*h*m+p*d*f,s[3]=l*h*f-p*d*m,s);i.rotation=function(t,e){var r,i,n,o=e[0],s=e[1],a=e[2],u=e[3],c=o+o,l=s+s,h=a+a,f=o*c,p=s*c,d=s*l,m=a*h,v=u*h,y=1-d-m,g=p-v,x=p+v,T=1-f-m,E=a*c-u*l,b=a*l+u*c,S=1-f-d;return t[1]=Math.asin((i=-1,(r=-E)>(n=1)?n:r<i?i:r))*iu,Math.abs(E)<.9999999?(t[0]=Math.atan2(b,S)*iu,t[2]=Math.atan2(x,y)*iu):(t[0]=0,t[2]=Math.atan2(-g,T)*iu),t}([],o)}return t.position&&(i.position=t.position),Array.isArray(t.scale)&&(i.scale=[t.scale[0]||1,t.scale[1]||1,t.scale[2]||1]),i}var s,a,u,c,l,h,f,p,d,m;return{}}}var Au=((Tu={})[E.S]=[E.S,E.BPlus,E.APlus],Tu[E.A]=[E.A,E.BPlus,E.APlus],Tu[E.B]=[E.B,E.BPlus],Tu);function Ru(t,e){if(!t||!e)return!0;var r=Au[e];return!!r&&r.includes(t)}var Cu=0,_u=function(){function t(t,e){var r,i;this.refCompositions=new Map,this.refCompositionProps=new Map,this.mask=0;var n=t.jsonScene,o=t.renderLevel,a=t.textureOptions,u=t.pluginSystem,c=t.totalTime,l=n.compositions,h=n.imgUsage,f=n.compositionId;if(!a)throw new Error("scene.textures expected");var p=a.map((function(t){return t&&(t instanceof qr?t:qr.create(e,t))}));t.textureOptions=p,null==p||p.forEach((function(t){return null==t?void 0:t.initialize()}));try{for(var d=s(l),m=d.next();!m.done;m=d.next()){var v=m.value;v.id===f?this.composition=v:this.refCompositions.set(v.id,v)}}catch(t){r={error:t}}finally{try{m&&!m.done&&(i=d.return)&&i.call(d)}finally{if(r)throw r.error}}if(!this.composition)throw new Error("Invalid composition id: "+f);this.jsonScene=n,this.renderLevel=o,this.pluginSystem=u,this.totalTime=null!=c?c:0,this.imgUsage=null!=h?h:{},this.textures=p,Cu=0,this.textureOptions=a,this.sourceContent=this.getContent(this.composition)}return t.prototype.getContent=function(t){var e=t.id,r=t.duration,i=t.name,n=t.endBehavior,o=t.camera,s=t.globalVolume,a=t.startTime,u=void 0===a?0:a,c=this.assembleItems(t);return{id:e,duration:r,name:i,endBehavior:isNaN(n)?1:n,items:c,camera:o,startTime:u,globalVolume:s}},t.prototype.assembleItems=function(t){var e=this,r=[];return t.items.forEach((function(t){var n,o={},s=t.visible,a=t.renderLevel,u=t.type;if(!1!==s){var c=i({},t.content);if(c&&(o.content=i({},c),Ru(a,e.renderLevel))){var l=o.content;if(o.type=u,l.renderer){l.renderer=e.changeTex(l.renderer),e.processMask(l.renderer);var h=l.splits&&!l.textureSheetAnimation&&l.splits[0];Number.isInteger(l.renderer.shape)?l.renderer.shape=Yo(null===(n=e.jsonScene)||void 0===n?void 0:n.shapes[l.renderer.shape],h):l.renderer.shape&&ir(l.renderer.shape)&&(l.renderer.shape=Yo(l.renderer.shape,h))}else o.content.renderer={order:0};l.trails&&(l.trails=e.changeTex(l.trails)),l.filter&&(l.filter=i({},l.filter));var f=t.name,p=t.delay,d=void 0===p?0:p,m=t.id,v=t.parentId,y=t.duration,g=t.endBehavior,x=t.pluginName,T=t.pn,E=t.transform,b=t.refCount,S=e.jsonScene.plugins,A=void 0===S?[]:S;if(o.name=f,o.delay=d,o.id=m,v&&(o.parentId=v),o.refCount=b,o.duration=y,o.listIndex=Cu++,o.endBehavior=g,x?o.pluginName=x:void 0!==T&&Number.isInteger(T)&&(o.pluginName=A[T]),E&&(o.transform=E),o.type===O.composition){e.mask++;var R=t.content.options.refId;if(!e.refCompositions.get(R))throw new Error("Invalid Ref Composition id: "+R);var C=e.getContent(e.refCompositions.get(R));e.refCompositionProps.has(R)||e.refCompositionProps.set(R,C),C.items.forEach((function(t){e.processMask(t.content)})),o.items=C.items}r.push(o)}}})),r},t.prototype.changeTex=function(t){var e=t.texture,r=i({},t);return void 0!==e&&(r.texture=this.addTextureUsage(e)||e),r},t.prototype.addTextureUsage=function(t){var e,r;if(Number.isInteger(t)){var i=null===(e=this.textures)||void 0===e?void 0:e[t],n=null==i?void 0:i.id,o=null!==(r=this.imgUsage)&&void 0!==r?r:{};if(n&&o)return o.hasOwnProperty(n)||(o[n]=0),o[n]++,i}},t.prototype.processMask=function(t){if(t.maskMode!==A.NONE&&!t.mask){var e=t.maskMode;e===A.MASK?t.mask=++this.mask:e!==A.OBSCURED&&e!==A.REVERSE_OBSCURED||(t.mask=this.mask)}},t.prototype.dispose=function(){this.textureOptions=[],this.textures=[],this.composition=void 0,this.jsonScene=void 0,this.totalTime=0,this.pluginSystem=void 0,this.sourceContent=void 0,this.refCompositions.clear(),this.refCompositionProps.clear()},t}();function wu(t){return ir(t)&&"jsonScene"in t}var Ou,Mu,Lu=1,Iu=function(){function e(t,e){void 0===t&&(t={}),void 0===e&&(e=new Ur),this.options=t,this.downloader=e,this.assets={},this.id=Lu++,this.timers=[],this.updateOptions(t)}return e.prototype.updateOptions=function(t){void 0===t&&(t={}),this.options=t,t.pluginData||(t.pluginData={});var e=t.timeout,r=void 0===e?10:e;this.timeout=r},e.prototype.updateSceneData=function(t){var e=this.options.variables;return!e||Object.keys(e).length<=0||t.forEach((function(t){t.items.forEach((function(t){if(t.type===O.text){var r=e[t.name];r&&(t.content.options.text=r)}}))})),t},e.prototype.loadScene=function(t,e,r){var s,u,c;return n(this,void 0,void 0,(function(){var l,h,f,p,d,m,v,y,g,x,T,E,b,S=this;return o(this,(function(A){return h=tr(t)?t:this.id,f=performance.now(),p=[],d=null==e?void 0:e.engine.gpuCapability,m=null!==(u=null===(s=null==d?void 0:d.detail)||void 0===s?void 0:s.asyncShaderCompile)&&void 0!==u&&u,v=null!==(c=null==d?void 0:d.detail.compressedTexture)&&void 0!==c?c:0,y={},x=!1,T=new Promise((function(t,e){g=window.setTimeout((function(){x=!0,S.removeTimer(g);var t=performance.now()-f;e("Load time out: totalTime: ".concat(t.toFixed(4),"ms ").concat(p.join(" "),", url: ").concat(h))}),1e3*S.timeout),S.timers.push(g)})),E=function(t,e){return n(S,void 0,void 0,(function(){var r,i,n,s;return o(this,(function(o){switch(o.label){case 0:if(x)return[3,4];r=performance.now(),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,e()];case 2:return i=o.sent(),n=performance.now()-r,p.push("[".concat(t,": ").concat(n.toFixed(2),"]")),y[t]=n,[2,i];case 3:throw s=o.sent(),new Error("load error in ".concat(t,", ").concat(s));case 4:throw new Error("load canceled.")}}))}))},b=function(){return n(S,void 0,void 0,(function(){var n,s,u,c,d,x,T,b,S,A,R,C,_,w,O,M,L,I,P,F=this;return o(this,(function(o){switch(o.label){case 0:return ir(t)?(l=t,this.baseUrl=location.href,[3,3]):[3,1];case 1:return t=new URL(t,location.href).href,this.baseUrl=t,[4,E("loadJSON",(function(){return F.loadJSON(t)}))];case 2:l=o.sent(),o.label=3;case 3:if(!wu(l))return[3,6];if(n=i({},l),!this.options||!this.options.variables||0===Object.keys(this.options.variables).length)return[3,5];for(s=l.jsonScene.images,u=n.images,d=0;d<s.length;d++)u[d]instanceof HTMLCanvasElement&&(u[d]=s[d]);return c=n,[4,E("processImages",(function(){return F.processImages(u,n.usedImages,v)}))];case 4:for(c.images=o.sent(),d=0;d<n.images.length;d++)n.textureOptions[d].image=n.images[d];n.jsonScene.compositions=this.updateSceneData(n.jsonScene.compositions),o.label=5;case 5:return[3,12];case 6:return[4,E("processJSON",(function(){return F.processJSON(l)}))];case 7:return x=o.sent(),T=x.usedImages,b=x.jsonScene,S=x.pluginSystem,A=b.bins,R=void 0===A?[]:A,C=b.images,_=b.compositions,w=b.fonts,[4,Promise.all([E("processBins",(function(){return F.processBins(R)})),E("processImages",(function(){return F.processImages(C,T,v)})),E("".concat(m?"async":"sync","Compile"),(function(){return F.precompile(_,S,e,r)}))])];case 8:return O=a.apply(void 0,[o.sent(),2]),M=O[0],L=O[1],[4,E("processFontURL",(function(){return F.processFontURL(w)}))];case 9:return o.sent(),[4,E("processTextures",(function(){return F.processTextures(L,M,b)}))];case 10:return I=o.sent(),b.compositions=this.updateSceneData(b.compositions),n={timeInfos:y,url:t,renderLevel:this.options.renderLevel,storage:{},pluginSystem:S,jsonScene:b,usedImages:T,images:L,textureOptions:I,bins:M},[4,E("processPlugins",(function(){return S.loadResources(n,F.options)}))];case 11:o.sent(),o.label=12;case 12:return P=performance.now()-f,Je.info("Load asset: totalTime: ".concat(P.toFixed(4),"ms ").concat(p.join(" "),", url: ").concat(h)),window.clearTimeout(g),this.removeTimer(g),n.totalTime=P,n.startTime=f,n.timeInfos=y,[2,n]}}))}))},[2,Promise.race([T,b()])]}))}))},e.prototype.precompile=function(t,e,r,i){return n(this,void 0,void 0,(function(){var n;return o(this,(function(o){switch(o.label){case 0:return r&&r.getShaderLibrary()?(n=null==r?void 0:r.getShaderLibrary(),[4,null==e?void 0:e.precompile(t,r,i)]):[2];case 1:return o.sent(),[4,new Promise((function(t){n.compileAllShaders((function(){t(null)}))}))];case 2:return o.sent(),[2]}}))}))},e.prototype.processJSON=function(t){return n(this,void 0,void 0,(function(){var e,r,i,n,s,a,u,c,l;return o(this,(function(o){switch(o.label){case 0:return e=vu(t),t.compositions.forEach((function(t,r){t.globalVolume&&(e.compositions[r].globalVolume=t.globalVolume)})),r=e.plugins,i=void 0===r?[]:r,n=e.compositions,s=e.imgUsage,a=e.images,[4,(u=new yr(i)).processRawJSON(e,this.options)];case 1:return o.sent(),c=this.options.renderLevel,l={},s?function(t,e,r,i,n){for(var o=0;o<e.length;o++){var s=r[e[o].id];if(s)for(var a=0;a<s.length;a++){var u=s[a];Ru(i[u].renderLevel,n)&&(t[u]=!0)}}}(l,n,s,a,c):null==a||a.forEach((function(t,e){l[e]=!0})),[2,{usedImages:l,jsonScene:e,pluginSystem:u}]}}))}))},e.prototype.processBins=function(t){return n(this,void 0,void 0,(function(){var e,r,i,n=this;return o(this,(function(o){return e=this.options.renderLevel,r=this.baseUrl,i=t.map((function(i){if(i instanceof ArrayBuffer)return i;if(Ru(i.renderLevel,e))return n.loadBins(new URL(i.url,r).href);throw new Error("Invalid bins source: ".concat(JSON.stringify(t)))})),[2,Promise.all(i)]}))}))},e.prototype.processFontURL=function(t){return n(this,void 0,void 0,(function(){var r,i=this;return o(this,(function(s){return t?(r=t.map((function(t){return n(i,void 0,void 0,(function(){var r,i,n;return o(this,(function(o){switch(o.label){case 0:if(!t.fontURL||e.fonts.has(t.fontFamily))return[3,4];Et(t.fontFamily)||console.warn("Risky font family: ".concat(t.fontFamily)),o.label=1;case 1:return o.trys.push([1,3,,4]),r=new URL(t.fontURL,this.baseUrl).href,[4,(i=new FontFace(null!==(n=t.fontFamily)&&void 0!==n?n:"","url("+r+")")).load()];case 2:return o.sent(),document.fonts.add(i),e.fonts.add(t.fontFamily),[3,4];case 3:return o.sent(),Je.warn("Invalid font family or font source: ".concat(JSON.stringify(t.fontURL))),[3,4];case 4:return[2]}}))}))})),[2,Promise.all(r)]):[2]}))}))},e.prototype.processImages=function(e,r,i){return n(this,void 0,void 0,(function(){var s,a,u,c,l,h=this;return o(this,(function(f){return s=this.options,a=s.useCompressedTexture,u=s.variables,c=this.baseUrl,l=e.map((function(e,s){return n(h,void 0,void 0,(function(){var n,l,h,f,p,d,m,v,y,g,x,T,E,b,S,A,R,C;return o(this,(function(o){switch(o.label){case 0:if(!r[s])return[2,void 0];if(n=e.url,l=e.webp,h=new URL(n,c).href,f=l&&new URL(l,c).href,!("template"in e))return[3,13];if(p=e.template,d="v"in p&&2===p.v&&p.background,m=d?p.background:void 0,!d||!m)return[3,8];v=Us(p,u),y=m.type===F.video,g=m&&y?Yr:Xr,o.label=1;case 1:return o.trys.push([1,6,,7]),[4,ks(v,g)];case 2:return(T=o.sent())instanceof HTMLVideoElement?[2,T]:[3,3];case 3:return m&&Array.isArray(v)&&u&&(u[m.name]=T.src),[4,Ys(T,p,u,this.options,-1===e.oriY)];case 4:return[2,o.sent()];case 5:return[3,7];case 6:throw x=o.sent(),new Error("Failed to load. Check the template or if the URL is ".concat(y?"video":"image"," type, URL: ").concat(v,", Error: ").concat(x.message));case 7:return[3,12];case 8:return o.trys.push([8,11,,12]),[4,Gr(h,f)];case 9:return[4,Ys((T=o.sent()).image,p,u,this.options,-1===e.oriY)];case 10:return[2,o.sent()];case 11:throw o.sent(),new Error("Failed to load. Check the template, URL: ".concat(h,"."));case 12:return[3,14];case 13:if("type"in e&&"video"===e.type)return console.warn("The video element is deprecated. Use template BackgroundType.video instead."),[2,Yr(e.url)];if("compressed"in e&&a&&i){if(E=e.compressed,b=void 0,i===En.ASTC?b=E.astc:i===En.PVRTC&&(b=E.pvrtc),b)return S=new URL(b,c).href,this.assets[s]={url:S,type:t.TextureSourceType.compressed},[2,this.loadBins(S)]}else{if("sourceType"in e)return[2,e];if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof qr)return[2,e]}o.label=14;case 14:return[4,Gr(h,f)];case 15:return A=o.sent(),R=A.url,C=A.image,this.assets[s]={url:R,type:t.TextureSourceType.image},[2,C]}}))}))})),[2,Promise.all(l)]}))}))},e.prototype.processTextures=function(e,r,s){var a;return n(this,void 0,void 0,(function(){var n,u,c=this;return o(this,(function(o){return n=null!==(a=s.textures)&&void 0!==a?a:e.map((function(t,e){return{source:e}})),u=n.map((function(n,o){if(n instanceof qr)return n;if("mipmaps"in n)try{return jr(n,r,s.bins)}catch(t){throw new Error("load texture ".concat(o," fails, error message: ").concat(t))}var a=n.source,u=e[a];if(u){var l=function(e,r){if(e instanceof qr)return e.source;if(e instanceof HTMLImageElement||function(t){var e;return"object"==typeof t&&null!==t&&"CANVAS"===(null===(e=t.tagName)||void 0===e?void 0:e.toUpperCase())}(e))return{image:e,sourceType:t.TextureSourceType.image,sourceFrom:r,keepImageSource:!0,minFilter:v.LINEAR,magFilter:v.LINEAR};if(e instanceof HTMLVideoElement)return{sourceType:t.TextureSourceType.video,video:e,minFilter:v.LINEAR,magFilter:v.LINEAR};if(e instanceof ArrayBuffer)return i(i({},Jr(e)),{sourceFrom:r});if("width"in e&&"height"in e&&"data"in e)return{sourceType:t.TextureSourceType.data,data:e,wrapS:v.CLAMP_TO_EDGE,wrapT:v.CLAMP_TO_EDGE,minFilter:v.NEAREST,magFilter:v.NEAREST};throw new Error("Invalid texture options")}(u,c.assets[o]);return l.sourceType===t.TextureSourceType.compressed?l:i(i({},l),n)}throw new Error("Invalid texture source: ".concat(a))})),[2,Promise.all(u)]}))}))},e.prototype.loadJSON=function(t){return n(this,void 0,void 0,(function(){var e=this;return o(this,(function(r){return[2,new Promise((function(r,i){e.downloader.downloadJSON(t,r,(function(e,r){i("Couldn't load JSON ".concat(JSON.stringify(t),": status ").concat(e,", ").concat(r))}))}))]}))}))},e.prototype.loadBins=function(t){return n(this,void 0,void 0,(function(){var e=this;return o(this,(function(r){return[2,new Promise((function(r,i){e.downloader.downloadBinary(t,r,(function(e,r){i("Couldn't load bins ".concat(JSON.stringify(t),": status ").concat(e,", ").concat(r))}))}))]}))}))},e.prototype.removeTimer=function(t){var e=this.timers.indexOf(t);-1!==e&&this.timers.splice(e,1)},e.prototype.dispose=function(){var t;for(var e in this.timers.length&&this.timers.map((function(t){return window.clearTimeout(t)})),this.assets){var r=this.assets[e];null===(t=null==r?void 0:r.dispose)||void 0===t||t.call(r)}this.assets={},this.timers=[]},e.fonts=new Set,e}(),Pu=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.items=[],t.itemTree=[],t.itemCacheMap=new Map,t.itemsToRemove=[],t.tempQueue=[],t}return r(n,e),Object.defineProperty(n.prototype,"type",{get:function(){return O.composition},enumerable:!1,configurable:!0}),n.prototype.onConstructed=function(t){var e=t.items,r=void 0===e?[]:e,i=t.startTime,n=void 0===i?0:i,o=t.content,s=t.refId;this.refId=s,this.itemProps=r,this.contentProps=o;var a=this.endBehavior;5!==a&&1!==a&&3!==a||(this.freezeOnEnd=!0),this.startTime=n,this.startTimeInms=Math.round(1e3*this.startTime)},n.prototype.createContent=function(){if(!this.items.length&&this.composition)for(var e=0;e<this.itemProps.length;e++){var r=void 0,o=this.itemProps[e];if(t.Item.isComposition(o)){var s=o.content.options.refId;(r=new n(i({refId:s},o),this.composition)).contentProps=o.content,r.transform.parentTransform=this.transform,this.composition.refContent.push(r),5===r.endBehavior&&(this.composition.autoRefTex=!1),r.createContent()}else(r=hr(this.itemProps[e],this.composition)).transform.parentTransform=lr.isCamera(r)?new cr:this.transform;lr.isExtraCamera(r)&&(this.extraCamera=r),this.items.push(r),this.tempQueue.push(r)}!this.content&&this.contentProps&&(this._content=this.doCreateContent())},n.prototype.doCreateContent=function(){var t=new Yn(this.contentProps,this);return t.renderData=t.getRenderData(0,!0),t},n.prototype.onLifetimeBegin=function(){var t;null===(t=this.items)||void 0===t||t.forEach((function(t){t.start(),t.createContent()})),this.buildItemTree()},n.prototype.doStop=function(){this.items&&this.items.forEach((function(t){return t.stop()}))},n.prototype.onItemUpdate=function(t,e){var r,i,n=this;if(this.content&&(this.content.updateTime(this.time),this.content.getRenderData(this.content.time)),this.items){null===(r=this.composition)||void 0===r||r.updatePluginLoaders(t);var o=[];this.itemsToRemove.length&&(this.itemsToRemove.forEach((function(t){var e,r,i=n.itemCacheMap.get(t.id);if(i){var o=i.children;if(i.parentId){var s=n.itemCacheMap.get(i.parentId);s?(s.children.splice(s.children.indexOf(i),1),o.forEach((function(t){return n.setItemParent(t.item,s.item)}))):(o.forEach((function(t){return n.setItemParent(t.item,void 0)})),(e=n.itemTree).push.apply(e,u([],a(o),!1)))}else(r=n.itemTree).splice.apply(r,u([n.itemTree.indexOf(i),1],a(o),!1)),o.forEach((function(t){return n.setItemParent(t.item,void 0)}));n.itemCacheMap.delete(t.id),n.items.splice(n.items.indexOf(t),1)}})),this.itemsToRemove.length=0);for(var s=0;s<this.itemTree.length;s++)if((l=this.itemTree[s])&&l.item){var c=l.item;lr.isComposition(c)&&c.ended&&5===c.endBehavior?c.restart():c.onUpdate(t),o.push.apply(o,u([],a(l.children),!1))}for(;o.length;){var l;(l=o.shift())&&l.item&&((c=l.item).onUpdate(t),o.push.apply(o,u([],a(l.children),!1)),c.composition||rt(this.itemsToRemove,c))}null===(i=this.extraCamera)||void 0===i||i.onUpdate(t)}},n.prototype.onItemRemoved=function(t){this.items&&(this.items.forEach((function(t){return t.dispose()})),this.items.length=0,this.itemTree.length=0,this.itemCacheMap.clear())},n.prototype.reset=function(){e.prototype.reset.call(this),this.itemTree=[],this.itemCacheMap.clear(),this.tempQueue.length=0,this.itemsToRemove.length=0},n.prototype.handleVisibleChanged=function(t){this.items.forEach((function(e){return e.setVisible(t)}))},n.prototype.setScale=function(t,e,r){this.content&&(this.content.startSize=new It(t,e,r))},n.prototype.scale=function(t,e,r){if(this.content){var i=this.content.startSize.clone();this.content.startSize=new It(t*i.x,e*i.y,r*i.z)}},n.prototype.getUpdateTime=function(t){var e=this.startTimeInms,r=this.timeInms;if(t<0&&r+t<e)return e-r;if(this.freezeOnEnd){var i=this.durInms-r;if(i<t)return i}return t},n.prototype.removeItem=function(t){var e,r=this;if(this.items.indexOf(t)>-1){if(rt(this.itemsToRemove,t),lr.isTree(t)||lr.isNull(t)){var i=6===t.endBehavior,n=lr.isNull(t)&&!!this.itemCacheMap.get(t.id);((null===(e=this.itemCacheMap.get(t.id))||void 0===e?void 0:e.children)||[]).forEach((function(t){n||r.setItemParent(t.item,void 0),i&&r.removeItem(t.item)}))}return!0}return this.items.forEach((function(e){if(lr.isComposition(e)&&e.items.indexOf(t)>-1)return e.removeItem(t),!0})),!1},n.prototype.setItemParent=function(t,e){var r=this.itemCacheMap.get(t.id);if(r)if(e){var i=this.itemCacheMap.get(e.id);if(r.parentId){var n=this.itemCacheMap.get(r.parentId);n.children.splice(n.children.indexOf(r),1)}t.parent=e,r.parentId=e.id,i.children.push(r),t.transform.parentTransform=e.transform}else r.parentId=void 0,t.parent=void 0,t.transform.parentTransform=lr.isExtraCamera(t)?new cr:this.transform;else console.error("item has been remove, please set item's parent in valid lifetime")},n.prototype.getItemCurrentParent=function(t){var e=t.id,r=this.itemCacheMap.get(e);if(r){var i=r.parentId;if(i){var n=this.itemCacheMap.get(i);return i&&n?n.item:void 0}}},n.prototype.getItemByName=function(t){var e,r,i=[];try{for(var n=s(this.items),o=n.next();!o.done;o=n.next()){var c=o.value;c.name===t?i.push(c):lr.isComposition(c)&&i.push.apply(i,u([],a(c.getItemByName(t)),!1))}}catch(t){e={error:t}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}return i},n.prototype.hitTest=function(e,r,i,n,o,s){for(var a=[],u=(null==s?void 0:s.stop)||$e,c=(null==s?void 0:s.skip)||$e,l=(null==s?void 0:s.maxCount)||this.items.length,h=0;h<this.items.length&&n.length<l;h++){var f=this.items[h];if(f.lifetime>=0&&f.lifetime<=1&&!lr.isComposition(f)&&!c(f)){var p=f.getHitTestParams(o);if(p){var d=!1,m=new It;if(p.type===t.HitTestType.triangle)for(var v=p.triangles,y=p.backfaceCulling,g=0;g<v.length;g++){var x=v[g];if(e.intersectTriangle(x,m,y)){d=!0,a.push(m);break}}else if(p.type===t.HitTestType.box){var T=p.center,E=p.size,b=T.clone().addScaledVector(E,.5),S=T.clone().addScaledVector(E,-.5);e.intersectBox({min:b,max:S},m)&&(d=!0,a.push(m))}else if(p.type===t.HitTestType.sphere){T=p.center;var A=p.radius;e.intersectSphere({center:T,radius:A},m)&&(d=!0,a.push(m))}else if(p.type===t.HitTestType.custom){var R=p.collect(e,new Lt(r,i));R&&R.length>0&&(R.forEach((function(t){a.push(t)})),d=!0)}if(d){var C={compContent:this,id:f.id,name:f.name,position:a[a.length-1],parentId:f.parentId,hitPositions:a,behavior:p.behavior};if(n.push(C),u(C))return n}}}}return n},n.prototype.isEnded=function(t){return t>=this.durInms},n.prototype.buildItemTree=function(){if(!this.itemTree.length&&this.composition){this.itemTree=[];for(var t=this.itemCacheMap,e=this.tempQueue,r=function(){var r=e.shift();if(void 0===r.parentId){var n={id:r.id,item:r,children:[]};i.itemTree.push(n),t.set(r.id,n)}else{var o=i.getParentIdWithoutSuffix(r.parentId),s=t.get(o);if(s)n={id:r.id,parentId:o,item:r,children:[]},r.parent=s.item,r.transform.parentTransform=s.item.getNodeTransform(r.parentId),s.children.push(n),t.set(r.id,n);else{if(-1===i.items.findIndex((function(t){return t.id===o})))throw Error("---");e.push(r)}}},i=this;e.length;)r()}},n.prototype.getParentIdWithoutSuffix=function(t){var e=t.lastIndexOf("^");return e>-1?t.substring(0,e):t},n.prototype.restart=function(){this.reset(),this.createContent(),this.start()},n}(lr),Fu=1,Vu=function(){function e(t,e){var r,n;this.speed=1,this.loaderData={},this.refContent=[],this.refCompositionProps=new Map,this.assigned=!1,this.destroyed=!1,this.paused=!1,this.lastVideoUpdateTime=0,this.postLoaders=[];var o=t.reusable,s=void 0!==o&&o,a=t.speed,u=void 0===a?1:a,c=t.baseRenderOrder,l=void 0===c?0:c,h=t.renderer,f=t.onPlayerPause,p=t.onMessageItem,d=t.onEnd,m=t.event,v=t.width,y=t.height;this.compositionSourceManager=new _u(e,h.engine),e.jsonScene.imgUsage=void 0,s&&(this.keepResource=!0,e.textures=void 0,e.consumed=!0);var g=this.compositionSourceManager,x=g.sourceContent,T=g.pluginSystem,E=g.imgUsage,b=g.totalTime,S=g.renderLevel,A=g.refCompositionProps;Tt(x),this.refCompositionProps=A;var R=new Pu(x,this),C=!s&&E;this.transform=new cr({name:this.name}),R.transform=this.transform,this.globalVolume=x.globalVolume,this.width=v,this.height=y,this.renderOrder=l,this.id=Fu++,this.renderer=h,this.texInfo=null!=C?C:{},this.event=m,this.statistic={loadTime:null!=b?b:0,loadStart:null!==(r=e.startTime)&&void 0!==r?r:0,firstFrameTime:0,precompileTime:null!==(n=e.timeInfos.asyncCompile)&&void 0!==n?n:e.timeInfos.syncCompile},this.reusable=s,this.speed=u,this.renderLevel=S,this.autoRefTex=!this.keepResource&&C&&5!==R.endBehavior,this.content=R,this.name=R.name,this.pluginSystem=T,this.pluginSystem.initializeComposition(this,e),this.camera=new ga(this.name,i(i({},null==x?void 0:x.camera),{aspect:v/y})),this.url=e.url,this.assigned=!0,this.interactive=!0,this.onPlayerPause=f,this.onMessageItem=p,this.onEnd=d,this.createRenderFrame(),this.reset()}return Object.defineProperty(e.prototype,"handleEnd",{set:function(t){console.warn("The handleEnd property is deprecated. Use onEnd instead."),this.onEnd=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textures",{get:function(){return this.compositionSourceManager.textures},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"items",{get:function(){return this.content.items},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"startTime",{get:function(){var t;return null!==(t=this.content.startTime)&&void 0!==t?t:0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"time",{get:function(){return this.content.timeInms/1e3},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),e.prototype.getDuration=function(){return this.content.duration},e.prototype.restart=function(){this.content.reset(),this.prepareRender(),this.reset(),this.transform.setValid(!0),this.content.start(),this.forwardTime(this.startTime),this.content.onUpdate(0),this.loaderData.spriteGroup.onUpdate(0)},e.prototype.setIndex=function(t){this.renderOrder=t},e.prototype.getIndex=function(){return this.renderOrder},e.prototype.setSpeed=function(t){this.speed=t},e.prototype.getSpeed=function(){return this.speed},e.prototype.play=function(){this.content.ended&&this.reusable&&this.restart(),this.content.started?this.gotoAndPlay(this.time-this.startTime):this.gotoAndPlay(0)},e.prototype.pause=function(){this.paused=!0},e.prototype.resume=function(){this.paused=!1},e.prototype.gotoAndPlay=function(t){this.resume(),this.content.started||this.content.start(),this.forwardTime(t+this.startTime)},e.prototype.gotoAndStop=function(t){this.gotoAndPlay(t),this.pause()},e.prototype.createRenderFrame=function(){this.renderFrame=new hn({camera:this.camera,renderer:this.renderer,keepColorBuffer:this.keepColorBuffer,globalVolume:this.globalVolume}),this.renderFrame.cachedTextures=this.textures},e.prototype.setTime=function(t){var e=this.paused;e&&this.resume(),this.content.started||this.content.start(),this.forwardTime(t+this.startTime,!0),e&&this.pause()},e.prototype.forwardTime=function(t,e){void 0===e&&(e=!1);for(var r=1e3*t-this.content.timeInms,i=r<0,n=Math.abs(r),o=i?-15:15;n>15;n-=15)this.update(o,e);this.update(i?-n:n,e)},e.prototype.reset=function(){var t=this;this.rendererOptions=null,this.pluginSystem.plugins.forEach((function(e){return e.onCompositionWillReset(t,t.renderFrame)})),this.content.createContent(),this.content.onEnd=function(){window.setTimeout((function(){var e;null===(e=t.onEnd)||void 0===e||e.call(t,t)}),0)},this.pluginSystem.resetComposition(this,this.renderFrame)},e.prototype.prepareRender=function(){var t=this,e=this.renderFrame;this.postLoaders.length=0,this.pluginSystem.plugins.forEach((function(r){r.prepareRenderFrame(t,e)&&t.postLoaders.push(r)})),this.postLoaders.forEach((function(r){return r.postProcessFrame(t,e)}))},e.prototype.shouldRestart=function(){var t=this.content,e=t.ended,r=t.endBehavior;return e&&5===r},e.prototype.shouldDispose=function(){if(this.reusable)return!1;var t=this.content,e=t.ended,r=t.endBehavior;return e&&(!r||3===r)},e.prototype.update=function(t,e){if(void 0===e&&(e=!1),this.assigned&&!this.paused){this.shouldRestart()&&this.restart();var r=this.content.getUpdateTime(t*this.speed);this.updateVideo(),this.content.onUpdate(r),this.loaderData.spriteGroup.onUpdate(r),this.updateCamera(),this.shouldDispose()?this.dispose():e||this.prepareRender()}},e.prototype.updateVideo=function(){var t,e=performance.now();e-this.lastVideoUpdateTime>33&&((null!==(t=this.textures)&&void 0!==t?t:[]).forEach((function(t){return null==t?void 0:t.uploadCurrentVideoFrame()})),this.lastVideoUpdateTime=e)},e.prototype.updateCamera=function(){this.camera.updateMatrix()},e.prototype.updatePluginLoaders=function(t){var e=this;this.pluginSystem.plugins.forEach((function(r){return r.onCompositionUpdate(e,t)}))},e.prototype.getItemByName=function(t,e){if(this.content&&this.content.items)return this.content.getItemByName(t)[0]},e.prototype.getItemByID=function(t){return this.content&&this.content.items&&this.content.itemCacheMap.has(t)?this.content.itemCacheMap.get(t).item:null},e.prototype.getItemCurrentParent=function(t){return this.content.getItemCurrentParent(t)},e.prototype.itemLifetimeEvent=function(t,e){var r=this,i=e?function(e){return e.onCompositionItemLifeBegin(r,t)}:function(e){return e.onCompositionItemLifeEnd(r,t)};this.pluginSystem.plugins.forEach(i)},e.prototype.getHitTestRay=function(t,e){var r=this.renderFrame.editorTransform,i=r.x,n=r.y;return ce((t-r.z)/i,(e-r.w)/n,this.camera)},e.prototype.getEngine=function(){var t;return null===(t=this.renderer)||void 0===t?void 0:t.engine},e.prototype.hitTest=function(t,e,r,i){if(this.isDestroyed||!this.interactive)return[];var n=[],o=this.getHitTestRay(t,e);return this.content.hitTest(o,t,e,n,r,i),this.refContent.forEach((function(s){s.hitTest(o,t,e,n,r,i)})),n},e.prototype.addInteractiveItem=function(t,e){var r;if(e===_.MESSAGE)return null===(r=this.onMessageItem)||void 0===r||r.call(this,{name:t.name,phrase:2,id:t.id,compositionId:this.id}),t.id},e.prototype.removeInteractiveItem=function(t,e){var r;e===_.MESSAGE&&(null===(r=this.onMessageItem)||void 0===r||r.call(this,{name:t.name,phrase:1,id:t.id,compositionId:this.id}))},e.prototype.destroyTextures=function(e){for(var r,i=0;i<e.length;i++){var n=e[i];n&&(n.sourceType!==t.TextureSourceType.data||this.texInfo[n.id]?this.autoRefTex&&(--this.texInfo[n.id]||n.dispose()):n!==(null===(r=this.rendererOptions)||void 0===r?void 0:r.emptyTexture)&&n!==this.renderFrame.transparentTexture&&n.dispose())}},e.prototype.destroyItem=function(t){var e=this;t.type==O.composition?4!==t.endBehavior&&t.items.forEach((function(t){return e.pluginSystem.plugins.forEach((function(r){return r.onCompositionItemRemoved(e,t)}))})):(this.content.removeItem(t),this.refContent.forEach((function(e){return e.removeItem(t)})),this.pluginSystem.plugins.forEach((function(r){return r.onCompositionItemRemoved(e,t)})))},e.prototype.lost=function(t){this.videoState=this.textures.map((function(t){if("video"in t.source)return t.source.video.pause(),t.source.video.currentTime})),this.textures.map((function(t){return t.dispose()})),this.dispose()},e.prototype.dispose=function(){var t,e,r=this;if(!this.destroyed){this.destroyed=!0;var i={},n=this.textures;n&&(this.keepResource?n.forEach((function(t){(null==t?void 0:t.dispose)&&(i[t.id]=t.dispose,t.dispose=$e)})):n.forEach((function(t){return t&&t.dispose()}))),this.content.dispose(),this.renderFrame.dispose(),null===(t=this.rendererOptions)||void 0===t||t.emptyTexture.dispose(),null===(e=this.pluginSystem)||void 0===e||e.destroyComposition(this),this.update=function(){Je.error("Update disposed composition: ".concat(r.name,"."))},this.onPlayerPause=$e,this.dispose=$e,n&&this.keepResource&&n.forEach((function(t){return t.dispose=i[t.id]})),this.compositionSourceManager.dispose(),this.refCompositionProps.clear()}},e.prototype.setEditorTransform=function(t,e,r){this.renderFrame.editorTransform.set(t,t,e,r)},e.prototype.translateByPixel=function(t,e){this.renderer?this.content.translateByPixel(t,e):console.warn("Can not translate position when container not assigned")},e.prototype.translate=function(t,e,r){this.content.translate(t,e,r)},e.prototype.setPosition=function(t,e,r){this.content.setPosition(t,e,r)},e.prototype.rotate=function(t,e,r){this.content.rotate(t,e,r)},e.prototype.setRotation=function(t,e,r){this.content.setRotation(t,e,r)},e.prototype.scale=function(t,e,r){this.content.scale(t,e,r)},e.prototype.setScale=function(t,e,r){this.content.setScale(t,e,r)},e.prototype.offloadTexture=function(){this.textureOffloaded||(this.textures.forEach((function(t){return t&&t.offloadData()})),this.textureOffloaded=!0)},e.prototype.getRendererOptions=function(){return this.rendererOptions||(this.rendererOptions={emptyTexture:this.renderFrame.emptyTexture,cachePrefix:"-"}),this.rendererOptions},e.prototype.reloadTexture=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.textureOffloaded?[4,Promise.all(this.textures.map((function(t){return null==t?void 0:t.reloadData()})))]:[3,2];case 1:t.sent(),this.textureOffloaded=!1,t.label=2;case 2:return[2]}}))}))},e}(),Nu=function(){function t(){this.destroyed=!1,this.textures=[],this.materials=[],this.geometries=[],this.meshes=[],this.renderPasses=[],this.renderErrors=new Set}return t.prototype.addTexture=function(t){this.destroyed||rt(this.textures,t)},t.prototype.removeTexture=function(t){this.destroyed||it(this.textures,t)},t.prototype.addMaterial=function(t){this.destroyed||rt(this.materials,t)},t.prototype.removeMaterial=function(t){this.destroyed||it(this.materials,t)},t.prototype.addGeometry=function(t){this.destroyed||rt(this.geometries,t)},t.prototype.removeGeometry=function(t){this.destroyed||it(this.geometries,t)},t.prototype.addMesh=function(t){this.destroyed||rt(this.meshes,t)},t.prototype.removeMesh=function(t){this.destroyed||it(this.meshes,t)},t.prototype.addRenderPass=function(t){this.destroyed||rt(this.renderPasses,t)},t.prototype.removeRenderPass=function(t){this.destroyed||it(this.renderPasses,t)},Object.defineProperty(t.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),t.prototype.getShaderLibrary=function(){return this.renderer.getShaderLibrary()},t.prototype.dispose=function(){if(!this.destroyed){this.destroyed=!0;var t=[];this.renderPasses.length>0&&t.push("Pass ".concat(this.renderPasses.length)),this.meshes.length>0&&t.push("Mesh ".concat(this.meshes.length)),this.geometries.length>0&&t.push("Geom ".concat(this.geometries.length)),this.textures.length>0&&t.push("Tex ".concat(this.textures.length)),t.length>0&&Je.warn("Release GPU memory: ".concat(t.join(", "))),this.renderPasses.forEach((function(t){t.dispose()})),this.meshes.forEach((function(t){t.dispose()})),this.geometries.forEach((function(t){t.dispose()})),this.materials.forEach((function(t){t.dispose()})),this.textures.forEach((function(t){t.dispose()})),this.textures=[],this.materials=[],this.geometries=[],this.meshes=[],this.renderPasses=[],this.renderer=null}},t}(),Du=function(){function t(t){void 0===t&&(t=60),this.paused=!0,this.lastTime=0,this.setFPS(t),this.tickers=[]}return t.prototype.getFPS=function(){return this.targetFPS},t.prototype.setFPS=function(t){this.targetFPS=Ot(t,1,120),this.interval=Math.floor(1e3/t)-2},t.prototype.getPaused=function(){return this.paused},t.prototype.start=function(){var t=this;if(this.paused=!1,!this.intervalId){this.lastTime=performance.now();var e=requestAnimationFrame||function(t){return window.setTimeout(t,16.7)},r=function(){t.intervalId=e(r),t.paused||t.tick()};r()}},t.prototype.stop=function(){(cancelAnimationFrame||window.clearTimeout)(this.intervalId),this.intervalId=0,this.lastTime=0,this.paused=!0,this.tickers=[]},t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1},t.prototype.tick=function(){if(!this.paused){var t=performance.now(),e=t-this.lastTime;if(e>=this.interval){this.lastTime=t,this.resetTickers&&(this.tickers=this.tickers.filter((function(t){return t})),this.resetTickers=!1);for(var r=0,i=this.tickers.length;r<i;r++)(0,this.tickers[r])(e)}}},t.prototype.add=function(t){if("function"!=typeof t)throw new Error("Ticker: The tick object must implement the tick method.");this.tickers.push(t)},t}();mr("camera",Er,br,!0),mr("sprite",Gn,qn,!0),mr("particle",bs,ds,!0),mr("cal",Ss,As,!0),mr("interact",On,_n,!0),mr("filter",Gn,Qn,!0),mr("text",qs,Zs,!0),$(xa);var zu=((Ou={})[v.RGBA]=34842,Ou[v.RGB]=34843,Ou[v.ALPHA]=33325,Ou[v.RED]=33325,Ou[v.LUMINANCE_ALPHA]=33327,Ou[v.LUMINANCE]=33325,Ou),Bu=((Mu={})[v.RGBA]=34836,Mu[v.RGB]=34837,Mu[v.ALPHA]=33326,Mu[v.RED]=33326,Mu[v.LUMINANCE_ALPHA]=33328,Mu[v.LUMINANCE]=33326,Mu),Uu=function(e){function s(t,r){var i=e.call(this)||this;i.initialized=!1;var n=i.assembleOptions(r),o=n.sourceType,s=n.sourceFrom,a=n.name,u=void 0===a?"":a;return i.source=n,i.sourceType=o,i.sourceFrom=s,i.name=u,i.engine=t,i}return r(s,e),s.prototype.bind=function(t){this.pipelineContext.bindTexture(this.target,this.textureBuffer,t)},s.prototype.initialize=function(){if(!this.initialized){var t=this.engine;t.addTexture(this);var e=t.getGLPipelineContext();this.pipelineContext=e;var r=e.gl,i=this.source,n=i.target,o=void 0===n?r.TEXTURE_2D:n,s=i.name;this.textureBuffer=r.createTexture(),this.textureBuffer&&ju(this.textureBuffer,s),this.target=o,this.update(this.source),this.release(),this.initialized=!0}},s.prototype.clone=function(){var t=new s(this.engine,this.source);return t.sourceFrom=this.sourceFrom,t.sourceType=this.sourceType,t.width=this.width,t.height=this.height,t},s.prototype.release=function(){switch(this.source.sourceType){case t.TextureSourceType.image:delete this.source.image,delete this.source.cube;break;case t.TextureSourceType.data:delete this.source.data;break;case t.TextureSourceType.compressed:case t.TextureSourceType.mipmaps:delete this.source.mipmaps}},s.prototype.update=function(e){var r,i,n,o,s=this;if(!this.pipelineContext||!this.textureBuffer)return this.width=0,void(this.height=0);var u=this.target,c=this.source,l=this.pipelineContext.gl,h=this.engine.gpuCapability.detail,f=c.sourceType,p=c.data,d=c.cube,m=c.image,y=c.video,x=c.mipmaps,T=c.mipmaps,E=e.data,b=e.cube,S=e.generateMipmap,A=e.mipmaps,R=c,C=R.format,_=R.type,w=R.internalFormat,O=0,M=0;if(this.bind(f===t.TextureSourceType.video),_===v.HALF_FLOAT?((_=h.halfFloatTexture)||Je.error("Half float texture is not support."),g(l)&&w===C&&(C===v.LUMINANCE&&(C=v.RED),w=zu[C]),h.halfFloatLinear||(c.minFilter=c.magFilter=l.NEAREST,Je.warn("Half float linear not support, change to NEAREST."))):_===l.FLOAT&&((_=h.floatTexture)||Je.error("Float texture is not support."),g(l)&&w===C&&(C===v.LUMINANCE&&(C=v.RED),w=Bu[C]),h.floatLinear||(c.minFilter=l.NEAREST,c.magFilter=l.NEAREST,Je.warn("Float linear not support, change to NEAREST."))),void 0===c.premultiplyAlpha&&(c.premultiplyAlpha=!1),l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,c.premultiplyAlpha),void 0===c.flipY&&(c.flipY=!1),l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,c.flipY),f===t.TextureSourceType.framebuffer)E&&(O=null!==(n=E.width)&&void 0!==n?n:0,M=null!==(o=E.height)&&void 0!==o?o:0,O&&M&&(this.width!==O||this.height!==M)&&l.texImage2D(u,0,w,O,M,0,C,_,null));else if(f===t.TextureSourceType.data)u===l.TEXTURE_CUBE_MAP?b.forEach((function(t,e){var r=a(s.texImage2DData(l,l.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,w,C,_,t),2),i=r[0],n=r[1];O=Math.max(i,O),M=Math.max(n,M)})):(r=a(this.texImage2DData(l,u,0,w,C,_,p),2),O=r[0],M=r[1]);else if(f===t.TextureSourceType.image||f===t.TextureSourceType.video){if(u===l.TEXTURE_CUBE_MAP)d.forEach((function(t,e){var r=a(s.texImage2D(l,l.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,w,C,_,t),2),i=r[0],n=r[1];O=Math.max(i,O),M=Math.max(n,M)}));else if(u===l.TEXTURE_2D){var L=null!=m?m:y;i=a(this.texImage2D(l,u,0,w,C,_,L),2),O=i[0],M=i[1]}S&&(ku(O)&&ku(M)||g(l))&&l.generateMipmap(u)}else if(f===t.TextureSourceType.mipmaps){var I;u===l.TEXTURE_2D?x.forEach((function(t,e){var r;I="data"in t?s.texImage2DData(l,u,e,w,C,_,t):s.texImage2D(l,u,e,w,C,_,t),0===e&&(r=a(I,2),O=r[0],M=r[1])})):u===l.TEXTURE_CUBE_MAP&&T.forEach((function(t,e){t.forEach((function(t,r){var i;I="data"in t?s.texImage2DData(l,l.TEXTURE_CUBE_MAP_POSITIVE_X+r,e,w,C,_,t):s.texImage2D(l,l.TEXTURE_CUBE_MAP_POSITIVE_X+r,e,w,C,_,t),0===e&&(i=a(I,2),O=i[0],M=i[1])}))}))}else f===t.TextureSourceType.compressed&&A&&(O=A[0].width,M=A[0].height,A.forEach((function(t,e){l.compressedTexImage2D(u,e,w,t.width,t.height,0,t.data)})));this.width=O,this.height=M,this.setTextureFilters(l,u,c)},s.prototype.setTextureFilters=function(t,e,r){var i=r.anisotropic,n=void 0===i?4:i,o=r.wrapS,s=void 0===o?t.CLAMP_TO_EDGE:o,a=r.wrapT,u=void 0===a?t.CLAMP_TO_EDGE:a,c=this.engine.gpuCapability;this.target===t.TEXTURE_2D&&c.setTextureAnisotropic(t,this.target,n);var l=g(t)||ku(this.width)&&ku(this.height),h=r.minFilter?r.minFilter:t.NEAREST,f=r.magFilter?r.magFilter:t.NEAREST;t.texParameteri(e,t.TEXTURE_MIN_FILTER,h),t.texParameteri(e,t.TEXTURE_MAG_FILTER,f),t.texParameteri(e,t.TEXTURE_WRAP_S,l?s:t.CLAMP_TO_EDGE),t.texParameteri(e,t.TEXTURE_WRAP_T,l?u:t.CLAMP_TO_EDGE)},s.prototype.texImage2D=function(e,r,i,n,o,s,a){var u,c=this,l=this.source,h=l.sourceType,f=l.minFilter,p=l.magFilter;l.flipY;var d=l.wrapS,m=l.wrapT,v=null!==(u=this.engine.gpuCapability.detail.maxTextureSize)&&void 0!==u?u:2048,y=a;if(h!==t.TextureSourceType.video){var g=f!==e.NEAREST||p!==e.NEAREST||d!==e.CLAMP_TO_EDGE||m!==e.CLAMP_TO_EDGE;(g=g||a.width>v||a.height>v)&&setTimeout((function(){y=c.resizeImage(a)}))}e.texImage2D(r,i,n,o,s,y);var x=[y.width,y.height];if(h===t.TextureSourceType.video){var T=a;return[T.videoWidth,T.videoHeight]}return x},s.prototype.texImage2DData=function(t,e,r,i,n,o,s){var a=s.data,u=s.width,c=s.height,l=n===t.UNSIGNED_BYTE?new Uint8Array(a.buffer,a.byteOffset,a.byteLength/a.BYTES_PER_ELEMENT):a;return t.texImage2D(e,r,i,u,c,0,n,o,l),[u,c]},s.prototype.resizeImage=function(t,e,r){var i,n=null!==(i=this.engine.gpuCapability.detail.maxTextureSize)&&void 0!==i?i:2048;if(g(this.pipelineContext.gl)&&t.width<n&&t.height<n)return t;var o=function(t,e,r,i){var n=t.width,o=t.height,s=Math.min(e,r||ue(n)),a=Math.min(e,i||ue(o));if(a!==o||s!==n){var u=Bs.getCanvas(),c=u.getContext("2d");return u.width=s,u.height=a,null==c||c.drawImage(t,0,0,n,o,0,0,s,a),Je.warn("Image resize from ".concat(n,"x").concat(o," to ").concat(s,"x").concat(a)),u}}(t,n,e,r);return o||t},s.prototype.reloadData=function(){return n(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.offloaded?[4,ei().reload(this)]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))},s.prototype.offloadData=function(){if(this.initialized&&ei().canOffloadTexture(this.source.sourceFrom)){var t=this.target,e=this.pipelineContext.gl;if(e&&this.textureBuffer){var r=new Uint8Array([255]);if(this.bind(),t===e.TEXTURE_2D)e.texImage2D(t,0,e.LUMINANCE,1,1,0,e.LUMINANCE,e.UNSIGNED_BYTE,r);else if(t===e.TEXTURE_CUBE_MAP)for(var i=[e.TEXTURE_CUBE_MAP_NEGATIVE_X,e.TEXTURE_CUBE_MAP_NEGATIVE_Y,e.TEXTURE_CUBE_MAP_NEGATIVE_Z,e.TEXTURE_CUBE_MAP_POSITIVE_X,e.TEXTURE_CUBE_MAP_POSITIVE_Y,e.TEXTURE_CUBE_MAP_POSITIVE_Z],n=0;n<i.length;n++)e.texImage2D(i[n],0,e.LUMINANCE,1,1,0,e.LUMINANCE,e.UNSIGNED_BYTE,r);e.generateMipmap(t),this.width=1,this.height=1}this.offloaded=!0}},s.prototype.uploadCurrentVideoFrame=function(){return n(this,void 0,void 0,(function(){var e;return o(this,(function(r){switch(r.label){case 0:return this.source.sourceType===t.TextureSourceType.video&&this.source.video&&this.initialized?(e=this.source.video).paused?[4,e.play()]:[3,2]:[3,3];case 1:r.sent(),r.label=2;case 2:return this.update({video:this.source.video}),[2,!0];case 3:return[2,!1]}}))}))},s.prototype.updateSource=function(t){this.source=this.assembleOptions(i(i({},this.source),t)),this.sourceType=this.source.sourceType,this.sourceFrom=this.source.sourceFrom,this.update(this.source)},s.prototype.restore=function(){},s.prototype.dispose=function(){this.pipelineContext&&this.textureBuffer&&this.pipelineContext.gl.deleteTexture(this.textureBuffer),this.source.sourceType===t.TextureSourceType.video&&this.source.video&&this.initialized&&(this.source.video.pause(),this.source.video.src="",this.source.video.load()),this.width=0,this.height=0,this.textureBuffer=null,this.destroyed=!0,this.update=function(){Je.error("This texture has been destroyed.")},this.initialize=or,void 0!==this.engine&&this.engine.removeTexture(this)},s}(qr);function ku(t){return 0==(t&t-1)&&0!==t}var Gu,Xu=function(){function t(t,e){this.engine=t,this.ready=!1,this.disposed=!1,this.gl=t.getGLPipelineContext().gl,this.vaoExt=t.gpuCapability.vaoExt,this.vao=this.createVertexArray(e)}return t.prototype.bind=function(){this.bindVertexArray(this.vao)},t.prototype.unbind=function(){this.bindVertexArray(null)},t.prototype.createVertexArray=function(t){var e=null;return g(this.gl)&&(e=this.gl.createVertexArray()),!e&&this.vaoExt&&(e=this.vaoExt.createVertexArrayOES()),e&&ju(e,t),e},t.prototype.bindVertexArray=function(t){var e;g(this.gl)?this.gl.bindVertexArray(t):null===(e=this.vaoExt)||void 0===e||e.bindVertexArrayOES(t)},t.prototype.dispose=function(){var t;g(this.gl)?this.gl.deleteVertexArray(this.vao):null===(t=this.vaoExt)||void 0===t||t.deleteVertexArrayOES(this.vao)},t}(),Hu=1,Yu=function(){function e(e){this.engine=e,this.textures=[],this.renderBuffers=[],this.frameBuffers=[],this.destroyed=!1;var r={width:1,height:1,data:new Uint8Array([255])},i=e.getGLPipelineContext(),n=i.gl;this.gl=n,this.pipelineContext=i,this.emptyTexture2D=new Uu(e,{data:r,sourceType:t.TextureSourceType.data,format:n.LUMINANCE,internalFormat:n.LUMINANCE,type:n.UNSIGNED_BYTE}),this.emptyTexture2D.initialize(),this.emptyTextureCube=new Uu(e,{target:n.TEXTURE_CUBE_MAP,cube:[r,r,r,r,r,r],sourceType:t.TextureSourceType.data,format:n.LUMINANCE,internalFormat:n.LUMINANCE,type:n.UNSIGNED_BYTE}),this.emptyTextureCube.initialize(),this.name="GLGPURenderer"+Hu,Hu++}return Object.defineProperty(e.prototype,"height",{get:function(){var t;return null===(t=this.gl)||void 0===t?void 0:t.drawingBufferHeight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){var t;return null===(t=this.gl)||void 0===t?void 0:t.drawingBufferWidth},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"canvas",{get:function(){return this.gl.canvas},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),e.prototype.copy2=function(t,e){var r=this.gl;if(r){this.sourceFbo||(this.sourceFbo=r.createFramebuffer()),this.targetFbo||(this.targetFbo=r.createFramebuffer());var i=this.pipelineContext,n=r.COLOR_ATTACHMENT0;i.bindFramebuffer(r.FRAMEBUFFER,this.sourceFbo),r.framebufferTexture2D(r.FRAMEBUFFER,n,r.TEXTURE_2D,t.textureBuffer,0),i.bindFramebuffer(r.FRAMEBUFFER,this.targetFbo),r.framebufferTexture2D(r.FRAMEBUFFER,n,r.TEXTURE_2D,e.textureBuffer,0),i.bindFramebuffer(r.READ_FRAMEBUFFER,this.sourceFbo),i.bindFramebuffer(r.DRAW_FRAMEBUFFER,this.targetFbo);var o=t.getWidth()===t.getHeight()&&e.getWidth()==e.getHeight()?r.NEAREST:r.LINEAR;r.blitFramebuffer(0,0,t.getWidth(),t.getHeight(),0,0,e.getWidth(),e.getHeight(),r.COLOR_BUFFER_BIT,o),i.bindFramebuffer(r.FRAMEBUFFER,null),i.bindFramebuffer(r.READ_FRAMEBUFFER,null),i.bindFramebuffer(r.DRAW_FRAMEBUFFER,null)}},e.prototype.resetColorAttachments=function(t,e){t.bind(),t.resetColorTextures(e)},e.prototype.createGLRenderBuffer=function(t){var e=this.gl.createRenderbuffer();return e&&rt(this.renderBuffers,t),e},e.prototype.resize=function(t,e){var r=this.gl;(r&&r.drawingBufferWidth!==t||r.drawingBufferHeight!==e)&&(r.canvas.width=t,r.canvas.height=e,r.viewport(0,0,t,e),this.frameBuffers.forEach((function(r){var i=r.viewport;r.isCustomViewport||r.resize(i[0],i[1],t*r.viewportScale,e*r.viewportScale)})))},e.prototype.drawGeometry=function(t,e){if(this.gl){var r=t,i=e.shader.program;if(i){var n=i.setupAttributes(r),o=this.gl,s=r.indicesBuffer,a=r.drawStart,u=r.mode,c=r.drawCount;if(s){var l=s.type,h=s.elementCount;(c=isNaN(c)?h:c)>0&&o.drawElements(u,c,l,null!=a?a:0)}else c>0&&o.drawArrays(u,a,c);null==n||n.unbind()}}else console.warn("GLGPURenderer is not bound to a gl object and cannot draw geometry")},e.prototype.createGLFrameBuffer=function(t,e){var r=this.gl.createFramebuffer();return r&&(rt(this.frameBuffers,t),ju(r,e,e)),r},e.prototype.createVAO=function(t){return new Xu(this.engine,t)},e.prototype.deleteGLTexture=function(t){t.textureBuffer&&!this.destroyed&&(this.gl.deleteTexture(t.textureBuffer),it(this.textures,t),delete t.textureBuffer)},e.prototype.deleteGPUBuffer=function(t){t&&!this.destroyed&&(this.gl.deleteBuffer(t.glBuffer),delete t.glBuffer)},e.prototype.deleteGLFrameBuffer=function(t){t&&!this.destroyed&&(this.gl.deleteFramebuffer(t.fbo),it(this.frameBuffers,t),delete t.fbo)},e.prototype.deleteGLRenderBuffer=function(t){t&&!this.destroyed&&(this.gl.deleteRenderbuffer(t.buffer),it(this.renderBuffers,t),delete t.buffer)},e.prototype.deleteResource=function(){var t=this,e=this.gl;e&&(e.deleteFramebuffer(this.sourceFbo),e.deleteFramebuffer(this.targetFbo),this.emptyTexture2D.dispose(),this.emptyTextureCube.dispose(),this.frameBuffers.forEach((function(e){return t.deleteGLFrameBuffer(e)})),this.frameBuffers.length=0,this.renderBuffers.forEach((function(e){return t.deleteGLRenderBuffer(e)})),this.renderBuffers.length=0,this.textures.forEach((function(e){return t.deleteGLTexture(e)})),this.textures.length=0)},e.prototype.lost=function(t){Je.error("gl lost, destroy glRenderer by default",t.target),this.deleteResource()},e.prototype.dispose=function(){this.deleteResource(),this.emptyTexture2D=this.emptyTextureCube=this.pipelineContext=this.gpu=this.gl=null,this.destroyed=!0},e}();function ju(t,e,r){void 0!==e&&(t.__SPECTOR_Metadata={name:e},t.__SPECTOR_Object_TAG?(t.__SPECTOR_Object_TAG.displayText=e,r&&(t.__SPECTOR_Object_TAG.id=r)):t.__SPECTOR_Object_TAG={displayText:e,id:""})}var Wu,Zu,qu,Ku=function(){function t(t,e){this.pipelineContext=t,this.byteLength=0,this.destroyed=!1;var r=e.target,i=void 0===r?v.ARRAY_BUFFER:r,n=e.type,o=void 0===n?v.FLOAT:n,s=e.name,a=e.usage,u=void 0===a?v.STATIC_DRAW:a,c=e.data,l=e.elementCount,h=function(t){var e,r;return null!==(r=null===(e=Qu[t])||void 0===e?void 0:e.BYTES_PER_ELEMENT)&&void 0!==r?r:0}(o);this.target=i,this.type=o,this.usage=u,this.glBuffer=this.createGLBuffer(s),this.bytesPerElement=h,c?this.bufferData(c):l&&this.bufferData(h*l)}return Object.defineProperty(t.prototype,"elementCount",{get:function(){return this.byteLength/this.bytesPerElement},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),t.prototype.createGLBuffer=function(t){var e=this.pipelineContext.gl.createBuffer();return e&&ju(e,t),e},t.prototype.bind=function(){this.pipelineContext.gl.bindBuffer(this.target,this.glBuffer)},t.prototype.bufferData=function(t){var e="number"==typeof t?t:t.byteLength;if(this.pipelineContext){this.byteLength=e;var r=this.pipelineContext.gl,i=this.target;r.bindBuffer(i,this.glBuffer),0===e?r.bufferData(i,1,this.usage):(r.bufferData(i,e,this.usage),"number"!=typeof t&&r.bufferSubData(i,0,t))}else this.byteLength=0},t.prototype.bufferSubData=function(t,e){if(this.pipelineContext){var r=this.pipelineContext.gl,i=this.target,n=t*this.bytesPerElement,o=n+e.byteLength;r.bindBuffer(i,this.glBuffer),o>this.byteLength&&(this.byteLength=o,r.bufferData(i,o,this.usage)),r.bufferSubData(i,n,e)}else this.byteLength=0},t.prototype.dispose=function(){this.pipelineContext.gl.deleteBuffer(this.glBuffer),this.glBuffer=null,this.destroyed=!0},t.prototype.readSubData=function(t,e){return!!g(this.pipelineContext.gl)&&(this.pipelineContext.gl.getBufferSubData(this.target,t*this.bytesPerElement,e),!0)},t}(),Qu=((Gu={})[v.INT]=Int32Array,Gu[v.FLOAT]=Float32Array,Gu[v.SHORT]=Int16Array,Gu[v.BYTE]=Int8Array,Gu[v.UNSIGNED_BYTE]=Uint8Array,Gu[v.UNSIGNED_INT]=Uint32Array,Gu[v.UNSIGNED_SHORT]=Uint16Array,Gu),Ju=((Wu={})[Uint8Array.BYTES_PER_ELEMENT]=v.UNSIGNED_BYTE,Wu[Uint16Array.BYTES_PER_ELEMENT]=v.UNSIGNED_SHORT,Wu[Uint32Array.BYTES_PER_ELEMENT]=v.UNSIGNED_INT,Wu),$u=1,tc=function(t){function e(e,r){var i=this,n=r.drawStart,o=void 0===n?0:n,s=r.drawCount,a=r.mode,u=r.indices,c=r.name,l=void 0===c?"effectsGeometry:".concat($u++):c,h=r.bufferUsage,f=void 0===h?v.STATIC_DRAW:h;(i=t.call(this,l)||this).buffers={},i.vaos={},i.initialized=!1,i.indicesReleasable=!1,i.attributesName=[],i.destroyed=!1,i.engine=e;var p={},d=[],m={},y={},g={},x=f;return i.drawStart=o,i.drawCount=isNaN(+s)?NaN:s,i.mode=isNaN(a)?v.TRIANGLES:a,Object.keys(r.attributes).forEach((function(t){var e=r.attributes[t],i=e.size,n=e.stride,o=e.offset,s=e.normalize,a=e,u=a.type,c=void 0===u?v.FLOAT:u,l=a.releasable,h=e.data;if(!c||"dataSource"in e||h||(h=Si(c)),h){var f=h instanceof Float32Array?v.FLOAT:v.INT;p[t]={data:h,usage:x,target:v.ARRAY_BUFFER,name:t},m[t]={size:i,stride:n,offset:o,type:null!=c?c:f,normalize:!!s,dataSource:t},g[t]=null!=l&&l,y[t]={dirty:!0,discard:!0,start:Number.POSITIVE_INFINITY,end:0}}else{var T=e.dataSource;T&&(m[t]={size:i,stride:n,offset:o,type:c,dataSource:T,normalize:!!s})}d.push(t)})),y.index={dirty:!0,discard:!0,start:Number.POSITIVE_INFINITY,end:0},i.indices=null==u?void 0:u.data,i.indicesReleasable=!0===(null==u?void 0:u.releasable),i.bufferProps=p,i.attributes=m,i.attributesName=d,i.attributesReleasable=g,i.dirtyFlags=y,i.options=r,i}return r(e,t),Object.defineProperty(e.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isInitialized",{get:function(){return this.initialized},enumerable:!1,configurable:!0}),e.prototype.getOptions=function(){return i({},this.options)},e.prototype.initialize=function(){var t=this;if(!this.initialized){var e=this.engine;Tt(e),e.addGeometry(this);var r=this.engine.getGLPipelineContext();Object.keys(this.bufferProps).forEach((function(e){t.buffers[e]=new Ku(r,t.bufferProps[e])})),this.indices&&(this.indicesBuffer=this.createIndicesBuffer(r,this.indices)),this.initialized=!0,this.flush(),this.options=void 0}},e.prototype.getAttributeBuffer=function(t){if(this.initialized){var e=this.attributes[t].dataSource;return this.buffers[e]}},e.prototype.setAttributeData=function(t,e){if(null!=this.bufferProps){var r=this.getAttributeBufferOption(t),i=this.attributes[t].dataSource;if(r){var n=r.usage,o=r.target;this.bufferProps[i]={data:e,usage:n,target:o,elementCount:e.length},this.dirtyFlags[i].discard=!0,this.dirtyFlags[i].dirty=!0}}},e.prototype.getAttributeData=function(t){if(null!=this.bufferProps){var e=this.getAttributeBufferOption(t);return e?e.data:void 0}},e.prototype.setAttributeSubData=function(t,e,r){if(null!=this.bufferProps){var i=this.getAttributeBufferOption(t);if(i&&null!=i.data){var n=e,o=e+r.length;if(i.data.length<o){var s=new r.constructor(o);s.set(i.data),i.data=s,this.dirtyFlags[t].discard=!0}else if(!this.dirtyFlags[t].discard){var a=this.dirtyFlags[t];a.start=Math.min(a.start,n),a.end=Math.max(a.end,o-1)}i.data.set(r,n),this.dirtyFlags[t].dirty=!0}}},e.prototype.getIndexData=function(){return this.indices},e.prototype.setIndexData=function(t){(t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array)&&(this.indices=t,this.dirtyFlags.index.discard=!0,this.dirtyFlags.index.dirty=!0)},e.prototype.setIndexSubData=function(t,e){var r;if(this.indices){var i=t,n=t+e.length;if(this.indices.length<n){var o=new e.constructor(end);o.set(this.indices),this.indices=o,this.dirtyFlags.index.discard=!0}else if(!this.dirtyFlags.index.discard){var s=this.dirtyFlags.index;s.start=Math.min(s.start,i),s.end=Math.max(s.end,n-1)}null===(r=this.indices)||void 0===r||r.set(e,i),this.dirtyFlags.index.dirty=!0}},e.prototype.getAttributeStride=function(t){var e=this.attributes[t],r=e.stride,i=e.size,n=e.type;return r||i*Ei[n]},e.prototype.getAttributeNames=function(){return this.attributesName},e.prototype.setDrawStart=function(t){this.drawStart=t},e.prototype.getDrawStart=function(){return this.drawStart},e.prototype.setDrawCount=function(t){this.drawCount=t},e.prototype.getDrawCount=function(){return this.drawCount},e.prototype.getAttributeBufferOption=function(t){var e=this.attributes[t];return e?this.bufferProps[e.dataSource]:void 0},e.prototype.createIndicesBuffer=function(t,e){var r=Ju[e.BYTES_PER_ELEMENT],i={data:e,target:v.ELEMENT_ARRAY_BUFFER,type:r,name:"".concat(this.name,"##index")};return new Ku(t,i)},e.prototype.flush=function(){var t=this;if(this.initialized){var e=this.attributes,r=this.bufferProps,i=this.indices;Object.keys(this.dirtyFlags).forEach((function(n){var o,s,a=t.dirtyFlags[n];if("index"==n)o=t.indicesBuffer,s=i;else{var u=e[n].dataSource;o=t.buffers[u],s=r[u].data}if((a.dirty||a.discard)&&o&&s){if(a.discard)o.bufferData(s);else{var c=a.start*s.BYTES_PER_ELEMENT+s.byteOffset,l=a.end-a.start+1,h=new s.constructor(s.buffer,c,l);o.bufferSubData(a.start,h)}a.start=Number.POSITIVE_INFINITY,a.end=0,a.dirty=a.discard=!1}})),Object.keys(this.attributesReleasable).forEach((function(i){var n=t.attributesReleasable[i],o=e[i].dataSource;r[o]&&n&&(r[o].data=void 0)})),this.indicesReleasable}},e.prototype.dispose=function(){var t,e=this;this.drawStart=0,this.drawCount=NaN,this.bufferProps={},this.indices=void 0,this.attributes={},this.attributesName=[],this.options=void 0,this.initialized&&(Object.keys(this.buffers).forEach((function(t){e.buffers[t].dispose()})),this.buffers={},null===(t=this.indicesBuffer)||void 0===t||t.dispose(),Object.keys(this.vaos).forEach((function(t){var r;null===(r=e.vaos[t])||void 0===r||r.dispose(),e.vaos[t]=void 0})),this.indicesBuffer=void 0,void 0!==this.engine&&(this.engine.removeGeometry(this),this.engine=void 0)),this.destroyed=!0},e}(bi),ec=function(){function t(){this.reset()}return t.prototype.setBlendColor=function(t){var e=a(t,4),r=e[0],i=e[1],n=e[2],o=e[3];this.blendColor[0]===r&&this.blendColor[1]===i&&this.blendColor[2]===n&&this.blendColor[3]===o||(this.blendColor[0]=r,this.blendColor[1]=i,this.blendColor[2]=n,this.blendColor[3]=o)},t.prototype.setBlending=function(t){this.blending!==t&&(this.blending=t)},t.prototype.setBlendFunctionParameters=function(t){var e=a(t,4),r=e[0],i=e[1],n=e[2],o=e[3];this.blendFunctionParameters[0]===r&&this.blendFunctionParameters[1]===i&&this.blendFunctionParameters[2]===n&&this.blendFunctionParameters[3]===o||(this.blendFunctionParameters[0]=r,this.blendFunctionParameters[1]=i,this.blendFunctionParameters[2]=n,this.blendFunctionParameters[3]=o)},t.prototype.setBlendEquationParameters=function(t){var e=a(t,2),r=e[0],i=e[1];this.blendEquationParameters[0]===r&&this.blendEquationParameters[1]===i||(this.blendEquationParameters[0]=r,this.blendEquationParameters[1]=i)},t.prototype.setDepthTest=function(t){this.depthTest!==t&&(this.depthTest=t)},t.prototype.setDepthMask=function(t){this.depthMask!==t&&(this.depthMask=t)},t.prototype.setDepthRange=function(t){this.depthRange[0]===t[0]&&this.depthRange[1]===t[1]||(this.depthRange[0]=t[0],this.depthRange[1]=t[1])},t.prototype.setDepthFunc=function(t){this.depthFunc!==t&&(this.depthFunc=t)},t.prototype.setPolygonOffsetFill=function(t){this.polygonOffsetFill!==t&&(this.polygonOffsetFill=t)},t.prototype.setPolygonOffset=function(t){this.polygonOffset[0]===t[0]&&this.polygonOffset[1]===t[1]||(this.polygonOffset[0]=t[0],this.polygonOffset[1]=t[1])},t.prototype.setSampleAlphaToCoverage=function(t){this.sampleAlphaToCoverage!==t&&(this.sampleAlphaToCoverage=t)},t.prototype.setColorMask=function(t){var e=a(t,4),r=e[0],i=e[1],n=e[2],o=e[3];this.colorMask[0]===r&&this.colorMask[1]===i&&this.colorMask[2]===n&&this.colorMask[3]===o||(this.colorMask[0]=r,this.colorMask[1]=i,this.colorMask[2]=n,this.colorMask[3]=o)},t.prototype.setStencilTest=function(t){this.stencilTest!==t&&(this.stencilTest=t)},t.prototype.setStencilMask=function(t){this.stencilMask[0]===t[0]&&this.stencilMask[1]===t[1]||(this.stencilMask[0]=t[0],this.stencilMask[1]=t[1])},t.prototype.setStencilRef=function(t){this.stencilRef[0]===t[0]&&this.stencilRef[1]===t[1]||(this.stencilRef[0]=t[0],this.stencilRef[1]=t[1])},t.prototype.setStencilFunc=function(t){this.stencilFunc[0]===t[0]&&this.stencilFunc[1]===t[1]||(this.stencilFunc[0]=t[0],this.stencilFunc[1]=t[1])},t.prototype.setStencilOpFail=function(t){this.stencilOpFail[0]===t[0]&&this.stencilOpFail[1]===t[1]||(this.stencilOpFail[0]=t[0],this.stencilOpFail[1]=t[1])},t.prototype.setStencilOpZFail=function(t){this.stencilOpZFail[0]===t[0]&&this.stencilOpZFail[1]===t[1]||(this.stencilOpZFail[0]=t[0],this.stencilOpZFail[1]=t[1])},t.prototype.setStencilOpZPass=function(t){this.stencilOpZPass[0]===t[0]&&this.stencilOpZPass[1]===t[1]||(this.stencilOpZPass[0]=t[0],this.stencilOpZPass[1]=t[1])},t.prototype.setCulling=function(t){this.culling!==t&&(this.culling=t)},t.prototype.setFrontFace=function(t){this.frontFace!==t&&(this.frontFace=t)},t.prototype.setCullFace=function(t){this.cullFace!==t&&(this.cullFace=t)},t.prototype.reset=function(){this.blending=!1,this.blendColor=[0,0,0,0],this.blendFunctionParameters=[v.ONE,v.ONE_MINUS_SRC_ALPHA,v.ONE,v.ONE_MINUS_SRC_ALPHA],this.blendEquationParameters=[v.FUNC_ADD,v.FUNC_ADD],this.depthTest=!1,this.depthMask=!1,this.depthRange=[0,1],this.depthFunc=v.LESS,this.polygonOffset=[0,0],this.polygonOffsetFill=!1,this.sampleAlphaToCoverage=!1,this.colorMask=[!0,!0,!0,!0],this.stencilTest=!1,this.stencilMask=[255,255],this.stencilRef=[0,0],this.stencilFunc=[v.ALWAYS,v.ALWAYS],this.stencilOpFail=[v.KEEP,v.KEEP],this.stencilOpZFail=[v.KEEP,v.KEEP],this.stencilOpZPass=[v.KEEP,v.KEEP],this.culling=!1,this.frontFace=v.CW,this.cullFace=v.FRONT},t.prototype.apply=function(t){if(t.toggle(v.SAMPLE_ALPHA_TO_COVERAGE,this.sampleAlphaToCoverage),t.toggle(v.BLEND,this.blending),t.toggle(v.DEPTH_TEST,this.depthTest),t.toggle(v.STENCIL_TEST,this.stencilTest),t.toggle(v.CULL_FACE,this.culling),t.toggle(v.POLYGON_OFFSET_FILL,this.polygonOffsetFill),this.stencilTest&&(t.stencilMaskSeparate(v.BACK,this.stencilMask[1]),t.stencilMaskSeparate(v.FRONT,this.stencilMask[0]),t.stencilFuncSeparate(v.BACK,this.stencilFunc[0],this.stencilRef[0],this.stencilMask[0]),t.stencilFuncSeparate(v.FRONT,this.stencilFunc[1],this.stencilRef[1],this.stencilMask[1]),t.stencilOpSeparate(v.BACK,this.stencilOpFail[0],this.stencilOpZFail[0],this.stencilOpZPass[0]),t.stencilOpSeparate(v.FRONT,this.stencilOpFail[1],this.stencilOpZFail[1],this.stencilOpZPass[1])),this.blending){var e=this,r=e.blendColor,i=e.blendEquationParameters,n=e.blendFunctionParameters;t.blendColor(r[0],r[1],r[2],r[3]),t.blendEquationSeparate(i[0],i[1]),t.blendFuncSeparate(n[0],n[1],n[2],n[3])}t.colorMask(this.colorMask[0],this.colorMask[1],this.colorMask[2],this.colorMask[3]),this.depthTest&&(t.depthMask(this.depthMask),t.depthFunc(this.depthFunc),t.depthRange(this.depthRange[0],this.depthRange[1])),this.culling&&(t.cullFace(this.cullFace),t.frontFace(this.frontFace)),this.polygonOffsetFill&&t.polygonOffset(this.polygonOffset[0],this.polygonOffset[1])},t}(),rc=kt,ic=Nt,nc=function(e){function i(t,r){var i=e.call(this,r)||this;return i.floats={},i.ints={},i.vector2s={},i.vector3s={},i.vector4s={},i.quaternions={},i.matrices={},i.matrice3s={},i.textures={},i.floatArrays={},i.vector4Arrays={},i.matrixArrays={},i.samplers=[],i.uniforms=[],i.uniformDirtyFlag=!0,i.glMaterialState=new ec,i.engine=t,i}return r(i,e),Object.defineProperty(i.prototype,"blending",{get:function(){return this.glMaterialState.blending},set:function(t){void 0!==t&&this.glMaterialState.setBlending(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blendColor",{get:function(){return this.glMaterialState.blendColor},set:function(t){t&&this.glMaterialState.setBlendColor(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blendFunction",{get:function(){return this.glMaterialState.blendFunctionParameters},set:function(t){t&&this.glMaterialState.setBlendFunctionParameters(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"blendEquation",{get:function(){return this.glMaterialState.blendEquationParameters},set:function(t){t&&this.glMaterialState.setBlendEquationParameters(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthTest",{get:function(){return this.glMaterialState.depthTest},set:function(t){void 0!==t&&this.glMaterialState.setDepthTest(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthMask",{get:function(){return this.glMaterialState.depthMask},set:function(t){void 0!==t&&this.glMaterialState.setDepthMask(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthRange",{get:function(){return this.glMaterialState.depthRange},set:function(t){t&&this.glMaterialState.setDepthRange(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthFunc",{get:function(){return this.glMaterialState.depthFunc},set:function(t){void 0!==t&&this.glMaterialState.setDepthFunc(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"polygonOffsetFill",{get:function(){return this.glMaterialState.polygonOffsetFill},set:function(t){void 0!==t&&this.glMaterialState.setPolygonOffsetFill(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"polygonOffset",{get:function(){return this.glMaterialState.polygonOffset},set:function(t){t&&this.glMaterialState.setPolygonOffset(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"sampleAlphaToCoverage",{get:function(){return this.glMaterialState.sampleAlphaToCoverage},set:function(t){void 0!==t&&this.glMaterialState.setSampleAlphaToCoverage(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"colorMask",{get:function(){return this.glMaterialState.colorMask},set:function(t){t&&this.glMaterialState.setColorMask(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilTest",{get:function(){return this.glMaterialState.stencilTest},set:function(t){void 0!==t&&this.glMaterialState.setStencilTest(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilMask",{get:function(){return this.glMaterialState.stencilMask},set:function(t){t&&this.glMaterialState.setStencilMask(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilRef",{get:function(){return this.glMaterialState.stencilRef},set:function(t){t&&this.glMaterialState.setStencilRef(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilFunc",{get:function(){return this.glMaterialState.stencilFunc},set:function(t){t&&this.glMaterialState.setStencilFunc(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpFail",{get:function(){return this.glMaterialState.stencilOpFail},set:function(t){t&&this.glMaterialState.setStencilOpFail(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpZFail",{get:function(){return this.glMaterialState.stencilOpZFail},set:function(t){t&&this.glMaterialState.setStencilOpZFail(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"stencilOpZPass",{get:function(){return this.glMaterialState.stencilOpZPass},set:function(t){t&&this.glMaterialState.setStencilOpZPass(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"culling",{get:function(){return this.glMaterialState.culling},set:function(t){void 0!==t&&this.glMaterialState.setCulling(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"frontFace",{get:function(){return this.glMaterialState.frontFace},set:function(t){void 0!==t&&this.glMaterialState.setFrontFace(t)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"cullFace",{get:function(){return this.glMaterialState.cullFace},set:function(t){void 0!==t&&this.glMaterialState.setCullFace(t)},enumerable:!1,configurable:!0}),i.prototype.enableKeyword=function(t){throw new Error("Method not implemented.")},i.prototype.disableKeyword=function(t){throw new Error("Method not implemented.")},i.prototype.isKeywordEnabled=function(t){throw new Error("Method not implemented.")},i.prototype.createMaterialStates=function(t){this.sampleAlphaToCoverage=!!t.sampleAlphaToCoverage,this.depthTest=t.depthTest,this.depthMask=t.depthMask,this.depthRange=t.depthRange,this.depthFunc=t.depthFunc,this.colorMask=t.colorMask,this.polygonOffset=t.polygonOffset,this.polygonOffsetFill=t.polygonOffsetFill,this.blending=t.blending,this.blendFunction=t.blendFunction,this.stencilTest=t.stencilTest},Object.defineProperty(i.prototype,"isDestroyed",{get:function(){return this.destroyed},enumerable:!1,configurable:!0}),i.prototype.initialize=function(){var t=this;if(!this.initialized){var e=this.engine;if(e.addMaterial(this),!this.shader){var r=e.getGLPipelineContext();this.shader=r.shaderLibrary.createShader(this.shaderSource)}this.shader.initialize(e),Object.keys(this.textures).forEach((function(e){var r=t.textures[e];rr(r.initialize)?r.initialize():Je.error("".concat(JSON.stringify(r)," is not valid Texture to initialize"))})),this.initialized=!0}},i.prototype.setupStates=function(t){this.glMaterialState.apply(t)},i.prototype.use=function(t,e){var r,i,n,o,a,u=t.engine.getGLPipelineContext();if(this.shader.program){var c;if(this.shader.program.bind(),this.setupStates(u),e){try{for(var l=s(e.uniforms),h=l.next();!h.done;h=l.next())c=h.value,this.checkUniform(c)}catch(t){r={error:t}}finally{try{h&&!h.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}try{for(var f=s(e.samplers),p=f.next();!p.done;p=f.next())c=p.value,this.samplers.includes(c)||(this.samplers.push(c),this.uniformDirtyFlag=!0)}catch(t){n={error:t}}finally{try{p&&!p.done&&(o=f.return)&&o.call(f)}finally{if(n)throw n.error}}}if(this.uniformDirtyFlag&&(this.shader.fillShaderInformation(this.uniforms,this.samplers),this.uniformDirtyFlag=!1),e){for(c in e.floats)this.shader.setFloat(c,e.floats[c]);for(c in e.ints)this.shader.setInt(c,e.ints[c]);for(c in e.matrices)this.shader.setMatrix(c,e.matrices[c])}for(c in this.textures)this.textures[c].textureBuffer||this.textures[c].initialize();for(c in this.floats)this.shader.setFloat(c,this.floats[c]);for(c in this.ints)this.shader.setInt(c,this.ints[c]);for(c in this.floatArrays)this.shader.setFloats(c,this.floatArrays[c]);for(c in this.textures)this.shader.setTexture(c,this.textures[c]);for(c in this.vector2s)this.shader.setVector2(c,this.vector2s[c]);for(c in this.vector3s)this.shader.setVector3(c,this.vector3s[c]);for(c in this.vector4s)this.shader.setVector4(c,this.vector4s[c]);for(c in this.quaternions)this.shader.setQuaternion(c,this.quaternions[c]);for(c in this.matrices)this.shader.setMatrix(c,this.matrices[c]);for(c in this.matrice3s)this.shader.setMatrix3(c,this.matrice3s[c]);for(c in this.vector4Arrays)this.shader.setVector4Array(c,this.vector4Arrays[c]);for(c in this.matrixArrays)this.shader.setMatrixArray(c,this.matrixArrays[c])}else null===(a=this.engine)||void 0===a||a.renderErrors.add(new Error("Shader program is not initialized"))},i.prototype.getFloat=function(t){return this.floats[t]},i.prototype.setFloat=function(t,e){this.checkUniform(t),this.floats[t]=e},i.prototype.getInt=function(t){return this.ints[t]},i.prototype.setInt=function(t,e){this.checkUniform(t),this.ints[t]=e},i.prototype.getFloats=function(t){return this.floatArrays[t]},i.prototype.setFloats=function(t,e){this.checkUniform(t),this.floatArrays[t]=e},i.prototype.getVector2=function(t){return this.vector2s[t]},i.prototype.setVector2=function(t,e){this.checkUniform(t),this.vector2s[t]=e},i.prototype.getVector3=function(t){return this.vector3s[t]},i.prototype.setVector3=function(t,e){this.checkUniform(t),this.vector3s[t]=e},i.prototype.getVector4=function(t){return this.vector4s[t]},i.prototype.setVector4=function(t,e){this.checkUniform(t),this.vector4s[t]=e},i.prototype.getQuaternion=function(t){return this.quaternions[t]},i.prototype.setQuaternion=function(t,e){this.checkUniform(t),this.quaternions[t]=e},i.prototype.getMatrix=function(t){return this.matrices[t]},i.prototype.setMatrix=function(t,e){this.checkUniform(t),this.matrices[t]=e},i.prototype.setMatrix3=function(t,e){this.checkUniform(t),this.matrice3s[t]=e},i.prototype.getVector4Array=function(t){return this.vector4Arrays[t]},i.prototype.setVector4Array=function(t,e){var r,i;this.checkUniform(t),this.vector4Arrays[t]=[];try{for(var n=s(e),o=n.next();!o.done;o=n.next()){var a=o.value;this.vector4Arrays[t].push(a.x,a.y,a.z,a.w)}}catch(t){r={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}},i.prototype.getMatrixArray=function(t){return this.matrixArrays[t]},i.prototype.setMatrixArray=function(t,e){var r,i;this.checkUniform(t),this.matrixArrays[t]=[];try{for(var n=s(e),o=n.next();!o.done;o=n.next())for(var a=o.value,u=0;u<16;u++)this.matrixArrays[t].push(a.elements[u])}catch(t){r={error:t}}finally{try{o&&!o.done&&(i=n.return)&&i.call(n)}finally{if(r)throw r.error}}},i.prototype.setMatrixNumberArray=function(t,e){this.checkUniform(t),this.matrixArrays[t]=e},i.prototype.getTexture=function(t){return this.textures[t]},i.prototype.setTexture=function(t,e){this.samplers.includes(t)||(this.samplers.push(t),this.uniformDirtyFlag=!0),this.textures[t]=e},i.prototype.hasUniform=function(t){return this.uniforms.includes(t)||this.samplers.includes(t)},i.prototype.clone=function(t){var e=t||this.props,r=this.engine;Tt(r);var n=new i(r,e);return n.glMaterialState=Object.assign(new ec,n.glMaterialState),n.floats=this.floats,n.ints=this.ints,n.vector2s=this.vector2s,n.vector3s=this.vector3s,n.vector4s=this.vector4s,n.quaternions=this.quaternions,n.matrices=this.matrices,n.textures=this.textures,n.floatArrays=this.floatArrays,n.vector4Arrays=this.vector4Arrays,n.matrixArrays=this.matrixArrays,n.samplers=this.samplers,n.uniforms=this.uniforms,n.uniformDirtyFlag=!0,n},i.prototype.cloneUniforms=function(t){var e,r=t;for(e in r.floats)this.setFloat(e,r.floats[e]);for(e in r.ints)this.setInt(e,r.ints[e]);for(e in r.floatArrays)this.setFloats(e,r.floatArrays[e]);for(e in r.textures)this.setTexture(e,r.textures[e]);for(e in r.vector2s)this.setVector2(e,r.vector2s[e]);for(e in r.vector3s)this.setVector3(e,r.vector3s[e]);for(e in r.vector4s)this.setVector4(e,r.vector4s[e]);for(e in r.quaternions)this.setQuaternion(e,r.quaternions[e]);for(e in r.matrices)this.setMatrix(e,r.matrices[e]);for(e in r.vector4Arrays){for(var i=[],n=0;n<r.vector4Arrays[e].length;n+=4)i.push(new rc(r.vector4Arrays[e][n],r.vector4Arrays[e][n+1],r.vector4Arrays[e][n+2],r.vector4Arrays[e][n+3]));this.setVector4Array(e,i)}for(e in r.matrixArrays){var o=[];for(n=0;n<r.matrixArrays[e].length;n+=16){for(var s=ic.fromIdentity(),a=0;a<16;a++)s.elements[a]=r.matrixArrays[e][n+a];o.push(s)}this.setMatrixArray(e,o)}},i.prototype.checkUniform=function(t){this.uniforms.includes(t)||(this.uniforms.push(t),this.uniformDirtyFlag=!0)},i.prototype.dispose=function(e){var r,i=this;this.destroyed||(null===(r=this.shader)||void 0===r||r.dispose(),(null==e?void 0:e.textures)!==t.DestroyOptions.keep&&Object.keys(this.textures).forEach((function(t){i.textures[t].dispose()})),this.shaderSource=null,this.uniformSemantics={},this.floats={},this.ints={},this.vector2s={},this.vector3s={},this.vector4s={},this.quaternions={},this.matrices={},this.matrice3s={},this.textures={},this.floatArrays={},this.vector4Arrays={},this.matrixArrays={},this.samplers=[],this.uniforms=[],this.initialize=or,this.destroyed=!0,void 0!==this.engine&&(this.engine.removeMaterial(this),this.engine=void 0))},i}(ui),oc=function(){function e(t){if(this.renderer=t,1===t.engine.gpuCapability.level){this.copyRenderPass=this.createCopyRenderPass().initialize(t);var e=this.copyRenderPass.meshes[0].material.shaderSource;t.pipelineContext.shaderLibrary.addShader(e)}}return e.prototype.resetColorAttachments=function(t,e){this.renderer&&t.resetColorAttachments(e)},e.prototype.copyTexture=function(e,r){this.renderer&&(e.initialize(),r.initialize(),r.updateSource({sourceType:t.TextureSourceType.framebuffer,data:{width:r.getWidth()||e.getWidth(),height:r.getHeight()||e.getHeight()}}),2===this.renderer.engine.gpuCapability.level?this.copy2(e,r):this.copy1(e,r))},e.prototype.copy2=function(t,e){var r,i=this.renderer.getFrameBuffer();null===(r=this.renderer)||void 0===r||r.glRenderer.copy2(t,e),this.renderer.setFrameBuffer(i)},e.prototype.copy1=function(t,e){var r=this.copyRenderPass;if(r){var i=this.renderer;if(i){var n=r.frameBuffer;n.viewport[2]=e.getWidth()||t.getWidth(),n.viewport[3]=e.getHeight()||t.getHeight(),i.glRenderer.resetColorAttachments(n,[e]),r.meshes[0].material.setTexture("uTex",t),i.renderRenderPass(r)}}},e.prototype.createCopyRenderPass=function(){var e="mri-copy-mesh",r={texture:{format:v.RGBA}},i=this.renderer.engine,n=new tc(i,{name:e,mode:v.TRIANGLE_STRIP,attributes:{aPos:{type:v.FLOAT,size:2,data:new Float32Array([-1,1,-1,-1,1,1,1,-1])}},drawCount:4}),o=i.gpuCapability.level,s=new nc(i,{name:e,shader:{cacheId:"$mri-internal-copy",name:e,vertex:Nr([],"\n        precision highp float;\n      attribute vec2 aPos;\n      varying vec2 vTex;\n      void main(){\n         gl_Position = vec4(aPos,0.,1.0);\n         vTex = (aPos + vec2(1.))/2.;\n       }\n      ",t.ShaderType.vertex,o),fragment:Nr([],"\n        precision highp float;\n      varying vec2 vTex;\n      uniform sampler2D uTex;\n      void main(){gl_FragColor = texture2D(uTex,vTex);}\n      ",t.ShaderType.fragment,o),glslVersion:2===o?t.GLSLVersion.GLSL3:t.GLSLVersion.GLSL1}});s.blending=!1,s.depthTest=!1,s.culling=!1;var a=new Li(i,{name:e,geometry:n,material:s,priority:0});return new sc(this.renderer,{name:"mri-copy-rp",clearAction:{colorAction:t.TextureLoadAction.whatever},attachments:[r],meshes:[a]})},e.prototype.dispose=function(){var t;this.renderer&&(null===(t=this.copyRenderPass)||void 0===t||t.dispose(),this.renderer=void 0)},e}(),sc=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return r(e,t),e.prototype.configure=function(t){this.currentFrameBuffer=t.getFrameBuffer(),t.setFrameBuffer(this.frameBuffer)},e.prototype.execute=function(t){this.clearAction&&t.clear(this.clearAction),t.renderMeshes(this.meshes),this.storeAction&&t.clear(this.storeAction),t.setFrameBuffer(this.currentFrameBuffer)},e}(Ni),ac=function(){function t(t,e,r){var i=this;void 0===e&&(e="webgl"),void 0===r&&(r={}),this.canvas=t,this.glType=e,this.restoreHandlers=[],this.lostHandlers=[],Tt(t),this.gl=p(t,e,r),this.contextLostListener=function(t){var e,r,n;try{for(var o=s(i.lostHandlers),a=o.next();!a.done;a=o.next())a.value.lost(t)}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}null===(n=i.canvas)||void 0===n||n.removeEventListener("webglcontextlost",i.contextLostListener)},this.contextRestoredListener=function(t){var e,r,n;try{for(var o=s(i.restoreHandlers),a=o.next();!a.done;a=o.next())a.value.restore()}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}null===(n=i.canvas)||void 0===n||n.addEventListener("webglcontextlost",i.contextLostListener)},t.addEventListener("webglcontextlost",this.contextLostListener),t.addEventListener("webglcontextrestored",this.contextRestoredListener)}return t.prototype.dispose=function(){this.canvas&&(this.canvas.removeEventListener("webglcontextlost",this.contextLostListener),this.canvas.removeEventListener("webglcontextrestored",this.contextRestoredListener)),this.gl=null,this.canvas=null},t.prototype.addLostHandler=function(t){this.lostHandlers.push(t)},t.prototype.removeLostHandler=function(t){var e=this.lostHandlers.indexOf(t);e>-1&&this.lostHandlers.splice(e,1)},t.prototype.addRestoreHandler=function(t){this.restoreHandlers.push(t)},t.prototype.removeRestoreHandler=function(t){var e=this.restoreHandlers.indexOf(t);e>-1&&this.restoreHandlers.splice(e,1)},t}(),uc=function(t){function e(e){var r=t.call(this)||this;return r.gpuCapability=new yn(e),r}return r(e,t),e.prototype.dispose=function(){this.isDestroyed||t.prototype.dispose.call(this)},e.prototype.getGLRenderer=function(){return this.renderer},e.prototype.getGLRendererInternal=function(){return this.getGLRenderer().glRenderer},e.prototype.getGLPipelineContext=function(){return this.getGLRenderer().pipelineContext},e}(Nu),cc=function(t){function e(e,r){var i=t.call(this,e)||this;return i.initialized=!1,void 0!==r&&i.initialize(r),i}return r(e,t),e.prototype.initialize=function(t){this.initialized||(this.initialized=!0,this.renderer=t,this.buffer=t.createGLRenderBuffer(this))},e.prototype.setSize=function(t,e){if(this.initialized){if(t!==this.size[0]||e!==this.size[1]){var r=this.renderer,i=r.gl;r.pipelineContext.bindRenderBuffer(i.RENDERBUFFER,this.buffer),t&&e?i.renderbufferStorage(i.RENDERBUFFER,this.format,this.size[0]=t,this.size[1]=e):Je.error("Invalid render buffer size: ".concat(t,"x").concat(e))}}else Je.error("Can't set size for uninitialized render buffer")},e.prototype.dispose=function(){this.renderer&&(this.renderer.deleteGLRenderBuffer(this),this.renderer=null,this.buffer=null),this.destroyed=!0,this.initialize=or},e}(mn),lc=1,hc=function(e){function i(r,i){var n,o=e.call(this)||this;o.attachmentTextures=[],o.renderer=i,o.engine=i.engine;var s=r.depthStencilAttachment,a=r.viewport,u=r.isCustomViewport,c=r.viewportScale,l=void 0===c?1:c,h=r.storeAction,f=r.name,p=void 0===f?"GLFrameBuffer".concat(lc++):f;return o.depthStencilStorageType=null!==(n=null==s?void 0:s.storageType)&&void 0!==n?n:t.RenderPassAttachmentStorageType.none,o.viewport=a,o.isCustomViewport=!!u,o.viewportScale=l,o.name=p,o.storeAction=h,o.updateProps(r),o}return r(i,e),Object.defineProperty(i.prototype,"stencilStorage",{get:function(){if(this.depthStencilStorageType!==t.RenderPassAttachmentStorageType.depth_16_opaque)return this.depthStencilRenderBuffer},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"depthStorage",{get:function(){if(this.depthStencilStorageType!==t.RenderPassAttachmentStorageType.stencil_8_opaque)return this.depthStencilRenderBuffer},enumerable:!1,configurable:!0}),i.prototype.getDepthTexture=function(){return this.depthTexture},i.prototype.getStencilTexture=function(){return this.stencilTexture},i.prototype.getColorTextures=function(){return this.colorTextures},i.prototype.updateAttachmentTextures=function(){var t=this;this.attachmentTextures.length=0,this.colorTextures.forEach((function(e){e.initialize(),rt(t.attachmentTextures,e.textureBuffer)})),this.stencilTexture&&rt(this.attachmentTextures,this.stencilTexture.textureBuffer),this.depthTexture&&rt(this.attachmentTextures,this.depthTexture.textureBuffer)},i.prototype.updateProps=function(e){var r,i,n=this.renderer,o=this.engine.gpuCapability,s=null!==(r=e.depthStencilAttachment)&&void 0!==r?r:{storageType:t.RenderPassAttachmentStorageType.none},a=e.attachments.length>0;this.externalStorage=!1;var u=!0;if(e.attachments.length>1&&!o.detail.drawBuffers)throw Error("multiple color attachments not support");var c=null===(i=e.depthStencilAttachment)||void 0===i?void 0:i.texture,l=o.detail.readableDepthStencilTextures;if(this.colorTextures=e.attachments.slice(),!a&&s.storageType!==t.RenderPassAttachmentStorageType.none)throw Error("use depth stencil attachment without color attachments");a&&(this.fbo=n.glRenderer.createGLFrameBuffer(this,this.name));var h=s.storageType;if(h===t.RenderPassAttachmentStorageType.depth_stencil_opaque){if(s.storage){if(!(s.storage instanceof cc))throw Error("invalid depth stencil attachment storage");this.depthStencilRenderBuffer=s.storage,this.externalStorage=!0}else this.depthStencilRenderBuffer=new cc({format:v.DEPTH_STENCIL,attachment:v.DEPTH_STENCIL_ATTACHMENT,storageType:h},n.glRenderer);u=!1}else if(h===t.RenderPassAttachmentStorageType.depth_16_opaque)if(s.storage){if(!(s.storage instanceof cc))throw Error("invalid depth attachment storage");this.depthStencilRenderBuffer=s.storage,this.externalStorage=!0}else this.depthStencilRenderBuffer=new cc({attachment:v.DEPTH_ATTACHMENT,format:v.DEPTH_COMPONENT16,storageType:h},n.glRenderer);else if(h===t.RenderPassAttachmentStorageType.stencil_8_opaque)if(s.storage){if(!(s.storage instanceof cc))throw Error("invalid stencil attachment storage");this.depthStencilRenderBuffer=s.storage,this.externalStorage=!0}else this.depthStencilRenderBuffer=new cc({attachment:v.STENCIL_ATTACHMENT,format:v.STENCIL_INDEX8,storageType:h},n.glRenderer);else if(h===t.RenderPassAttachmentStorageType.depth_16_texture){if(!l)throw Error("depth texture is not support in framebuffer");this.depthTexture=null!=c?c:new Uu(this.engine,{sourceType:t.TextureSourceType.framebuffer,format:v.DEPTH_COMPONENT,internalFormat:o.internalFormatDepth16,type:v.UNSIGNED_SHORT,name:"".concat(this.name,"##depthTex")}),this.depthTexture.initialize()}else if(h===t.RenderPassAttachmentStorageType.depth_24_stencil_8_texture){if(!l)throw Error("depth stencil texture is not support in framebuffer");this.depthTexture=this.stencilTexture=null!=c?c:new Uu(this.engine,{sourceType:t.TextureSourceType.framebuffer,format:v.DEPTH_STENCIL,internalFormat:o.internalFormatDepth24_stencil8,type:o.UNSIGNED_INT_24_8,name:"".concat(this.name,"##dpthStclTex")}),this.depthTexture.initialize(),u=!0}this.storeInvalidAttachments=this.getStoreAttachments(this.storeAction,u),this.updateAttachmentTextures()},i.prototype.getStoreAttachments=function(e,r){var i=this.renderer.glRenderer.gl,n=this.colorTextures.length;if(e&&g(i)&&n>0){var o=[];if(e.depthAction===t.TextureStoreAction.clear&&this.depthStorage&&rt(o,r?i.DEPTH_ATTACHMENT:i.DEPTH_STENCIL_ATTACHMENT),e.stencilAction===t.TextureStoreAction.clear&&this.stencilStorage&&rt(o,r?i.STENCIL_ATTACHMENT:i.DEPTH_STENCIL_ATTACHMENT),e.colorAction===t.TextureStoreAction.clear)for(var s=0;s<n;s++)rt(o,i["COLOR_ATTACHMENT".concat(s)]);return o}},i.prototype.unbind=function(){var t=this.storeInvalidAttachments;if(null==t?void 0:t.length){var e=this.renderer.glRenderer.gl;e.invalidateFramebuffer(e.FRAMEBUFFER,t)}this.renderer.pipelineContext.bindSystemFramebuffer()},i.prototype.bind=function(){var t=this,e=this.renderer.glRenderer.gl,r=this.renderer.pipelineContext;if(this.fbo){var i=e.FRAMEBUFFER,n=a(this.viewport,4),o=n[0],s=n[1],u=n[2],c=n[3];r.bindFramebuffer(i,this.fbo),r.viewport(o,s,u,c);var l=this.renderer.glRenderer.emptyTexture2D.textureBuffer;Object.keys(r.textureUnitDict).forEach((function(e){var i=r.textureUnitDict[e];i!==l&&i&&t.attachmentTextures.includes(i)&&(r.activeTexture(+e),t.renderer.glRenderer.emptyTexture2D.bind())}));for(var h=0;h<4;h++)r.activeTexture(e.TEXTURE0+h),this.renderer.glRenderer.emptyTexture2D.bind();if(!this.ready){var f=this,p=f.depthStencilRenderBuffer,d=f.depthTexture,m=f.stencilTexture;if(r.activeTexture(e.TEXTURE0),p)p.setSize(u,c),e.framebufferRenderbuffer(i,p.attachment,e.RENDERBUFFER,p.buffer);else if(d){d.source.data={width:u,height:c},d.update({data:{width:u,height:c,data:new Uint16Array(0)}});var v=d&&m?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.framebufferTexture2D(i,v,e.TEXTURE_2D,d.textureBuffer,0)}this.resetColorTextures(this.colorTextures);var y=e.checkFramebufferStatus(i);if(y!==e.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer failed, status: ".concat(y,", error: ").concat(e.getError()));this.ready=!0}}},i.prototype.resetColorTextures=function(t){var e,r,i=t,n=this.renderer.glRenderer.gl,o=this.engine.gpuCapability,a=this.viewport,u=[];if(i){try{for(var c=s(i),l=c.next();!l.done;l=c.next())l.value.initialize()}catch(t){e={error:t}}finally{try{l&&!l.done&&(r=c.return)&&r.call(c)}finally{if(e)throw e.error}}this.colorTextures=i.slice()}this.renderer.pipelineContext.activeTexture(n.TEXTURE0),this.colorTextures.forEach((function(t,e){var r={width:a[2],height:a[3],data:new Uint8Array(0)};t.update({data:r}),o.framebufferTexture2D(n,n.FRAMEBUFFER,e,n.TEXTURE_2D,t.textureBuffer),u.push(!0)})),o.drawBuffers(n,u),this.updateAttachmentTextures()},i.prototype.resize=function(t,e,r,i){var n=a(this.viewport,4),o=n[0],s=n[1],u=n[2],c=n[3];o===t&&s===e&&u===r&&c===i||(this.viewport=[t,e,r,i],this.ready=!1,this.bind())},i.prototype.dispose=function(e){var r,i,n=this.renderer;if(n){n.glRenderer.deleteGLFrameBuffer(this),delete this.fbo;var o=(null==e?void 0:e.depthStencilAttachment)?e.depthStencilAttachment:t.RenderPassDestroyAttachmentType.force;(o===t.RenderPassDestroyAttachmentType.force||o===t.RenderPassDestroyAttachmentType.keepExternal&&!this.externalStorage)&&(null===(r=this.depthStencilRenderBuffer)||void 0===r||r.dispose(),null===(i=this.depthTexture)||void 0===i||i.dispose()),this.renderer=this.stencilRenderBuffer=this.depthStencilRenderBuffer=null}},i}(Sn),fc=function(t){for(var e=5381,r=t.length;r;)e=33*e^t.charCodeAt(--r);return e>>>0},pc=((Zu={})[v.FLOAT]=1,Zu[v.INT]=1,Zu[v.UNSIGNED_INT]=1,Zu[v.SHORT]=1,Zu[v.BOOL]=1,Zu[v.UNSIGNED_SHORT]=1,Zu[v.FLOAT_VEC2]=2,Zu[v.FLOAT_VEC3]=3,Zu[v.FLOAT_VEC4]=4,Zu[v.FLOAT_MAT2]=4,Zu[v.FLOAT_MAT3]=9,Zu[v.FLOAT_MAT4]=16,Zu[v.FLOAT_MAT2x3]=6,Zu[v.FLOAT_MAT2x4]=8,Zu[v.FLOAT_MAT4x3]=12,Zu[v.FLOAT_MAT4x2]=8,Zu[v.FLOAT_MAT3x4]=12,Zu[v.FLOAT_MAT3x2]=6,Zu[v.INT_VEC2]=2,Zu[v.INT_VEC3]=3,Zu[v.INT_VEC4]=4,Zu[v.UNSIGNED_INT_VEC2]=2,Zu[v.UNSIGNED_INT_VEC3]=3,Zu[v.UNSIGNED_INT_VEC4]=4,Zu[v.BOOL_VEC2]=2,Zu[v.BOOL_VEC3]=3,Zu[v.BOOL_VEC4]=4,Zu),dc=gc(Float32Array),mc=gc(Int32Array),vc=gc(Uint8Array);function yc(t){return function(e,r,i,n){var o={start:r[1],dirty:!0};if(r[2]>1){var s=e;if(s.length){for(var a=n[1]||s.length,u=r[4]/t.BYTES_PER_ELEMENT,c=o.buffer=new t(a*u),l=n[0]||0,h=0;h<a;h++)c[h*u]=s[h+l];o.start+=l*u}}else o.buffer=new t([e]);return o}}function gc(t){return function(e,r,i,n){for(var o=r[8],s=r[2],a=r[5],u=1===s?o:r[4],c=a?u/a:1,l=u/t.BYTES_PER_ELEMENT/c,h=o/t.BYTES_PER_ELEMENT/l,f=pc[r[0]],p=f/c,d=(n[0]||0)*f,m=n[1]?c*n[1]:h,v=new t(l*m),y={start:r[1]+u*(n[0]||0),dirty:!0,buffer:v},g=0,x=0,T=d;g<m;g++){for(var E=0;E<p;E++)v[x+E]=e[T+E];x+=l,T+=p}return y}}function xc(t,e){for(var r=[],i=[],n=t.getProgramParameter(e,t.ACTIVE_UNIFORM_BLOCKS),o=function(n){var o=t.getActiveUniformBlockName(e,n),s={index:t.getUniformBlockIndex(e,o),usedByVertexShader:t.getActiveUniformBlockParameter(e,n,t.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER),usedByFragmentShader:t.getActiveUniformBlockParameter(e,n,t.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER),size:t.getActiveUniformBlockParameter(e,n,t.UNIFORM_BLOCK_DATA_SIZE),uniformIndices:t.getActiveUniformBlockParameter(e,n,t.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES),used:!1,uniforms:{},name:o,id:""};s.used=s.usedByVertexShader||s.usedByFragmentShader,r[n]=s;for(var a=s.uniformIndices,u=[],c=0;c<a.length;c++){var l=t.getActiveUniform(e,a[c]).name.replace("[0]","");s.uniforms[l]=[0,0,0,0,0,0,0,c,0],u[c]=l,i.push(l)}for([t.UNIFORM_TYPE,t.UNIFORM_OFFSET,t.UNIFORM_SIZE,t.UNIFORM_BLOCK_INDEX,t.UNIFORM_ARRAY_STRIDE,t.UNIFORM_MATRIX_STRIDE,t.UNIFORM_IS_ROW_MAJOR].forEach((function(r,i){t.getActiveUniforms(e,a,r).forEach((function(t,e){var r=u[e];s.uniforms[r][i]=+t}))})),c=0;c<u.length;c++){var h=s.uniforms[u[c]],f=s.uniforms[u[c+1]],p=f?f[1]:s.size;h[8]=p-h[1]}s.id=function(t){var e=t.name,r=t.size,i=t.uniforms,n=t.uniformIndices;return Object.keys(i).map((function(t){return"".concat(t,"[").concat(i[t].join(":"),"]")})).join("+"),fc("".concat(e,"+"),"".concat(r,"+"),"".concat(n.length,"+"))}(s)+""},s=0;s<n;++s)o(s);return{blockSpecs:r,blockUniformNames:i}}(qu={})[v.FLOAT]=yc(Float32Array),qu[v.INT]=yc(Int32Array),qu[v.UNSIGNED_INT]=yc(Uint32Array),qu[v.SHORT]=yc(Int16Array),qu[v.BOOL]=yc(Uint8Array),qu[v.UNSIGNED_SHORT]=yc(Uint16Array),qu[v.FLOAT_VEC2]=dc,qu[v.FLOAT_VEC3]=dc,qu[v.FLOAT_VEC4]=dc,qu[v.FLOAT_MAT2]=dc,qu[v.FLOAT_MAT3]=dc,qu[v.FLOAT_MAT4]=dc,qu[v.FLOAT_MAT2x3]=dc,qu[v.FLOAT_MAT2x4]=dc,qu[v.FLOAT_MAT4x3]=dc,qu[v.FLOAT_MAT4x2]=dc,qu[v.FLOAT_MAT3x4]=dc,qu[v.FLOAT_MAT3x2]=dc,qu[v.INT_VEC2]=mc,qu[v.INT_VEC3]=mc,qu[v.INT_VEC4]=mc,qu[v.UNSIGNED_INT_VEC2]=mc,qu[v.UNSIGNED_INT_VEC3]=mc,qu[v.UNSIGNED_INT_VEC4]=mc,qu[v.BOOL_VEC2]=vc,qu[v.BOOL_VEC3]=vc,qu[v.BOOL_VEC4]=vc;var Tc=function(){function t(t,e,r,i){var n=this;this.engine=t,this.program=e,this.shared=r,this.id=i,this.uniformBlockMap={},this.pipelineContext=t.getGLPipelineContext();var o=this.pipelineContext.gl;if(this.pipelineContext.useProgram(e),this.attribInfoMap=this.createAttribMap(),g(o)){var s=xc(o,e),a=s.blockSpecs;s.blockUniformNames,a.forEach((function(t){return n.uniformBlockMap[t.name]=t}))}this.pipelineContext.useProgram(null)}return t.prototype.bind=function(){this.pipelineContext.useProgram(this.program)},t.prototype.setupAttributes=function(t){var e,r,i=this,n=this.id,o=this.pipelineContext.gl;return t.vaos[n]?r=t.vaos[n]:((r=new Xu(this.engine,"".concat(t.name,"-").concat(n)))||console.error("Failed to create VAO object"),t.vaos[n]=r),r&&r.vao&&(r.bind(),r.ready)||(Object.keys(this.attribInfoMap).forEach((function(e){var r=i.attribInfoMap[e],n=t.attributes[e];if(n){var s=t.buffers[n.dataSource];if(!s)throw Error("no buffer named ".concat(n.dataSource||e));s.bind(),o.enableVertexAttribArray(r.loc),o.vertexAttribPointer(r.loc,n.size,n.type,n.normalize,n.stride||0,n.offset||0)}})),null===(e=t.indicesBuffer)||void 0===e||e.bind(),r&&(r.ready=!0)),r},t.prototype.createAttribMap=function(){for(var t=this.pipelineContext.gl,e=this.program,r={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),n=0;n<i;n++){var o=t.getActiveAttrib(e,n),s=o.name,a=o.type,u=o.size,c=t.getAttribLocation(e,s);r[s]={type:a,name:s,size:u,loc:c}}return r},t.prototype.dispose=function(){this.pipelineContext&&(this.pipelineContext.gl.deleteProgram(this.program),this.pipelineContext=null)},t}(),Ec=function(t){function e(e){var r=t.call(this,e)||this;return r.initialized=!1,r.uniformLocations={},r.samplerChannels={},r}return r(e,t),e.prototype.initialize=function(t){this.initialized||t.getGLPipelineContext().shaderLibrary.compileShader(this)},e.prototype.setFloat=function(t,e){this.pipelineContext.setFloat(this.uniformLocations[t],e)},e.prototype.setInt=function(t,e){this.pipelineContext.setInt(this.uniformLocations[t],e)},e.prototype.setFloats=function(t,e){this.pipelineContext.setFloats(this.uniformLocations[t],e)},e.prototype.setTexture=function(t,e){this.pipelineContext.setTexture(this.uniformLocations[t],this.samplerChannels[t],e)},e.prototype.setVector2=function(t,e){this.pipelineContext.setVector2(this.uniformLocations[t],e)},e.prototype.setVector3=function(t,e){this.pipelineContext.setVector3(this.uniformLocations[t],e)},e.prototype.setVector4=function(t,e){this.pipelineContext.setVector4(this.uniformLocations[t],e)},e.prototype.setQuaternion=function(t,e){this.pipelineContext.setQuaternion(this.uniformLocations[t],e)},e.prototype.setMatrix=function(t,e){this.pipelineContext.setMatrix(this.uniformLocations[t],e)},e.prototype.setMatrix3=function(t,e){this.pipelineContext.setMatrix3(this.uniformLocations[t],e)},e.prototype.setVector4Array=function(t,e){this.pipelineContext.setVector4Array(this.uniformLocations[t],e)},e.prototype.setMatrixArray=function(t,e){this.pipelineContext.setMatrixArray(this.uniformLocations[t],e)},e.prototype.fillShaderInformation=function(t,e){var r=e.slice();t=t.concat(r);for(var i,n=this.pipelineContext.getUniforms(this.program.program,t),o=0;o<t.length;o++)this.uniformLocations[t[o]]=n[o];for(i=0;i<r.length;i++)null==this.uniformLocations[r[i]]&&(r.splice(i,1),i--);for(i=0;i<r.length;i++){var s=r[i];this.samplerChannels[s]=i}},e.prototype.dispose=function(){var t;this.compileResult&&this.compileResult.shared||null===(t=this.program)||void 0===t||t.dispose()},e}(li),bc=0,Sc=function(){function e(t,e){this.engine=t,this.pipelineContext=e,this.shaderResults={},this.programMap={},this.glVertShaderMap=new Map,this.glFragShaderMap=new Map,this.shaderAllDone=!1,this.cachedShaders={},this.glAsyncCompileExt=t.gpuCapability.glAsyncCompileExt}return e.prototype.compileAllShaders=function(t){var e,r,i=this;if(this.shaderAllDone)t&&t([]);else{var n=[];try{for(var o=s(Object.keys(this.cachedShaders)),a=o.next();!a.done;a=o.next()){var u=a.value;this.cachedShaders[u].initialized||n.push(u)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}t?n.length?Promise.all(n.map((function(t){return new Promise((function(e){return i.compileShader(i.cachedShaders[t],e)}))}))).then(t).catch((function(){return 0})):t([]):n.map((function(t){return i.compileShader(i.cachedShaders[t])})),this.shaderAllDone=!0}},e.prototype.addShader=function(e){var r=this.computeShaderCacheId(e);if(this.cachedShaders[r])return r;this.shaderAllDone=!1;var i=e.glslVersion===t.GLSLVersion.GLSL3?"#version 300 es\n":"",n=e.vertex?i+e.vertex:"",o=e.fragment?i+e.fragment:"",s=!1;return(e.shared||e.cacheId)&&(s=!0),this.cachedShaders[r]=new Ec({vertex:n,fragment:o,name:e.name||r,shared:s}),this.cachedShaders[r].id=r,r},e.prototype.createShader=function(t){var e=this.addShader(t);return this.cachedShaders[e]},e.prototype.compileShader=function(e,r){var i=this,n=e.source,o=!1;(n.shared||n.cacheId)&&(o=!0);var s={vertex:n.vertex,fragment:n.fragment,name:n.name,shared:o},a=this.pipelineContext.gl,u={shared:s.shared,status:t.ShaderCompileResultStatus.compiling},c=this.createProgram(a,s.vertex,s.fragment,u),l=this.glAsyncCompileExt,h=performance.now(),f=function(r){u.status=t.ShaderCompileResultStatus.success,u.compileTime=performance.now()-h,e.program=r,e.initialized=!0,e.pipelineContext=i.pipelineContext,void 0!==i.programMap[e.id]&&console.warn("find duplicated shader id",e.id),i.programMap[e.id]=r},p=function(){var n=(!r||!l||l&&1==a.getProgramParameter(u.program,l.COMPLETION_STATUS_KHR))&&c();if(n){if(u.status!==t.ShaderCompileResultStatus.fail){ju(n,s.name);var h=new Tc(i.engine,n,o,e.id);if(a.validateProgram(n),a.getProgramParameter(n,a.VALIDATE_STATUS))f(h);else{var d=a.getProgramInfoLog(n);(null==d?void 0:d.includes("the same texture"))?f(h):(u.status=t.ShaderCompileResultStatus.fail,u.error=d,console.error("compileProgramError: "+d,"\nvertex:\n",s.vertex,"\nfragment:\n",s.fragment),a.deleteProgram(n))}}r&&r(u)}else r&&requestAnimationFrame(p)};e.compileResult=u,p()},e.prototype.computeShaderCacheId=function(t){var e,r=t.vertex?t.vertex:"",i=t.fragment?t.fragment:"";return e=t.shared||t.cacheId?t.cacheId||"shared_".concat(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var r=0,i=0;i<arguments.length;i++)for(var n=t[i],o=0;o<n.length;o++)r=Math.imul(31,r)+n.charCodeAt(o)|0;return r}(r,i)):"instanced_"+bc++,e},e.prototype.createProgram=function(e,r,i,n){var o=e.createProgram(),s=this.createGLShader(e,e.VERTEX_SHADER,r),a=this.createGLShader(e,e.FRAGMENT_SHADER,i);return o&&s&&a?(e.attachShader(o,s),e.attachShader(o,a),e.linkProgram(o),n.program=o,n.status=t.ShaderCompileResultStatus.compiling,function(){if(delete n.program,!e.getProgramParameter(o,e.LINK_STATUS)){var u=Ac(e,s,"vertex",r),c=Ac(e,a,"fragment",i);return n.status=t.ShaderCompileResultStatus.fail,u&&(n.error=u.error,n.status=u.status),c&&(n.error=c.error,n.status=c.status),o}return o}):(n.status=t.ShaderCompileResultStatus.fail,function(){return null})},e.prototype.createGLShader=function(t,e,r){var i=e===t.VERTEX_SHADER?this.glVertShaderMap:this.glFragShaderMap,n=fc(null!=r?r:""),o=i.get(n);if(o)return o;var s=t.createShader(e);return s&&(t.shaderSource(s,r),t.compileShader(s),i.set(n,s)),s},e.prototype.deleteShader=function(t){var e=this.programMap[t];void 0!==e&&(e.dispose(),delete this.programMap[t]),void 0!==this.shaderResults[t]&&delete this.shaderResults[t]},e.prototype.restore=function(){},e.prototype.dispose=function(){var t=this;if(Object.keys(this.programMap).forEach((function(e){t.programMap[e].dispose()})),this.programMap={},this.pipelineContext){var e=this.pipelineContext.gl;this.glFragShaderMap.forEach((function(t){e.deleteShader(t)})),this.glVertShaderMap.forEach((function(t){e.deleteShader(t)})),this.glVertShaderMap=new Map,this.glFragShaderMap=new Map}},e}();function Ac(e,r,i,n){if(!e.getShaderParameter(r,e.COMPILE_STATUS)){var o=e.getShaderInfoLog(r);return console.error("compile "+i+" error: "+o,(null!=n?n:"").split("\n").map((function(t,e){return"".concat(e+1," ").concat(t)})).join("\n")),{error:o,status:t.ShaderCompileResultStatus.fail}}}var Rc=function(){function t(t,e){this.engine=t,this.gl=e,this.gl=e,this.shaderLibrary=new Sc(t,this),this.maxTextureCount=this.gl.TEXTURE0+this.gl.getParameter(this.gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS)-1,this.reset()}return t.prototype.dispose=function(){this.shaderLibrary.dispose(),this.reset()},t.prototype.reset=function(){this.glCapabilityCache={},this.activeTextureIndex=v.TEXTURE0,this.textureUnitDict={},this.currentFramebuffer={},this.pixelStorei={},this.currentRenderBuffer={}},t.prototype.toggle=function(t,e){e?this.enable(t):this.disable(t)},t.prototype.enable=function(t){!0!==this.glCapabilityCache[t]&&(this.glCapabilityCache[t]=!0,this.gl.enable(t))},t.prototype.disable=function(t){!1!==this.glCapabilityCache[t]&&(this.glCapabilityCache[t]=!1,this.gl.disable(t))},t.prototype.bindFramebuffer=function(t,e){this.currentFramebuffer[t]!==e&&(this.currentFramebuffer[t]=e,this.gl.bindFramebuffer(t,e))},t.prototype.bindRenderBuffer=function(t,e){this.currentRenderBuffer[t]!==e&&(this.currentRenderBuffer[t]=e,this.gl.bindRenderbuffer(t,e))},t.prototype.bindSystemFramebuffer=function(){this.bindFramebuffer(this.gl.FRAMEBUFFER,null)},t.prototype.useProgram=function(t){this.set1("useProgram",t)},t.prototype.clear=function(t){this.gl.clear(t)},t.prototype.clearDepth=function(t){this.set1("clearDepth",t)},t.prototype.depthFunc=function(t){this.set1("depthFunc",t)},t.prototype.depthMask=function(t){this.set1("depthMask",t)},t.prototype.polygonOffset=function(t,e){this.set2("polygonOffset",t,e)},t.prototype.depthRange=function(t,e){this.set2("depthRange",t,e)},t.prototype.clearStencil=function(t){this.set1("clearStencil",t)},t.prototype.stencilMask=function(t){this.stencilMaskSeparate(this.gl.FRONT,t),this.stencilMaskSeparate(this.gl.BACK,t)},t.prototype.stencilFunc=function(t,e,r){this.stencilFuncSeparate(this.gl.FRONT,t,e,r),this.stencilFuncSeparate(this.gl.BACK,t,e,r)},t.prototype.stencilFuncSeparate=function(t,e,r,i){this.set4("stencilFuncSeparate",t,e,r,i)},t.prototype.stencilMaskSeparate=function(t,e){this.set2("stencilMaskSeparate",t,e)},t.prototype.stencilOp=function(t,e,r){this.stencilOpSeparate(this.gl.FRONT,t,e,r),this.stencilOpSeparate(this.gl.BACK,t,e,r)},t.prototype.stencilOpSeparate=function(t,e,r,i){this.set4("stencilOpSeparate",t,e,r,i)},t.prototype.cullFace=function(t){this.set1("cullFace",t)},t.prototype.frontFace=function(t){this.set1("frontFace",t)},t.prototype.clearColor=function(t,e,r,i){this.set4("clearColor",t,e,r,i)},t.prototype.colorMask=function(t,e,r,i){this.set4("colorMask",t,e,r,i)},t.prototype.blendColor=function(t,e,r,i){this.set4("blendColor",t,e,r,i)},t.prototype.blendFunc=function(t,e){this.blendFuncSeparate(t,e,t,e)},t.prototype.blendFuncSeparate=function(t,e,r,i){this.set4("blendFuncSeparate",t,e,r,i)},t.prototype.blendEquation=function(t){this.set1("blendEquation",t)},t.prototype.blendEquationSeparate=function(t,e){this.set2("blendEquationSeparate",t,e)},t.prototype.setPixelStorei=function(t,e){this.pixelStorei[t]!==e&&(this.pixelStorei[t]=e,this.gl.pixelStorei(t,e))},t.prototype.viewport=function(t,e,r,i){this.set4("viewport",t,e,r,i)},t.prototype.activeTexture=function(t){t=Math.min(t,this.maxTextureCount),this.activeTextureIndex!==t&&(this.activeTextureIndex=t,this.gl.activeTexture(t))},t.prototype.bindTexture=function(t,e,r){(this.currentTextureBinding!==e||r)&&(this.gl.bindTexture(t,e),this.currentTextureBinding=e),this.textureUnitDict[this.activeTextureIndex]=e},t.prototype.set1=function(t,e){this.glCapabilityCache[t]!==e&&(this.glCapabilityCache[t]=e,this.gl[t](e))},t.prototype.set2=function(t,e,r){var i=this.glCapabilityCache[t];i||(i=this.glCapabilityCache[t]={x:NaN,y:NaN}),i.x===e&&i.y===r||this.gl[t](i.x=e,i.y=r)},t.prototype.set3=function(t,e,r,i){var n=this.glCapabilityCache[t];n||(n=this.glCapabilityCache[t]={x:NaN,y:NaN,z:NaN}),n.x===e&&n.y===r&&n.z===i||this.gl[t](n.x=e,n.y=r,n.z=i)},t.prototype.set4=function(t,e,r,i,n){var o=this.glCapabilityCache[t];o||(o=this.glCapabilityCache[t]={x:NaN,y:NaN,z:NaN,w:NaN}),o.x===e&&o.y===r&&o.z===i&&o.w===n||this.gl[t](o.x=e,o.y=r,o.z=i,o.w=n)},t.prototype.get=function(t){return this.glCapabilityCache[t]},t.prototype.setFloat=function(t,e){t&&this.gl.uniform1f(t,e)},t.prototype.setInt=function(t,e){t&&this.gl.uniform1i(t,e)},t.prototype.setFloats=function(t,e){t&&this.gl.uniform1fv(t,e)},t.prototype.setVector2=function(t,e){this.setFloat2(t,e.x,e.y)},t.prototype.setVector3=function(t,e){this.setFloat3(t,e.x,e.y,e.z)},t.prototype.setVector4=function(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)},t.prototype.setQuaternion=function(t,e){this.setFloat4(t,e.x,e.y,e.z,e.w)},t.prototype.setVector4Array=function(t,e){t&&e.length%4==0&&this.gl.uniform4fv(t,e)},t.prototype.setMatrix=function(t,e){t&&this.gl.uniformMatrix4fv(t,!1,e.elements)},t.prototype.setMatrix3=function(t,e){t&&this.gl.uniformMatrix3fv(t,!1,e.elements)},t.prototype.setMatrixArray=function(t,e){t&&e.length%16==0&&this.gl.uniformMatrix4fv(t,!1,e)},t.prototype.setTexture=function(t,e,r){if(t){this.gl.activeTexture(this.gl.TEXTURE0+e);var i=r.target;this.gl.bindTexture(i,r.textureBuffer),this.gl.uniform1i(t,e)}},t.prototype.getUniforms=function(t,e){for(var r=[],i=0;i<e.length;i++)r.push(this.gl.getUniformLocation(t,e[i]));return r},t.prototype.setFloat4=function(t,e,r,i,n){t&&this.gl.uniform4f(t,e,r,i,n)},t.prototype.setFloat3=function(t,e,r,i){t&&this.gl.uniform3f(t,e,r,i)},t.prototype.setFloat2=function(t,e,r){t&&this.gl.uniform2f(t,e,r)},t}(),Cc=function(e){function n(r,n,o){var s=e.call(this)||this;s.canvas=r,s.temporaryRTs={};var a=i({preserveDrawingBuffer:void 0,alpha:!0,stencil:!0,antialias:!0,depth:!0,premultipliedAlpha:!0},o);s.context=new ac(r,n,a);var u=s.context.gl;return Tt(u),s.engine=new uc(u),s.engine.renderer=s,s.pipelineContext=new Rc(s.engine,u),s.glRenderer=new Yu(s.engine),s.extension=new oc(s),s.renderingData={currentFrame:{}},s.frameBuffer=new hc({storeAction:{},viewport:[0,0,s.width,s.height],attachments:[new Uu(s.engine,{sourceType:t.TextureSourceType.framebuffer,data:{width:s.width,height:s.height}})],depthStencilAttachment:{storageType:t.RenderPassAttachmentStorageType.none}},s),s}return r(n,e),Object.defineProperty(n.prototype,"isDestroyed",{get:function(){var t=this.glRenderer;return!t||t.isDestroyed},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"height",{get:function(){var t,e;return null!==(e=null===(t=this.glRenderer)||void 0===t?void 0:t.height)&&void 0!==e?e:0},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"width",{get:function(){var t,e;return null!==(e=null===(t=this.glRenderer)||void 0===t?void 0:t.width)&&void 0!==e?e:0},enumerable:!1,configurable:!0}),n.prototype.renderRenderFrame=function(t){var e,r,i,n,o,a,u=t;u.resource&&u.resource.color_b.initialize(),u.emptyTexture.initialize(),u.transparentTexture.initialize();var c=u._renderPasses;if(this.isDestroyed)return console.error("renderer is destroyed",this);u.renderer.getShaderLibrary().compileAllShaders(),this.setFrameBuffer(null),this.clear(u.clearAction),this.renderingData.currentFrame=u,this.renderingData.currentCamera=u.camera,vt(c);try{for(var l=s(c),h=l.next();!h.done;h=l.next()){var f=(m=h.value).delegate;null===(o=f.willBeginRenderPass)||void 0===o||o.call(f,m,this.renderingData),this.renderRenderPass(m),null===(a=f.didEndRenderPass)||void 0===a||a.call(f,m,this.renderingData)}}catch(t){e={error:t}}finally{try{h&&!h.done&&(r=l.return)&&r.call(l)}finally{if(e)throw e.error}}try{for(var p=s(c),d=p.next();!d.done;d=p.next()){var m;(m=d.value).frameCleanup(this)}}catch(t){i={error:t}}finally{try{d&&!d.done&&(n=p.return)&&n.call(p)}finally{if(i)throw i.error}}},n.prototype.renderRenderPass=function(t){this.renderingData.currentPass=t,t.initialize(this),t.configure(this),t.execute(this)},n.prototype.renderMeshes=function(t){var e,r,i,n,o=this.renderingData.currentPass.delegate;try{for(var a=s(t),u=a.next();!u.done;u=a.next()){var c=u.value;c.isDestroyed||c.getVisible()&&(c.material?(c.material.initialize(),c.geometry.initialize(),null===(i=o.willRenderMesh)||void 0===i||i.call(o,c,this.renderingData),c.render(this),null===(n=o.didRenderMesh)||void 0===n||n.call(o,c,this.renderingData)):console.warn("Mesh "+c.name+" There is no bound material."))}}catch(t){e={error:t}}finally{try{u&&!u.done&&(r=a.return)&&r.call(a)}finally{if(e)throw e.error}}},n.prototype.setGlobalFloat=function(t,e){this.checkGlobalUniform(t),this.renderingData.currentFrame.globalUniforms.floats[t]=e},n.prototype.setGlobalInt=function(t,e){this.checkGlobalUniform(t),this.renderingData.currentFrame.globalUniforms.ints[t]=e},n.prototype.setGlobalMatrix=function(t,e){this.checkGlobalUniform(t),this.renderingData.currentFrame.globalUniforms.matrices[t]=e},n.prototype.drawGeometry=function(t,e){this.glRenderer.drawGeometry(t,e)},n.prototype.setFrameBuffer=function(t){t?(this.frameBuffer=t,this.frameBuffer.bind(),this.setViewport(t.viewport[0],t.viewport[1],t.viewport[2],t.viewport[3])):(this.pipelineContext.bindSystemFramebuffer(),this.setViewport(0,0,this.getWidth(),this.getHeight()))},n.prototype.getFrameBuffer=function(){return this.frameBuffer},n.prototype.getTemporaryRT=function(e,r,i,n,o,s){if(this.temporaryRTs[e])return this.temporaryRTs[e];var a,u,c=t.RenderPassAttachmentStorageType.none;o===t.FilterMode.Linear?a=v.LINEAR:o===t.FilterMode.Nearest&&(a=v.NEAREST),s===t.RenderTextureFormat.RGBA32?u=v.UNSIGNED_BYTE:s===t.RenderTextureFormat.RGBAHalf&&(u=v.HALF_FLOAT),0===n?c=t.RenderPassAttachmentStorageType.none:16===n?c=t.RenderPassAttachmentStorageType.depth_16_opaque:24===n&&(c=t.RenderPassAttachmentStorageType.depth_24_stencil_8_texture);var l=new Uu(this.engine,{sourceType:t.TextureSourceType.framebuffer,minFilter:a,magFilter:a,internalFormat:v.RGBA,format:v.RGBA,type:u}),h=new hc({name:e,storeAction:{},viewport:[0,0,r,i],viewportScale:1,isCustomViewport:!0,attachments:[l],depthStencilAttachment:{storageType:c}},this);return this.temporaryRTs[e]=h,h},n.prototype.setViewport=function(t,e,r,i){this.pipelineContext.viewport(t,e,r,i)},n.prototype.clear=function(e){var r=this.pipelineContext,i=0;if(e.colorAction===t.TextureLoadAction.clear){var n=e.clearColor;n&&r.clearColor(n[0],n[1],n[2],n[3]),r.colorMask(!0,!0,!0,!0),i=v.COLOR_BUFFER_BIT}if(e.stencilAction===t.TextureLoadAction.clear&&(r.stencilMask(255),r.clearStencil(e.clearStencil||0),i|=v.STENCIL_BUFFER_BIT),e.depthAction===t.TextureLoadAction.clear){var o=e.clearDepth;r.depthMask(!0),r.clearDepth(Number.isFinite(o)?o:1),i|=v.DEPTH_BUFFER_BIT}i&&r.clear(i)},n.prototype.addLostHandler=function(t){this.context.addLostHandler(t)},n.prototype.addRestoreHandler=function(t){this.context.addRestoreHandler(t)},n.prototype.getShaderLibrary=function(){return this.pipelineContext.shaderLibrary},n.prototype.getWidth=function(){return this.width},n.prototype.getHeight=function(){return this.height},n.prototype.dispose=function(){var t;this.context.dispose(),this.extension.dispose(),this.pipelineContext.dispose(),null===(t=this.glRenderer)||void 0===t||t.dispose(),this.canvas=null,this.engine.dispose()},n.prototype.lost=function(t){t.preventDefault(),this.pipelineContext.dispose(),this.extension.dispose(),this.glRenderer.lost(t)},n.prototype.restore=function(){var t=this.context.gl;if(!t)throw new Error("Can not restore automatically because losing gl context");this.engine=new uc(t),this.engine.renderer=this,this.pipelineContext=new Rc(this.engine,t),this.glRenderer=new Yu(this.engine),this.extension=new oc(this)},n.prototype.resize=function(t,e){var r=this.glRenderer;r&&(this.width===t&&this.height===e||r.resize(t,e))},n.prototype.checkGlobalUniform=function(t){var e=this.renderingData.currentFrame.globalUniforms;e.uniforms.includes(t)||e.uniforms.push(t)},n}(An),_c="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",wc="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",Oc="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",Mc="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",Lc="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",Ic="https://galacean.antgroup.com/effects/#/user/gasrv4ka5sacrwpg",Pc=new Map,Fc=!1,Vc=1,Nc=function(){function e(t){var e,r,a=this;this.compositions=[],this.displayScale=1,this.resumePending=!1,this.disposed=!1,this.assetManagers=[],this.speed=1,this.baseCompositionIndex=0,this.lost=function(t){var e,r;null===(e=a.ticker)||void 0===e||e.pause(),a.compositions.forEach((function(e){return e.lost(t)})),a.renderer.lost(t),null===(r=a.handleWebGLContextLost)||void 0===r||r.call(a,t),zc(a,!1)},this.restore=function(){return n(a,void 0,void 0,(function(){var t,e,r,i=this;return o(this,(function(s){switch(s.label){case 0:return this.renderer.restore(),t=this,[4,Promise.all(this.compositions.map((function(t){return n(i,void 0,void 0,(function(){var e,r,i,n,s,a,u,c,l,h,f,p;return o(this,(function(o){switch(o.label){case 0:return e=t.time,r=t.url,i=t.speed,n=t.keepResource,s=t.reusable,a=t.renderOrder,u=t.transform,c=t.videoState,[4,this.loadScene(r)];case 1:(l=o.sent()).speed=i,l.reusable=s,l.keepResource=n,l.renderOrder=a,l.transform=u,h=0,o.label=2;case 2:return h<c.length?c[h]?((f=l.textures[h].source.video).currentTime=null!==(p=c[h])&&void 0!==p?p:0,[4,f.play()]):[3,4]:[3,5];case 3:o.sent(),o.label=4;case 4:return h++,[3,2];case 5:return l.content.start(),l.gotoAndPlay(e),[2,l]}}))}))})))];case 1:return t.compositions=s.sent(),null===(e=this.handleWebGLContextRestored)||void 0===e||e.call(this),null===(r=this.ticker)||void 0===r||r.resume(),[2]}}))}))},this.handleResume=function(){var t;null===(t=a.handlePlayableUpdate)||void 0===t||t.call(a,{player:a,playing:!0})},this.handleClick=function(t){var e=t.x,r=t.y;a.compositions.forEach((function(t){var n,o=t.hitTest(e,r);if(o.length)for(var s=0;s<o.length;s++){var u=o[s].behavior||w.NOTIFY;u===w.NOTIFY?t.onItemClicked?t.onItemClicked(i({},o[s])):null===(n=a.handleItemClicked)||void 0===n||n.call(a,i(i({},o[s]),{compositionId:t.id,compositionName:t.name,composition:t.name,player:a})):u===w.RESUME_PLAYER&&a.resume()}}))};var u=t.container,c=t.canvas,l=t.gl,h=t.fps,f=t.name,p=t.pixelRatio,d=t.manualRender,v=t.interactive,y=t.reportGPUTime,g=t.onMessageItem,x=t.onPausedByItem,T=t.onItemClicked,E=t.onPlayableUpdate,b=t.onRenderError,S=t.onWebGLContextLost,A=t.onWebGLContextRestored,R=t.renderFramework,C=t.env,_=void 0===C?"":C,O=t.notifyTouch;if(m.length)throw new Error("Errors before player create: ".concat(m.map((function(t,e){return"\n ".concat(e+1,": ").concat(t)}))));var M=null!==(r=null!==(e=t.renderOptions)&&void 0!==e?e:t)&&void 0!==r?r:{},L=M.willCaptureImage,I=M.premultiplyAlpha;if(!Fc&&"debug-disable"!==R){var P,F=ft()||(P=/iPhone OS (\d+)_(\d+)/.exec(navigator.userAgent))&&("13"===P[1]||"16"===P[1]&&"5"===P[2])?"webgl":"webgl2";if(R&&(F="webgl"===R?"webgl":"webgl2"),this.handleWebGLContextLost=S,this.handleWebGLContextRestored=A,this.reportGPUTime=y,this.handleItemClicked=T,this.handleMessageItem=g,this.handlePlayableUpdate=E,this.handleRenderError=b,this.handlePlayerPause=function(t){a.pause(),null==x||x({name:t.name,player:a})},this.pixelRatio=Number.isFinite(p)?p:ht(),this.offscreenMode=!0,this.env=_,c)this.canvas=c;else if(l){this.canvas=l.canvas;var V=l instanceof WebGLRenderingContext?"webgl":"webgl2";F!==V&&(Je.error("The gl context(".concat(V,") is inconsistent with renderFramework or default version(").concat(F,")")),F=V)}else Bc(u),this.canvas=document.createElement("canvas"),u.appendChild(this.canvas);this.renderer=An.create(this.canvas,F,{preserveDrawingBuffer:L,premultipliedAlpha:I}),this.renderer.env=_,this.renderer.addLostHandler({lost:this.lost}),this.renderer.addRestoreHandler({restore:this.restore}),this.gpuCapability=this.renderer.engine.gpuCapability,Pc.forEach((function(t){t.gpuCapability.type!==a.gpuCapability.type&&Je.warn("Create player with different webgl version: old=".concat(t.gpuCapability.type,", new=").concat(a.gpuCapability.type))})),d||(this.ticker=new Du(h),this.ticker.add(this.tick.bind(this))),this.event=new Mr(this.canvas,!!O),this.event.bindListeners(),this.event.addEventListener(Rr,this.handleClick),this.interactive=null!=v&&v,this.name=f||"".concat(Vc++),l||this.resize(),Pn(this.gpuCapability.detail),this.container=this.canvas.parentElement,Pc.set(this.canvas,this),function(){var t,e,r=[];try{for(var i=s(Pc.values()),n=i.next();!n.done;n=i.next()){var o=n.value;o.paused||r.push(o)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}r.length>1&&Je.error("Current running player count: ".concat(r.length,", see ").concat(Ic),r)}(),zc(this,!0)}}return e.prototype.setSpeed=function(t){isNaN(t)||(this.speed=t)},e.prototype.getSpeed=function(){return this.speed},e.prototype.getCompositionByName=function(t){return this.compositions.find((function(e){return e.name===t}))},e.prototype.getCompositions=function(){return this.compositions},Object.defineProperty(e.prototype,"hasPlayable",{get:function(){return this.compositions.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"paused",{get:function(){var t;return null===(t=this.ticker)||void 0===t?void 0:t.getPaused()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"interactive",{get:function(){return this.event.enabled},set:function(t){this.event.enabled=t},enumerable:!1,configurable:!0}),e.prototype.loadScene=function(t,e){var r;return n(this,void 0,void 0,(function(){var i,s,a=this;return o(this,(function(u){switch(u.label){case 0:return s=this.baseCompositionIndex,er(t)?(this.baseCompositionIndex+=t.length,[4,Promise.all(t.map((function(t,r){return n(a,void 0,void 0,(function(){var i;return o(this,(function(n){switch(n.label){case 0:return[4,this.createComposition(t,e)];case 1:return(i=n.sent()).setIndex(s+r),[2,i]}}))}))})))]):[3,2];case 1:return i=u.sent(),[3,4];case 2:return this.baseCompositionIndex+=1,[4,this.createComposition(t,e)];case 3:(i=u.sent()).setIndex(s),u.label=4;case 4:return null===(r=this.ticker)||void 0===r||r.start(),[2,i]}}))}))},e.prototype.createComposition=function(t,e){return void 0===e&&(e={}),n(this,void 0,void 0,(function(){var r,n,s,a,u,c,l,h,f=this;return o(this,(function(o){switch(o.label){case 0:return r=this.renderer,n=performance.now(),s=i({autoplay:!0},e),Dc(t)?(a=t.scene,s=i(i({},s),t.options||{})):a=t,u=new Iu(s),this.assetManagers.push(u),[4,u.loadScene(a,this.renderer,{env:this.env})];case 1:if(c=o.sent(),this.disposed)throw new Error("Disposed player can not used to create Composition");return l=new Vu(i(i({},s),{renderer:r,width:r.getWidth(),height:r.getHeight(),event:this.event,onPlayerPause:this.handlePlayerPause,onMessageItem:this.handleMessageItem}),c),this.ticker&&l.renderLevel===E.B&&this.ticker.setFPS(Math.min(this.ticker.getFPS(),30)),[4,new Promise((function(t){f.renderer.getShaderLibrary().compileAllShaders((function(){t(null)}))}))];case 2:return o.sent(),s.autoplay?(this.autoPlaying=!0,l.play()):l.pause(),h=performance.now()-n+l.statistic.loadTime,l.statistic.firstFrameTime=h,Je.info("first frame: [".concat(l.name,"]").concat(h.toFixed(4),"ms")),this.compositions.push(l),[2,l]}}))}))},e.prototype.play=function(){var t;this.offscreenMode&&(this.resize(),this.offscreenMode=!1),this.autoPlaying=!0,this.compositions.map((function(t){t.play()})),null===(t=this.ticker)||void 0===t||t.start()},e.prototype.gotoAndPlay=function(t){this.offscreenMode&&(this.resize(),this.offscreenMode=!1),this.autoPlaying=!0,this.compositions.map((function(e){e.gotoAndPlay(t)})),this.ticker?this.ticker.start():this.doTick(0,!0)},e.prototype.gotoAndStop=function(t){var e,r;this.offscreenMode&&(this.resize(),this.offscreenMode=!1),this.autoPlaying=!1,this.compositions.map((function(e){e.gotoAndStop(t)})),this.ticker&&!(null===(e=this.ticker)||void 0===e?void 0:e.getPaused())||this.doTick(0,!0),null===(r=this.handlePlayableUpdate)||void 0===r||r.call(this,{player:this,playing:!1})},e.prototype.playSequence=function(t){for(var e,r=function(e){var r=t[e],i=r.onEnd;r.onEnd=function(){null==i||i.call(r,r),t[e+1].play()}},i=0;i<t.length-1;i++)r(i);t[0].play(),null===(e=this.ticker)||void 0===e||e.start()},e.prototype.pause=function(t){var e,r;this.paused||(null===(e=this.ticker)||void 0===e||e.pause(),null===(r=this.handlePlayableUpdate)||void 0===r||r.call(this,{player:this,playing:!1}),t&&t.offloadTexture&&this.offloadTexture())},e.prototype.resume=function(){var t;return n(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.resumePending?[2]:this.paused?(this.resumePending=!0,[4,Promise.all(this.compositions.map((function(t){return t.reloadTexture()})))]):[3,2];case 1:e.sent(),this.resumePending=!1,this.handleResume(),e.label=2;case 2:return null===(t=this.ticker)||void 0===t||t.resume(),[2]}}))}))},e.prototype.tick=function(t){this.doTick(t,this.forceRenderNextFrame),this.forceRenderNextFrame=!1},e.prototype.doTick=function(e,r){var i,n,o,s,a,u=this,c=this.renderer.engine.renderErrors;c.size>0&&(null===(i=this.handleRenderError)||void 0===i||i.call(this,c.values().next().value),null===(n=this.ticker)||void 0===n||n.pause()),e=Math.min(e,33)*this.speed;var l=this.compositions,h=!1;l.sort((function(t,e){return t.getIndex()-e.getIndex()})),this.compositions=[];for(var f=0;f<l.length;f++){var p=l[f];p.textureOffloaded?(h=!0,Je.error("Composition ".concat(p.name," texture offloaded, skip render.")),this.compositions.push(p)):(!p.isDestroyed&&p.renderer&&p.update(e),p.isDestroyed||this.compositions.push(p))}if(this.baseCompositionIndex=this.compositions.length,h)return null===(o=this.handleRenderError)||void 0===o||o.call(this,new Error("play when texture offloaded")),null===(s=this.ticker)||void 0===s?void 0:s.pause();if(!this.paused||r){var m=this.gpuCapability.level,v=this.renderer.context.gl,y=2===m&&this.reportGPUTime?d(v):void 0;if(null==y||y.begin(),this.compositions.length||this.compositions.length<l.length||r)for(this.renderer.setFrameBuffer(null),this.renderer.clear({stencilAction:t.TextureLoadAction.clear,clearStencil:0,depthAction:t.TextureLoadAction.clear,clearDepth:1,colorAction:t.TextureLoadAction.clear,clearColor:[0,0,0,0]}),f=0;f<l.length;f++)!l[f].renderFrame.isDestroyed&&this.renderer.renderRenderFrame(l[f].renderFrame);null==y||y.end(),null==y||y.getTime().then((function(t){var e;return null===(e=u.reportGPUTime)||void 0===e?void 0:e.call(u,null!=t?t:0)})).catch,this.autoPlaying&&(null===(a=this.handlePlayableUpdate)||void 0===a||a.call(this,{player:this,playing:!0}))}},e.prototype.resizeToAspect=function(t,e){void 0===e&&(e=1),t!==this.displayAspect&&(this.displayAspect=t),e!==this.displayScale&&(this.displayScale=e),this.resize()},e.prototype.resize=function(){var t,e,r,i,n,o=this.canvas.parentElement;if(o){var s=this.getTargetSize(o);e=s[0],r=s[1],i=s[2],n=s[3]}else e=i=this.canvas.width,r=n=this.canvas.height;var a=e/r;if(e&&r){var u=document.documentElement.clientWidth;i>2*u&&Je.error("DPI overflowed, width ".concat(i," is more than 2x document width ").concat(u,", see ").concat(wc));var c=this.env?this.gpuCapability.detail.maxTextureSize:2048;(i>c||n>c)&&(Je.error("Container size overflowed ".concat(i,"x").concat(n,", see ").concat(_c)),a>1?(i=Math.round(c),n=Math.round(c/a)):(n=Math.round(c),i=Math.round(c*a))),this.renderer.resize(i,n),this.canvas.style.width=e+"px",this.canvas.style.height=r+"px",Je.info("Resize player ".concat(this.name," [").concat(i,",").concat(n,",").concat(e,",").concat(r,"].")),null===(t=this.compositions)||void 0===t||t.forEach((function(t){t.camera.aspect=a}))}},e.prototype.clearCanvas=function(e){e?this.renderer.clear({stencilAction:t.TextureLoadAction.clear,clearStencil:0,depthAction:t.TextureLoadAction.clear,clearDepth:1,colorAction:t.TextureLoadAction.clear,clearColor:[0,0,0,0]}):this.forceRenderNextFrame=!0},e.prototype.destroyItem=function(t,e){},e.prototype.destroyCurrentCompositions=function(){this.compositions.forEach((function(t){return t.dispose()})),this.compositions.length=0,this.baseCompositionIndex=0},e.prototype.dispose=function(t){var e;if(Je.info("call player destroy: ".concat(this.name)),!this.disposed){Pc.delete(this.canvas),this.pause(),null===(e=this.ticker)||void 0===e||e.stop(),this.assetManagers.forEach((function(t){return t.dispose()})),this.compositions.forEach((function(t){return t.dispose()})),this.compositions.length=0,this.renderer.context.removeLostHandler({lost:this.lost}),this.renderer.context.removeRestoreHandler({restore:this.restore}),this.event.dispose(),this.renderer.dispose(!t),zc(this,!1),this.canvas instanceof HTMLCanvasElement&&!t&&this.renderer.context&&(Bs.dispose(),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.canvas.remove());var r,i=(r=this.name,"Never use destroyed player: ".concat(r," again, see ").concat(Lc)),n=function(){return function(t){throw new Error(t)}(i)},o=function(){return t=i,Promise.reject(t);var t};this.tick=n,this.resize=n,this.loadScene=o,this.play=o,this.gotoAndPlay=o,this.gotoAndStop=o,this.playSequence=n,this.destroyCurrentCompositions=n,this.resume=o,this.disposed=!0}},e.prototype.offloadTexture=function(){this.compositions.forEach((function(t){return t.offloadTexture()}))},e.prototype.getTargetSize=function(t){Bc(t);var e,r,i=this.displayAspect;i?t.clientWidth/t.clientHeight>i?e=(r=t.clientHeight*this.displayScale)*i:r=(e=t.clientWidth*this.displayScale)/i:(e=t.clientWidth,r=t.clientHeight);var n=this.pixelRatio,o=e,s=r;if(e=Math.round(e*n),(r=Math.round(r*n))<1||r<1){if(!this.offscreenMode)throw Error("Invalid container size ".concat(e,"x").concat(r,", see ").concat(Oc));e=r=o=s=1}return[o,s,e,r]},e}();function Dc(t){return ir(t)&&"scene"in t&&"options"in t}function zc(t,e){Object.keys(fr).forEach((function(r){var i=fr[r],n=e?i.onPlayerCreated:i.onPlayerDestroy;null==n||n(t)}))}function Bc(t){if(null==t)throw new Error("Container is not an HTMLElement, see ".concat(Mc))}qr.create=function(t,e){return new Uu(t,e)},qr.createWithData=function(e,r,i){void 0===r&&(r=dt("#fff")),void 0===i&&(i={});var n=i,o=n.type,s=void 0===o?v.UNSIGNED_BYTE:o,a=n.format,u=void 0===a?v.RGBA:a,c=n.internalFormat,l=n.wrapS,h=void 0===l?v.MIRRORED_REPEAT:l,f=n.wrapT,p=void 0===f?v.MIRRORED_REPEAT:f,d=n.minFilter,m=void 0===d?v.NEAREST:d,y=n.magFilter,g=void 0===y?v.NEAREST:y,x=n.flipY,T=void 0!==x&&x;return new Uu(e,{data:r,type:s,sourceType:t.TextureSourceType.data,format:u,internalFormat:c||u,wrapS:h,wrapT:p,minFilter:m,magFilter:g,flipY:T})},ui.create=function(t,e){return new nc(t,e)},bi.create=function(t,e){return new tc(t,e)},Li.create=function(t,e){return new Li(t,e)},mn.create=function(t){return new cc(t)},Sn.create=function(t,e){return new hc(t,e)},An.create=function(t,e,r){return new Cc(t,e,r)},Nu.create=function(t){return new uc(t)};var Uc="1.6.5";Je.info("player version: "+Uc),t.AbstractPlugin=xr,t.AssetManager=Iu,t.BYTES_TYPE_MAP=Ei,t.BezierCurve=Ne,t.BezierCurvePath=De,t.COMPRESSED_TEXTURE=En,t.COPY_FRAGMENT_SHADER=di,t.COPY_MESH_SHADER_ID=fi,t.COPY_VERTEX_SHADER=pi,t.CalculateItem=Yn,t.CalculateLoader=Ss,t.CalculateVFXItem=As,t.Camera=ga,t.CameraController=Tr,t.CameraVFXItem=br,t.CameraVFXItemLoader=Er,t.Composition=Vu,t.CompositionSourceManager=_u,t.DEFAULT_FONTS=Vs,t.Downloader=Ur,t.EFFECTS_COPY_MESH_NAME=hi,t.EVENT_TYPE_CLICK=Rr,t.EVENT_TYPE_TOUCH_END=wr,t.EVENT_TYPE_TOUCH_MOVE=_r,t.EVENT_TYPE_TOUCH_START=Cr,t.Engine=Nu,t.EventSystem=Mr,t.FILTER_NAME_NONE=h,t.FilterSpriteVFXItem=Qn,t.Float16ArrayWrapper=Qt,t.FrameBuffer=Sn,t.GLEngine=uc,t.GLGeometry=tc,t.GLRenderer=Cc,t.GPUCapability=yn,t.Geometry=bi,t.GlobalUniforms=dn,t.GradientValue=Fe,t.HELP_LINK=f,t.InteractBehavior=Or,t.InteractItem=Mn,t.InteractLoader=On,t.InteractMesh=Cn,t.InteractVFXItem=_n,t.KTXTexture=Qr,t.LineSegments=Ve,t.LinearValue=Pe,t.Material=ui,t.MaterialDataBlock=ii,t.Mesh=Li,t.PLAYER_OPTIONS_ENV_EDITOR=l,t.POST_PROCESS_SETTINGS="post_process_settings",t.ParticleLoader=bs,t.ParticleMesh=vs,t.ParticleSystem=rs,t.ParticleVFXItem=ds,t.PassTextureCache=xi,t.Player=Nc,t.PluginSystem=yr,t.QCanvasViewer=Ms,t.QText=Os,t.RENDER_PASS_NAME_PREFIX=cn,t.RENDER_PREFER_LOOKUP_TEXTURE=Ai,t.RUNTIME_ENV="runtime_env",t.RandomSetValue=Me,t.RandomValue=Le,t.RandomVectorValue=Ie,t.RenderBuffer=mn,t.RenderFrame=hn,t.RenderPass=Ni,t.RenderPassPriorityNormal=Ii,t.RenderPassPriorityPostprocess=3e3,t.RenderPassPriorityPrepare=0,t.RenderTargetHandle=Fi,t.Renderer=An,t.SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_0="PRE_MAIN_COLOR_0",t.SEMANTIC_MAIN_PRE_COLOR_ATTACHMENT_SIZE_0="PRE_MAIN_COLOR_SIZE_0",t.SEMANTIC_PRE_COLOR_ATTACHMENT_0="PRE_COLOR_0",t.SEMANTIC_PRE_COLOR_ATTACHMENT_SIZE_0="PRE_COLOR_SIZE_0",t.SPRITE_VERTEX_STRIDE=c,t.SemanticMap=Ti,t.Shader=li,t.SpriteItem=Zn,t.SpriteLoader=Gn,t.SpriteMesh=In,t.SpriteVFXItem=qn,t.StaticValue=Oe,t.TEMPLATE_USE_OFFSCREEN_CANVAS=Ri,t.TextItem=Ws,t.TextLoader=qs,t.TextMesh=Rs,t.TextVFXItem=Zs,t.Texture=qr,t.TextureFactory=ti,t.Ticker=Du,t.TimelineComponent=Ze,t.Transform=cr,t.VFXItem=lr,t.ValueGetter=we,t.addByOrder=yt,t.addItem=rt,t.addItemWithOrder=nt,t.alphaFrameFrag=Xi,t.alphaMaskFrag=Hi,t.assertExist=Tt,t.asserts=function(t,e){if(void 0===e&&(e="asserts failed"),!t)throw new Error(e)},t.blend="vec4 blendColor(vec4 color,vec4 vc,float mode){vec4 ret=color*vc;\n#ifdef PRE_MULTIPLY_ALPHA\nfloat alpha=vc.a;\n#else\nfloat alpha=ret.a;\n#endif\nif(mode==1.){ret.rgb*=alpha;}else if(mode==2.){ret.rgb*=alpha;ret.a=dot(ret.rgb,vec3(0.33333333));}else if(mode==3.){alpha=color.r*alpha;ret=vec4(vc.rgb*alpha,alpha);}return ret;}",t.bloomMixVert=qi,t.bloomThresholdVert=Ki,t.calculateTranslation=te,t.cameraMoveFrag="uniform vec2 uMoveTexSize;uniform sampler2D uFilterSource;\n#define INTERPOLATION 1\nvec4 filterMain(vec2 texCoord,sampler2D tex){\n#ifdef INTERPOLATION\nvec2 texInPixel=texCoord*uMoveTexSize;vec2 coordMin=floor(texInPixel);vec2 pp=texInPixel-coordMin;vec4 fCoord=vec4(coordMin/uMoveTexSize,(coordMin+vec2(1.))/uMoveTexSize);vec4 cLT=texture2D(uFilterSource,vec2(fCoord.x,fCoord.w));vec4 cLB=texture2D(uFilterSource,vec2(fCoord.x,fCoord.y));vec4 cRT=texture2D(uFilterSource,vec2(fCoord.z,fCoord.w));vec4 cRB=texture2D(uFilterSource,vec2(fCoord.z,fCoord.y));vec4 cB=mix(cLB,cRB,pp.x);vec4 cT=mix(cLT,cRT,pp.x);return mix(cB,cT,pp.y);\n#else\nreturn texture2D(uFilterSource,texCoord);\n#endif\n}",t.cameraMoveVert=Yi,t.canvasPool=Bs,t.colorGradingFrag=Ji,t.colorStopsFromGradient=ut,t.colorToArr=st,t.combineImageTemplate=Ys,t.combineImageTemplate1=Is,t.combineImageTemplate1Async=function(t,e,r,i,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){return console.warn("The combineImageTemplate1Async function is deprecated. Use combineImageTemplate1 instead."),[2,Is(t,e,r,i,s)]}))}))},t.combineImageTemplate2=Hs,t.combineImageTemplate2Async=function(t,e,r,i,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){return console.warn("The combineImageTemplate2Async function is deprecated. Use combineImageTemplate2 instead."),[2,Hs(t,e,r,i,s)]}))}))},t.combineImageTemplateAsync=function(t,e,r,i,s){return n(this,void 0,void 0,(function(){return o(this,(function(n){return console.warn("The combineImageTemplateAsync function is deprecated. Use combineImageTemplate instead."),[2,Ys(t,e,r,i,s)]}))}))},t.compatibleFrag="#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#define textureCube texture\n#define textureCubeLodEXT textureLod\nlayout(location=0)out vec4 fragColor;\n#else\n#define fragColor gl_FragColor\n#endif\n",t.compatibleVert="#version 300 es\n#ifdef WEBGL2\n#define texture2D texture\n#else\n#endif\n",t.convertAnchor=ae,t.copyFrag=ci,t.createCopyShader=mi,t.createFilter=et,t.createFilterShaders=tt,t.createGLContext=p,t.createKeyFrameMeta=Xe,t.createShaderWithMarcos=Nr,t.createShape=vo,t.createVFXItem=hr,t.createValueGetter=Be,t.decimalEqual=he,t.deepClone=function t(e){if(er(e))return e.map(t);if(e&&"object"==typeof e){if(ArrayBuffer.isView(e))return e.slice();for(var r={},i=Object.keys(e),n=0;n<i.length;n++){var o=i[n];r[o]=t(e[o])}return r}return e},t.defaultGlobalVolume=un,t.defaultPlugins=pr,t.delayFrag=ji,t.deserializeMipmapTexture=jr,t.disableAllPlayer=function(t){Fc=!!t},t.distortionFrag=Wi,t.distortionVert=Zi,t.earcut=Bo,t.enlargeBuffer=ot,t.ensureVec3=ee,t.filters=xa,t.findPreviousRenderPass=function(t,e){var r=t.indexOf(e);return t[r-1]},t.gaussianDownFrag="precision highp float;varying vec2 uv;uniform sampler2D _MainTex;uniform vec2 _TextureSize;float GaussWeight2D(float x,float y,float sigma){float PI=3.14159265358;float E=2.71828182846;float sigma_2=pow(sigma,2.0);float a=-(x*x+y*y)/(2.0*sigma_2);return pow(E,a)/(2.0*PI*sigma_2);}vec3 GaussNxN(sampler2D tex,vec2 uv,vec2 stride,float sigma){vec3 color=vec3(0.,0.,0.);const int r=5/2;float weight=0.0;for(int i=-r;i<=r;i++){for(int j=-r;j<=r;j++){float w=GaussWeight2D(float(i),float(j),sigma);vec2 coord=uv+vec2(i,j)*stride;color+=texture2D(tex,coord).rgb*w;weight+=w;}}color/=weight;return color;}void main(){vec4 mainColor=texture2D(_MainTex,uv);vec3 color=mainColor.rgb;color=GaussNxN(_MainTex,uv,1.0/_TextureSize,1.0);gl_FragColor=vec4(color,1.0);}",t.gaussianDownHFrag=$i,t.gaussianDownVFrag=tn,t.gaussianUpFrag=en,t.generateEmptyTypedArray=Si,t.generateHalfFloatTexture=Kr,t.getActivePlayers=function(){return Array.from(Pc.values())},t.getBackgroundImage=Us,t.getColorFromGradientStops=at,t.getConfig=_i,t.getDefaultTemplateCanvasPool=function(){return Bs},t.getDefaultTextureFactory=ei,t.getGeometryByShape=Yo,t.getGeometryTriangles=Ho,t.getImageItemRenderInfo=Fn,t.getKTXTextureOptions=Jr,t.getKeyFrameMetaByRawValue=Ge,t.getParticleMeshShader=xs,t.getPixelRatio=ht,t.getPlayerByCanvas=function(t){return Pc.get(t)},t.getPreMultiAlpha=Ir,t.getStandardComposition=xu,t.getStandardImage=gu,t.getStandardItem=Su,t.getStandardJSON=vu,t.getTextureSize=fn,t.glContext=v,t.gpuTimer=d,t.imageDataFromColor=dt,t.imageDataFromGradient=mt,t.initErrors=m,t.initGLContext=y,t.integrate="float calculateMovement(float t,vec2 p1,vec2 p2,vec2 p3,vec2 p4){float movement=0.0;float h=(t-p1.x)*0.05;for(int i=0;i<=20;i++){float t=float(i)*h;float nt=binarySearchT(t,p1.x,p2.x,p3.x,p4.x);float y=cubicBezier(nt,p1.y,p2.y,p3.y,p4.y);float weight=(i==0||i==20)? 1.0 :(mod(float(i),2.)!=0.)? 4.0 : 2.0;movement+=weight*y;}movement*=h/3.;return movement;}float integrateFromBezierCurveFrames(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i+=2){vec4 k0=lookup_curve(i+start);vec4 k1=lookup_curve(i+1+start);if(i==0&&time<k0.x){return ret;}vec2 p1=vec2(k0.x,k0.y);vec2 p2=vec2(k0.z,k0.w);vec2 p3=vec2(k1.z,k1.w);vec2 p4=vec2(k1.x,k1.y);if(time>=k1.x){ret+=calculateMovement(k1.x,p1,p2,p3,p4);}if(time>=k0.x&&time<k1.x){return ret+calculateMovement(time,p1,p2,p3,p4);}}return ret;}float integrateByTimeLineSeg(float t,vec2 p0,vec2 p1){float t0=p0.x;float t1=p1.x;float y0=p0.y;float y1=p1.y;vec4 tSqr=vec4(t,t,t0,t0);tSqr=tSqr*tSqr;vec4 a=vec4(2.*t,3.,-t0,3.)*tSqr;float t1y0=t1*y0;vec4 b=vec4(y0-y1,t0*y1-t1y0,2.*y0+y1,t1y0);float r=dot(a,b);return r/(t0-t1)*0.16666667;}float integrateLineSeg(float time,vec2 p0,vec2 p1){float h=time-p0.x;float y0=p0.y;return(y0+y0+(p1.y-y0)*h/(p1.x-p0.x))*h/2.;}float integrateFromLineSeg(float time,float frameStart,float frameCount){if(time==0.){return 0.;}int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i++){if(i>count){return ret;}vec4 ks=lookup_curve(i+start);vec2 k0=ks.xy;vec2 k1=ks.zw;if(time>k0.x&&time<=k1.x){return ret+integrateLineSeg(time,k0,k1);}ret+=integrateLineSeg(k1.x,k0,k1);vec2 k2=lookup_curve(i+start+1).xy;if(time>k1.x&&time<=k2.x){return ret+integrateLineSeg(time,k1,k2);}ret+=integrateLineSeg(k2.x,k1,k2);}return ret;}float integrateByTimeFromLineSeg(float time,float frameStart,float frameCount){if(time==0.){return 0.;}int start=int(frameStart);int count=int(frameCount-1.);float ret=0.;for(int i=0;i<ITR_END;i++){if(i>count){return ret;}vec4 ks=lookup_curve(i+start);vec2 k0=ks.xy;vec2 k1=ks.zw;if(time>k0.x&&time<=k1.x){return ret+integrateByTimeLineSeg(time,k0,k1);}ret+=integrateByTimeLineSeg(k1.x,k0,k1);vec2 k2=lookup_curve(i+start+1).xy;if(time>k1.x&&time<=k2.x){return ret+integrateByTimeLineSeg(time,k1,k2);}ret+=integrateByTimeLineSeg(k2.x,k1,k2);}return ret;}float getIntegrateFromTime0(float t1,vec4 value){float type=value.x;if(type==0.){return value.y*t1;}if(type==1.){vec2 p0=vec2(0.,value.y);vec2 p1=vec2(value.w,value.z);return integrateLineSeg(t1,p0,p1);}if(type==3.){return integrateFromLineSeg(t1,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed)*t1;}if(type==5.){return integrateFromBezierCurveFrames(t1,value.z,value.w);}return 0.;}float getIntegrateByTimeFromTime(float t0,float t1,vec4 value){float type=value.x;if(type==0.){return value.y*(t1*t1-t0*t0)/2.;}else if(type==1.){vec2 p0=vec2(0.,value.y);vec2 p1=vec2(value.w,value.z);return integrateByTimeLineSeg(t1,p0,p1)-integrateByTimeLineSeg(t0,p0,p1);}if(type==3.){return integrateByTimeFromLineSeg(t1,value.y,value.z)-integrateByTimeFromLineSeg(t0,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed)*(t1*t1-t0*t0)/2.;}if(type==5.){return integrateFromBezierCurveFrames(t1,value.z,value.w)-integrateFromBezierCurveFrames(t0,value.z,value.w);}return 0.;}",t.interpolateColor=ct,t.isAlipayMiniApp=function(){return"undefined"!=typeof my&&"web"===(null===my||void 0===my?void 0:my.renderTarget)},t.isAndroid=ft,t.isArray=er,t.isCanvasUsedByPlayer=function(t){return Pc.has(t)},t.isFunction=rr,t.isIOS=function(){return!!navigator.platform&&/iPad|iPhone|iPod/.test(navigator.platform)},t.isObject=ir,t.isScene=wu,t.isSceneWithOptions=Dc,t.isSimulatorCellPhone=pt,t.isString=tr,t.isUniformStruct=ni,t.isUniformStructArray=function(t){return t&&void 0!==t.length&&ni(t[0])},t.isValidFontFamily=Et,t.isWebGL2=g,t.itemFrag=Bi,t.itemFrameFrag=Di,t.itemVert=zi,t.loadBinary=Hr,t.loadBlob=function(t){return n(this,void 0,void 0,(function(){return o(this,(function(e){return[2,new Promise((function(e,r){(new Ur).downloadBlob(t,e,(function(e,i){r("Couldn't load blob ".concat(t,": status ").concat(e,", ").concat(i))}))}))]}))}))},t.loadImage=Xr,t.loadMedia=ks,t.loadVideo=Yr,t.loadWebPOptional=Gr,t.logger=Je,t.math=qt,t.modifyMaxKeyframeShader=Ts,t.nearestPowerOfTwo=ue,t.noop=$e,t.numberToFix=fe,t.parsePercent=lt,t.particleFrag=Ui,t.particleOriginTranslateMap=se,t.particleUniformTypeMap=ms,t.particleVert=ki,t.pluginLoaderMap=fr,t.pointOnLine=function(t,e,r,i,n,o){var s=t*i+e*n+r*o-n*i-o*t-r*e;return s>-.001&&s<.001},t.random=nr,t.registerFilter=J,t.registerFilters=$,t.registerPlugin=mr,t.removeItem=it,t.requestAsync=Ls,t.rotateVec2=jo,t.screenMeshVert=Qi,t.setBlendMode=Dr,t.setConfig=function(t,e){return Ci[t]=e},t.setDefaultTextureFactory=function(t){$r=t},t.setMaskMode=Br,t.setMaxSpriteMeshItemCount=function(e){t.maxSpriteMeshItemCount=e},t.setRayFromCamera=ce,t.setSideMode=zr,t.setSpriteMeshMaxFragmentTextures=function(e){t.maxSpriteTextureCount=e},t.setSpriteMeshMaxItemCountByGPU=Pn,t.sortByOrder=vt,t.spec=bt,t.spriteMeshShaderFromFilter=Vn,t.spriteMeshShaderFromRenderInfo=Dn,t.spriteMeshShaderIdFromRenderInfo=Nn,t.thresholdFrag=rn,t.throwDestroyedError=or,t.trailVert=Gi,t.translatePoint=function(t,e){for(var r=[-.5,.5,-.5,-.5,.5,.5,.5,-.5],i=0;i<8;i+=2)r[i]+=t,r[i+1]+=e;return r},t.trianglesFromRect=le,t.unregisterPlugin=function(t){delete dr[t],delete fr[t],it(pr,t)},t.valIfUndefined=function(t,e){return null==t?e:t},t.value="#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n#if CURVE_VALUE_COUNT > 0\n#if LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n#endif\n#else\n#define lookup_curve(i) vec4(0.)\n#endif\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n#define NONE_CONST_INDEX 1\n#ifdef SHADER_VERTEX\nin float aSeed;out float vSeed;\n#endif\n#ifdef SHADER_VERTEX\n#define MAX_C VERT_MAX_KEY_FRAME_COUNT\n#else\n#define MAX_C FRAG_MAX_KEY_FRAME_COUNT\n#endif\nmat4 cubicBezierMatrix=mat4(1.0,-3.0,3.0,-1.0,0.0,3.0,-6.0,3.0,0.0,0.0,3.0,-3.0,0.0,0.0,0.0,1.0);float cubicBezier(float t,float y1,float y2,float y3,float y4){vec4 tVec=vec4(1.0,t,t*t,t*t*t);vec4 yVec=vec4(y1,y2,y3,y4);vec4 result=tVec*cubicBezierMatrix*yVec;return result.x+result.y+result.z+result.w;}float binarySearchT(float x,float x1,float x2,float x3,float x4){float left=0.0;float right=1.0;float mid=0.0;float computedX;for(int i=0;i<8;i++){mid=(left+right)*0.5;computedX=cubicBezier(mid,x1,x2,x3,x4);if(abs(computedX-x)<0.0001){break;}else if(computedX>x){right=mid;}else{left=mid;}}return mid;}float valueFromBezierCurveFrames(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);for(int i=0;i<ITR_END;i+=2){if(i>=count){break;}vec4 k0=lookup_curve(i+start);vec4 k1=lookup_curve(i+1+start);if(i==0&&time<k0.x){return k0.y;}if(i==int(frameCount-2.)&&time>=k1.x){return k1.y;}if(time>=k0.x&&time<=k1.x){float t=(time-k0.x)/(k1.x-k0.x);float nt=binarySearchT(time,k0.x,k0.z,k1.z,k1.x);return cubicBezier(nt,k0.y,k0.w,k1.w,k1.y);}}}float evaluteLineSeg(float t,vec2 p0,vec2 p1){return p0.y+(p1.y-p0.y)*(t-p0.x)/(p1.x-p0.x);}float valueFromLineSegs(float time,float frameStart,float frameCount){int start=int(frameStart);int count=int(frameCount-1.);int end=start+count;for(int i=0;i<ITR_END;i++){if(i>count){return lookup_curve(i).w;}vec4 seg=lookup_curve(i+start);vec2 p0=seg.xy;vec2 p1=seg.zw;if(time>=p0.x&&time<=p1.x){return evaluteLineSeg(time,p0,p1);}vec2 p2=lookup_curve(i+start+1).xy;if(time>p1.x&&time<=p2.x){return evaluteLineSeg(time,p1,p2);}}return lookup_curve(0).y;}float getValueFromTime(float time,vec4 value){float type=value.x;if(type==0.){return value.y;}if(type==1.){return mix(value.y,value.z,time/value.w);}if(type==3.){return valueFromLineSegs(time,value.y,value.z);}if(type==4.){return mix(value.y,value.z,aSeed);}if(type==5.){return valueFromBezierCurveFrames(time,value.z,value.w);}return 0.;}",t.valueDefine="#ifdef SHADER_VERTEX\n#define CURVE_VALUE_TEXTURE uVCurveValueTexture\n#define CURVE_VALUE_ARRAY uVCurveValues\n#define CURVE_VALUE_COUNT VERT_CURVE_VALUE_COUNT\n#define FRAG_CURVE_VALUE_COUNT 0\n#else\n#define CURVE_VALUE_TEXTURE uFCurveValueTexture\n#define CURVE_VALUE_ARRAY uFCurveValues\n#define CURVE_VALUE_COUNT FRAG_CURVE_VALUE_COUNT\n#define VERT_CURVE_VALUE_COUNT 0\n#endif\n#if CURVE_VALUE_COUNT > 0\n#if LOOKUP_TEXTURE_CURVE\nuniform sampler2D CURVE_VALUE_TEXTURE;const float uCurveCount=1./float(CURVE_VALUE_COUNT);\n#define lookup_curve(i) texture2D(CURVE_VALUE_TEXTURE,vec2(float(i) * uCurveCount,0.))\n#else\nuniform vec4 CURVE_VALUE_ARRAY[CURVE_VALUE_COUNT];\n#define lookup_curve(i) CURVE_VALUE_ARRAY[i]\n#endif\n#else\n#define lookup_curve(i) vec4(0.)\n#endif\n#ifdef WEBGL2\n#define ITR_END (count + 1)\n#else\n#define ITR_END MAX_C\n#endif\n",t.vecAssign=ie,t.vecFill=re,t.vecMulCombine=oe,t.vecNormalize=ne,t.version=Uc,Object.defineProperty(t,"__esModule",{value:!0})}));